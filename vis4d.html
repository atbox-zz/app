<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>六十四卦互動地圖（六維超立方體投影）</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
  <style>
    body { font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif; margin:0; }
    #container { display:flex; height:100vh; }
    #mynetwork { flex:1; border-right:1px solid #ddd; }
    #panel { width:420px; padding:16px; box-sizing:border-box; overflow:auto; }
    .gua-title { font-size:22px; font-weight:700; margin-bottom:6px; }
    .gua-bits { color:#666; margin-bottom:8px; }
    .change-list { margin-top:12px; }
    .change-item { padding:6px; border:1px solid #eee; margin-bottom:6px; cursor:pointer; border-radius:6px; }
    .highlight { background:#fff9c4; }
    .btn { display:inline-block; padding:6px 10px; border-radius:6px; background:#1976d2; color:white; text-decoration:none; }
    @media (max-width:900px){
      #panel{width:46vw;}
    }
  </style>
</head>
<body>
<div id="container">
  <div id="mynetwork"></div>
  <div id="panel">
    <div class="gua-title" id="guaName">點選節點查看卦象</div>
    <div class="gua-bits" id="guaBits"></div>
    <div id="guaText"><em>卦辭 / 爻辭 會在此顯示（目前為簡化說明）。</em></div>
    <div class="change-list" id="changeList"></div>
    <div style="margin-top:12px;">
      <a class="btn" id="btnCenter">重置視角</a>
      <a class="btn" id="btnLoadFull" style="background:#388e3c; margin-left:8px;">載入完整《易經》原文（需從網路取得）</a>
      <div style="margin-top:8px; color:#777; font-size:13px;">說明：點選變卦可以跳至該卦並高亮。陽爻=1，陰爻=0，自上而下。</div>
    </div>
  </div>
</div>

<script>
// 節點資料（文王卦序對應）
const guaNames = [
"乾","夬","大有","大壯","小畜","需","大畜","泰",
"履","兌","睽","歸妹","中孚","節","損","臨",
"同人","革","離","豐","家人","既濟","賁","明夷",
"無妄","隨","噬嗑","震","益","屯","頤","復",
"姤","大過","鼎","恆","巽","井","蠱","升",
"訟","困","未濟","解","渙","坎","蒙","師",
"遯","咸","旅","小過","漸","蹇","艮","謙",
"否","萃","晉","豫","觀","比","剝","坤"
];

const kingwenBits = [
"111111","111110","111101","111100","111011","111010","111001","111000",
"110111","110110","110101","110100","110011","110010","110001","110000",
"101111","101110","101101","101100","101011","101010","101001","101000",
"100111","100110","100101","100100","100011","100010","100001","100000",
"011111","011110","011101","011100","011011","011010","011001","011000",
"010111","010110","010101","010100","010011","010010","010001","010000",
"001111","001110","001101","001100","001011","001010","001001","001000",
"000111","000110","000101","000100","000011","000010","000001","000000"
];

// 建立 nodes 與 edges（超立方體：相差一位相連）
const nodes = [];
const edges = [];
const bitToIndex = {};
for(let i=0;i<kingwenBits.length;i++){
  const bits = kingwenBits[i];
  const name = guaNames[i];
  const sunCount = bits.split('').reduce((a,b)=>a+Number(b),0);
  const colorScale = Math.round(255 - sunCount * 20);
  const color = `rgb(${colorScale},${180},${200})`;
  nodes.push({id:i, label:name, title:`<b>${name}</b><br>${bits}<br><small>點擊查看詳細</small>`, bits:bits, gua:name, value: Math.max(1,sunCount), color:color});
  bitToIndex[bits]=i;
}
// edges
for(let i=0;i<kingwenBits.length;i++){
  const bits = kingwenBits[i];
  for(let j=0;j<6;j++){
    const nb = bits.split('');
    nb[j] = nb[j]==='1'?'0':'1';
    const nbstr = nb.join('');
    const k = bitToIndex[nbstr];
    if(k!==undefined){
      // add edge once (i<k)
      if(i<k) edges.push({from:i,to:k});
    }
  }
}

// create network
const container = document.getElementById('mynetwork');
const data = { nodes: nodes, edges: edges };
const options = {
  nodes: {
    shape: 'dot',
    size: 18,
    font: {size:12}
  },
  edges: {
    width: 1,
    color: {color:'#888'}
  },
  physics: {
    stabilization: false,
    barnesHut: {gravitationalConstant:-4000, springLength:120}
  }
};
const network = new vis.Network(container, data, options);

// helper: show gua in panel
function showGua(idx, highlightLine=null){
  const node = nodes[idx];
  document.getElementById('guaName').innerText = `${node.gua} （#${idx+1}）`;
  document.getElementById('guaBits').innerText = `六爻二進位：${node.bits} （上→下，1=陽，0=陰）`;
  // 簡化說明與 placeholder 爻辭
  const simple = `<h4>簡化說明（示意）</h4><div>這裡目前為簡短說明：<br>「${node.gua}」代表的象徵意義與機鋒簡述。若需完整《易經》原文，請按「載入完整《易經》原文」。</div>`;
  // 列出六個可能變卦（標示動爻）
  let changeHtml = '<h4>六個可能的變卦（點擊跳轉並高亮）</h4>';
  for(let j=0;j<6;j++){
    const bitsArr = node.bits.split('');
    const orig = bitsArr.slice();
    bitsArr[j] = bitsArr[j]==='1'?'0':'1';
    const newBits = bitsArr.join('');
    const newIdx = bitToIndex[newBits];
    const moving = 6-j; // 爻位：上爻為第1爻（顯示上→下）
    changeHtml += `<div class="change-item" onclick="jumpTo(${newIdx}, ${j})"><b>動爻 ${moving}（翻轉） → ${guaNames[newIdx]} （#${newIdx+1}）</b><br><small>${newBits}</small></div>`;
  }
  document.getElementById('guaText').innerHTML = simple;
  document.getElementById('changeList').innerHTML = changeHtml;
  // highlight node temporarily
  network.selectNodes([idx]);
  network.focus(idx,{scale:1.2, animation:true});
  clearHighlights();
  network.body.data.nodes.update({id: idx, color: {background:'#ffeb3b'}});
}

// jumpTo: 點擊變卦跳轉並高亮（也會在 panel 顯示該卦）
function jumpTo(idx, movedIndex){
  showGua(idx);
  // 在 panel 中標示是哪一爻變動的來源資訊
  const list = document.getElementById('changeList');
  const items = list.getElementsByClassName('change-item');
  for(let i=0;i<items.length;i++) items[i].classList.remove('highlight');
  if(items && items[movedIndex]) {
    items[movedIndex].classList.add('highlight');
  }
}

// 清除所有節點顏色高亮（回復預設）
function clearHighlights(){
  const updates = [];
  for(const n of nodes){
    updates.push({id:n.id, color: {background: n.color}});
  }
  network.body.data.nodes.update(updates);
}

// network 點擊事件
network.on("click", function(params){
  if(params.nodes.length>0){
    const idx = params.nodes[0];
    showGua(idx);
  } else {
    // 點空白處
  }
});

document.getElementById('btnCenter').onclick = function(){ network.fit({animation:true}); };
document.getElementById('btnLoadFull').onclick = function(){
  if(confirm("要我從網路抓取並載入完整《易經》原文（卦辭與爻辭）嗎？我將自公有領域來源擷取並填入。確定嗎？")){
    // 這個按鈕會呼叫外部動作（在本地檔案中沒辦法直接取得網路），
    // 我會在下一步協助你把完整原文抓下並更新到這個檔案。
    alert("好的，我會在下一個回合從網路抓取並替你填入完整原文，然後回傳更新後的互動檔案。");
  }
};

// init：預設選中第一個卦
showGua(0);

</script>
</body>
</html>
