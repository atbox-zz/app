<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç¤ºæ³¢å™¨ - éŸ³è¨Šåˆ†æå·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #00ff88;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦å´èŠå¤©å€åŸŸ */
        .chat-panel {
            width: 35%;
            background: rgba(0, 0, 0, 0.8);
            border-right: 2px solid #00ff88;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        .chat-header {
            padding: 20px;
            background: linear-gradient(90deg, #00ff88, #00cc70);
            color: #000;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 255, 136, 0.3);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
        }

        .user-message {
            background: linear-gradient(135deg, #00ff88, #00cc70);
            color: #000;
            align-self: flex-end;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.1);
            color: #00ff88;
            align-self: flex-start;
            border: 1px solid rgba(0, 255, 136, 0.3);
            backdrop-filter: blur(5px);
        }

        .chat-input {
            padding: 20px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid #00ff88;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00ff88;
            border-radius: 8px;
            color: #00ff88;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            border-color: #00cc70;
        }

        .input-group button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #00ff88, #00cc70);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .input-group button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        /* å³å´è¦–è¦ºåŒ–å€åŸŸ */
        .visualization-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: radial-gradient(circle at center, rgba(0, 255, 136, 0.05) 0%, transparent 70%);
        }

        .viz-header {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #00ff88;
        }

        .viz-title {
            font-size: 20px;
            font-weight: bold;
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-button {
            padding: 8px 16px;
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            border-radius: 6px;
            color: #00ff88;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .control-button:hover {
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        .control-button.active {
            background: #00ff88;
            color: #000;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* p5.js canvas styling */
        #p5-canvas {
            display: block !important;
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .recording {
            animation: pulse 1s infinite;
        }

        /* è‡ªè¨‚æ»¾å‹•æ¢ */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #00cc70;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .chat-panel {
                width: 100%;
                height: 50%;
            }
            
            .visualization-panel {
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦å´èŠå¤©å€åŸŸ -->
        <div class="chat-panel">
            <div class="chat-header">
                ğŸ¤– AI ç¤ºæ³¢å™¨åŠ©æ‰‹
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI ç¤ºæ³¢å™¨åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¹«ä½ ï¼š
                    <br>â€¢ åˆ†æéŸ³è¨Šæ³¢å½¢ç‰¹æ€§
                    <br>â€¢ èª¿æ•´é¡¯ç¤ºåƒæ•¸
                    <br>â€¢ è§£é‡‹é »è­œåˆ†æçµæœ
                    <br>â€¢ æä¾›éŸ³è¨Šè™•ç†å»ºè­°
                    <br><br>è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™é–‹å§‹åˆ†æï¼Œæˆ–å•æˆ‘ä»»ä½•å•é¡Œï¼
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" id="messageInput" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ...">
                    <button onclick="sendMessage()">ç™¼é€</button>
                </div>
            </div>
        </div>

        <!-- å³å´è¦–è¦ºåŒ–å€åŸŸ -->
        <div class="visualization-panel">
            <div class="viz-header">
                <div class="viz-title">ğŸŒŠ å³æ™‚éŸ³è¨Šåˆ†æ</div>
                <div class="controls">
                    <button class="control-button active" id="timeDomainBtn" onclick="setMode('time')">æ™‚åŸŸ</button>
                    <button class="control-button" id="frequencyBtn" onclick="setMode('frequency')">é »åŸŸ</button>
                    <button class="control-button" id="xyBtn" onclick="setMode('xy')">XYæ¨¡å¼</button>
                    <button class="control-button" id="spectrumBtn" onclick="setMode('spectrum')">3Dé »è­œ</button>
                    <button class="control-button" id="recordBtn" onclick="toggleRecording()">ğŸ¤ é–‹å§‹</button>
                </div>
            </div>
            
            <div class="canvas-container" id="canvasContainer">
                <!-- p5.js canvas å°‡åœ¨é€™è£¡å‰µå»º -->
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let mic;
        let fft;
        let isRecording = false;
        let currentMode = 'time';
        let isDemoMode = false;
        let demoTime = 0;
        let waveHistory = [];
        let spectrumHistory = [];
        let particles = [];

        // p5.js é¡è‰²ä¸»é¡Œ
        let primaryColor, secondaryColor, bgColor, gridColor;
        
        // AI å›æ‡‰åº«
        const aiResponses = {
            greeting: ['ä½ å¥½ï¼æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«åŠ©ä½ åˆ†æçš„å—ï¼Ÿ', 'å—¨ï¼æº–å‚™é–‹å§‹éŸ³è¨Šåˆ†æäº†å—ï¼Ÿ'],
            frequency: [
                'é »åŸŸåˆ†æå¯ä»¥é¡¯ç¤ºéŸ³è¨Šä¸­å„å€‹é »ç‡æˆåˆ†çš„å¼·åº¦ã€‚ä½é »åœ¨å·¦å´ï¼Œé«˜é »åœ¨å³å´ã€‚',
                'é€é FFT è½‰æ›ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°éŸ³è¨Šçš„é »è­œåˆ†å¸ƒã€‚å³°å€¼è¡¨ç¤ºä¸»è¦çš„é »ç‡æˆåˆ†ã€‚',
                'é »è­œåˆ†ææœ‰åŠ©æ–¼è­˜åˆ¥éŸ³èª¿ã€è«§æ³¢å’Œå™ªéŸ³ç‰¹å¾µã€‚'
            ],
            time: [
                'æ™‚åŸŸé¡¯ç¤ºéŸ³è¨Šä¿¡è™Ÿéš¨æ™‚é–“çš„è®ŠåŒ–ã€‚æŒ¯å¹…åæ˜ éŸ³é‡å¤§å°ã€‚',
                'æ³¢å½¢çš„å½¢ç‹€å‘Šè¨´æˆ‘å€‘éŸ³è¨Šçš„ç‰¹æ€§ï¼šæ­£å¼¦æ³¢è¡¨ç¤ºç´”éŸ³èª¿ï¼Œè¤‡é›œæ³¢å½¢è¡¨ç¤ºè±å¯Œçš„è«§æ³¢å…§å®¹ã€‚',
                'è§€å¯Ÿæ³¢å½¢å¯ä»¥å¹«åŠ©è­˜åˆ¥éŸ³è¨Šçš„å‹•æ…‹ç¯„åœå’Œå¤±çœŸæƒ…æ³ã€‚'
            ],
            xy: [
                'XY æ¨¡å¼å‰µé€ ç¾éº—çš„æè–©èŒ¹åœ–å½¢ï¼Œé¡¯ç¤ºå·¦å³è²é“çš„ç›¸ä½é—œä¿‚ã€‚',
                'åœ“å½¢åœ–æ¡ˆè¡¨ç¤ºå–®è²é“ä¿¡è™Ÿï¼Œè¤‡é›œåœ–å½¢è¡¨ç¤ºç«‹é«”è²æ•ˆæœã€‚',
                'XY æ¨¡å¼å¸¸ç”¨æ–¼åˆ†æç«‹é«”è²çš„å¯¬åº¦å’Œç›¸ä½ä¸€è‡´æ€§ã€‚'
            ],
            spectrum: [
                '3D é »è­œæ¨¡å¼å±•ç¤ºé »ç‡éš¨æ™‚é–“çš„è®ŠåŒ–ï¼Œå‰µé€ å£¯è§€çš„ç€‘å¸ƒåœ–æ•ˆæœã€‚',
                'ç¸±è»¸æ˜¯é »ç‡ï¼Œæ©«è»¸æ˜¯æ™‚é–“ï¼Œé¡è‰²æ·±åº¦è¡¨ç¤ºèƒ½é‡å¼·åº¦ã€‚',
                'é€™å€‹è¦–åœ–æœ€é©åˆè§€å¯ŸéŸ³æ¨‚çš„å‹•æ…‹è®ŠåŒ–å’Œé »ç‡æ¼”é€²ã€‚'
            ],
            analysis: [
                'æˆ‘æ³¨æ„åˆ°ä½ çš„éŸ³è¨Šæœ‰æœ‰è¶£çš„ç‰¹å¾µï¼éœ€è¦æˆ‘è©³ç´°åˆ†æå—ï¼Ÿ',
                'é€™å€‹æ³¢å½¢é¡¯ç¤ºäº†è±å¯Œçš„é »ç‡å…§å®¹ã€‚ä½ æƒ³äº†è§£ç‰¹å®šçš„é »æ®µå—ï¼Ÿ',
                'éŸ³è¨Šä¿¡è™Ÿçœ‹èµ·ä¾†å¾ˆç©©å®šã€‚æœ‰ç‰¹å®šçš„åˆ†æéœ€æ±‚å—ï¼Ÿ'
            ]
        };

        // p5.js ä¸»è¦å‡½æ•¸
        function setup() {
            // å‰µå»º canvas ä¸¦æ”¾ç½®åˆ°æŒ‡å®šå®¹å™¨ä¸­
            let canvasContainer = document.getElementById('canvasContainer');
            let canvas = createCanvas(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
            canvas.parent('canvasContainer');
            canvas.id('p5-canvas');
            
            // åˆå§‹åŒ–é¡è‰²
            primaryColor = color(0, 255, 136);
            secondaryColor = color(0, 204, 112);
            bgColor = color(0, 0, 0, 20);
            gridColor = color(0, 255, 136, 50);
            
            // åˆå§‹åŒ–éŸ³è¨Š
            fft = new p5.FFT(0.8, 1024);
            
            // åˆå§‹åŒ–ç²’å­ç³»çµ±
            for (let i = 0; i < 50; i++) {
                particles.push(new Particle());
            }
            
            // è¨­ç½®ç•«å¸ƒéŸ¿æ‡‰å¼
            windowResized();
        }

        function draw() {
            // èƒŒæ™¯
            fill(bgColor);
            rect(0, 0, width, height);
            
            if (isRecording) {
                if (isDemoMode) {
                    generateDemoData();
                }
                
                switch(currentMode) {
                    case 'time':
                        drawTimeDomain();
                        break;
                    case 'frequency':
                        drawFrequencyDomain();
                        break;
                    case 'xy':
                        drawXYMode();
                        break;
                    case 'spectrum':
                        draw3DSpectrum();
                        break;
                }
            } else {
                drawIdleAnimation();
            }
            
            // ç¹ªè£½ç¶²æ ¼
            if (currentMode !== 'spectrum' && currentMode !== 'xy') {
                drawGrid();
            }
        }

        function drawTimeDomain() {
            let waveform = fft.waveform();
            
            stroke(primaryColor);
            strokeWeight(2);
            noFill();
            
            beginShape();
            for (let i = 0; i < waveform.length; i++) {
                let x = map(i, 0, waveform.length, 0, width);
                let y = map(waveform[i], -1, 1, height, 0);
                vertex(x, y);
            }
            endShape();
            
            // æ·»åŠ ç™¼å…‰æ•ˆæœ
            drawGlow(waveform);
        }

        function drawFrequencyDomain() {
            let spectrum = fft.analyze();
            
            // å‰µå»ºæ¼¸è®Šæ•ˆæœ
            for (let i = 0; i < spectrum.length / 2; i++) {
                let x = map(i, 0, spectrum.length / 2, 0, width);
                let h = map(spectrum[i], 0, 255, 0, height);
                
                // å½©è™¹æ¼¸è®Š
                let hue = map(i, 0, spectrum.length / 2, 120, 300);
                colorMode(HSB);
                fill(hue, 80, 90, 0.8);
                
                rect(x, height - h, width / (spectrum.length / 2), h);
                
                // æ·»åŠ é ‚éƒ¨äº®é»
                fill(0, 0, 100);
                ellipse(x + width / (spectrum.length / 2) / 2, height - h, 3, 3);
            }
            colorMode(RGB);
            
            // é »ç‡æ¨™ç±¤
            drawFrequencyLabels();
        }

        function drawXYMode() {
            let waveform = fft.waveform();
            
            // æ¸…é™¤è»Œè·¡ï¼ˆéƒ¨åˆ†ï¼‰
            fill(0, 0, 0, 10);
            rect(0, 0, width, height);
            
            stroke(primaryColor);
            strokeWeight(1);
            noFill();
            
            beginShape();
            for (let i = 0; i < waveform.length - 1; i += 2) {
                let x = map(waveform[i], -1, 1, 0, width);
                let y = map(waveform[i + 1], -1, 1, height, 0);
                
                // æ·»åŠ é¡è‰²è®ŠåŒ–
                let alpha = map(i, 0, waveform.length, 255, 50);
                stroke(red(primaryColor), green(primaryColor), blue(primaryColor), alpha);
                
                vertex(x, y);
            }
            endShape();
            
            // ä¸­å¿ƒåå­—ç·š
            stroke(gridColor);
            strokeWeight(1);
            line(width/2, 0, width/2, height);
            line(0, height/2, width, height/2);
        }

        function draw3DSpectrum() {
            let spectrum = fft.analyze();
            
            // ä¿å­˜é »è­œæ­·å²
            if (frameCount % 2 === 0) { // æ¯å…©å¹€ä¿å­˜ä¸€æ¬¡
                spectrumHistory.push([...spectrum]);
                if (spectrumHistory.length > 100) {
                    spectrumHistory.shift();
                }
            }
            
            // ç¹ªè£½3Dç€‘å¸ƒåœ–
            for (let t = 0; t < spectrumHistory.length; t++) {
                let currentSpectrum = spectrumHistory[t];
                let z = map(t, 0, spectrumHistory.length - 1, 0.1, 1.0);
                
                for (let i = 0; i < currentSpectrum.length / 4; i++) {
                    let x = map(i, 0, currentSpectrum.length / 4, 0, width);
                    let y = height - map(t, 0, spectrumHistory.length - 1, 0, height * 0.8);
                    let h = map(currentSpectrum[i], 0, 255, 0, height * 0.3) * z;
                    
                    // 3D æ•ˆæœé¡è‰²
                    let hue = map(currentSpectrum[i], 0, 255, 240, 0);
                    colorMode(HSB);
                    fill(hue, 80, 90, z * 0.7);
                    noStroke();
                    
                    rect(x, y - h, width / (currentSpectrum.length / 4), h);
                }
            }
            colorMode(RGB);
        }

        function drawIdleAnimation() {
            // ç²’å­å‹•ç•«
            for (let particle of particles) {
                particle.update();
                particle.display();
            }
            
            // æ³¢å‹•æ•ˆæœ
            stroke(primaryColor);
            strokeWeight(2);
            noFill();
            
            beginShape();
            for (let x = 0; x < width; x += 5) {
                let y = height/2 + sin((x + frameCount * 2) * 0.01) * 50 * sin(frameCount * 0.005);
                vertex(x, y);
            }
            endShape();
        }

        function drawGlow(waveform) {
            // ç™¼å…‰æ•ˆæœ
            for (let i = 0; i < waveform.length - 1; i++) {
                let x1 = map(i, 0, waveform.length, 0, width);
                let y1 = map(waveform[i], -1, 1, height, 0);
                let x2 = map(i + 1, 0, waveform.length, 0, width);
                let y2 = map(waveform[i + 1], -1, 1, height, 0);
                
                // å¤šå±¤ç™¼å…‰
                for (let j = 0; j < 5; j++) {
                    stroke(red(primaryColor), green(primaryColor), blue(primaryColor), 20 - j * 3);
                    strokeWeight(8 - j);
                    line(x1, y1, x2, y2);
                }
            }
        }

        function drawGrid() {
            stroke(gridColor);
            strokeWeight(1);
            
            // æ°´å¹³ç·š
            for (let y = 0; y < height; y += height / 8) {
                line(0, y, width, y);
            }
            
            // å‚ç›´ç·š
            for (let x = 0; x < width; x += width / 10) {
                line(x, 0, x, height);
            }
        }

        function drawFrequencyLabels() {
            fill(primaryColor);
            textSize(12);
            textAlign(CENTER);
            
            let labels = ['20Hz', '200Hz', '2kHz', '20kHz'];
            for (let i = 0; i < labels.length; i++) {
                let x = map(i, 0, labels.length - 1, 50, width - 50);
                text(labels[i], x, height - 10);
            }
        }

        function windowResized() {
            let canvasContainer = document.getElementById('canvasContainer');
            if (canvasContainer) {
                resizeCanvas(canvasContainer.offsetWidth, canvasContainer.offsetHeight);
            }
        }

        // ç²’å­é¡
        class Particle {
            constructor() {
                this.x = random(width);
                this.y = random(height);
                this.vx = random(-1, 1);
                this.vy = random(-1, 1);
                this.alpha = random(50, 150);
                this.size = random(1, 3);
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                
                if (this.x < 0 || this.x > width) this.vx *= -1;
                if (this.y < 0 || this.y > height) this.vy *= -1;
                
                this.alpha = 100 + sin(frameCount * 0.05 + this.x * 0.01) * 50;
            }
            
            display() {
                fill(red(primaryColor), green(primaryColor), blue(primaryColor), this.alpha);
                noStroke();
                ellipse(this.x, this.y, this.size);
            }
        }

        // éŸ³è¨Šå’Œæ§åˆ¶å‡½æ•¸
        async function toggleRecording() {
            const btn = document.getElementById('recordBtn');
            
            if (!isRecording) {
                try {
                    // è«‹æ±‚éº¥å…‹é¢¨æ¬Šé™
                    mic = new p5.AudioIn();
                    mic.start();
                    fft.setInput(mic);
                    
                    isRecording = true;
                    isDemoMode = false;
                    btn.textContent = 'â¸ï¸ åœæ­¢';
                    btn.classList.add('recording');
                    
                    addMessage('ai', 'âœ… éº¥å…‹é¢¨é€£æ¥æˆåŠŸï¼ç¾åœ¨å¯ä»¥çœ‹åˆ°ä½ çš„è²éŸ³æ³¢å½¢äº†ã€‚è©¦è‘—èªªè©±æˆ–æ’­æ”¾éŸ³æ¨‚å§ï¼');
                    
                } catch (err) {
                    console.error('éŸ³è¨Šæ¬Šé™éŒ¯èª¤:', err);
                    addMessage('ai', 'âŒ éº¥å…‹é¢¨æ¬Šé™è¢«æ‹’çµ•ã€‚é»æ“Šåœ°å€æ¬„çš„ğŸ”’åœ–æ¨™å…è¨±éº¥å…‹é¢¨æ¬Šé™ï¼Œç„¶å¾Œé‡æ–°æ•´ç†é é¢ã€‚');
                    showDemoOption();
                }
            } else {
                if (mic) {
                    mic.stop();
                }
                isRecording = false;
                isDemoMode = false;
                btn.textContent = 'ğŸ¤ é–‹å§‹';
                btn.classList.remove('recording');
                addMessage('ai', 'â¹ï¸ éŒ„è£½å·²åœæ­¢ã€‚');
            }
        }

        function startDemoMode() {
            isRecording = true;
            isDemoMode = true;
            demoTime = 0;
            
            const btn = document.getElementById('recordBtn');
            btn.textContent = 'â¸ï¸ åœæ­¢ç¤ºç¯„';
            btn.classList.add('recording');
            
            addMessage('ai', 'ğŸµ ç¤ºç¯„æ¨¡å¼å•Ÿå‹•ï¼æ­£åœ¨ç”Ÿæˆæ¨¡æ“¬éŸ³è¨Šä¿¡è™Ÿ...');
        }

        function generateDemoData() {
            demoTime += 0.02;
            
            // å‰µå»ºæ¨¡æ“¬ FFT æ•¸æ“š
            if (!window.demoWaveform) {
                window.demoWaveform = new Array(1024);
                window.demoSpectrum = new Array(1024);
            }
            
            for (let i = 0; i < 1024; i++) {
                if (currentMode === 'time' || currentMode === 'xy') {
                    // æ™‚åŸŸä¿¡è™Ÿ
                    window.demoWaveform[i] = 
                        0.5 * sin(2 * PI * 0.1 * i + demoTime * 10) +     // åŸºæ³¢
                        0.3 * sin(2 * PI * 0.2 * i + demoTime * 15) +     // 2æ¬¡è«§æ³¢
                        0.2 * sin(2 * PI * 0.3 * i + demoTime * 20) +     // 3æ¬¡è«§æ³¢
                        0.1 * random(-1, 1);                               // å™ªéŸ³
                } else {
                    // é »åŸŸä¿¡è™Ÿ
                    let freq = i / 1024.0;
                    if (freq < 0.1) window.demoSpectrum[i] = 200 + 50 * sin(demoTime * 5);
                    else if (freq < 0.3) window.demoSpectrum[i] = 150 + 30 * sin(demoTime * 7);
                    else if (freq < 0.6) window.demoSpectrum[i] = 80 + 20 * sin(demoTime * 10);
                    else window.demoSpectrum[i] = 20 + 10 * random();
                }
            }
            
            // è¦†è“‹ p5.FFT æ–¹æ³•
            fft.waveform = () => window.demoWaveform;
            fft.analyze = () => window.demoSpectrum;
        }

        function showDemoOption() {
            const demoBtn = document.createElement('button');
            demoBtn.className = 'control-button';
            demoBtn.innerHTML = 'ğŸµ ç¤ºç¯„æ¨¡å¼';
            demoBtn.onclick = startDemoMode;
            
            const controls = document.querySelector('.controls');
            controls.appendChild(demoBtn);
        }

        function setMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.control-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            let activeBtn = document.getElementById(
                mode === 'time' ? 'timeDomainBtn' :
                mode === 'frequency' ? 'frequencyBtn' :
                mode === 'xy' ? 'xyBtn' : 'spectrumBtn'
            );
            if (activeBtn) activeBtn.classList.add('active');
            
            // æ¸…ç©ºæ­·å²æ•¸æ“š
            spectrumHistory = [];
            
            // AI å›æ‡‰
            if (aiResponses[mode]) {
                const response = aiResponses[mode][Math.floor(Math.random() * aiResponses[mode].length)];
                setTimeout(() => addMessage('ai', response), 500);
            }
        }

        // èŠå¤©åŠŸèƒ½
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage('user', message);
                input.value = '';
                
                setTimeout(() => {
                    const response = generateAIResponse(message);
                    addMessage('ai', response);
                }, 1000);
            }
        }

        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.innerHTML = content;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function generateAIResponse(message) {
            const msg = message.toLowerCase();
            
            if (msg.includes('é »ç‡') || msg.includes('é »åŸŸ') || msg.includes('fft')) {
                return aiResponses.frequency[Math.floor(Math.random() * aiResponses.frequency.length)];
            } else if (msg.includes('æ™‚åŸŸ') || msg.includes('æ³¢å½¢') || msg.includes('æ™‚é–“')) {
                return aiResponses.time[Math.floor(Math.random() * aiResponses.time.length)];
            } else if (msg.includes('xy') || msg.includes('ç«‹é«”') || msg.includes('ç›¸ä½')) {
                return aiResponses.xy[Math.floor(Math.random() * aiResponses.xy.length)];
            } else if (msg.includes('3d') || msg.includes('é »è­œ') || msg.includes('ç€‘å¸ƒ')) {
                return aiResponses.spectrum[Math.floor(Math.random() * aiResponses.spectrum.length)];
            } else if (msg.includes('åˆ†æ') || msg.includes('æ€éº¼')) {
                return aiResponses.analysis[Math.floor(Math.random() * aiResponses.analysis.length)];
            } else if (msg.includes('ä½ å¥½') || msg.includes('å—¨')) {
                return aiResponses.greeting[Math.floor(Math.random() * aiResponses.greeting.length)];
            } else {
                return 'é€™æ˜¯å€‹å¾ˆå¥½çš„å•é¡Œï¼' + (isRecording ? 
                    'æˆ‘å¯ä»¥çœ‹åˆ°ä½ çš„éŸ³è¨Šæ•¸æ“šï¼Œ' + (currentMode === 'time' ? 'æ™‚åŸŸæ³¢å½¢' : 
                    currentMode === 'frequency' ? 'é »è­œåˆ†æ' : 
                    currentMode === 'xy' ? 'XYæ¨¡å¼åœ–å½¢' : '3Dé »è­œç€‘å¸ƒåœ–') + 'é¡¯ç¤ºäº†æœ‰è¶£çš„ç‰¹å¾µã€‚' :
                    'è«‹å…ˆé–‹å§‹éŒ„è£½ä»¥ä¾¿æˆ‘åˆ†æä½ çš„éŸ³è¨Šã€‚');
            }
        }

        // éµç›¤äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });

        // ç”¨æˆ¶äº’å‹•éœ€è¦å…ˆå•Ÿå‹•éŸ³è¨Šä¸Šä¸‹æ–‡
        function userStartAudio() {
            if (getAudioContext().state !== 'running') {
                userStartAudio();
            }
        }

        // é»æ“Šå•Ÿå‹•éŸ³è¨Š
        document.addEventListener('click', userStartAudio, { once: true });
        document.addEventListener('touchstart', userStartAudio, { once: true });