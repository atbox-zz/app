<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å°ç£åœ°æ–¹å¤§é¸ï¼šè’™ç‰¹å¡æ´›4.0æ¨¡æ“¬èˆ‡æ™‚é–“è»¸åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #000095; --green: #1b9431; --white: #28c8c8; --dark: #2c3e50; --accent: #e67e22; --bg: #f4f7f9; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; color: #333; }
        header { background: var(--dark); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .dashboard { display: grid; grid-template-columns: 320px 1fr; gap: 20px; max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        
        /* å´é‚Šæ§åˆ¶æ¬„ */
        .sidebar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: fit-content; }
        .city-selector { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .btn-city { padding: 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: white; transition: 0.3s; }
        .btn-city.active { background: var(--dark); color: white; border-color: var(--dark); }
        .candidate-card { border-left: 5px solid #ccc; padding: 10px; background: #fafafa; margin-bottom: 10px; border-radius: 4px; font-size: 0.9rem; }
        
        /* äº‹ä»¶é¡¯ç¤ºå€ */
        .event-panel { background: #fff3cd; border: 1px dashed #ffeeba; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; }
        .btn-simulate { background: var(--accent); color: white; font-size: 1.1rem; }
        .btn-event { background: var(--dark); color: white; }
        .btn-simulate:hover { opacity: 0.9; transform: translateY(-2px); }

        /* ä¸»å ±è¡¨å€ */
        .main-content { display: flex; flex-direction: column; gap: 20px; }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .full-width { grid-column: span 2; }
        
        canvas { width: 100% !important; height: auto !important; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; }
        .win-prob { font-weight: bold; color: #e74c3c; font-size: 1.1rem; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ—³ï¸ 2026 å°ç£åœ°æ–¹é¸èˆ‰æ¨¡æ“¬æŒ‡æ®ä¸­å¿ƒ</h1>
    <p>æ•¸æ“šé©…å‹•ï¼šéš¨æ©Ÿäº‹ä»¶ã€æ£„ä¿æ¼”ç®—ã€èˆ‡æ™‚é–“è»¸æ”¯æŒåº¦æ¼”åŒ–</p>
</header>

<div class="dashboard">
    <div class="sidebar">
        <h3>ğŸ“ åˆ‡æ›è§€æ¸¬ç¸£å¸‚</h3>
        <div class="city-selector">
            <button class="btn-city active" onclick="changeCity('new-taipei', this)">æ–°åŒ—å¸‚ (ä¸‰è…³ç£æˆ°å€)</button>
            <button class="btn-city" onclick="changeCity('tainan', this)">å°å—å¸‚ (åˆé¸éœ‡ç›ªå€)</button>
            <button class="btn-city" onclick="changeCity('kaohsiung', this)">é«˜é›„å¸‚ (äº”äº”æ³¢è† è‘—)</button>
        </div>

        <div class="event-panel" id="eventBox">
            <strong>ç›®å‰æƒ…å‹¢ï¼š</strong><br>
            <span id="eventText" style="font-size: 0.85rem;">é¸å‰ 320 å¤©ï¼Œå„æ–¹å‚™æˆ°ä¸­ã€‚</span>
        </div>

        <button class="btn-action btn-event" onclick="triggerRandomEvent()">ğŸ² è§¸ç™¼é¸æˆ°éš¨æ©Ÿäº‹ä»¶</button>
        
        <div id="candidateDisplay"></div>

        <button class="btn-action btn-simulate" onclick="runAllSimulations()">ğŸš€ åŸ·è¡Œå…¨æ–¹ä½æ¨¡æ“¬</button>
    </div>

    <div class="main-content">
        <div class="card full-width">
            <h3>ğŸ“ˆ é¸å‰ 320 å¤©æ”¯æŒåº¦æ¼”åŒ–è¶¨å‹¢ (Time-series Evolution)</h3>
            <canvas id="timeLineChart" height="100"></canvas>
        </div>

        <div class="chart-row">
            <div class="card">
                <h3>ğŸ“Š å€™é¸äººæˆ°åŠ›ç‰¹å¾µ (Radar)</h3>
                <canvas id="radarChart"></canvas>
            </div>
            <div class="card">
                <h3>ğŸ¯ 10,000 æ¬¡æ¨¡æ“¬å‹é¸æ©Ÿç‡</h3>
                <canvas id="winChart"></canvas>
            </div>
        </div>

        <div class="card full-width">
            <h3>ğŸ æ¨¡æ“¬çµ±è¨ˆé æ¸¬è¡¨</h3>
            <table id="statsTable">
                <thead>
                    <tr><th>å€™é¸äºº</th><th>å±¬æ€§</th><th>é æœŸå¹³å‡æ”¯æŒåº¦</th><th>æ¨¡æ“¬å‹å ´</th><th>æœ€çµ‚å‹é¸æ©Ÿç‡</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// 1. åˆå§‹åŒ–æ•¸æ“š (æ¨¡æ“¬ 2026/01/13 çœŸå¯¦æƒ…å¢ƒ)
const cityConfig = {
    'new-taipei': [
        { id: 0, name: "æå››å· (è—)", mean: 40, sd: 2.5, air: 70, org: 95, img: 85, color: "#000095" },
        { id: 1, name: "è˜‡å·§æ…§ (ç¶ )", mean: 35, sd: 2.5, air: 85, org: 88, img: 82, color: "#1b9431" },
        { id: 2, name: "é»ƒåœ‹æ˜Œ (ç™½)", mean: 13, sd: 4.5, air: 95, org: 35, img: 75, color: "#28c8c8" }
    ],
    'tainan': [
        { id: 0, name: "é™³äº­å¦ƒ (ç¶ )", mean: 52, sd: 3.5, air: 75, org: 92, img: 80, color: "#1b9431" },
        { id: 1, name: "è¬é¾ä»‹ (è—)", mean: 35, sd: 3.0, air: 90, org: 70, img: 85, color: "#000095" }
    ],
    'kaohsiung': [
        { id: 0, name: "ç¶ ç‡Ÿå€™é¸äºº", mean: 42, sd: 3.0, air: 80, org: 90, img: 85, color: "#1b9431" },
        { id: 1, name: "æŸ¯å¿—æ© (è—)", mean: 40, sd: 3.0, air: 85, org: 85, img: 90, color: "#000095" }
    ]
};

let currentCity = 'new-taipei';
let eventModifiers = {};
let charts = {};

// 2. éš¨æ©Ÿå‡½æ•¸ï¼šBox-Muller æ­£æ…‹åˆ†ä½ˆ
function randn_bm() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

// 3. åˆ‡æ›åŸå¸‚
function changeCity(city, btn) {
    currentCity = city;
    eventModifiers = {};
    document.querySelectorAll('.btn-city').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('eventText').innerText = "åˆ‡æ›è‡³ " + btn.innerText + "ï¼Œé‡ç½®æ¨¡æ“¬ç’°å¢ƒã€‚";
    runAllSimulations();
}

// 4. äº‹ä»¶ç³»çµ±
const events = [
    { name: "çˆ†ç™¼åœŸåœ°çˆ­è­°", impact: -4, target: "all", desc: "é ˜å…ˆè€…å—åˆ°è² é¢æ–°èæ‰“æ“Šï¼Œæ”¯æŒåº¦é‡æŒ«ã€‚" },
    { name: "æˆåŠŸå¤§é€ å‹¢", impact: 3, target: "random", desc: "éš¨æ©Ÿä¸€åå€™é¸äººèˆ‰è¾¦å¤§å‹é›†æœƒï¼Œå‡èšåŸºå±¤ã€‚" },
    { name: "æ£„ä¿æ•ˆæ‡‰ç™¼é…µ", impact: 5, target: "major", desc: "å°é»¨æ”¯æŒè€…å‘å…‰è­œæ¥è¿‘çš„å¤§æ”¿é»¨é æ”ã€‚" }
];

function triggerRandomEvent() {
    const e = events[Math.floor(Math.random() * events.length)];
    const cands = cityConfig[currentCity];
    const targetIdx = Math.floor(Math.random() * cands.length);
    
    eventModifiers[targetIdx] = (eventModifiers[targetIdx] || 0) + e.impact;
    document.getElementById('eventText').innerHTML = `<strong>${e.name}ï¼š</strong> ${e.desc}`;
    runAllSimulations();
}

// 5. æ ¸å¿ƒæ¨¡æ“¬é‚è¼¯
function runAllSimulations() {
    const cands = cityConfig[currentCity];
    renderCandidates(cands);
    updateRadar(cands);
    
    // åŸ·è¡Œè’™ç‰¹å¡æ´› (10,000æ¬¡)
    const stats = runMonteCarlo(cands);
    updateWinChart(stats);
    updateTable(stats);
    
    // åŸ·è¡Œæ™‚é–“è»¸æ¨¡æ“¬ (320å¤©)
    runTimeSeries(cands);
}

function runMonteCarlo(cands) {
    const iterations = 10000;
    let results = cands.map(c => ({ ...c, wins: 0, totalScore: 0 }));
    
    for (let i = 0; i < iterations; i++) {
        let scores = results.map((c, idx) => {
            let mod = eventModifiers[idx] || 0;
            // åŠ å…¥çµ„ç¹”åŠ›åŠ æ¬Šï¼šçµ„ç¹”åŠ›è¶Šé«˜ï¼Œçµæœè¶Šç©©å®š
            let stability = (100 - c.org) / 20;
            return { id: c.id, val: c.mean + mod + (randn_bm() * (c.sd + stability)) };
        });
        
        // æ£„ä¿æ¨¡æ“¬ (åƒ…é™æ–°åŒ—å¸‚)
        if (currentCity === 'new-taipei') {
            let tpp = scores.find(s => s.id === 2);
            if (tpp.val < 10) { // å¦‚æœæ°‘çœ¾é»¨æ”¯æŒåº¦ä½æ–¼10%
                let move = tpp.val * 0.4;
                tpp.val -= move;
                scores[0].val += move; // æµå‘åœ‹æ°‘é»¨
            }
        }

        let winner = scores.reduce((prev, curr) => (curr.val > prev.val) ? curr : prev);
        results.find(r => r.id === winner.id).wins++;
        results.forEach((r, idx) => r.totalScore += scores[idx].val);
    }
    return results;
}

function runTimeSeries(cands) {
    const days = 320; // å¾ä»Šå¤©åˆ°é¸æˆ°æ—¥
    const labels = Array.from({length: days}, (_, i) => i === 0 ? "ä»Šå¤©" : (i === days-1 ? "æŠ•ç¥¨æ—¥" : ""));
    const datasets = cands.map((c, idx) => {
        let data = [];
        let currentLevel = c.mean + (eventModifiers[idx] || 0);
        for (let d = 0; d < days; d++) {
            // å¸ƒæœ—é‹å‹•éš¨æ©Ÿæ¸¸èµ°
            let drift = 0;
            // æ¨¡æ“¬é¸æˆ°æœ€å¾Œè¡åˆºï¼šçµ„ç¹”åŠ›å¼·çš„åœ¨æœ€å¾Œ 30 å¤©æœƒæœ‰ä¸Šå‡è¶¨å‹¢
            if (d > days - 30) drift = (c.org / 1000);
            
            currentLevel += (randn_bm() * (c.sd / 5)) + drift;
            data.push(currentLevel.toFixed(2));
        }
        return { label: c.name, data: data, borderColor: c.color, fill: false, pointRadius: 0 };
    });

    if (charts.time) charts.time.destroy();
    charts.time = new Chart(document.getElementById('timeLineChart'), {
        type: 'line',
        data: { labels: labels, datasets: datasets },
        options: { 
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: { y: { beginAtZero: false } }
        }
    });
}

// UI è¼”åŠ©å‡½æ•¸
function renderCandidates(cands) {
    document.getElementById('candidateDisplay').innerHTML = cands.map((c, idx) => {
        let mod = eventModifiers[idx] || 0;
        return `<div class="candidate-card" style="border-left-color: ${c.color}">
            <strong>${c.name}</strong> <br>
            <small>åŸºæº– ${c.mean}% | ä¿®æ­£ ${mod > 0 ? '+' : ''}${mod}% | æ³¢å‹• Â±${c.sd}%</small>
        </div>`;
    }).join('');
}

function updateRadar(cands) {
    const ctx = document.getElementById('radarChart');
    if (charts.radar) charts.radar.destroy();
    charts.radar = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['ç©ºæˆ°èƒ½åŠ›', 'åœ°æ–¹çµ„ç¹”', 'å€‹äººå½¢è±¡'],
            datasets: cands.map(c => ({
                label: c.name,
                data: [c.air, c.org, c.img],
                backgroundColor: c.color + "33",
                borderColor: c.color
            }))
        }
    });
}

function updateWinChart(stats) {
    const ctx = document.getElementById('winChart');
    if (charts.win) charts.win.destroy();
    charts.win = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: stats.map(s => s.name),
            datasets: [{ data: stats.map(s => s.wins), backgroundColor: stats.map(s => s.color) }]
        }
    });
}

function updateTable(stats) {
    const tbody = document.querySelector('#statsTable tbody');
    tbody.innerHTML = stats.sort((a,b) => b.wins - a.wins).map(s => `
        <tr>
            <td>${s.name}</td>
            <td style="font-size:0.8rem">ç©ºæˆ°:${s.air} / çµ„ç¹”:${s.org}</td>
            <td>${(s.totalScore/10000).toFixed(2)}%</td>
            <td>${s.wins}</td>
            <td class="win-prob">${((s.wins/10000)*100).toFixed(1)}%</td>
        </tr>
    `).join('');
}

// å•Ÿå‹•é¦–å±æ¨¡æ“¬
window.onload = runAllSimulations;
</script>

</body>
</html>