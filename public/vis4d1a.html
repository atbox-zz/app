<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>六十四卦互動地圖（六維超立方體投影）</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
  <style>
    body { 
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif; 
      margin: 0; 
      background: #ffffff;
      color: #333333;
    }
    #container { display: flex; height: 100vh; flex-direction: column; }
    #mynetwork { 
      flex: 1; 
      border-bottom: 2px solid #cccccc;
      background: #f8f8f8;
      position: relative;
    }
    #panel { 
      width: 100%;
      padding: 10px;
      box-sizing: border-box; 
      overflow: auto; 
      background: rgba(255, 255, 255, 0.9);
      border-top: 1px solid #cccccc;
      transition: transform 0.3s ease;
    }
    .gua-title { 
      font-size: 24px;
      font-weight: 700; 
      margin-bottom: 8px; 
      color: #d81b60;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }
    .gua-bits { 
      color: #2e7d32;
      margin-bottom: 12px; 
      font-family: monospace;
      font-size: 14px;
      background: #e8f5e9;
      padding: 8px;
      border-radius: 6px;
    }
    .gua-symbol {
      font-size: 20px;
      margin: 10px 0;
      text-align: center;
      font-family: monospace;
      line-height: 1.2;
    }
    .change-list { margin-top: 16px; }
    .change-item { 
      padding: 8px;
      border: 1px solid #cccccc; 
      margin-bottom: 8px; 
      cursor: pointer; 
      border-radius: 8px; 
      background: rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    .change-item:hover, .change-item:focus {
      background: rgba(0, 0, 0, 0.1);
      border-color: #999999;
    }
    .change-item:focus {
      outline: 2px solid #d81b60;
    }
    .highlight { 
      background: rgba(255, 64, 129, 0.2) !important; 
      border-color: #d81b60 !important;
    }
    .btn { 
      display: inline-block; 
      padding: 8px 12px;
      border-radius: 8px; 
      background: linear-gradient(135deg, #0288d1, #0277bd);
      color: #ffffff; 
      text-decoration: none; 
      margin: 4px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    .btn:hover, .btn:focus {
      background: linear-gradient(135deg, #0277bd, #01579b);
      transform: translateY(-2px);
    }
    .btn:focus {
      outline: 2px solid #d81b60;
    }
    .btn-success {
      background: linear-gradient(135deg, #388e3c, #2e7d32);
    }
    .btn-success:hover, .btn-success:focus {
      background: linear-gradient(135deg, #2e7d32, #1b5e20);
    }
    .original-text {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #d81b60;
    }
    .yao-text {
      margin: 8px 0;
      padding: 8px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
      border-left: 3px solid #0288d1;
    }
    .panel-toggle {
      display: none;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: linear-gradient(135deg, #0288d1, #0277bd);
      padding: 10px;
      border-radius: 8px;
      color: #ffffff;
      cursor: pointer;
    }
    .panel-toggle:hover, .panel-toggle:focus {
      background: linear-gradient(135deg, #0277bd, #01579b);
    }
    .panel-toggle:focus {
      outline: 2px solid #d81b60;
    }
    @media (min-width: 601px) {
      #container { flex-direction: row; }
      #mynetwork { 
        border-right: 2px solid #cccccc;
        border-bottom: none;
      }
      #panel { 
        width: 450px;
        border-top: none;
        border-left: 1px solid #cccccc;
      }
      .gua-title { font-size: 28px; }
      .gua-bits { font-size: 16px; }
      .gua-symbol { font-size: 24px; }
      .change-item { padding: 10px; }
      .btn { padding: 10px 16px; }
      .original-text { padding: 15px; }
    }
    @media (max-width: 600px) {
      #container { flex-direction: column; }
      #mynetwork { order: 1; }
      #panel { 
        order: 2;
        transform: none;
        position: relative;
        height: auto;
      }
      .panel-toggle { display: none; }
      .gua-title { font-size: 20px; }
      .gua-bits { font-size: 12px; }
      .gua-symbol { font-size: 18px; }
      .change-item { padding: 6px; }
      .btn { padding: 6px 10px; }
      .original-text { padding: 8px; }
      .vis-label { font-size: 12px !important; }
    }
    .controls {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #cccccc;
    }
    .control-item {
      margin-bottom: 10px;
    }
    .control-item label {
      display: block;
      margin-bottom: 5px;
      color: #333333;
      font-size: 14px;
    }
    .control-item select, .control-item input {
      background: #f5f5f5;
      border: 1px solid #cccccc;
      color: #333333;
      padding: 6px;
      border-radius: 4px;
      width: 100%;
    }
    .control-item select:focus, .control-item input:focus {
      outline: 2px solid #d81b60;
    }
    .vis-label {
      visibility: visible !important;
      opacity: 1 !important;
      z-index: 1000;
      color: #333333 !important;
      font-family: 'Noto Sans TC', sans-serif !important;
      font-size: 14px !important;
    }
    @media (max-width: 600px) {
      .controls { 
        padding: 10px;
        left: 10px;
        top: 10px;
      }
      .control-item label { font-size: 12px; }
      .control-item select, .control-item input { padding: 4px; }
    }
  </style>
</head>
<body>
<div id="container">
  <div id="mynetwork">
    <div class="controls">
      <div class="control-item">
        <label for="layoutSelect">布局算法:</label>
        <select id="layoutSelect" aria-label="選擇網絡布局算法">
          <option value="barnesHut">Barnes-Hut (默認)</option>
          <option value="repulsion">斥力布局</option>
          <option value="hierarchical">階層布局</option>
          <option value="forceAtlas2">Force Atlas 2</option>
        </select>
      </div>
      <div class="control-item">
        <label for="nodeSizeSlider">節點大小:</label>
        <input type="range" id="nodeSizeSlider" min="10" max="40" value="18" aria-label="調整節點大小">
      </div>
      <div class="control-item">
        <label for="displayMode">顯示模式:</label>
        <select id="displayMode" aria-label="選擇顯示模式">
          <option value="all">所有卦象</option>
          <option value="bagua">八卦系統</option>
          <option value="palace">卦宮分類</option>
        </select>
      </div>
    </div>
    <button class="panel-toggle" id="panelToggle" aria-label="切換資訊面板">開啟面板</button>
  </div>
  <div id="panel">
    <div class="gua-title" id="guaName">點選節點查看卦象</div>
    <div class="gua-bits" id="guaBits"></div>
    <div class="gua-symbol" id="guaSymbol"></div>
    <div id="guaText"><em>卦辭 / 爻辭 會在此顯示。</em></div>
    <div class="change-list" id="changeList"></div>
    <div style="margin-top:16px;">
      <button class="btn" id="btnCenter" aria-label="重置網絡視角">重置視角</button>
      <button class="btn btn-success" id="btnRandomWalk" aria-label="隨機選擇卦象">隨機漫步</button>
      <div style="margin-top:12px; color:#666666; font-size:13px;">
        說明：點選變卦可以跳至該卦並高亮。陽爻=1，陰爻=0，自下而上。<br>
        此為六維超立方體投影，每個卦象對應一個六維頂點。
      </div>
    </div>
  </div>
</div>

<script>
// 定義關鍵數據（文王卦序對應）
const guaNames = [
  "乾","夬","大有","大壯","小畜","需","大畜","泰",
  "履","兌","睽","歸妹","中孚","節","損","臨",
  "同人","革","離","豐","家人","既濟","賁","明夷",
  "無妄","隨","噬嗑","震","益","屯","頤","復",
  "姤","大過","鼎","恆","巽","井","蠱","升",
  "訟","困","未濟","解","渙","坎","蒙","師",
  "遯","咸","旅","小過","漸","蹇","艮","謙",
  "否","萃","晉","豫","觀","比","剝","坤"
];

const kingwenBits = [
  "111111","111110","111101","111100","111011","111010","111001","111000",
  "110111","110110","110101","110100","110011","110010","110001","110000",
  "101111","101110","101101","101100","101011","101010","101001","101000",
  "100111","100110","100101","100100","100011","100010","100001","100000",
  "011111","011110","011101","011100","011011","011010","011001","011000",
  "010111","010110","010101","010100","010011","010010","010001","010000",
  "001111","001110","001101","001100","001011","001010","001001","001000",
  "000111","000110","000101","000100","000011","000010","000001","000000"
];

// 完整的六十四卦數據
const hexagramData = {
  "111111": {name: "乾", desc: "天行健，君子以自強不息", text: "元亨利貞。初九：潛龍勿用。九二：見龍在田，利見大人。九三：君子終日乾乾，夕惕若厲，無咎。九四：或躍在淵，無咎。九五：飛龍在天，利見大人。上九：亢龍有悔。用九：見群龍無首，吉。"},
  "000000": {name: "坤", desc: "地勢坤，君子以厚德載物", text: "元亨，利牝馬之貞。君子有攸往，先迷後得主，利。西南得朋，東北喪朋。安貞，吉。初六：履霜，堅冰至。六二：直方大，不習無不利。六三：含章可貞，或從王事，無成有終。六四：括囊，無咎無譽。六五：黃裳，元吉。上六：龍戰於野，其血玄黃。用六：利永貞。"},
  "100010": {name: "屯", desc: "雲雷屯，君子以經綸", text: "元亨利貞，勿用有攸往，利建侯。初九：磐桓，利居貞，利建侯。六二：屯如邅如，乘馬班如，匪寇婚媾，女子貞不字，十年乃字。六三：即鹿無虞，惟入于林中，君子幾不如舍，往吝。六四：乘馬班如，求婚媾，往吉，無不利。九五：屯其膏，小貞吉，大貞凶。上六：乘馬班如，泣血漣如。"},
  "010001": {name: "蒙", desc: "山下出泉，蒙，君子以果行育德", text: "亨。匪我求童蒙，童蒙求我。初筮告，再三瀆，瀆則不告。利貞。初六：發蒙，利用刑人，用說桎梏，以往吝。九二：包蒙，吉。納婦，吉。子克家。六三：勿用取女，見金夫，不有躬，無攸利。六四：困蒙，吝。六五：童蒙，吉。上九：擊蒙，不利為寇，利禦寇。"},
  "111010": {name: "需", desc: "雲上於天，需，君子以飲食宴樂", text: "有孚，光亨，貞吉，利涉大川。初九：需于郊，利用恆，無咎。九二：需于沙，小有言，終吉。九三：需于泥，致寇至。六四：需于血，出自穴。九五：需于酒食，貞吉。上六：入于穴，有不速之客三人來，敬之終吉。"},
  "010111": {name: "訟", desc: "天與水違行，訟，君子以作事謀始", text: "有孚，窒惕，中吉，終凶。利見大人，不利涉大川。初六：不永所事，小有言，終吉。九二：不克訟，歸而逋，其邑人三百戶，無眚。六三：食舊德，貞厲，終吉。或從王事，無成。九四：不克訟，復即命，渝安貞，吉。九五：訟，元吉。上九：或錫之鞶帶，終朝三褫之。"},
  "000010": {name: "師", desc: "地中有水，師，君子以容民畜眾", text: "貞，丈人吉，無咎。初六：師出以律，否臧凶。九二：在師中，吉，無咎，王三錫命。六三：師或輿尸，凶。六四：師左次，無咎。六五：田有禽，利執言，無咎。長子帥師，弟子輿尸，貞凶。上六：大君有命，開國承家，小人勿用。"},
  "010000": {name: "比", desc: "地上有水，比，先王以建萬國，親諸侯", text: "吉。原筮，元永貞，無咎。不寧方來，後夫凶。初六：有孚比之，無咎。有孚盈缶，終來有他，吉。六二：比之自內，貞吉。六三：比之匪人。六四：外比之，貞吉。九五：顯比，王用三驅，失前禽，邑人不誡，吉。上六：比之無首，凶。"},
  "110111": {name: "小畜", desc: "風行天上，小畜，君子以懿文德", text: "亨。密雲不雨，自我西郊。初九：復自道，何其咎？吉。九二：牽復，吉。九三：輿說輻，夫妻反目。六四：有孚，血去惕出，無咎。九五：有孚攣如，富以其鄰。上九：既雨既處，尚德載，婦貞厲。月幾望，君子征凶。"},
  "111011": {name: "履", desc: "上天下澤，履，君子以辨上下，定民志", text: "履虎尾，不咥人，亨。初九：素履，往無咎。九二：履道坦坦，幽人貞吉。六三：眇能視，跛能履，履虎尾，咥人，凶。武人為于大君。九四：履虎尾，愬愬，終吉。九五：夬履，貞厲。上九：視履考祥，其旋元吉。"},
  "111000": {name: "泰", desc: "天地交，泰，后以財成天地之道，輔相天地之宜，以左右民", text: "小往大來，吉，亨。初九：拔茅茹，以其彙，征吉。九二：包荒，用馮河，不遐遺，朋亡，得尚于中行。九三：無平不陂，無往不復，艱貞無咎。勿恤其孚，于食有福。六四：翩翩，不富以其鄰，不戒以孚。六五：帝乙歸妹，以祉元吉。上六：城復于隍，勿用師。自邑告命，貞吝。"},
  "000111": {name: "否", desc: "天地不交，否，君子以儉德辟難，不可榮以祿", text: "否之匪人，不利君子貞，大往小來。初六：拔茅茹，以其彙，貞吉，亨。六二：包承，小人吉，大人否亨。六三：包羞。九四：有命無咎，疇離祉。九五：休否，大人吉。其亡其亡，繫于苞桑。上九：傾否，先否後喜。"},
  "101111": {name: "同人", desc: "天與火，同人，君子以類族辨物", text: "同人于野，亨，利涉大川，利君子貞。初九：同人于門，無咎。六二：同人于宗，吝。九三：伏戎于莽，升其高陵，三歲不興。九四：乘其墉，弗克攻，吉。九五：同人，先號啕而後笑，大師克相遇。上九：同人于郊，無悔。"},
  "111101": {name: "大有", desc: "火在天上，大有，君子以遏惡揚善，順天休命", text: "元亨。初九：無交害，匪咎，艱則無咎。九二：大車以載，有攸往，無咎。九三：公用亨于天子，小人弗克。九四：匪其彭，無咎。六五：厥孚交如，威如，吉。上九：自天祐之，吉無不利。"},
  "001000": {name: "謙", desc: "地中有山，謙，君子以裒多益寡，稱物平施", text: "亨，君子有終。初六：謙謙君子，用涉大川，吉。六二：鳴謙，貞吉。九三：勞謙君子，有終，吉。六四：無不利，撝謙。六五：不富以其鄰，利用侵伐，無不利。上六：鳴謙，利用行師，征邑國。"},
  "000100": {name: "豫", desc: "雷出地奮，豫，先王以作樂崇德，殷薦之上帝，以配祖考", text: "利建侯行師。初六：鳴豫，凶。六二：介于石，不終日，貞吉。六三：盱豫，悔，遲有悔。九四：由豫，大有得。勿疑，朋盍簪。六五：貞疾，恆不死。上六：冥豫，成有渝，無咎。"},
  "100110": {name: "隨", desc: "澤中有雷，隨，君子以嚮晦入宴息", text: "元亨利貞，無咎。初九：官有渝，貞吉。出門交有功。六二：係小子，失丈夫。六三：係丈夫，失小子，隨有求得，利居貞。九四：隨有獲，貞凶。有孚在道，以明，何咎？九五：孚于嘉，吉。上六：拘係之，乃從維之，王用亨于西山。"},
  "011001": {name: "蠱", desc: "山下有風，蠱，君子以振民育德", text: "元亨，利涉大川。先甲三日，後甲三日。初六：幹父之蠱，有子，考無咎，厲終吉。九二：幹母之蠱，不可貞。九三：幹父之蠱，小有悔，無大咎。六四：裕父之蠱，往見吝。六五：幹父之蠱，用譽。上九：不事王侯，高尚其事。"},
  "000110": {name: "臨", desc: "澤上有地，臨，君子以教思無窮，容保民無疆", text: "元亨利貞。至于八月有凶。初九：咸臨，貞吉。九二：咸臨，吉，無不利。六三：甘臨，無攸利。既憂之，無咎。六四：至臨，無咎。六五：知臨，大君之宜，吉。上六：敦臨，吉，無咎。"},
  "011000": {name: "觀", desc: "風行地上，觀，先王以省方觀民設教", text: "盥而不薦，有孚顒若。初六：童觀，小人無咎，君子吝。六二：窺觀，利女貞。六三：觀我生，進退。六四：觀國之光，利用賓于王。九五：觀我生，君子無咎。上九：觀其生，君子無咎。"},
  "100101": {name: "噬嗑", desc: "雷電，噬嗑，先王以明罰敕法", text: "亨，利用獄。初九：屨校滅趾，無咎。六二：噬膚滅鼻，無咎。六三：噬臘肉，遇毒，小吝，無咎。九四：噬乾胏，得金矢，利艱貞，吉。六五：噬乾肉，得黃金，貞厲，無咎。上九：何校滅耳，凶。"},
  "101001": {name: "賁", desc: "山下有火，賁，君子以明庶政，無敢折獄", text: "亨。小利有攸往。初九：賁其趾，舍車而徒。六二：賁其須。九三：賁如濡如，永貞吉。六四：賁如皤如，白馬翰如，匪寇婚媾。六五：賁于丘園，束帛戔戔，吝，終吉。上九：白賁，無咎。"},
  "000001": {name: "剝", desc: "山附于地，剝，上以厚下安宅", text: "不利有攸往。初六：剝床以足，蔑貞，凶。六二：剝床以辨，蔑貞，凶。六三：剝之，無咎。六四：剝床以膚，凶。六五：貫魚，以宮人寵，無不利。上九：碩果不食，君子得輿，小人剝廬。"},
  "100000": {name: "復", desc: "雷在地中，復，先王以至日閉關，商旅不行，后不省方", text: "亨。出入無疾，朋來無咎。反復其道，七日來復，利有攸往。初九：不遠復，無祇悔，元吉。六二：休復，吉。六三：頻復，厲，無咎。六四：中行獨復。六五：敦復，無悔。上六：迷復，凶，有災眚。用行師，終有大敗，以其國君凶，至于十年不克征。"},
  "100111": {name: "無妄", desc: "天下雷行，物與無妄，先王以茂對時育萬物", text: "元亨利貞。其匪正有眚，不利有攸往。初九：無妄，往吉。六二：不耕穫，不菑畬，則利有攸往。六三：無妄之災，或繫之牛，行人之得，邑人之災。九四：可貞，無咎。九五：無妄之疾，勿藥有喜。上九：無妄，行有眚，無攸利。"},
  "111001": {name: "大畜", desc: "天在山中，大畜，君子以多識前言往行，以畜其德", text: "利貞。不家食，吉。利涉大川。初九：有厲，利已。九二：輿說輻。九三：良馬逐，利艱貞。曰閑輿衛，利有攸往。六四：童牛之牿，元吉。六五：豶豕之牙，吉。上九：何天之衢，亨。"},
  "100001": {name: "頤", desc: "山下有雷，頤，君子以慎言語，節飲食", text: "貞吉。觀頤，自求口實。初九：舍爾靈龜，觀我朵頤，凶。六二：顛頤，拂經，于丘頤，征凶。六三：拂頤，貞凶，十年勿用，無攸利。六四：顛頤，吉。虎視眈眈，其欲逐逐，無咎。六五：拂經，居貞吉，不可涉大川。上九：由頤，厲吉，利涉大川。"},
  "011110": {name: "大過", desc: "澤滅木，大過，君子以獨立不懼，遯世無悶", text: "棟橈，利有攸往，亨。初六：藉用白茅，無咎。九二：枯楊生稊，老夫得其女妻，無不利。九三：棟橈，凶。九四：棟隆，吉。有他，吝。九五：枯楊生華，老婦得其士夫，無咎無譽。上六：過涉滅頂，凶，無咎。"},
  "010010": {name: "坎", desc: "水洊至，習坎，君子以常德行，習教事", text: "習坎，有孚，維心亨，行有尚。初六：習坎，入于坎窞，凶。九二：坎有險，求小得。六三：來之坎坎，險且枕，入于坎窞，勿用。六四：樽酒簋貳，用缶，納約自牖，終無咎。九五：坎不盈，祇既平，無咎。上六：係用徽纆，置于叢棘，三歲不得，凶。"},
  "101101": {name: "離", desc: "明兩作，離，大人以繼明照于四方", text: "利貞，亨。畜牝牛，吉。初九：履錯然，敬之，無咎。六二：黃離，元吉。九三：日昃之離，不鼓缶而歌，則大耋之嗟，凶。九四：突如其來如，焚如，死如，棄如。六五：出涕沱若，戚嗟若，吉。上九：王用出征，有嘉，折首獲匪其醜，無咎。"},
  "001110": {name: "咸", desc: "澤上有山，咸，君子以虛受人", text: "亨，利貞。取女吉。初六：咸其拇。九二：咸其腓，凶，居吉。九三：咸其股，執其隨，往吝。九四：貞吉，悔亡。憧憧往來，朋從爾思。九五：咸其脢，無悔。上六：咸其輔頰舌。"},
  "011100": {name: "恆", desc: "雷風，恆，君子以立不易方", text: "亨，無咎，利貞，利有攸往。初六：浚恆，貞凶，無攸利。九二：悔亡。九三：不恆其德，或承之羞，貞吝。九四：田無禽。六五：恆其德，貞，婦人吉，夫子凶。上六：振恆，凶。"},
  "001111": {name: "遯", desc: "天下有山，遯，君子以遠小人，不惡而嚴", text: "亨。小利貞。初六：遯尾，厲，勿用有攸往。六二：執之用黃牛之革，莫之勝說。九三：係遯，有疾厲，畜臣妾吉。九四：好遯，君子吉，小人否。九五：嘉遯，貞吉。上九：肥遯，無不利。"},
  "111100": {name: "大壯", desc: "雷在天上，大壯，君子以非禮勿履", text: "利貞。初九：壯于趾，征凶，有孚。九二：貞吉。九三：小人用壯，君子用罔，貞厲。羝羊觸藩，羸其角。九四：貞吉悔亡，藩決不羸，壯于大輿之輹。六五：喪羊于易，無悔。上六：羝羊觸藩，不能退，不能遂，無攸利，艱則吉。"},
  "000101": {name: "晉", desc: "明出地上，晉，君子以自昭明德", text: "康侯用錫馬蕃庶，晝日三接。初六：晉如，摧如，貞吉。罔孚，裕無咎。六二：晉如，愁如，貞吉。受茲介福，于其王母。六三：眾允，悔亡。九四：晉如鼫鼠，貞厲。六五：悔亡，失得勿恤，往吉，無不利。上九：晉其角，維用伐邑，厲吉無咎，貞吝。"},
  "101000": {name: "明夷", desc: "明入地中，明夷，君子以蒞眾，用晦而明", text: "利艱貞。初九：明夷于飛，垂其翼。君子于行，三日不食。有攸往，主人有言。六二：明夷，夷于左股，用拯馬壯，吉。九三：明夷于南狩，得其大首，不可疾貞。六四：入于左腹，獲明夷之心，于出門庭。六五：箕子之明夷，利貞。上六：不明晦，初登于天，後入于地。"},
  "101011": {name: "家人", desc: "風自火出，家人，君子以言有物而行有恆", text: "利女貞。初九：閑有家，悔亡。六二：無攸遂，在中饋，貞吉。九三：家人嗃嗃，悔厲吉。婦子嘻嘻，終吝。六四：富家，大吉。九五：王假有家，勿恤，吉。上九：有孚威如，終吉。"},
  "110101": {name: "睽", desc: "上火下澤，睽，君子以同而異", text: "小事吉。初九：悔亡。喪馬，勿逐自復。見惡人，無咎。九二：遇主于巷，無咎。六三：見輿曳，其牛掣，其人天且劓，無初有終。九四：睽孤，遇元夫，交孚，厲無咎。六五：悔亡，厥宗噬膚，往何咎？上九：睽孤，見豕負塗，載鬼一車，先張之弧，後說之弧，匪寇婚媾，往遇雨則吉。"},
  "001010": {name: "蹇", desc: "山上有水，蹇，君子以反身修德", text: "利西南，不利東北。利見大人，貞吉。初六：往蹇來譽。六二：王臣蹇蹇，匪躬之故。九三：往蹇來反。六四：往蹇來連。九五：大蹇朋來。上六：往蹇來碩，吉，利見大人。"},
  "100011": {name: "解", desc: "雷雨作，解，君子以赦過宥罪", text: "利西南。無所往，其來復吉。有攸往，夙吉。初六：無咎。九二：田獲三狐，得黃矢，貞吉。六三：負且乘，致寇至，貞吝。九四：解而拇，朋至斯孚。九五：君子維有解，吉，有孚于小人。上六：公用射隼于高墉之上，獲之，無不利。"},
  "110001": {name: "損", desc: "山下有澤，損，君子以懲忿窒欲", text: "有孚，元吉，無咎，可貞，利有攸往。曷之用？二簋可用享。初九：已事遄往，無咎，酌損之。九二：利貞，征凶，弗損益之。六三：三人行，則損一人；一人行，則得其友。六四：損其疾，使遄有喜，無咎。六五：或益之十朋之龜，弗克違，元吉。上九：弗損益之，無咎，貞吉，利有攸往，得臣無家。"},
  "100011": {name: "益", desc: "風雷，益，君子以見善則遷，有過則改", text: "利有攸往，利涉大川。初九：利用為大作，元吉，無咎。六二：或益之十朋之龜，弗克違，永貞吉。王用享于帝，吉。六三：益之用凶事，無咎。有孚中行，告公用圭。六四：中行，告公從。利用為依遷國。九五：有孚惠心，勿問元吉。有孚惠我德。上九：莫益之，或擊之，立心勿恆，凶。"},
  "111110": {name: "夬", desc: "澤上于天，夬，君子以施祿及下，居德則忌", text: "揚于王庭，孚號，有厲，告自邑，不利即戎，利有攸往。初九：壯于前趾，往不勝為咎。九二：惕號，莫夜有戎，勿恤。九三：壯于頄，有凶。君子夬夬，獨行遇雨，若濡有慍，無咎。九四：臀無膚，其行次且。牽羊悔亡，聞言不信。九五：莧陸夬夬，中行無咎。上六：無號，終有凶。"},
  "011111": {name: "姤", desc: "天下有風，姤，后以施命誥四方", text: "女壯，勿用取女。初六：繫于金柅，貞吉。有攸往，見凶。羸豕孚蹢躅。九二：包有魚，無咎，不利賓。九三：臀無膚，其行次且，厲，無大咎。九四：包無魚，起凶。九五：以杞包瓜，含章，有隕自天。上九：姤其角，吝，無咎。"},
  "000011": {name: "萃", desc: "澤上于地，萃，君子以除戎器，戒不虞", text: "亨，王假有廟，利見大人，亨，利貞。用大牲吉，利有攸往。初六：有孚不終，乃亂乃萃，若號，一握為笑，勿恤，往無咎。六二：引吉，無咎，孚乃利用禴。六三：萃如嗟如，無攸利，往無咎，小吝。九四：大吉，無咎。九五：萃有位，無咎。匪孚，元永貞，悔亡。上六：齎咨涕洟，無咎。"},
  "011000": {name: "升", desc: "地中生木，升，君子以順德，積小以高大", text: "元亨，用見大人，勿恤，南征吉。初六：允升，大吉。九二：孚乃利用禴，無咎。九三：升虛邑。六四：王用亨于岐山，吉，無咎。六五：貞吉，升階。上六：冥升，利于不息之貞。"},
  "010110": {name: "困", desc: "澤無水，困，君子以致命遂志", text: "亨，貞，大人吉，無咎。有言不信。初六：臀困于株木，入于幽谷，三歲不見。九二：困于酒食，朱紱方來，利用享祀。征凶，無咎。六三：困于石，據于蒺藜，入于其宮，不見其妻，凶。九四：來徐徐，困于金車，吝，有終。九五：劓刖，困于赤紱，乃徐有說，利用祭祀。上六：困于葛藟，于臲卼，曰動悔有悔，征吉。"},
  "011010": {name: "井", desc: "木上有水，井，君子以勞民勸相", text: "改邑不改井，無喪無得，往來井井。汔至，亦未繘井，羸其瓶，凶。初六：井泥不食，舊井無禽。九二：井谷射鮒，甕敝漏。九三：井渫不食，為我心惻，可用汲，王明，並受其福。六四：井甃，無咎。九五：井冽，寒泉食。上六：井收勿幕，有孚元吉。"},
  "101110": {name: "革", desc: "澤中有火，革，君子以治歷明時", text: "巳日乃孚，元亨利貞，悔亡。初九：鞏用黃牛之革。六二：巳日乃革之，征吉，無咎。九三：征凶，貞厲，革言三就有孚。九四：悔亡，有孚改命，吉。九五：大人虎變，未占有孚。上六：君子豹變，小人革面，征凶，居貞吉。"},
  "011101": {name: "鼎", desc: "木上有火，鼎，君子以正位凝命", text: "元吉，亨。初六：鼎顛趾，利出否，得妾以其子，無咎。九二：鼎有實，我仇有疾，不我能即，吉。九三：鼎耳革，其行塞，雉膏不食，方雨虧悔，終吉。九四：鼎折足，覆公餗，其形渥，凶。六五：鼎黃耳金鉉，利貞。上九：鼎玉鉉，大吉，無不利。"},
  "100100": {name: "震", desc: "洊雷，震，君子以恐懼修省", text: "亨。震來虩虩，笑言啞啞。震驚百里，不喪匕鬯。初九：震來虩虩，後笑言啞啞，吉。六二：震來厲，億喪貝，躱于九陵，勿逐，七日得。六三：震蘇蘇，震行無眚。六四：震遂泥。九五：震往來厲，億無喪，有事。上六：震索索，視矍矍，征凶。震不于其躬，于其鄰，無咎。婚媾有言。"},
  "001001": {name: "艮", desc: "兼山，艮，君子以思不出其位", text: "艮其背，不獲其身，行其庭，不見其人，無咎。初六：艮其趾，無咎，利永貞。六二：艮其腓，不拯其隨，其心不快。九三：艮其限，列其夤，厲薰心。六四：艮其身，無咎。六五：艮其輔，言有序，悔亡。上九：敦艮，吉。"},
  "001011": {name: "漸", desc: "山上有木，漸，君子以居賢德善俗", text: "女歸吉，利貞。初六：鴻漸于干，小子厲，有言，無咎。六二：鴻漸于磐，飲食衎衎，吉。九三：鴻漸于陸，夫征不復，婦孕不育，凶。利禦寇。六四：鴻漸于木，或得其桷，無咎。九五：鴻漸于陵，婦三歲不孕，終莫之勝，吉。上九：鴻漸于逵，其羽可用為儀，吉。"},
  "110100": {name: "歸妹", desc: "澤上有雷，歸妹，君子以永終知敝", text: "征凶，無攸利。初九：歸妹以娣，跛能履，征吉。九二：眇能視，利幽人之貞。六三：歸妹以須，反歸以娣。九四：歸妹愆期，遲歸有時。六五：帝乙歸妹，其君之袂不如其娣之袂良，月幾望，吉。上六：女承筐無實，士刲羊無血，無攸利。"},
  "101100": {name: "豐", desc: "雷電皆至，豐，君子以折獄致刑", text: "亨，王假之，勿憂，宜日中。初九：遇其配主，雖旬無咎，往有尚。六二：豐其蔀，日中見斗，往得疑疾，有孚發若，吉。九三：豐其沛，日中見沬，折其右肱，無咎。九四：豐其蔀，日中見斗，遇其夷主，吉。六五：來章，有慶譽，吉。上六：豐其屋，蔀其家，窺其戶，闃其無人，三歲不見，凶。"},
  "001101": {name: "旅", desc: "山上有火，旅，君子以明慎用刑而不留獄", text: "小亨，旅貞吉。初六：旅瑣瑣，斯其所取災。六二：旅即次，懷其資，得童僕貞。九三：旅焚其次，喪其童僕，貞厲。九四：旅于處，得其資斧，我心不快。六五：射雉一矢亡，終以譽命。上九：鳥焚其巢，旅人先笑後號啕。喪牛于易，凶。"},
  "011011": {name: "巽", desc: "隨風，巽，君子以申命行事", text: "小亨，利有攸往，利見大人。初六：進退，利武人之貞。九二：巽在床下，用史巫紛若，吉，無咎。九三：頻巽，吝。六四：悔亡，田獲三品。九五：貞吉，悔亡，無不利。無初有終，先庚三日，後庚三日，吉。上九：巽在床下，喪其資斧，貞凶。"},
  "110110": {name: "兌", desc: "麗澤，兌，君子以朋友講習", text: "亨，利貞。初九：和兌，吉。九二：孚兌，吉，悔亡。六三：來兌，凶。九四：商兌未寧，介疾有喜。九五：孚于剝，有厲。上六：引兌。"},
  "010011": {name: "渙", desc: "風行水上，渙，先王以享于帝立廟", text: "亨。王假有廟，利涉大川，利貞。初六：用拯馬壯，吉。九二：渙奔其案，悔亡。六三：渙其躬，無悔。六四：渙其群，元吉。渙有丘，匪夷所思。九五：渙汗其大號，渙王居，無咎。上九：渙其血，去逖出，無咎。"},
  "110010": {name: "節", desc: "澤上有水，節，君子以制數度，議德行", text: "亨。苦節，不可貞。初九：不出戶庭，無咎。九二：不出門庭，凶。六三：不節若，則嗟若，無咎。六四：安節，亨。九五：甘節，吉，往有尚。上六：苦節，貞凶，悔亡。"},
  "110011": {name: "中孚", desc: "澤上有風，中孚，君子以議獄緩死", text: "豚魚吉，利涉大川，利貞。初九：虞吉，有他不燕。九二：鳴鶴在陰，其子和之。我有好爵，吾與爾靡之。六三：得敵，或鼓或罷，或泣或歌。六四：月幾望，馬匹亡，無咎。九五：有孚攣如，無咎。上九：翰音登于天，貞凶。"},
  "001100": {name: "小過", desc: "山上有雷，小過，君子以行過乎恭，喪過乎哀，用過乎儉", text: "亨，利貞，可小事，不可大事。飛鳥遺之音，不宜上，宜下，大吉。初六：飛鳥以凶。六二：過其祖，遇其妣；不及其君，遇其臣，無咎。九三：弗過防之，從或戕之，凶。九四：無咎，弗過遇之。往厲必戒，勿用永貞。六五：密雲不雨，自我西郊，公弋取彼在穴。上六：弗遇過之，飛鳥離之，凶，是謂災眚。"},
  "101010": {name: "既濟", desc: "水在火上，既濟，君子以思患而豫防之", text: "亨小，利貞。初吉終亂。初九：曳其輪，濡其尾，無咎。六二：婦喪其茀，勿逐，七日得。九三：高宗伐鬼方，三年克之，小人勿用。六四：繻有衣袽，終日戒。九五：東鄰殺牛，不如西鄰之禴祭，實受其福。上六：濡其首，厲。"},
  "010101": {name: "未濟", desc: "火在水上，未濟，君子以慎辨物居方", text: "亨，小狐汔濟，濡其尾，無攸利。初六：濡其尾，吝。九二：曳其輪，貞吉。六三：未濟，征凶，利涉大川。九四：貞吉，悔亡，震用伐鬼方，三年有賞于大國。六五：貞吉，無悔，君子之光，有孚，吉。上九：有孚于飲酒，無咎，濡其首，有孚失是。"}
};

const bagua = {
  "111": "乾", "110": "兌", "101": "離", "100": "震",
  "011": "巽", "010": "坎", "001": "艮", "000": "坤"
};

const palaces = {
  "乾": ["111111", "111110", "111101", "111100", "111011", "111010", "111001", "111000"],
  "兌": ["110111", "110110", "110101", "110100", "110011", "110010", "110001", "110000"],
  "離": ["101111", "101110", "101101", "101100", "101011", "101010", "101001", "101000"],
  "震": ["100111", "100110", "100101", "100100", "100011", "100010", "100001", "100000"],
  "巽": ["011111", "011110", "011101", "011100", "011011", "011010", "011001", "011000"],
  "坎": ["010111", "010110", "010101", "010100", "010011", "010010", "010001", "010000"],
  "艮": ["001111", "001110", "001101", "001100", "001011", "001010", "001001", "001000"],
  "坤": ["000111", "000110", "000101", "000100", "000011", "000010", "000001", "000000"]
};

// 全局變數
let network, nodes, edges, bitToIndex, originalEdgeColors, hexagramTexts;

// 檢查數據初始化
function checkDataInitialization() {
  if (!guaNames || guaNames.length !== 64) {
    console.error('錯誤：guaNames 未正確定義或長度不為64，當前長度：', guaNames ? guaNames.length : '未定義');
    return false;
  }
  if (!kingwenBits || kingwenBits.length !== 64) {
    console.error('錯誤：kingwenBits 未正確定義或長度不為64，當前長度：', kingwenBits ? kingwenBits.length : '未定義');
    return false;
  }
  if (!hexagramData || Object.keys(hexagramData).length < 3) {
    console.error('錯誤：hexagramData 未正確定義或數據不足，當前卦數：', hexagramData ? Object.keys(hexagramData).length : '未定義');
    return false;
  }
  console.log('數據初始化檢查通過：guaNames, kingwenBits, hexagramData 均已正確定義');
  return true;
}

// 生成卦辭數據
function generateHexagramTexts() {
  const texts = {};
  const yaoNames = ["初", "二", "三", "四", "五", "上"];
  guaNames.forEach((name, i) => {
    const bits = kingwenBits[i];
    texts[bits] = hexagramData[bits] || {
      name: name,
      desc: `${name}卦象徵意義的簡述`,
      text: `${name}：卦辭。${yaoNames.map((yao, j) => {
        const isYang = bits[j] === '1';
        return `${yao}${isYang ? '九' : '六'}：${name}${yao}爻辭。`;
      }).join(' ')}`
    };
  });
  return texts;
}

// 生成節點
function generateNodes() {
  const nodes = [];
  const bitToIndex = {};
  for (let i = 0; i < kingwenBits.length; i++) {
    const bits = kingwenBits[i];
    const name = guaNames[i];
    const yangCount = bits.split('').reduce((a, b) => a + Number(b), 0);
    const colors = ['#4ecdc4', '#45b7d1', '#bb8fce', '#82e0aa', '#f7dc6f', '#ff8e53', '#ff6b6b'];
    const color = colors[yangCount];
    const size = Math.max(15, 15 + yangCount * 2);
    nodes.push({
      id: i,
      label: name,
      title: `<b>${name}卦</b><br>${bits}<br>陽爻數量: ${yangCount}<br><small>點擊查看詳細</small>`,
      bits: bits,
      gua: name,
      value: size,
      color: { background: color, border: '#333333', highlight: { background: '#d81b60', border: '#b71c1c' } },
      font: { color: '#333333', size: 14, face: 'Noto Sans TC', align: 'center' },
      upperTrigram: bits.slice(0, 3),
      lowerTrigram: bits.slice(3, 6),
      shape: 'square'// 明確設置為方形節點
    });
    bitToIndex[bits] = i;
  }
  console.log(`節點生成完成，總數：${nodes.length}`);
  return { nodes, bitToIndex };
}

// 創建邊（六維超立方體的邊，根據變爻位置著色）
function generateEdges(bitToIndex) {
  const edges = [];
  const originalEdgeColors = [];
  const edgeColors = ['#ff6b6b', '#ff8e53', '#f7dc6f', '#82e0aa', '#45b7d1', '#4ecdc4'];
  for (let i = 0; i < kingwenBits.length; i++) {
    const bits = kingwenBits[i];
    for (let j = 0; j < 6; j++) {
      const nb = bits.split('');
      nb[j] = nb[j] === '1' ? '0' : '1';
      const nbstr = nb.join('');
      const k = bitToIndex[nbstr];
      if (k !== undefined && i < k) {
        const edge = {
          from: i,
          to: k,
          color: { color: edgeColors[j], opacity: 0.6 },
          width: 1,
          smooth: { type: 'continuous' },
          title: `第${j+1}爻變`
        };
        edges.push(edge);
        originalEdgeColors.push({ from: i, to: k, color: edgeColors[j] });
      }
    }
  }
  console.log(`邊生成完成，總數：${edges.length}`);
  const dryIdx = bitToIndex['111111'];
  const meetIdx = bitToIndex['011111'];
  if (dryIdx !== undefined && meetIdx !== undefined) {
    console.log(`乾卦（111111, ID: ${dryIdx}）第一爻變連接到姤卦（011111, ID: ${meetIdx}）`);
    const edgeExists = edges.some(edge => 
      (edge.from === dryIdx && edge.to === meetIdx && edge.title === '第一爻變') ||
      (edge.from === meetIdx && edge.to === dryIdx && edge.title === '第一爻變')
    );
    console.log(`乾卦到姤卦的邊是否存在且標籤正確：${edgeExists}`);
  }
  return { edges, originalEdgeColors };
}

// 顯示卦象詳情
function showGua(idx, highlightLine = null) {
  if (!nodes[idx]) {
    console.error(`無效的節點索引: ${idx}`);
    return;
  }

  const node = nodes[idx];
  const bits = node.bits;
  const hexData = hexagramTexts[bits];

  const guaName = document.getElementById('guaName');
  const guaBits = document.getElementById('guaBits');
  const guaSymbol = document.getElementById('guaSymbol');
  const guaText = document.getElementById('guaText');
  const changeList = document.getElementById('changeList');

  if (!guaName || !guaBits || !guaSymbol || !guaText || !changeList) {
    console.error('DOM 元素缺失:', { guaName: !!guaName, guaBits: !!guaBits, guaSymbol: !!guaSymbol, guaText: !!guaText, changeList: !!changeList });
    return;
  }

  guaName.innerText = `${node.gua}卦 （第${idx+1}卦）`;
  guaBits.innerText = `六維坐標：${bits} （陽爻=1，陰爻=0）`;
  const yaoSymbols = bits.split('').map(bit => bit === '1' ? '⚊' : '⚋').reverse();
  guaSymbol.innerHTML = yaoSymbols.join('<br>');
  
  const lines = hexData.text.split('。').filter(line => line.trim());
  const textHtml = `
    <div class="original-text">
      <h4>${hexData.name}卦</h4>
      <p><strong>象徵：</strong>${hexData.desc}</p>
      ${lines.map(line => `<div class="yao-text">${line}。</div>`).join('')}
    </div>
  `;
  
  let changeHtml = '<h4>六個變卦（一爻變）</h4>';
  for (let j = 0; j < 6; j++) {
    const bitsArr = node.bits.split('');
    bitsArr[j] = bitsArr[j] === '1' ? '0' : '1';
    const newBits = bitsArr.join('');
    const newIdx = bitToIndex[newBits];
    const yaoPos = j + 1;
    const yaoName = bitsArr[j] === '1' ? '陽' : '陰';
    changeHtml += `<div class="change-item" data-idx="${newIdx}" data-yao="${j}" tabindex="0">
      <b>第${yaoPos}爻變${yaoName} → ${guaNames[newIdx]}卦</b><br>
      <small>${newBits}</small>
    </div>`;
  }
  
  guaText.innerHTML = textHtml;
  changeList.innerHTML = changeHtml;

  document.querySelectorAll('.change-item').forEach(item => {
    item.addEventListener('click', () => {
      const idx = parseInt(item.getAttribute('data-idx'));
      const yao = parseInt(item.getAttribute('data-yao'));
      jumpTo(idx, yao);
      console.log(`點擊變卦：從 ${node.gua} (ID: ${idx}) 跳轉到 ${guaNames[idx]}，高亮第 ${yao+1} 爻`);
    });
    item.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const idx = parseInt(item.getAttribute('data-idx'));
        const yao = parseInt(item.getAttribute('data-yao'));
        jumpTo(idx, yao);
        console.log(`鍵盤跳轉：從 ${node.gua} (ID: ${idx}) 跳轉到 ${guaNames[idx]}，高亮第 ${yao+1} 爻`);
      }
    });
  });
  
  network.selectNodes([idx]);
  network.focus(idx, { animation: { duration: 1000, easingFunction: 'easeInOutQuad' } });
   // 更新節點顏色，但保留標籤
  const nodeUpdates = nodes.map(n => ({
    id: n.id,
    color: n.id === idx ? { background: '#d81b60', border: '#b71c1c' } : n.color,
    label: n.label,
    font: n.font
  }));
  // 更新邊的顏色
  const connectedEdges = network.getConnectedEdges(idx);
  const edgeUpdates = edges.map(edge => {
    const isConnected = connectedEdges.includes(edge.from + '-' + edge.to) || connectedEdges.includes(edge.to + '-' + edge.from);
    return {
      from: edge.from,
      to: edge.to,
      color: isConnected ? { color: '#d81b60', opacity: 1 } : edge.color,
      width: edge.width,
      smooth: edge.smooth,
      title: edge.title
    };
  });

  network.setData({ nodes: nodeUpdates, edges: edgeUpdates });
  
  console.log(`顯示卦象 ${node.gua}，節點 ID: ${idx}，標籤: ${node.label}`);
  console.log(`與節點 ${idx} 相連的邊數量: ${connectedEdges.length}, 已更新為紅色`);
}

// 跳轉到指定卦象
function jumpTo(idx, movedIndex) {
  if (typeof showGua !== 'function') {
    console.error('錯誤：showGua 函數未定義');
    return;
  }
  showGua(idx);
  setTimeout(() => {
    const items = document.querySelectorAll('.change-item');
    items.forEach(item => item.classList.remove('highlight'));
    if (items[movedIndex]) {
      items[movedIndex].classList.add('highlight');
      items[movedIndex].focus();
      console.log(`高亮變卦項目：第 ${movedIndex+1} 爻`);
    }
  }, 100);
}

// 初始化網絡
function initializeNetwork() {
  console.log('開始初始化網絡');
  if (!checkDataInitialization()) {
    console.error('初始化失敗：關鍵數據未正確定義');
    alert('初始化失敗：關鍵數據未正確定義，請檢查控制台錯誤訊息');
    return; // 合法的 return，位於函數內部
  }

  hexagramTexts = generateHexagramTexts();
  const { nodes: generatedNodes, bitToIndex: generatedBitToIndex } = generateNodes();
  const { edges: generatedEdges, originalEdgeColors: generatedEdgeColors } = generateEdges(generatedBitToIndex);

  nodes = generatedNodes;
  bitToIndex = generatedBitToIndex;
  edges = generatedEdges;
  originalEdgeColors = generatedEdgeColors;

  const container = document.getElementById('mynetwork');
  if (!container) {
    console.error('錯誤：無法找到 mynetwork 容器');
    alert('初始化失敗：無法找到網絡容器');
    return; // 合法的 return，位於函數內部
  }

  const data = { nodes, edges };
  const options = {
    nodes: {
      shape: 'square',
      size: 18,
      font: { size: 14, color: '#333333', face: 'Noto Sans TC', align: 'center' },
      borderWidth: 2,
      shadow: true,
      scaling: { label: { enabled: true, min: 14, max: 18, maxVisible: 18, drawThreshold: 5 } }
    },
    edges: {
      width: 1,
      color: { color: '#666666' },
      smooth: { type: 'continuous' }
    },
    physics: { enabled: false },
    interaction: {
      hover: false,
      selectConnectedEdges: false,
      keyboard: { enabled: true },
      zoomView: true,
      dragView: true,
      dragNodes: true
    },
    layout: { randomSeed: 42 }
  };

  network = new vis.Network(container, data, options);
  console.log('網絡初始化完成，節點數: ' + nodes.length + '，邊數: ' + edges.length);

  network.on("click", function(params) {
    if (params.nodes.length > 0) {
      const idx = params.nodes[0];
      showGua(idx);
      console.log(`點擊節點：${nodes[idx].gua} (ID: ${idx})`);
    }
  });

  // DOM 事件監聽器
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM 完全加載，開始綁定事件');
    const layoutSelect = document.getElementById('layoutSelect');
    const nodeSizeSlider = document.getElementById('nodeSizeSlider');
    const displayMode = document.getElementById('displayMode');
    const btnCenter = document.getElementById('btnCenter');
    const btnRandomWalk = document.getElementById('btnRandomWalk');
    const panelToggle = document.getElementById('panelToggle');
  // 檢查必要元素是否存在
    const requiredElements = {
      guaName: document.getElementById('guaName'),
      guaBits: document.getElementById('guaBits'),
      guaSymbol: document.getElementById('guaSymbol'),
      guaText: document.getElementById('guaText'),
      changeList: document.getElementById('changeList')
    };

    if (Object.values(requiredElements).some(el => !el)) {
      console.error('初始化失敗：缺失必要的 DOM 元素:', requiredElements);
      alert('初始化失敗：缺失必要的 DOM 元素');
      return; // 合法的 return，位於事件處理函數內
    }

    if (layoutSelect) {
      layoutSelect.addEventListener('change', function() {
        const layout = this.value;
        let newOptions = { ...options };
        switch (layout) {
          case 'repulsion':
            newOptions.physics = { repulsion: { nodeDistance: 200 } };
            break;
          case 'hierarchical':
            newOptions.layout = { hierarchical: { direction: 'UD', sortMethod: 'directed' } };
            newOptions.physics = { enabled: false };
            break;
          case 'forceAtlas2':
            newOptions.physics = { forceAtlas2Based: { gravitationalConstant: -50, centralGravity: 0.01 } };
            break;
          default:
            newOptions.physics = { barnesHut: { gravitationalConstant: -2000, centralGravity: 0.3 } };
        }
        network.setOptions(newOptions);
        console.log(`布局切換至 ${layout}`);
      });
    }

    if (nodeSizeSlider) {
      nodeSizeSlider.addEventListener('input', function() {
        const size = parseInt(this.value);
        const updateArray = nodes.map(node => ({
          id: node.id,
          size: size,
          label: node.label,// 保留標籤
          font: node.font // 保留字體設置
        }));
        network.setData({ nodes: updateArray, edges: edges });
        console.log(`節點大小更新至 ${size}，標籤應保持可見`);
      });
    }

    if (displayMode) {
      displayMode.addEventListener('change', function() {
        const mode = this.value;
        let filteredNodes = nodes;
        let filteredEdges = edges;
        if (mode === 'bagua') {
          filteredNodes = nodes.filter(node => node.upperTrigram === '111');
          filteredEdges = edges.filter(edge => 
            filteredNodes.some(n => n.id === edge.from) && filteredNodes.some(n => n.id === edge.to)
          );
        } else if (mode === 'palace') {
          filteredNodes = nodes.filter(node => palaces['乾'].includes(node.bits));
          filteredEdges = edges.filter(edge => 
            filteredNodes.some(n => n.id === edge.from) && filteredNodes.some(n => n.id === edge.to)
          );
        }
// 確保標籤在模式切換時保留
          filteredNodes = filteredNodes.map(node => ({
          id: node.id,
          label: node.label,
          font: node.font,
          color: node.color,
          size: node.size
        }));
        // 重置邊的顏色為原始顏色
        filteredEdges = filteredEdges.map(edge => {
          const original = originalEdgeColors.find(e => e.from === edge.from && e.to === edge.to);
          return {
            from: edge.from,
            to: edge.to,
            color: original ? { color: original.color, opacity: 0.6 } : edge.color,
            width: edge.width,
            smooth: edge.smooth,
            title: edge.title
          };
        });
        network.setData({ nodes: filteredNodes, edges: filteredEdges });
        console.log(`顯示模式切換至 ${mode}，節點數: ${filteredNodes.length}，邊數: ${filteredEdges.length}`);
      });
    }

    if (btnCenter) {
      btnCenter.addEventListener('click', function() { 
        network.fit({ animation: { duration: 1000, easingFunction: 'easeInOutQuad' } }); 
        console.log('網絡視角重置，標籤應保持可見');
      });
    }

    if (btnRandomWalk) {
      btnRandomWalk.addEventListener('click', function() {
        const randomIdx = Math.floor(Math.random() * nodes.length);
        showGua(randomIdx);
        console.log(`隨機漫步至卦象：${nodes[randomIdx].gua} (ID: ${randomIdx})`);
      });
    }

    if (panelToggle) {
      panelToggle.addEventListener('click', function() {
        const panel = document.getElementById('panel');
        if (panel) {
          const isOpen = panel.classList.contains('open');
          panel.classList.toggle('open');
          this.innerText = isOpen ? '開啟面板' : '關閉面板';
          console.log(`面板狀態：${isOpen ? '關閉' : '開啟'}`);
        }
      });
    }

    // 初始化顯示乾卦
    showGua(0);
    console.log('初始顯示乾卦 (ID: 0)');
  });

  // 鍵盤導航
  document.addEventListener('keydown', function(event) {
    if (event.key === 'ArrowRight' || event.key === 'ArrowLeft') {
      const currentNode = network.getSelectedNodes()[0];
      if (currentNode !== undefined) {
        const connected = network.getConnectedNodes(currentNode);
        const nextIdx = connected[Math.floor(Math.random() * connected.length)];
        showGua(nextIdx);
        console.log(`鍵盤導航至卦象：${nodes[nextIdx].gua} (ID: ${nextIdx})`);
      }
    }
  });
}

// 主程序執行
try {
  console.log('主程序開始執行');
  initializeNetwork();
  console.log('主程序執行完成');
} catch (error) {
  console.error('網絡初始化失敗：', error);
  alert('應用程序初始化失敗，請檢查控制台以獲取詳細錯誤訊息');
}
</script>
</body>
</html>