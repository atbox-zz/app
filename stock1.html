<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨åˆ†æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #2c3e50;
            font-weight: bold;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-weight: 500;
            color: #2c3e50;
        }

        input, select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .highlight {
            background-color: #d4edda !important;
            font-weight: bold;
        }

        .highlight::before {
            content: 'âœ… ';
            color: #28a745;
        }

        .low-value {
            background-color: #fff3cd;
            color: #856404;
        }

        .high-value {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-undervalued {
            color: #28a745;
            font-weight: bold;
        }

        .status-fair {
            color: #ffc107;
            font-weight: bold;
        }

        .status-overvalued {
            color: #dc3545;
            font-weight: bold;
        }

        .add-stock-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 150px;
        }

        .form-group input {
            width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .sector-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .sector-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .sector-card:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .sector-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .sector-count {
            font-size: 1.5em;
            color: #3498db;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š è‚¡ç¥¨åˆ†æå·¥å…·</h1>
            <p>å°ˆæ¥­ç´šæŠ•è³‡åˆ†æå¹³å° - æ™ºèƒ½ç¯©é¸ â€¢ é¢¨éšªè©•ä¼° â€¢ åƒ¹å€¼ç™¼ç¾</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">ğŸ“ˆ ç¸½è¦½åˆ†æ</button>
            <button class="tab" onclick="showTab('screening')">ğŸ” æ¢ä»¶ç¯©é¸</button>
            <button class="tab" onclick="showTab('sectors')">ğŸ¢ ç”¢æ¥­åˆ†æ</button>
            <button class="tab" onclick="showTab('add')">â• æ–°å¢è‚¡ç¥¨</button>
        </div>

        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalStocks">12</div>
                    <div class="stat-label">è¿½è¹¤è‚¡ç¥¨æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="qualifiedStocks">3</div>
                    <div class="stat-label">ç¬¦åˆæ¢ä»¶è‚¡ç¥¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgPE">12.5</div>
                    <div class="stat-label">å¹³å‡æœ¬ç›Šæ¯”</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgYield">4.2%</div>
                    <div class="stat-label">å¹³å‡æ®–åˆ©ç‡</div>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>æœ¬ç›Šæ¯”ä¸Šé™:</label>
                    <input type="number" id="peLimit" value="10" min="1" max="50">
                </div>
                <div class="control-group">
                    <label>æ®–åˆ©ç‡ä¸‹é™:</label>
                    <input type="number" id="yieldLimit" value="5" min="0" max="20" step="0.1">%
                </div>
                <div class="control-group">
                    <label>ç”¢æ¥­ç¯©é¸:</label>
                    <select id="sectorFilter">
                        <option value="">å…¨éƒ¨ç”¢æ¥­</option>
                        <option value="é›»å­">é›»å­</option>
                        <option value="é‡‘è">é‡‘è</option>
                        <option value="èˆªé‹">èˆªé‹</option>
                        <option value="å…‰é€šè¨Š">å…‰é€šè¨Š</option>
                        <option value="å‚³çµ±ç”¢æ¥­">å‚³çµ±ç”¢æ¥­</option>
                    </select>
                </div>
                <button onclick="applyFilters()">ğŸ” ç¯©é¸</button>
                <button onclick="resetFilters()">ğŸ”„ é‡ç½®</button>
                <button onclick="fetchTWSEData()">ğŸ“¡ æ›´æ–°è‚¡åƒ¹</button>
                <button onclick="exportToCSV()">ğŸ’¾ åŒ¯å‡ºCSV</button>
                <button onclick="importCSV()">ğŸ“¥ åŒ¯å…¥CSV</button>
            </div>

            <div class="table-container">
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨ä»£è™Ÿ</th>
                            <th>å…¬å¸åç¨±</th>
                            <th>ç”¢æ¥­</th>
                            <th>è‚¡åƒ¹</th>
                            <th>EPS</th>
                            <th>æœ¬ç›Šæ¯”</th>
                            <th>æ·¨å€¼æ¯”</th>
                            <th>æ®–åˆ©ç‡</th>
                            <th>ç‡Ÿæ”¶YoY</th>
                            <th>åˆç†åƒ¹ä¸‹é™</th>
                            <th>åˆç†åƒ¹ä¸Šé™</th>
                            <th>åƒ¹æ ¼è©•ä¼°</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="stockTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="screening" class="tab-content">
            <h2>ğŸ” é€²éšæ¢ä»¶ç¯©é¸</h2>
            <div class="controls">
                <div class="control-group">
                    <label>EPS ä¸‹é™:</label>
                    <input type="number" id="epsMin" value="2" step="0.1">
                </div>
                <div class="control-group">
                    <label>ç‡Ÿæ”¶æˆé•·ç‡:</label>
                    <input type="number" id="revenueGrowth" value="10">%
                </div>
                <div class="control-group">
                    <label>æ·¨å€¼æ¯”ä¸Šé™:</label>
                    <input type="number" id="pbMax" value="2" step="0.1">
                </div>
                <button onclick="advancedScreening()">ğŸš€ é€²éšç¯©é¸</button>
            </div>
            <div id="screeningResults"></div>
        </div>

        <div id="sectors" class="tab-content">
            <h2>ğŸ¢ ç”¢æ¥­åˆ†æ</h2>
            <div class="sector-analysis" id="sectorAnalysis">
            </div>
        </div>

        <div id="add" class="tab-content">
            <h2>â• æ–°å¢è‚¡ç¥¨</h2>
            <div class="add-stock-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>è‚¡ç¥¨ä»£è™Ÿ</label>
                        <input type="text" id="newCode" placeholder="ä¾‹: 2330">
                    </div>
                    <div class="form-group">
                        <label>å…¬å¸åç¨±</label>
                        <input type="text" id="newName" placeholder="ä¾‹: å°ç©é›»">
                    </div>
                    <div class="form-group">
                        <label>ç”¢æ¥­</label>
                        <select id="newSector">
                            <option value="é›»å­">é›»å­</option>
                            <option value="é‡‘è">é‡‘è</option>
                            <option value="èˆªé‹">èˆªé‹</option>
                            <option value="å…‰é€šè¨Š">å…‰é€šè¨Š</option>
                            <option value="å‚³çµ±ç”¢æ¥­">å‚³çµ±ç”¢æ¥­</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>è‚¡åƒ¹</label>
                        <input type="number" id="newPrice" placeholder="è‚¡åƒ¹" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>EPS</label>
                        <input type="number" id="newEPS" placeholder="æ¯è‚¡ç›ˆé¤˜" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>æ·¨å€¼æ¯”</label>
                        <input type="number" id="newPB" placeholder="PBæ¯”" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>æ®–åˆ©ç‡ (%)</label>
                        <input type="number" id="newYield" placeholder="æ®–åˆ©ç‡" step="0.1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ç‡Ÿæ”¶YoY (%)</label>
                        <input type="number" id="newRevenue" placeholder="ç‡Ÿæ”¶æˆé•·ç‡" step="0.1">
                    </div>
                    <button onclick="addStock()">ğŸ“Š æ–°å¢è‚¡ç¥¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è‚¡ç¥¨æ•¸æ“š - å¯å¾è­‰äº¤æ‰€APIæˆ–GoodInfoå–å¾—
        let stocks = [
            {code: '2330', name: 'å°ç©é›»', sector: 'é›»å­', price: 580, eps: 28.5, pb: 6.2, yield: 2.1, revenue: 15.2},
            {code: '2317', name: 'é´»æµ·', sector: 'é›»å­', price: 105, eps: 8.2, pb: 1.8, yield: 4.8, revenue: 8.5},
            {code: '2881', name: 'å¯Œé‚¦é‡‘', sector: 'é‡‘è', price: 58, eps: 6.5, pb: 0.9, yield: 6.2, revenue: 12.3},
            {code: '2882', name: 'åœ‹æ³°é‡‘', sector: 'é‡‘è', price: 52, eps: 5.8, pb: 0.8, yield: 7.1, revenue: 9.8},
            {code: '2603', name: 'é•·æ¦®', sector: 'èˆªé‹', price: 135, eps: 15.2, pb: 1.2, yield: 8.5, revenue: -5.2},
            {code: '2609', name: 'é™½æ˜', sector: 'èˆªé‹', price: 45, eps: 4.8, pb: 0.7, yield: 9.2, revenue: -12.5},
            {code: '3008', name: 'å¤§ç«‹å…‰', sector: 'å…‰é€šè¨Š', price: 2180, eps: 89.5, pb: 3.2, yield: 3.8, revenue: -8.3},
            {code: '2454', name: 'è¯ç™¼ç§‘', sector: 'é›»å­', price: 820, eps: 42.1, pb: 4.5, yield: 2.9, revenue: 18.7},
            {code: '1301', name: 'å°å¡‘', sector: 'å‚³çµ±ç”¢æ¥­', price: 78, eps: 8.9, pb: 1.1, yield: 6.8, revenue: 5.4},
            {code: '2412', name: 'ä¸­è¯é›»', sector: 'é›»å­', price: 115, eps: 4.9, pb: 1.6, yield: 4.3, revenue: 2.1},
            {code: '2886', name: 'å…†è±é‡‘', sector: 'é‡‘è', price: 35, eps: 3.8, pb: 0.6, yield: 8.1, revenue: 7.6},
            {code: '2002', name: 'ä¸­é‹¼', sector: 'å‚³çµ±ç”¢æ¥­', price: 28, eps: 1.2, pb: 0.8, yield: 5.9, revenue: -3.2}
        ];

        function updateStockPrices(apiData) {
            // æ›´æ–°è‚¡åƒ¹æ•¸æ“šï¼ˆå¯¦éš›ä½¿ç”¨æ™‚éœ€è¦è§£æAPIæ ¼å¼ï¼‰
            apiData.forEach(item => {
                const stock = stocks.find(s => s.code === item.Code);
                if (stock && item.ClosingPrice) {
                    stock.price = parseFloat(item.ClosingPrice);
                }
            });
            renderTable();
        }

        // æ¨¡æ“¬GoodInfoæ•¸æ“šç²å–
        async function fetchGoodInfoData(stockCode) {
            try {
                // æ³¨æ„ï¼šå¯¦éš›ä½¿ç”¨éœ€è¦è™•ç†CORSå’Œåçˆ¬èŸ²æ©Ÿåˆ¶
                console.log(`å˜—è©¦å¾GoodInfoç²å– ${stockCode} çš„æ•¸æ“š...`);
                
                // é€™è£¡æœƒå›å‚³æ¨¡æ“¬æ•¸æ“šï¼Œå¯¦éš›æ‡‰ç”¨éœ€è¦å¾Œç«¯ä»£ç†
                return {
                    eps: Math.random() * 20 + 5,
                    pb: Math.random() * 3 + 0.5,
                    yield: Math.random() * 8 + 2,
                    revenue: (Math.random() - 0.5) * 30
                };
            } catch (error) {
                console.log('GoodInfoæ•¸æ“šç²å–å¤±æ•—:', error);
                return null;
            }
        }

        let filteredStocks = [...stocks];

        // è¨ˆç®—å‡½æ•¸
        function calculatePE(price, eps) {
            return eps > 0 ? (price / eps).toFixed(1) : 'N/A';
        }

        function calculateFairValueLow(eps) {
            return (eps * 8).toFixed(1);
        }

        function calculateFairValueHigh(eps) {
            return (eps * 15).toFixed(1);
        }

        function getValuationStatus(price, eps) {
            const fairLow = eps * 8;
            const fairHigh = eps * 15;
            
            if (price < fairLow) return { text: 'ğŸ“‰ ä½ä¼°', class: 'status-undervalued' };
            if (price > fairHigh) return { text: 'ğŸ“ˆ é«˜ä¼°', class: 'status-overvalued' };
            return { text: 'âš–ï¸ åˆç†', class: 'status-fair' };
        }

        function isQualified(stock, peLimit = 10, yieldLimit = 5) {
            const pe = calculatePE(stock.price, stock.eps);
            return pe !== 'N/A' && parseFloat(pe) < peLimit && stock.yield > yieldLimit;
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';

            filteredStocks.forEach(stock => {
                const pe = calculatePE(stock.price, stock.eps);
                const fairLow = calculateFairValueLow(stock.eps);
                const fairHigh = calculateFairValueHigh(stock.eps);
                const valuation = getValuationStatus(stock.price, stock.eps);
                const qualified = isQualified(stock, parseFloat(document.getElementById('peLimit').value), parseFloat(document.getElementById('yieldLimit').value));

                const row = document.createElement('tr');
                if (qualified) {
                    row.classList.add('highlight');
                }

                row.innerHTML = `
                    <td>${stock.code}</td>
                    <td>${stock.name}</td>
                    <td>${stock.sector}</td>
                    <td>$${stock.price}</td>
                    <td>$${stock.eps}</td>
                    <td>${pe}</td>
                    <td>${stock.pb}</td>
                    <td>${stock.yield}%</td>
                    <td>${stock.revenue}%</td>
                    <td>$${fairLow}</td>
                    <td>$${fairHigh}</td>
                    <td class="${valuation.class}">${valuation.text}</td>
                    <td>${qualified ? 'âœ… å€¼å¾—é—œæ³¨' : 'â³ è§€å¯Ÿä¸­'}</td>
                `;

                tbody.appendChild(row);
            });

            updateStats();
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            const totalStocks = filteredStocks.length;
            const qualifiedStocks = filteredStocks.filter(stock => 
                isQualified(stock, parseFloat(document.getElementById('peLimit').value), parseFloat(document.getElementById('yieldLimit').value))
            ).length;
            
            const avgPE = filteredStocks.reduce((sum, stock) => {
                const pe = parseFloat(calculatePE(stock.price, stock.eps));
                return sum + (isNaN(pe) ? 0 : pe);
            }, 0) / totalStocks;

            const avgYield = filteredStocks.reduce((sum, stock) => sum + stock.yield, 0) / totalStocks;

            document.getElementById('totalStocks').textContent = totalStocks;
            document.getElementById('qualifiedStocks').textContent = qualifiedStocks;
            document.getElementById('avgPE').textContent = avgPE.toFixed(1);
            document.getElementById('avgYield').textContent = avgYield.toFixed(1) + '%';
        }

        // ç¯©é¸åŠŸèƒ½
        function applyFilters() {
            const sectorFilter = document.getElementById('sectorFilter').value;
            
            filteredStocks = stocks.filter(stock => {
                return !sectorFilter || stock.sector === sectorFilter;
            });

            renderTable();
        }

        function resetFilters() {
            document.getElementById('sectorFilter').value = '';
            filteredStocks = [...stocks];
            renderTable();
        }

        // é€²éšç¯©é¸
        function advancedScreening() {
            const epsMin = parseFloat(document.getElementById('epsMin').value) || 0;
            const revenueGrowth = parseFloat(document.getElementById('revenueGrowth').value) || 0;
            const pbMax = parseFloat(document.getElementById('pbMax').value) || 999;

            const results = stocks.filter(stock => 
                stock.eps >= epsMin && 
                stock.revenue >= revenueGrowth && 
                stock.pb <= pbMax
            );

            const resultsDiv = document.getElementById('screeningResults');
            resultsDiv.innerHTML = `
                <h3>ç¯©é¸çµæœ (${results.length} æª”è‚¡ç¥¨)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨</th>
                                <th>EPS</th>
                                <th>ç‡Ÿæ”¶YoY</th>
                                <th>æ·¨å€¼æ¯”</th>
                                <th>è©•ä¼°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${results.map(stock => `
                                <tr>
                                    <td>${stock.code} ${stock.name}</td>
                                    <td>$${stock.eps}</td>
                                    <td>${stock.revenue}%</td>
                                    <td>${stock.pb}</td>
                                    <td class="${getValuationStatus(stock.price, stock.eps).class}">
                                        ${getValuationStatus(stock.price, stock.eps).text}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ç”¢æ¥­åˆ†æ
        function renderSectorAnalysis() {
            const sectorCounts = {};
            stocks.forEach(stock => {
                sectorCounts[stock.sector] = (sectorCounts[stock.sector] || 0) + 1;
            });

            const sectorDiv = document.getElementById('sectorAnalysis');
            sectorDiv.innerHTML = Object.entries(sectorCounts).map(([sector, count]) => `
                <div class="sector-card">
                    <div class="sector-name">${sector}</div>
                    <div class="sector-count">${count} æª”</div>
                </div>
            `).join('');
        }

        // æ–°å¢è‚¡ç¥¨
        function addStock() {
            const newStock = {
                code: document.getElementById('newCode').value,
                name: document.getElementById('newName').value,
                sector: document.getElementById('newSector').value,
                price: parseFloat(document.getElementById('newPrice').value),
                eps: parseFloat(document.getElementById('newEPS').value),
                pb: parseFloat(document.getElementById('newPB').value),
                yield: parseFloat(document.getElementById('newYield').value),
                revenue: parseFloat(document.getElementById('newRevenue').value)
            };

            if (newStock.code && newStock.name && !isNaN(newStock.price)) {
                stocks.push(newStock);
                filteredStocks = [...stocks];
                renderTable();
                renderSectorAnalysis();
                
                // æ¸…ç©ºè¡¨å–®
                ['newCode', 'newName', 'newPrice', 'newEPS', 'newPB', 'newYield', 'newRevenue'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                
                alert('âœ… è‚¡ç¥¨æ–°å¢æˆåŠŸï¼');
            } else {
                alert('âŒ è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
            }
        }

        // æ¨™ç±¤åˆ‡æ›
        function showTab(tabName) {
            // éš±è—æ‰€æœ‰å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ¨™ç±¤æ´»å‹•ç‹€æ…‹
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„å…§å®¹
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // ç‰¹æ®Šè™•ç†
            if (tabName === 'sectors') {
                renderSectorAnalysis();
            }
        }

        // åŒ¯å‡ºCSVåŠŸèƒ½
        function exportToCSV() {
            const headers = ['è‚¡ç¥¨ä»£è™Ÿ', 'å…¬å¸åç¨±', 'ç”¢æ¥­', 'è‚¡åƒ¹', 'EPS', 'æœ¬ç›Šæ¯”', 'æ·¨å€¼æ¯”', 'æ®–åˆ©ç‡', 'ç‡Ÿæ”¶YoY', 'åˆç†åƒ¹ä¸‹é™', 'åˆç†åƒ¹ä¸Šé™', 'åƒ¹æ ¼è©•ä¼°', 'ç‹€æ…‹'];
            
            let csvContent = headers.join(',') + '\n';
            
            filteredStocks.forEach(stock => {
                const pe = calculatePE(stock.price, stock.eps);
                const fairLow = calculateFairValueLow(stock.eps);
                const fairHigh = calculateFairValueHigh(stock.eps);
                const valuation = getValuationStatus(stock.price, stock.eps);
                const qualified = isQualified(stock, parseFloat(document.getElementById('peLimit').value), parseFloat(document.getElementById('yieldLimit').value));
                
                const row = [
                    stock.code,
                    stock.name,
                    stock.sector,
                    stock.price,
                    stock.eps,
                    pe,
                    stock.pb,
                    stock.yield + '%',
                    stock.revenue + '%',
                    fairLow,
                    fairHigh,
                    valuation.text.replace(/ğŸ“‰|ğŸ“ˆ|âš–ï¸/g, '').trim(),
                    qualified ? 'å€¼å¾—é—œæ³¨' : 'è§€å¯Ÿä¸­'
                ];
                
                csvContent += row.join(',') + '\n';
            });

            // ä¸‹è¼‰CSVæª”æ¡ˆ
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è‚¡ç¥¨åˆ†æ_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // æ‰¹é‡æ›´æ–°è‚¡ç¥¨æ•¸æ“š
        async function updateMultipleStocks() {
            const stockCodes = stocks.map(stock => stock.code);
            const updatePromises = stockCodes.map(code => fetchGoodInfoData(code));
            
            try {
                const results = await Promise.all(updatePromises);
                results.forEach((data, index) => {
                    if (data) {
                        stocks[index] = { ...stocks[index], ...data };
                    }
                });
                renderTable();
                alert('âœ… è‚¡ç¥¨æ•¸æ“šæ›´æ–°å®Œæˆï¼');
            } catch (error) {
                console.log('æ‰¹é‡æ›´æ–°å¤±æ•—:', error);
            }
        }
        // åˆå§‹åŒ–
        window.onload = function() {
            renderTable();
            renderSectorAnalysis();
            
            // ç¶å®šç¯©é¸æ¢ä»¶è®Šæ›´äº‹ä»¶
            ['peLimit', 'yieldLimit'].forEach(id => {
                document.getElementById(id).addEventListener('change', renderTable);
            });
        };

        // åŒ¯å‡ºCSVåŠŸèƒ½
        function exportToCSV() {
            const headers = ['è‚¡ç¥¨ä»£è™Ÿ', 'å…¬å¸åç¨±', 'ç”¢æ¥­', 'è‚¡åƒ¹', 'EPS', 'æœ¬ç›Šæ¯”', 'æ·¨å€¼æ¯”', 'æ®–åˆ©ç‡', 'ç‡Ÿæ”¶YoY', 'åˆç†åƒ¹ä¸‹é™', 'åˆç†åƒ¹ä¸Šé™', 'åƒ¹æ ¼è©•ä¼°', 'ç‹€æ…‹'];
            
            let csvContent = headers.join(',') + '\n';
            
            filteredStocks.forEach(stock => {
                const pe = calculatePE(stock.price, stock.eps);
                const fairLow = calculateFairValueLow(stock.eps);
                const fairHigh = calculateFairValueHigh(stock.eps);
                const valuation = getValuationStatus(stock.price, stock.eps);
                const qualified = isQualified(stock, parseFloat(document.getElementById('peLimit').value), parseFloat(document.getElementById('yieldLimit').value));
                
                const row = [
                    stock.code,
                    stock.name,
                    stock.sector,
                    stock.price,
                    stock.eps,
                    pe,
                    stock.pb,
                    stock.yield + '%',
                    stock.revenue + '%',
                    fairLow,
                    fairHigh,
                    valuation.text.replace(/ğŸ“‰|ğŸ“ˆ|âš–ï¸/g, '').trim(),
                    qualified ? 'å€¼å¾—é—œæ³¨' : 'è§€å¯Ÿä¸­'
                ];
                
                csvContent += row.join(',') + '\n';
            });

            // ä¸‹è¼‰CSVæª”æ¡ˆ
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `è‚¡ç¥¨åˆ†æ_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // æ•¸æ“šç²å–åŠŸèƒ½ - è§£æ±ºCORSå•é¡Œ
        async function fetchTWSEData() {
            try {
                // æ–¹æ¡ˆ1: ä½¿ç”¨CORSä»£ç†æœå‹™
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = 'https://openapi.twse.com.tw/v1/exchangeReport/STOCK_DAY_ALL';
                
                console.log('æ­£åœ¨ç²å–è­‰äº¤æ‰€æ•¸æ“š...');
                
                // æ³¨æ„ï¼šcors-anywhereéœ€è¦å…ˆè¨ªå•å•Ÿç”¨é é¢
                // å¯¦éš›æ‡‰ç”¨å»ºè­°ä½¿ç”¨è‡ªå·±çš„å¾Œç«¯ä»£ç†
                const response = await fetch(proxyUrl + targetUrl, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('APIè«‹æ±‚å¤±æ•—');
                }
                
                const data = await response.json();
                console.log('è­‰äº¤æ‰€æ•¸æ“šç²å–æˆåŠŸ:', data.length, 'ç­†è³‡æ–™');
                updateStockPrices(data);
                
            } catch (error) {
                console.log('APIè«‹æ±‚å¤±æ•—ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“šæ›´æ–°:', error.message);
                
                // æ¨¡æ“¬çœŸå¯¦å¸‚å ´æ³¢å‹•
                stocks.forEach(stock => {
                    const volatility = 0.03; // 3%æ³¢å‹•
                    const change = (Math.random() - 0.5) * 2 * volatility;
                    stock.price *= (1 + change);
                    stock.price = Math.round(stock.price * 100) / 100;
                });
                
                renderTable();
                
                // é¡¯ç¤ºCORSè§£æ±ºæ–¹æ¡ˆæç¤º
                showCORSDialog();
            }
        }

        function showCORSDialog() {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                z-index: 1000; max-width: 500px; text-align: center;
            `;
            
            dialog.innerHTML = `
                <h3 style="color: #e74c3c; margin-bottom: 15px;">ğŸš« CORS æ”¿ç­–é™åˆ¶</h3>
                <p style="margin-bottom: 20px; line-height: 1.6;">
                    ç€è¦½å™¨é˜»æ­¢äº†ç›´æ¥å­˜å–è­‰äº¤æ‰€APIã€‚<br>
                    <strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong>
                </p>
                <div style="text-align: left; margin-bottom: 20px;">
                    <p><strong>1. ä½¿ç”¨ç€è¦½å™¨æ“´å……åŠŸèƒ½ï¼š</strong></p>
                    <p style="margin-left: 20px;">â€¢ å®‰è£ "CORS Unblock" æ“´å……åŠŸèƒ½</p>
                    <p style="margin-left: 20px;">â€¢ æš«æ™‚é—œé–‰CORSæª¢æŸ¥</p>
                    
                    <p style="margin-top: 15px;"><strong>2. å»ºç«‹å¾Œç«¯ä»£ç†ï¼š</strong></p>
                    <p style="margin-left: 20px;">â€¢ Node.js/Python ä»£ç†ä¼ºæœå™¨</p>
                    <p style="margin-left: 20px;">â€¢ è§£æ±ºCORSä¸¦è™•ç†åçˆ¬èŸ²</p>
                    
                    <p style="margin-top: 15px;"><strong>3. æ‰‹å‹•åŒ¯å…¥ï¼š</strong></p>
                    <p style="margin-left: 20px;">â€¢ å¾GoodInfoè¤‡è£½æ•¸æ“š</p>
                    <p style="margin-left: 20px;">â€¢ ä½¿ç”¨CSVåŒ¯å…¥åŠŸèƒ½</p>
                </div>
                <button onclick="this.parentElement.remove()" style="background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">äº†è§£</button>
            `;
            
            document.body.appendChild(dialog);
            
            // 3ç§’å¾Œè‡ªå‹•é—œé–‰
            setTimeout(() => {
                if (dialog.parentElement) {
                    dialog.remove();
                }
            }, 10000);
        }

        // CSVåŒ¯å…¥åŠŸèƒ½
        function importCSV() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        parseCSVData(e.target.result);
                    };
                    reader.readAsText(file, 'UTF-8');
                }
            };
            input.click();
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            
            const newStocks = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= 8) {
                    newStocks.push({
                        code: values[0],
                        name: values[1],
                        sector: values[2],
                        price: parseFloat(values[3]) || 0,
                        eps: parseFloat(values[4]) || 0,
                        pb: parseFloat(values[6]) || 0,
                        yield: parseFloat(values[7].replace('%', '')) || 0,
                        revenue: parseFloat(values[8].replace('%', '')) || 0
                    });
                }
            }
            
            if (newStocks.length > 0) {
                stocks.push(...newStocks);
                filteredStocks = [...stocks];
                renderTable();
                renderSectorAnalysis();
                alert(`âœ… æˆåŠŸåŒ¯å…¥ ${newStocks.length} æª”è‚¡ç¥¨ï¼`);
            }
        }
    </script>
</body>
</html>