<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ’» TypeScript ç¥ç¶“ç¶²è·¯æ•™å­¸</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;overflow-x:hidden}
body{font-family:'Segoe UI',sans-serif;background:linear-gradient(160deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:12px}

h1{color:#fff;text-align:center;font-size:clamp(1.3rem,6vw,2rem);text-shadow:0 2px 8px rgba(0,0,0,0.25);margin-bottom:3px}
.subtitle{color:rgba(255,255,255,0.9);text-align:center;font-size:clamp(0.78rem,3.5vw,1rem);margin-bottom:14px}

.card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,0.13);padding:14px;margin-bottom:12px}
h2{color:#667eea;font-size:clamp(0.95rem,4.5vw,1.25rem);margin-bottom:10px;display:flex;align-items:center;gap:6px}
h3{color:#764ba2;font-size:clamp(0.85rem,3.5vw,1rem);margin-bottom:8px}

/* å•é¡Œé¸æ“‡ */
.problems{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.pbtn{padding:12px 4px;border:2px solid #eee;border-radius:12px;background:#fafafa;cursor:pointer;text-align:center;transition:all .2s;font-size:clamp(0.7rem,3vw,0.9rem);color:#555;font-weight:600;touch-action:manipulation}
.pbtn .emo{font-size:clamp(1.4rem,5vw,1.8rem);display:block;margin-bottom:4px}
.pbtn:active{transform:scale(.94)}
.pbtn.active{border-color:#667eea;background:linear-gradient(135deg,#e8eaff,#d8d0f8);color:#667eea;font-weight:700}

/* Canvas */
#nn-canvas{width:100%;display:block;border-radius:12px;background:#0d1117}

/* è¨“ç·´è³‡æ–™è¡¨æ ¼ */
.truth-table{width:100%;border-collapse:collapse;font-size:clamp(0.72rem,3vw,0.92rem)}
.truth-table th{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:8px 6px;text-align:center;font-weight:600}
.truth-table td{padding:8px 6px;text-align:center;border-bottom:1px solid #f0e6ff}
.truth-table tr:last-child td{border-bottom:none}
.truth-table tr:nth-child(even) td{background:#f8f6ff}
.val-0{color:#e53935;font-weight:700;font-size:1.1em}
.val-1{color:#2e7d32;font-weight:700;font-size:1.1em}

/* è¨“ç·´æ§åˆ¶ */
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.btn{padding:13px 6px;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:clamp(0.82rem,3.5vw,1rem);transition:all .2s;color:#fff;touch-action:manipulation}
.btn:active{transform:scale(.96)}
.btn-one{background:linear-gradient(135deg,#667eea,#764ba2)}
.btn-auto{background:linear-gradient(135deg,#f093fb,#f5576c)}
.btn-reset{background:linear-gradient(135deg,#a18cd1,#fbc2eb);color:#fff;grid-column:1/-1}
.stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.stat-box{background:linear-gradient(135deg,#e8eaff,#d8d0f8);border-radius:10px;padding:10px;text-align:center}
.stat-lbl{font-size:clamp(0.65rem,2.5vw,0.8rem);color:#aaa;margin-bottom:3px}
.stat-val{font-size:clamp(1.1rem,5vw,1.6rem);font-weight:900;color:#667eea}

/* é€²åº¦æ¢ */
.progress-wrap{margin-top:10px}
.progress-lbl{display:flex;justify-content:space-between;font-size:clamp(0.72rem,3vw,0.88rem);color:#888;margin-bottom:4px}
.progress-bar{height:10px;background:#e8eaff;border-radius:6px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#667eea,#764ba2);border-radius:6px;transition:width .3s;width:0%}

/* æ¸¬è©¦å€ */
.test-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.input-box{background:#f8f6ff;border-radius:10px;padding:12px;text-align:center;cursor:pointer;border:2px solid #e0d8f8;transition:all .2s;touch-action:manipulation}
.input-box:active{transform:scale(.96)}
.input-box.on{background:linear-gradient(135deg,#667eea,#764ba2);border-color:#667eea}
.input-box .inp-lbl{font-size:clamp(0.72rem,3vw,0.9rem);color:#888;margin-bottom:6px}
.input-box.on .inp-lbl{color:rgba(255,255,255,.8)}
.input-box .inp-val{font-size:clamp(1.4rem,6vw,2rem);font-weight:900;color:#667eea}
.input-box.on .inp-val{color:#fff}
.predict-btn{width:100%;padding:15px;border:none;border-radius:12px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:700;font-size:clamp(1rem,4.5vw,1.2rem);cursor:pointer;box-shadow:0 4px 15px rgba(102,126,234,0.4);touch-action:manipulation;transition:all .2s}
.predict-btn:active{transform:scale(.97)}

/* çµæœé¡¯ç¤º */
.result-box{border-radius:12px;padding:16px;text-align:center;margin-top:12px;display:none;border:2px solid transparent;animation:pop .3s ease}
.result-box.show{display:block}
.r-emo{font-size:clamp(2rem,10vw,3rem);margin-bottom:6px}
.r-text{font-size:clamp(1.1rem,5vw,1.5rem);font-weight:700;margin-bottom:5px}
.r-pct{font-size:clamp(1.3rem,6vw,1.8rem);font-weight:900;margin-bottom:8px}
.r-detail{font-size:clamp(0.75rem,3vw,0.9rem);line-height:1.7;background:rgba(255,255,255,.75);border-radius:8px;padding:10px;color:#555;text-align:left}

/* ç¨‹å¼ç¢¼å€å¡Š */
.code-tabs{display:flex;gap:4px;margin-bottom:8px;overflow-x:auto;padding-bottom:2px}
.ctab{padding:7px 14px;border:none;border-radius:8px 8px 0 0;background:#e8eaff;color:#667eea;font-weight:600;cursor:pointer;font-size:clamp(0.72rem,3vw,0.88rem);white-space:nowrap;touch-action:manipulation;transition:all .2s}
.ctab.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.code-block{display:none;background:#0d1117;border-radius:0 8px 8px 8px;padding:14px;overflow-x:auto}
.code-block.show{display:block}
pre{font-family:'Courier New',monospace;font-size:clamp(0.65rem,2.5vw,0.82rem);line-height:1.7;color:#e6edf3;tab-size:2}
/* èªæ³•é«˜äº® */
.kw{color:#ff7b72}
.tp{color:#ffa657}
.fn{color:#d2a8ff}
.cm{color:#8b949e;font-style:italic}
.st{color:#a5d6ff}
.nm{color:#79c0ff}
.op{color:#ff7b72}

/* èªªæ˜æ­¥é©Ÿ */
.steps{display:grid;gap:10px}
.step{display:flex;gap:10px;align-items:flex-start;padding:10px;background:#f8f6ff;border-radius:10px;border-left:3px solid #667eea}
.step-num{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-weight:900;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:0.9rem;flex-shrink:0}
.step-text h4{color:#333;font-weight:700;margin-bottom:3px;font-size:clamp(0.85rem,3.5vw,1rem)}
.step-text p{color:#888;font-size:clamp(0.72rem,2.8vw,0.88rem);line-height:1.5}
.formula{background:#1a1a2e;color:#79c0ff;border-radius:8px;padding:8px 12px;font-family:'Courier New',monospace;font-size:clamp(0.65rem,2.5vw,0.82rem);margin-top:6px;overflow-x:auto;white-space:nowrap}

@keyframes pop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.pulsing{animation:pulse 1s infinite}
</style>
</head>
<body>

<h1>ğŸ’» TypeScript ç¥ç¶“ç¶²è·¯</h1>
<p class="subtitle">æœ€å°åŒ–å¯¦ä½œï¼š2 è¼¸å…¥ â†’ 4 éš±è— â†’ 1 è¼¸å‡º</p>

<!-- å•é¡Œé¸æ“‡ -->
<div class="card">
  <h2>ğŸ¯ é¸æ“‡é‚è¼¯å•é¡Œ</h2>
  <div class="problems" id="problems"></div>
  <p id="prob-desc" style="margin-top:10px;color:#888;font-size:clamp(0.75rem,3vw,0.9rem);line-height:1.6"></p>
</div>

<!-- ç¥ç¶“ç¶²è·¯è¦–è¦ºåŒ– -->
<div class="card">
  <h2>ğŸ§  ç¥ç¶“ç¶²è·¯çµæ§‹ï¼ˆå³æ™‚ï¼‰</h2>
  <canvas id="nn-canvas"></canvas>
</div>

<!-- çœŸå€¼è¡¨ -->
<div class="card">
  <h2 id="table-title">ğŸ“Š çœŸå€¼è¡¨</h2>
  <table class="truth-table" id="truth-table"></table>
</div>

<!-- è¨“ç·´ -->
<div class="card">
  <h2>ğŸ® è¨“ç·´ç¥ç¶“ç¶²è·¯</h2>
  <div class="btn-row">
    <button class="btn btn-one" onclick="trainOnce()">ğŸ“š å­¸ç¿’ä¸€è¼ª</button>
    <button class="btn btn-auto" id="auto-btn" onclick="toggleAuto()">ğŸš€ å¿«é€Ÿè¨“ç·´</button>
    <button class="btn btn-reset" onclick="resetNN()">ğŸ”„ é‡ç½®ç¶²è·¯</button>
  </div>
  <div class="stats">
    <div class="stat-box"><div class="stat-lbl">è¨“ç·´è¼ªæ•¸</div><div class="stat-val" id="epoch-val">0</div></div>
    <div class="stat-box"><div class="stat-lbl">å¹³å‡èª¤å·®</div><div class="stat-val" id="err-val">-.--</div></div>
    <div class="stat-box"><div class="stat-lbl">æº–ç¢ºåº¦</div><div class="stat-val" id="acc-val">0%</div></div>
  </div>
  <div class="progress-wrap">
    <div class="progress-lbl"><span>å­¸ç¿’é€²åº¦</span><span id="prog-txt">0%</span></div>
    <div class="progress-bar"><div class="progress-fill" id="prog-fill"></div></div>
  </div>
</div>

<!-- æ¸¬è©¦ -->
<div class="card">
  <h2>ğŸ§ª æ¸¬è©¦é æ¸¬</h2>
  <p style="color:#888;font-size:clamp(0.75rem,3vw,0.9rem);margin-bottom:10px">é»æ“Šåˆ‡æ› 0 / 1</p>
  <div class="test-grid">
    <div class="input-box" id="inp-a" onclick="toggleInput('a')">
      <div class="inp-lbl" id="lbl-a">è¼¸å…¥ A</div>
      <div class="inp-val" id="val-a">0</div>
    </div>
    <div class="input-box" id="inp-b" onclick="toggleInput('b')">
      <div class="inp-lbl" id="lbl-b">è¼¸å…¥ B</div>
      <div class="inp-val" id="val-b">0</div>
    </div>
  </div>
  <button class="predict-btn" onclick="predict()">ğŸ” AI é æ¸¬çµæœ</button>
  <div class="result-box" id="result-box">
    <div class="r-emo" id="r-emo"></div>
    <div class="r-text" id="r-text"></div>
    <div class="r-pct" id="r-pct"></div>
    <div class="r-detail" id="r-detail"></div>
  </div>
</div>

<!-- ç¨‹å¼ç¢¼ -->
<div class="card">
  <h2>ğŸ“ TypeScript æ ¸å¿ƒç¨‹å¼ç¢¼</h2>
  <div class="code-tabs">
    <button class="ctab active" onclick="showCode(0)">é¡åˆ¥å®šç¾©</button>
    <button class="ctab" onclick="showCode(1)">å‰å‘å‚³æ’­</button>
    <button class="ctab" onclick="showCode(2)">åå‘å‚³æ’­</button>
    <button class="ctab" onclick="showCode(3)">å®Œæ•´è¨“ç·´</button>
  </div>
  <div class="code-block show" id="code-0"><pre id="pre-0"></pre></div>
  <div class="code-block" id="code-1"><pre id="pre-1"></pre></div>
  <div class="code-block" id="code-2"><pre id="pre-2"></pre></div>
  <div class="code-block" id="code-3"><pre id="pre-3"></pre></div>
</div>

<!-- å­¸ç¿’æ­¥é©Ÿ -->
<div class="card">
  <h2>ğŸ“– ç¥ç¶“ç¶²è·¯å­¸ç¿’åŸç†</h2>
  <div class="steps">
    <div class="step">
      <div class="step-num">1</div>
      <div class="step-text">
        <h4>å‰å‘å‚³æ’­ Forward Pass</h4>
        <p>è¼¸å…¥è³‡æ–™å¾å·¦åˆ°å³æµéç¶²è·¯ï¼Œæ¯å€‹ç¥ç¶“å…ƒè¨ˆç®—åŠ æ¬Šç¸½å’Œå¾Œé€šé Sigmoid å‡½æ•¸</p>
        <div class="formula">output = sigmoid( Î£(weight Ã— input) + bias )</div>
      </div>
    </div>
    <div class="step">
      <div class="step-num">2</div>
      <div class="step-text">
        <h4>è¨ˆç®—æå¤± Loss</h4>
        <p>æ¯”è¼ƒé æ¸¬å€¼å’ŒçœŸå¯¦ç­”æ¡ˆçš„å·®è·ï¼Œèª¤å·®è¶Šå°ä»£è¡¨å­¸å¾—è¶Šå¥½</p>
        <div class="formula">error = target - output</div>
      </div>
    </div>
    <div class="step">
      <div class="step-num">3</div>
      <div class="step-text">
        <h4>åå‘å‚³æ’­ Backpropagation</h4>
        <p>èª¤å·®å¾å³åˆ°å·¦å‚³å›ï¼Œè¨ˆç®—æ¯å€‹æ¬Šé‡å°èª¤å·®çš„è²¢ç»ï¼ˆæ¢¯åº¦ï¼‰</p>
        <div class="formula">delta = error Ã— sigmoid'(output)</div>
      </div>
    </div>
    <div class="step">
      <div class="step-num">4</div>
      <div class="step-text">
        <h4>æ›´æ–°æ¬Šé‡ Update Weights</h4>
        <p>æ ¹æ“šæ¢¯åº¦èª¿æ•´æ‰€æœ‰æ¬Šé‡ï¼Œå­¸ç¿’ç‡æ§åˆ¶æ¯æ¬¡èª¿æ•´çš„å¹…åº¦</p>
        <div class="formula">weight += learningRate Ã— delta Ã— input</div>
      </div>
    </div>
    <div class="step">
      <div class="step-num">5</div>
      <div class="step-text">
        <h4>é‡è¤‡è¿­ä»£ Iterate</h4>
        <p>ä¸æ–·é‡è¤‡ 1-4 æ­¥é©Ÿï¼Œç›´åˆ°èª¤å·®è¶³å¤ å°ï¼Œç¶²è·¯å°±ã€Œå­¸æœƒäº†ã€</p>
        <div class="formula">repeat until error &lt; threshold</div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// TypeScript é¢¨æ ¼çš„ç¥ç¶“ç¶²è·¯ï¼ˆç·¨è­¯æˆ JS åŸ·è¡Œï¼‰
// é€™å°±æ˜¯ TypeScript ç¨‹å¼ç¢¼å¯¦éš›é‹ä½œçš„æ¨£å­ï¼
// ============================================================

// --- é¡åˆ¥å®šç¾©ï¼ˆå°æ‡‰ TypeScript classï¼‰---
class NeuralNetwork {
  constructor(inputSize, hiddenSize, outputSize, learningRate = 0.5) {
    this.lr = learningRate;
    // number[][] äºŒç¶­çŸ©é™£
    this.w1 = this.randMatrix(inputSize, hiddenSize);
    this.w2 = this.randMatrix(hiddenSize, outputSize);
    // number[] åå·®å‘é‡
    this.b1 = this.randArray(hiddenSize);
    this.b2 = this.randArray(outputSize);
    // æš«å­˜å‰å‘å‚³æ’­çµæœ
    this.H = new Array(hiddenSize).fill(0);
    this.O = new Array(outputSize).fill(0);
  }

  // åˆå§‹åŒ–éš¨æ©ŸçŸ©é™£ (-1 ~ 1)
  randMatrix(rows, cols) {
    return Array.from({length: rows}, () =>
      Array.from({length: cols}, () => Math.random() * 2 - 1)
    );
  }

  // åˆå§‹åŒ–éš¨æ©Ÿé™£åˆ—
  randArray(size) {
    return Array.from({length: size}, () => Math.random() * 2 - 1);
  }

  // Sigmoid æ¿€æ´»å‡½æ•¸ï¼šæŠŠä»»æ„æ•¸å£“ç¸®åˆ° 0~1
  sigmoid(x) { return 1 / (1 + Math.exp(-x)); }

  // Sigmoid å°æ•¸ï¼šç”¨æ–¼åå‘å‚³æ’­
  sigmoidDerivative(x) { return x * (1 - x); }

  // å‰å‘å‚³æ’­ï¼šinput â†’ hidden â†’ output
  forward(input) {
    // è¨ˆç®—éš±è—å±¤ï¼šæ¯å€‹éš±è—ç¥ç¶“å…ƒ = sigmoid(åŠ æ¬Šç¸½å’Œ + åå·®)
    this.H = this.b1.map((bias, i) => {
      const sum = input.reduce((acc, val, j) => acc + val * this.w1[j][i], bias);
      return this.sigmoid(sum);
    });
    // è¨ˆç®—è¼¸å‡ºå±¤
    this.O = this.b2.map((bias, i) => {
      const sum = this.H.reduce((acc, val, j) => acc + val * this.w2[j][i], bias);
      return this.sigmoid(sum);
    });
    return this.O;
  }

  // åå‘å‚³æ’­ï¼šè¨ˆç®—æ¢¯åº¦ä¸¦æ›´æ–°æ¬Šé‡
  train(input, target) {
    const output = this.forward(input);

    // 1. è¼¸å‡ºå±¤èª¤å·®å’Œ delta
    const outErr = output.map((o, i) => target[i] - o);
    const outDelta = output.map((o, i) => outErr[i] * this.sigmoidDerivative(o));

    // 2. éš±è—å±¤èª¤å·®å’Œ deltaï¼ˆç”±è¼¸å‡ºå±¤åå‚³ï¼‰
    const hidErr = this.H.map((_, i) =>
      outDelta.reduce((acc, d, j) => acc + d * this.w2[i][j], 0)
    );
    const hidDelta = this.H.map((h, i) => hidErr[i] * this.sigmoidDerivative(h));

    // 3. æ›´æ–°è¼¸å‡ºå±¤æ¬Šé‡: w += lr Ã— delta Ã— hidden_value
    this.w2.forEach((row, i) =>
      row.forEach((_, j) => { this.w2[i][j] += this.lr * outDelta[j] * this.H[i]; })
    );
    // 4. æ›´æ–°éš±è—å±¤æ¬Šé‡: w += lr Ã— delta Ã— input_value
    this.w1.forEach((row, i) =>
      row.forEach((_, j) => { this.w1[i][j] += this.lr * hidDelta[j] * input[i]; })
    );
    // 5. æ›´æ–°åå·®
    this.b2 = this.b2.map((b, i) => b + this.lr * outDelta[i]);
    this.b1 = this.b1.map((b, i) => b + this.lr * hidDelta[i]);

    return Math.abs(outErr[0]);
  }

  predict(input) { return this.forward(input)[0]; }
}

// ============ å•é¡Œå®šç¾© ============
const PROBLEMS = [
  {
    id:'xor', emoji:'âš¡', name:'XOR',
    desc:'ã€Œç•°æˆ–ã€å•é¡Œï¼šå…©å€‹è¼¸å…¥ä¸åŒæ™‚è¼¸å‡º1ï¼Œç›¸åŒæ™‚è¼¸å‡º0ã€‚é€™æ˜¯ç¥ç¶“ç¶²è·¯æœ€ç¶“å…¸çš„æ¸¬è©¦â€”â€”ç·šæ€§æ¨¡å‹ç„¡æ³•è§£æ±ºï¼Œå¿…é ˆé éš±è—å±¤ï¼',
    lblA:'è¼¸å…¥ A', lblB:'è¼¸å…¥ B',
    data:[{a:0,b:0,y:0},{a:0,b:1,y:1},{a:1,b:0,y:1},{a:1,b:1,y:0}]
  },
  {
    id:'and', emoji:'ğŸ”—', name:'AND',
    desc:'ã€Œä¸”ã€å•é¡Œï¼šå…©å€‹è¼¸å…¥éƒ½æ˜¯1æ™‚æ‰è¼¸å‡º1ï¼Œå¦å‰‡è¼¸å‡º0ã€‚å°±åƒã€Œæœ‰éŒ¢ä¸”æœ‰æ™‚é–“æ‰å»æ—…éŠã€ã€‚',
    lblA:'è¼¸å…¥ A', lblB:'è¼¸å…¥ B',
    data:[{a:0,b:0,y:0},{a:0,b:1,y:0},{a:1,b:0,y:0},{a:1,b:1,y:1}]
  },
  {
    id:'or', emoji:'ğŸ”€', name:'OR',
    desc:'ã€Œæˆ–ã€å•é¡Œï¼šå…©å€‹è¼¸å…¥è‡³å°‘æœ‰ä¸€å€‹æ˜¯1æ™‚è¼¸å‡º1ã€‚å°±åƒã€Œæœ‰éŒ¢æˆ–æœ‰æ™‚é–“å°±å»æ—…éŠã€ã€‚',
    lblA:'è¼¸å…¥ A', lblB:'è¼¸å…¥ B',
    data:[{a:0,b:0,y:0},{a:0,b:1,y:1},{a:1,b:0,y:1},{a:1,b:1,y:1}]
  }
];

// ============ ç‹€æ…‹ ============
let nn = new NeuralNetwork(2, 4, 1, 0.5);
let probIdx = 0, epoch = 0, autoTimer = null, isAuto = false;
let inputA = 0, inputB = 0;

const cvs = document.getElementById('nn-canvas');
const cx = cvs.getContext('2d');

// ============ ç•«å¸ƒ ============
function resizeCanvas() {
  cvs.width = cvs.parentElement.clientWidth - 28;
  cvs.height = Math.max(260, Math.round(cvs.width * 0.52));
  redraw();
}

function redraw() {
  nn.forward([inputA, inputB]);
  drawNN([inputA, inputB], nn.H, nn.O);
  updateTruthTable();
}

function drawNN(inp, hid, out) {
  const W = cvs.width, H = cvs.height;
  cx.clearRect(0, 0, W, H);
  cx.fillStyle = '#0d1117';
  cx.fillRect(0, 0, W, H);

  const layerX = [W*.1, W*.37, W*.63, W*.9];
  const sizes = [2, 4, 4, 1];
  const clrs = ['#79c0ff','#d2a8ff','#ffa657','#56d364'];
  const vals = [inp, hid.slice(0,4), hid.slice(0,4), out];
  const topPad = H*.18, botPad = H*.15;
  const usable = H - topPad - botPad;

  function ny(li, ni) {
    const gap = usable / sizes[li];
    return topPad + gap * ni + gap / 2;
  }

  const R = Math.max(8, Math.min(16, W*.028));
  const fs = Math.max(8, Math.min(11, W*.022));

  // é€£ç·š
  for (let li = 0; li < 3; li++) {
    for (let i = 0; i < sizes[li]; i++) {
      for (let j = 0; j < sizes[li+1]; j++) {
        const v = vals[li][i] || 0;
        const w2val = li === 1 ? (nn.w2[i] ? nn.w2[i][0] : 0) : 0;
        const bright = li === 1 ? Math.abs(w2val) * .4 : v * .45;
        cx.beginPath();
        cx.moveTo(layerX[li], ny(li,i));
        cx.lineTo(layerX[li+1], ny(li+1,j));
        cx.strokeStyle = li === 1
          ? `rgba(210,168,255,${.06 + bright})`
          : `rgba(121,192,255,${.06 + v*.4})`;
        cx.lineWidth = .5 + v * 1.5;
        cx.stroke();
      }
    }
  }

  // ç¯€é»
  for (let li = 0; li < 4; li++) {
    for (let ni = 0; ni < sizes[li]; ni++) {
      const x = layerX[li], y = ny(li,ni);
      const v = vals[li][ni] || 0;
      const r = R + v * 3;
      const g = cx.createRadialGradient(x,y,0,x,y,r);
      g.addColorStop(0, 'white');
      g.addColorStop(.5, clrs[li]);
      g.addColorStop(1, 'transparent');
      cx.beginPath(); cx.arc(x,y,r,0,Math.PI*2);
      cx.fillStyle = g;
      if (v > .5) { cx.shadowBlur = 14; cx.shadowColor = clrs[li]; }
      cx.fill(); cx.shadowBlur = 0;
      cx.strokeStyle = clrs[li]; cx.lineWidth = 1.5; cx.stroke();

      // ç¯€é»æ•¸å€¼
      cx.fillStyle = 'rgba(255,255,255,.85)';
      cx.font = `bold ${fs}px monospace`;
      cx.textAlign = 'center';
      cx.fillText(v.toFixed(1), x, y + 4);
    }
  }

  // å±¤æ¨™ç±¤ï¼ˆä¸Šæ–¹ï¼‰
  const layerNames = ['è¼¸å…¥å±¤','éš±è—å±¤1','éš±è—å±¤2','è¼¸å‡ºå±¤'];
  layerNames.forEach((nm, li) => {
    cx.font = `bold ${fs}px Arial`;
    cx.fillStyle = clrs[li];
    cx.textAlign = 'center';
    cx.fillText(nm, layerX[li], H*.09);
    cx.font = `${Math.max(7,fs-2)}px Arial`;
    cx.fillStyle = 'rgba(255,255,255,.4)';
    cx.fillText(`(${sizes[li]}å€‹)`, layerX[li], H*.09 + fs + 2);
  });

  // è¼¸å…¥æ¨™ç±¤ï¼ˆåº•éƒ¨ï¼‰
  const p = PROBLEMS[probIdx];
  [[p.lblA, 0], [p.lblB, 1]].forEach(([lbl, ni]) => {
    const x = layerX[0], y = ny(0, ni);
    const r = R + (vals[0][ni]||0)*3;
    let txt = lbl.replace(/[\u{1F000}-\u{1FFFF}]/gu,'').trim();
    cx.font = `${fs-1}px Arial`;
    cx.fillStyle = 'rgba(255,255,255,.8)';
    cx.textAlign = 'center';
    cx.fillText(txt, x, y + r + fs + 3);
  });

  // è¼¸å‡ºæ¨™ç±¤
  const oy = ny(3, 0), ov = out[0] || 0, or2 = R + ov*3;
  cx.font = `${fs-1}px Arial`;
  cx.fillStyle = 'rgba(255,255,255,.8)';
  cx.textAlign = 'center';
  cx.fillText('è¼¸å‡º', layerX[3], oy + or2 + fs + 3);
}

// ============ å•é¡Œ ============
function loadProblem(idx) {
  probIdx = idx;
  const p = PROBLEMS[idx];
  document.querySelectorAll('.pbtn').forEach((b,i) => b.classList.toggle('active', i===idx));
  document.getElementById('prob-desc').textContent = p.desc;
  document.getElementById('table-title').textContent = 'ğŸ“Š ' + p.name + ' çœŸå€¼è¡¨';
  document.getElementById('lbl-a').textContent = p.lblA;
  document.getElementById('lbl-b').textContent = p.lblB;
  updateTruthTable();
  resetNN();
}

function updateTruthTable() {
  const p = PROBLEMS[probIdx];
  const rows = p.data.map(d => {
    const pred = nn.predict([d.a, d.b]);
    const correct = Math.round(pred) === d.y;
    return `<tr>
      <td class="val-${d.a}">${d.a}</td>
      <td class="val-${d.b}">${d.b}</td>
      <td class="val-${d.y}">${d.y}</td>
      <td style="color:${correct?'#2e7d32':'#e53935'};font-weight:700">${pred.toFixed(3)}</td>
      <td>${correct ? 'âœ…' : 'âŒ'}</td>
    </tr>`;
  }).join('');
  document.getElementById('truth-table').innerHTML = `
    <thead><tr>
      <th>${p.lblA}</th><th>${p.lblB}</th>
      <th>æ­£ç¢ºç­”æ¡ˆ</th><th>AIé æ¸¬</th><th>å°å—</th>
    </tr></thead>
    <tbody>${rows}</tbody>`;
}

function buildProbBtns() {
  document.getElementById('problems').innerHTML = PROBLEMS.map((p,i) => `
    <button class="pbtn ${i===0?'active':''}" onclick="loadProblem(${i})">
      <span class="emo">${p.emoji}</span>${p.name}
    </button>`).join('');
}

// ============ è¨“ç·´ ============
function getData() { return PROBLEMS[probIdx].data.map(d => ({inp:[d.a,d.b], tgt:[d.y]})); }

function updateStats(err) {
  epoch++;
  const acc = PROBLEMS[probIdx].data.filter(d => Math.round(nn.predict([d.a,d.b])) === d.y).length
    / PROBLEMS[probIdx].data.length * 100;
  document.getElementById('epoch-val').textContent = epoch;
  document.getElementById('err-val').textContent = err.toFixed(3);
  document.getElementById('acc-val').textContent = acc.toFixed(0) + '%';
  const pct = Math.min(100, (1-err)*100);
  document.getElementById('prog-fill').style.width = pct + '%';
  document.getElementById('prog-txt').textContent = pct.toFixed(0) + '%';
}

function trainOnce() {
  const data = getData(); let err = 0;
  data.forEach(d => { err += nn.train(d.inp, d.tgt); });
  updateStats(err / data.length);
  redraw();
}

function toggleAuto() {
  isAuto = !isAuto;
  const btn = document.getElementById('auto-btn');
  if (isAuto) {
    btn.textContent = 'â¹ åœæ­¢';
    btn.classList.add('pulsing');
    autoTimer = setInterval(() => {
      const data = getData(); let err = 0;
      data.forEach(d => { err += nn.train(d.inp, d.tgt); });
      updateStats(err / data.length);
      redraw();
      if (err / data.length < 0.02) toggleAuto();
    }, 20);
  } else {
    clearInterval(autoTimer);
    btn.textContent = 'ğŸš€ å¿«é€Ÿè¨“ç·´';
    btn.classList.remove('pulsing');
  }
}

function resetNN() {
  if (isAuto) toggleAuto();
  nn = new NeuralNetwork(2, 4, 1, 0.5);
  epoch = 0;
  document.getElementById('epoch-val').textContent = '0';
  document.getElementById('err-val').textContent = '-.--';
  document.getElementById('acc-val').textContent = '0%';
  document.getElementById('prog-fill').style.width = '0%';
  document.getElementById('prog-txt').textContent = '0%';
  document.getElementById('result-box').classList.remove('show');
  redraw();
}

// ============ æ¸¬è©¦ ============
function toggleInput(which) {
  if (which === 'a') {
    inputA = inputA === 0 ? 1 : 0;
    document.getElementById('val-a').textContent = inputA;
    document.getElementById('inp-a').classList.toggle('on', inputA === 1);
  } else {
    inputB = inputB === 0 ? 1 : 0;
    document.getElementById('val-b').textContent = inputB;
    document.getElementById('inp-b').classList.toggle('on', inputB === 1);
  }
  document.getElementById('result-box').classList.remove('show');
  redraw();
}

function predict() {
  const v = nn.predict([inputA, inputB]);
  const ans = Math.round(v);
  const p = PROBLEMS[probIdx];
  const correct = p.data.find(d => d.a === inputA && d.b === inputB);
  const isRight = correct && Math.round(v) === correct.y;
  const box = document.getElementById('result-box');
  box.style.background = ans === 1 ? '#e8f5e9' : '#fce4ec';
  box.style.borderColor = ans === 1 ? '#81c784' : '#f48fb1';
  document.getElementById('r-emo').textContent = ans === 1 ? 'âœ…' : 'âŒ';
  document.getElementById('r-text').textContent = `é æ¸¬çµæœï¼š${ans}`;
  document.getElementById('r-text').style.color = ans === 1 ? '#2e7d32' : '#c62828';
  document.getElementById('r-pct').textContent = `ä¿¡å¿ƒå€¼ï¼š${(v*100).toFixed(1)}%`;
  document.getElementById('r-pct').style.color = ans === 1 ? '#2e7d32' : '#c62828';
  document.getElementById('r-detail').innerHTML =
    `<b>è¼¸å…¥ï¼š</b> A=${inputA}ï¼ŒB=${inputB}<br>
     <b>åŸå§‹è¼¸å‡ºï¼š</b> ${v.toFixed(4)}ï¼ˆ&gt;0.5 åˆ¤ç‚º 1ï¼‰<br>
     <b>æ­£ç¢ºç­”æ¡ˆï¼š</b> ${correct ? correct.y : '?'}<br>
     <b>åˆ¤æ–·ï¼š</b> ${isRight ? 'ğŸ‰ ç­”å°äº†ï¼' : 'ğŸ˜… ç­”éŒ¯äº†ï¼Œç¹¼çºŒè¨“ç·´è©¦è©¦'}`;
  box.classList.add('show');
  redraw();
}

// ============ ç¨‹å¼ç¢¼å±•ç¤º ============
const CODES = [
  // é¡åˆ¥å®šç¾©
  `<span class="cm">// TypeScript é¡åˆ¥å®šç¾©</span>
<span class="kw">class</span> <span class="tp">NeuralNetwork</span> {
  <span class="kw">private</span> w1<span class="op">:</span> <span class="tp">number</span>[][]  <span class="cm">// è¼¸å…¥â†’éš±è— æ¬Šé‡</span>
  <span class="kw">private</span> w2<span class="op">:</span> <span class="tp">number</span>[][]  <span class="cm">// éš±è—â†’è¼¸å‡º æ¬Šé‡</span>
  <span class="kw">private</span> b1<span class="op">:</span> <span class="tp">number</span>[]   <span class="cm">// éš±è—å±¤åå·®</span>
  <span class="kw">private</span> b2<span class="op">:</span> <span class="tp">number</span>[]   <span class="cm">// è¼¸å‡ºå±¤åå·®</span>

  <span class="fn">constructor</span>(
    inputSize<span class="op">:</span> <span class="tp">number</span>,
    hiddenSize<span class="op">:</span> <span class="tp">number</span>,
    outputSize<span class="op">:</span> <span class="tp">number</span>,
    learningRate<span class="op">:</span> <span class="tp">number</span> <span class="op">=</span> <span class="nm">0.5</span>
  ) {
    <span class="cm">// éš¨æ©Ÿåˆå§‹åŒ– -1 ~ 1</span>
    <span class="kw">this</span>.w1 <span class="op">=</span> <span class="kw">this</span>.<span class="fn">randMatrix</span>(inputSize, hiddenSize)
    <span class="kw">this</span>.w2 <span class="op">=</span> <span class="kw">this</span>.<span class="fn">randMatrix</span>(hiddenSize, outputSize)
    <span class="kw">this</span>.b1 <span class="op">=</span> <span class="kw">this</span>.<span class="fn">randArray</span>(hiddenSize)
    <span class="kw">this</span>.b2 <span class="op">=</span> <span class="kw">this</span>.<span class="fn">randArray</span>(outputSize)
  }

  <span class="cm">// Sigmoidï¼šå£“ç¸®åˆ° 0~1</span>
  <span class="kw">private</span> <span class="fn">sigmoid</span>(x<span class="op">:</span> <span class="tp">number</span>)<span class="op">:</span> <span class="tp">number</span> {
    <span class="kw">return</span> <span class="nm">1</span> <span class="op">/</span> (<span class="nm">1</span> <span class="op">+</span> Math.<span class="fn">exp</span>(<span class="op">-</span>x))
  }
}`,
  // å‰å‘å‚³æ’­
  `<span class="cm">// å‰å‘å‚³æ’­ï¼šè¨ˆç®—é æ¸¬å€¼</span>
<span class="fn">forward</span>(input<span class="op">:</span> <span class="tp">number</span>[])<span class="op">:</span> {
  hidden<span class="op">:</span> <span class="tp">number</span>[],
  output<span class="op">:</span> <span class="tp">number</span>[]
} {
  <span class="cm">// è¨ˆç®—éš±è—å±¤</span>
  <span class="kw">const</span> hidden <span class="op">=</span> <span class="kw">this</span>.b1.<span class="fn">map</span>((bias, i) <span class="op">=&gt;</span> {
    <span class="cm">// åŠ æ¬Šç¸½å’Œ + åå·®</span>
    <span class="kw">const</span> sum <span class="op">=</span> input.<span class="fn">reduce</span>(
      (acc, val, j) <span class="op">=&gt;</span>
        acc <span class="op">+</span> val <span class="op">*</span> <span class="kw">this</span>.w1[j][i],
      bias
    )
    <span class="kw">return</span> <span class="kw">this</span>.<span class="fn">sigmoid</span>(sum)
  })

  <span class="cm">// è¨ˆç®—è¼¸å‡ºå±¤ï¼ˆåŒç†ï¼‰</span>
  <span class="kw">const</span> output <span class="op">=</span> <span class="kw">this</span>.b2.<span class="fn">map</span>((bias, i) <span class="op">=&gt;</span> {
    <span class="kw">const</span> sum <span class="op">=</span> hidden.<span class="fn">reduce</span>(
      (acc, val, j) <span class="op">=&gt;</span>
        acc <span class="op">+</span> val <span class="op">*</span> <span class="kw">this</span>.w2[j][i],
      bias
    )
    <span class="kw">return</span> <span class="kw">this</span>.<span class="fn">sigmoid</span>(sum)
  })

  <span class="kw">return</span> { hidden, output }
}`,
  // åå‘å‚³æ’­
  `<span class="cm">// åå‘å‚³æ’­ï¼šè¨ˆç®—æ¢¯åº¦</span>
<span class="fn">backpropagate</span>(
  input<span class="op">:</span> <span class="tp">number</span>[],
  hidden<span class="op">:</span> <span class="tp">number</span>[],
  output<span class="op">:</span> <span class="tp">number</span>[],
  target<span class="op">:</span> <span class="tp">number</span>[]
) {
  <span class="cm">// è¼¸å‡ºå±¤èª¤å·®</span>
  <span class="kw">const</span> outErr <span class="op">=</span> output.<span class="fn">map</span>(
    (o, i) <span class="op">=&gt;</span> target[i] <span class="op">-</span> o
  )
  <span class="cm">// è¼¸å‡ºå±¤ delta</span>
  <span class="kw">const</span> outDelta <span class="op">=</span> output.<span class="fn">map</span>(
    (o, i) <span class="op">=&gt;</span> outErr[i] <span class="op">*</span> o <span class="op">*</span> (<span class="nm">1</span> <span class="op">-</span> o)
  )
  <span class="cm">// éš±è—å±¤èª¤å·®ï¼ˆåå‘å‚³éï¼‰</span>
  <span class="kw">const</span> hidErr <span class="op">=</span> hidden.<span class="fn">map</span>((_, i) <span class="op">=&gt;</span>
    outDelta.<span class="fn">reduce</span>(
      (acc, d, j) <span class="op">=&gt;</span>
        acc <span class="op">+</span> d <span class="op">*</span> <span class="kw">this</span>.w2[i][j],
      <span class="nm">0</span>
    )
  )
  <span class="cm">// éš±è—å±¤ delta</span>
  <span class="kw">const</span> hidDelta <span class="op">=</span> hidden.<span class="fn">map</span>(
    (h, i) <span class="op">=&gt;</span> hidErr[i] <span class="op">*</span> h <span class="op">*</span> (<span class="nm">1</span> <span class="op">-</span> h)
  )
  <span class="kw">return</span> { outDelta, hidDelta }
}`,
  // å®Œæ•´è¨“ç·´
  `<span class="cm">// ä¸€æ¬¡å®Œæ•´è¨“ç·´æ­¥é©Ÿ</span>
<span class="fn">train</span>(
  input<span class="op">:</span> <span class="tp">number</span>[],
  target<span class="op">:</span> <span class="tp">number</span>[]
)<span class="op">:</span> <span class="tp">number</span> {
  <span class="cm">// 1. å‰å‘å‚³æ’­</span>
  <span class="kw">const</span> { hidden, output } <span class="op">=</span>
    <span class="kw">this</span>.<span class="fn">forward</span>(input)

  <span class="cm">// 2. åå‘å‚³æ’­</span>
  <span class="kw">const</span> { outDelta, hidDelta } <span class="op">=</span>
    <span class="kw">this</span>.<span class="fn">backpropagate</span>(
      input, hidden, output, target
    )

  <span class="cm">// 3. æ›´æ–°è¼¸å‡ºå±¤æ¬Šé‡</span>
  <span class="kw">this</span>.w2.<span class="fn">forEach</span>((row, i) <span class="op">=&gt;</span>
    row.<span class="fn">forEach</span>((_, j) <span class="op">=&gt;</span> {
      <span class="kw">this</span>.w2[i][j] <span class="op">+=</span>
        <span class="kw">this</span>.lr <span class="op">*</span> outDelta[j] <span class="op">*</span> hidden[i]
    })
  )
  <span class="cm">// 4. æ›´æ–°éš±è—å±¤æ¬Šé‡</span>
  <span class="kw">this</span>.w1.<span class="fn">forEach</span>((row, i) <span class="op">=&gt;</span>
    row.<span class="fn">forEach</span>((_, j) <span class="op">=&gt;</span> {
      <span class="kw">this</span>.w1[i][j] <span class="op">+=</span>
        <span class="kw">this</span>.lr <span class="op">*</span> hidDelta[j] <span class="op">*</span> input[i]
    })
  )
  <span class="cm">// 5. æ›´æ–°åå·®</span>
  <span class="kw">this</span>.b2 <span class="op">=</span> <span class="kw">this</span>.b2.<span class="fn">map</span>(
    (b, i) <span class="op">=&gt;</span> b <span class="op">+</span> <span class="kw">this</span>.lr <span class="op">*</span> outDelta[i]
  )
  <span class="kw">this</span>.b1 <span class="op">=</span> <span class="kw">this</span>.b1.<span class="fn">map</span>(
    (b, i) <span class="op">=&gt;</span> b <span class="op">+</span> <span class="kw">this</span>.lr <span class="op">*</span> hidDelta[i]
  )
  <span class="cm">// å›å‚³èª¤å·®</span>
  <span class="kw">return</span> Math.<span class="fn">abs</span>(target[<span class="nm">0</span>] <span class="op">-</span> output[<span class="nm">0</span>])
}`
];

function showCode(idx) {
  document.querySelectorAll('.ctab').forEach((t,i) => t.classList.toggle('active', i===idx));
  document.querySelectorAll('.code-block').forEach((b,i) => b.classList.toggle('show', i===idx));
}

// æ³¨å…¥ç¨‹å¼ç¢¼
CODES.forEach((c,i) => { document.getElementById('pre-'+i).innerHTML = c; });

// ============ åˆå§‹åŒ– ============
window.addEventListener('load', () => {
  buildProbBtns();
  loadProblem(0);
  resizeCanvas();
});
window.addEventListener('resize', resizeCanvas);
</script>
</body>
</html>