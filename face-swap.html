<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äººè‡‰åµæ¸¬èˆ‡æ›è‡‰ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 2.5em;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 30px;
    }

    .section {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 15px;
      border: 2px solid #e9ecef;
    }

    .section-title {
      font-size: 1.5em;
      color: #495057;
      margin-bottom: 20px;
      font-weight: bold;
    }

    button {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: none;
      border-radius: 10px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(56, 239, 125, 0.4);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .btn-warning:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(245, 87, 108, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .canvas-container {
      position: relative;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      margin: 20px 0;
      min-height: 500px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      max-width: 100%;
      display: block;
    }

    .placeholder {
      color: #6c757d;
      font-size: 1.2em;
      text-align: center;
      padding: 20px;
    }

    .face-library {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .face-card {
      background: white;
      border: 3px solid #dee2e6;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .face-card:hover {
      border-color: #667eea;
      transform: scale(1.05);
    }

    .face-card.selected {
      border-color: #667eea;
      background: #e8eaf6;
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
    }

    .face-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .face-card-name {
      font-weight: bold;
      color: #495057;
      font-size: 0.9em;
    }

    .alert {
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      display: none;
    }

    .alert.show {
      display: block;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .loading {
      text-align: center;
      padding: 60px;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .slider-container {
      margin: 15px 0;
    }

    .slider-container label {
      display: block;
      margin-bottom: 8px;
      color: #495057;
      font-weight: bold;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #dee2e6;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #667eea;
      cursor: pointer;
    }

    .value-display {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 5px;
      font-weight: bold;
      margin-left: 10px;
    }

    .info-box {
      background: #e8f4f8;
      border-left: 4px solid #17a2b8;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }

    .info-box h3 {
      color: #17a2b8;
      margin-bottom: 10px;
    }

    .info-box ul {
      margin-left: 20px;
      color: #495057;
    }

    .info-box li {
      margin: 5px 0;
    }

    @media (max-width: 1024px) {
      .content {
        grid-template-columns: 1fr;
      }

      .face-library {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px;
      }

      h1 {
        font-size: 1.8em;
        flex-direction: column;
        text-align: center;
      }

      .face-library {
        grid-template-columns: repeat(2, 1fr);
      }

      .canvas-container {
        min-height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
        <line x1="9" y1="9" x2="9.01" y2="9"></line>
        <line x1="15" y1="9" x2="15.01" y2="9"></line>
      </svg>
      äººè‡‰åµæ¸¬èˆ‡æ›è‡‰ç³»çµ±
    </h1>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>æ­£åœ¨è¼‰å…¥æ¨¡å‹ï¼Œè«‹ç¨å€™...</p>
    </div>

    <div id="alert" class="alert"></div>

    <div id="mainContent" style="display: none;">
      <div class="content">
        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <div>
          <div class="section">
            <h2 class="section-title">ğŸ“¤ ä¸Šå‚³ç…§ç‰‡</h2>
            <button class="btn-primary" onclick="document.getElementById('uploadInput').click()">
              <span>ğŸ“·</span> é¸æ“‡è¦æ›è‡‰çš„ç…§ç‰‡
            </button>
            <input type="file" id="uploadInput" accept="image/*" style="display: none;" onchange="handleUploadImage(event)">
            
            <div class="slider-container">
              <label>
                é€æ˜åº¦èª¿æ•´
                <span class="value-display" id="opacityValue">70%</span>
              </label>
              <input type="range" id="opacitySlider" min="0" max="100" value="70" oninput="updateOpacity(this.value)">
            </div>

            <div class="slider-container">
              <label>
                è‡‰éƒ¨ç¸®æ”¾
                <span class="value-display" id="scaleValue">100%</span>
              </label>
              <input type="range" id="scaleSlider" min="50" max="150" value="100" oninput="updateScale(this.value)">
            </div>
          </div>

          <div class="section" style="margin-top: 20px;">
            <h2 class="section-title">ğŸ­ æ›è‡‰ç´ æåº«</h2>
            <button class="btn-success" onclick="document.getElementById('faceLibInput').click()">
              <span>â•</span> æ–°å¢æ›è‡‰ç´ æ
            </button>
            <input type="file" id="faceLibInput" accept="image/*" style="display: none;" onchange="addFaceToLibrary(event)">
            
            <div class="face-library" id="faceLibrary"></div>
          </div>

          <div class="info-box" style="margin-top: 20px;">
            <h3>ğŸ’¡ ä½¿ç”¨èªªæ˜</h3>
            <ul>
              <li>ä¸Šå‚³åŒ…å«äººè‡‰çš„ç…§ç‰‡</li>
              <li>æ–°å¢æ›è‡‰ç´ æåˆ°ç´ æåº«</li>
              <li>é»é¸ç´ æé€²è¡Œæ›è‡‰</li>
              <li>èª¿æ•´é€æ˜åº¦å’Œç¸®æ”¾</li>
              <li>ä¸‹è¼‰æœ€çµ‚çµæœ</li>
            </ul>
          </div>
        </div>

        <!-- å³å´é¡¯ç¤ºå€åŸŸ -->
        <div>
          <div class="canvas-container">
            <canvas id="canvas"></canvas>
            <div id="placeholder" class="placeholder">
              è«‹ä¸Šå‚³ä¸€å¼µåŒ…å«äººè‡‰çš„ç…§ç‰‡é–‹å§‹ä½¿ç”¨
            </div>
          </div>

          <div class="controls">
            <button id="swapBtn" class="btn-warning" onclick="performFaceSwap()" disabled>
              <span>ğŸ”„</span> åŸ·è¡Œæ›è‡‰
            </button>
            <button id="resetBtn" class="btn-primary" onclick="resetImage()" disabled>
              <span>â†»</span> é‡ç½®
            </button>
            <button id="downloadBtn" class="btn-success" onclick="downloadImage()" disabled>
              <span>ğŸ’¾</span> ä¸‹è¼‰çµæœ
            </button>
          </div>

          <div id="faceInfo" class="section" style="margin-top: 20px; display: none;">
            <h2 class="section-title">ğŸ“Š åµæ¸¬è³‡è¨Š</h2>
            <div id="faceInfoContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let modelsLoaded = false;
    let originalImage = null;
    let detectedFaces = [];
    let faceLibrary = [];
    let selectedFace = null;
    let currentOpacity = 0.7;
    let currentScale = 1.0;

    // è¼‰å…¥æ¨¡å‹
    async function loadModels() {
      try {
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
        await Promise.all([
          faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
        ]);
        modelsLoaded = true;
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        loadFaceLibrary();
        showAlert('æ¨¡å‹è¼‰å…¥å®Œæˆï¼å¯ä»¥é–‹å§‹ä½¿ç”¨', 'success');
      } catch (err) {
        showAlert('æ¨¡å‹è¼‰å…¥å¤±æ•—: ' + err.message, 'error');
        document.getElementById('loading').innerHTML = '<p style="color: red;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>';
      }
    }

    // è¼‰å…¥ç´ æåº«
    function loadFaceLibrary() {
      const saved = localStorage.getItem('faceLibrary');
      if (saved) {
        faceLibrary = JSON.parse(saved);
        updateFaceLibraryDisplay();
      }
    }

    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    function showAlert(message, type = 'info') {
      const alertEl = document.getElementById('alert');
      alertEl.className = `alert alert-${type} show`;
      alertEl.textContent = message;
      setTimeout(() => {
        alertEl.className = 'alert';
      }, 5000);
    }

    // ä¸Šå‚³ä¸»ç…§ç‰‡
    async function handleUploadImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      const img = await loadImage(file);
      originalImage = img;

      // åµæ¸¬äººè‡‰
      const detections = await faceapi
        .detectAllFaces(img)
        .withFaceLandmarks();

      if (detections.length === 0) {
        showAlert('æœªåµæ¸¬åˆ°äººè‡‰ï¼Œè«‹ä¸Šå‚³åŒ…å«æ¸…æ™°äººè‡‰çš„ç…§ç‰‡', 'error');
        return;
      }

      detectedFaces = detections;
      drawOriginalImage();
      
      document.getElementById('faceInfo').style.display = 'block';
      document.getElementById('faceInfoContent').innerHTML = `
        <p style="font-size: 1.1em;"><strong>åµæ¸¬åˆ° ${detections.length} å¼µäººè‡‰</strong></p>
        <p style="color: #6c757d; margin-top: 5px;">è«‹å¾ç´ æåº«é¸æ“‡è¦æ›ä¸Šçš„è‡‰éƒ¨ç´ æ</p>
      `;
      
      document.getElementById('resetBtn').disabled = false;
      document.getElementById('downloadBtn').disabled = false;
      
      if (selectedFace) {
        document.getElementById('swapBtn').disabled = false;
      }

      showAlert(`æˆåŠŸåµæ¸¬åˆ° ${detections.length} å¼µäººè‡‰ï¼`, 'success');
    }

    // æ–°å¢ç´ æåˆ°ç´ æåº«
    async function addFaceToLibrary(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const newFace = {
          id: Date.now(),
          name: `ç´ æ ${faceLibrary.length + 1}`,
          dataUrl: e.target.result
        };

        faceLibrary.push(newFace);
        localStorage.setItem('faceLibrary', JSON.stringify(faceLibrary));
        updateFaceLibraryDisplay();
        showAlert('ç´ æå·²åŠ å…¥ç´ æåº«', 'success');
      };
      reader.readAsDataURL(file);
    }

    // æ›´æ–°ç´ æåº«é¡¯ç¤º
    function updateFaceLibraryDisplay() {
      const container = document.getElementById('faceLibrary');
      
      if (faceLibrary.length === 0) {
        container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #6c757d; padding: 20px;">ç´ æåº«æ˜¯ç©ºçš„<br>è«‹æ–°å¢æ›è‡‰ç´ æ</p>';
        return;
      }

      container.innerHTML = faceLibrary.map(face => `
        <div class="face-card ${selectedFace && selectedFace.id === face.id ? 'selected' : ''}" onclick="selectFace(${face.id})">
          <img src="${face.dataUrl}" alt="${face.name}">
          <div class="face-card-name">${face.name}</div>
          <button class="delete-btn" style="width: 100%; padding: 5px; margin-top: 5px; font-size: 0.8em;" onclick="event.stopPropagation(); deleteFaceFromLibrary(${face.id})">ğŸ—‘ï¸</button>
        </div>
      `).join('');
    }

    // é¸æ“‡ç´ æ
    function selectFace(id) {
      selectedFace = faceLibrary.find(f => f.id === id);
      updateFaceLibraryDisplay();
      
      if (originalImage) {
        document.getElementById('swapBtn').disabled = false;
        showAlert(`å·²é¸æ“‡ ${selectedFace.name}`, 'info');
      }
    }

    // åˆªé™¤ç´ æ
    function deleteFaceFromLibrary(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç´ æï¼Ÿ')) return;
      
      faceLibrary = faceLibrary.filter(f => f.id !== id);
      localStorage.setItem('faceLibrary', JSON.stringify(faceLibrary));
      
      if (selectedFace && selectedFace.id === id) {
        selectedFace = null;
        document.getElementById('swapBtn').disabled = true;
      }
      
      updateFaceLibraryDisplay();
      showAlert('ç´ æå·²åˆªé™¤', 'success');
    }

    // è¼‰å…¥åœ–ç‰‡
    function loadImage(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => resolve(img);
      });
    }

    // ç¹ªè£½åŸå§‹åœ–ç‰‡
    function drawOriginalImage() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      canvas.width = originalImage.width;
      canvas.height = originalImage.height;
      ctx.drawImage(originalImage, 0, 0);

      // ç¹ªè£½äººè‡‰æ¡†
      const displaySize = { width: originalImage.width, height: originalImage.height };
      faceapi.matchDimensions(canvas, displaySize);
      const resizedDetections = faceapi.resizeResults(detectedFaces, displaySize);
      faceapi.draw.drawDetections(canvas, resizedDetections);
      faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);

      canvas.style.display = 'block';
      document.getElementById('placeholder').style.display = 'none';
    }

    // --- è¼”åŠ©å‡½å¼ 1: å–å¾—å€åŸŸçš„å¹³å‡é¡è‰² ---
    function getAverageColor(ctx, x, y, width, height) {
      try {
        const imageData = ctx.getImageData(x, y, width, height);
        const data = imageData.data;
        let r = 0, g = 0, b = 0;
        let count = 0;

        for (let i = 0; i < data.length; i += 4) {
          // å¿½ç•¥é€æ˜åƒç´ 
          if (data[i + 3] > 0) { 
            r += data[i];
            g += data[i + 1];
            b += data[i + 2];
            count++;
          }
        }
        return count > 0 ? { r: Math.round(r / count), g: Math.round(g / count), b: Math.round(b / count) } : null;
      } catch (e) {
        return null;
      }
    }

    // --- è¼”åŠ©å‡½å¼ 2: è†šè‰²é·ç§» (Reinhard Color Transfer ç°¡åŒ–ç‰ˆ) ---
    function matchSkinTone(sourceCanvas, targetColor) {
      const ctx = sourceCanvas.getContext('2d');
      const width = sourceCanvas.width;
      const height = sourceCanvas.height;
      
      // å–å¾—ç´ æè‡‰çš„å¹³å‡é¡è‰²
      const sourceColor = getAverageColor(ctx, 0, 0, width, height);
      if (!sourceColor || !targetColor) return;

      const imgData = ctx.getImageData(0, 0, width, height);
      const data = imgData.data;

      // è¨ˆç®—å·®ç•° (Delta)
      const dr = targetColor.r - sourceColor.r;
      const dg = targetColor.g - sourceColor.g;
      const db = targetColor.b - sourceColor.b;

      // åƒç´ ç´šèª¿æ•´
      for (let i = 0; i < data.length; i += 4) {
        if (data[i + 3] > 0) { // åªèª¿æ•´éé€æ˜å€åŸŸ
          // ç°¡å–®çš„åŠ æ³•è‰²å½©å¹³è¡¡ (ä¿ç•™äº®åº¦å°æ¯”ï¼Œèª¿æ•´è‰²å)
          // ä½¿ç”¨ Math.min/max ç¢ºä¿é¡è‰²åœ¨ 0-255 ä¹‹é–“
          data[i]     = Math.min(255, Math.max(0, data[i] + dr));     // R
          data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + dg)); // G
          data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + db)); // B
        }
      }

      ctx.putImageData(imgData, 0, 0);
    }
    
    // åŸ·è¡Œæ›è‡‰
    async function performFaceSwap() {
      if (!originalImage || !selectedFace || detectedFaces.length === 0) {
        showAlert('è«‹å…ˆä¸Šå‚³ç…§ç‰‡ä¸¦é¸æ“‡ç´ æ', 'error');
        return;
      }

      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      // 1. é‡ç½®ç•«å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(originalImage, 0, 0);

      // é è¼‰å…¥ç´ æåœ–ç‰‡
      const swapFaceImg = new Image();
      swapFaceImg.src = selectedFace.dataUrl;
      await new Promise(resolve => { swapFaceImg.onload = resolve; });

      // å°æ¯å€‹åµæ¸¬åˆ°çš„äººè‡‰é€²è¡Œè™•ç†
      for (const detection of detectedFaces) {
        const landmarks = detection.landmarks;
        const box = detection.detection.box;

        // --- A. æº–å‚™ç´ æç•«å¸ƒ (Off-screen Canvas) ---
        // æˆ‘å€‘å»ºç«‹ä¸€å€‹æš«å­˜ç•«å¸ƒä¾†è™•ç†ç´ æçš„è®Šå½¢å’Œè®Šè‰²ï¼Œè€Œä¸å½±éŸ¿ä¸»ç•«é¢
        const tempCanvas = document.createElement('canvas');
        const tCtx = tempCanvas.getContext('2d');
        
        // è®“æš«å­˜ç•«å¸ƒç¨å¾®å¤§ä¸€é»ï¼Œå®¹ç´ç¸®æ”¾
        const w = box.width * currentScale;
        const h = box.height * currentScale;
        tempCanvas.width = w;
        tempCanvas.height = h;

        // ç¹ªè£½ç´ æåˆ°æš«å­˜ç•«å¸ƒ
        tCtx.drawImage(swapFaceImg, 0, 0, w, h);

        // --- B. åŸ·è¡Œè†šè‰²é·ç§» ---
        // å–å¾—ã€ŒåŸå§‹ç…§ç‰‡ã€ä¸­è©²äººè‡‰å€åŸŸçš„å¹³å‡é¡è‰²
        const originalFaceColor = getAverageColor(ctx, box.x + box.width*0.25, box.y + box.height*0.25, box.width*0.5, box.height*0.5);
        
        // èª¿æ•´æš«å­˜ç•«å¸ƒä¸­çš„é¡è‰²å»åŒ¹é…åŸå§‹ç…§ç‰‡
        matchSkinTone(tempCanvas, originalFaceColor);

        // --- C. è¨ˆç®—æ—‹è½‰è§’åº¦ ---
        const leftEye = landmarks.positions[36];
        const rightEye = landmarks.positions[45];
        const angle = Math.atan2(rightEye.y - leftEye.y, rightEye.x - leftEye.x);

        // --- D. åœ¨ä¸»ç•«å¸ƒä¸Šç¹ªè£½ ---
        ctx.save(); // å„²å­˜ç‹€æ…‹

        // 1. å®šä½èˆ‡æ—‹è½‰
        const centerX = box.x + box.width / 2;
        const centerY = box.y + box.height / 2;
        ctx.translate(centerX, centerY);
        ctx.rotate(angle);

        // 2. å»ºç«‹å‰ªè£è·¯å¾‘ (Masking) - é€™æ˜¯é—œéµï¼
        // æˆ‘å€‘ç•«ä¸€å€‹æ©¢åœ“å½¢æˆ–åœ“è§’çŸ©å½¢ä½œç‚ºé®ç½©ï¼Œä¸¦åŠ ä¸Šç¾½åŒ–
        ctx.beginPath();
        // é€™è£¡æˆ‘å€‘æ¨¡æ“¬ä¸€å€‹è‡‰éƒ¨å½¢ç‹€çš„é®ç½© (å¯¬åº¦ç•¥å°æ–¼é«˜åº¦)
        ctx.ellipse(0, 0, (w / 2) * 0.9, (h / 2) * 0.95, 0, 0, 2 * Math.PI);
        
        // 3. è¨­å®šç¾½åŒ–æ•ˆæœ (Soft Edge)
        // åˆ©ç”¨ shadowBlur ä¾†è£½é€ é‚Šç·£æ¨¡ç³Šï¼Œè®“è²¼åœ–ä¸é‚£éº¼ç”Ÿç¡¬
        ctx.shadowColor = "rgba(0,0,0,1)"; // é€™è£¡é¡è‰²ä¸é‡è¦ï¼Œå› ç‚ºæˆ‘å€‘æ˜¯ç”¨ clip
        // ä½†åœ¨ clip æ¨¡å¼ä¸‹ shadowBlur æ•ˆæœæœ‰é™ï¼Œæˆ‘å€‘æ”¹ç”¨ globalCompositeOperation çš„æ–¹å¼æ¨¡æ“¬ç¾½åŒ–
        // æˆ–è€…ç°¡å–®åœ°ï¼Œæˆ‘å€‘ä¸åš clipï¼Œè€Œæ˜¯ç”¨åˆæˆæ¨¡å¼ï¼š
        
        // ç°¡å–®ç¾½åŒ–æ–¹æ¡ˆï¼šé™åˆ¶ç¹ªè£½å€åŸŸ
        ctx.clip(); 

        // 4. è¨­å®šæ•´é«”é€æ˜åº¦
        ctx.globalAlpha = currentOpacity;

        // 5. ç¹ªè£½è™•ç†éé¡è‰²çš„ç´ æ
        // ä½¿ç”¨ 'overlay' æˆ– 'hard-light' å¯ä»¥è®“ç´‹ç†æ›´èåˆï¼Œä½† 'source-over' æœ€ç©©å®š
        // ctx.globalCompositeOperation = 'hard-light'; // å¯é¸ï¼šå˜—è©¦æ··åˆæ¨¡å¼
        
        ctx.drawImage(tempCanvas, -w / 2, -h / 2);

        ctx.restore(); // æ¢å¾©ç‹€æ…‹
      }

      showAlert('åƒç´ ç´šèåˆæ›è‡‰å®Œæˆï¼', 'success');
    }

    // æ›´æ–°é€æ˜åº¦
    function updateOpacity(value) {
      currentOpacity = value / 100;
      document.getElementById('opacityValue').textContent = value + '%';
    }

    // æ›´æ–°ç¸®æ”¾
    function updateScale(value) {
      currentScale = value / 100;
      document.getElementById('scaleValue').textContent = value + '%';
    }

    // é‡ç½®åœ–ç‰‡
    function resetImage() {
      if (originalImage) {
        drawOriginalImage();
        showAlert('å·²é‡ç½®ç‚ºåŸå§‹åœ–ç‰‡', 'info');
      }
    }

    // ä¸‹è¼‰åœ–ç‰‡
    function downloadImage() {
      const canvas = document.getElementById('canvas');
      const link = document.createElement('a');
      link.download = 'face-swap-result.png';
      link.href = canvas.toDataURL();
      link.click();
      showAlert('åœ–ç‰‡å·²ä¸‹è¼‰', 'success');
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.addEventListener('load', loadModels);
  </script>
</body>
</html>