<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»å°‡éŠæˆ² - Emojiç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* éŠæˆ²æ¨™é¡Œ */
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
        }

        .game-header h1 {
            font-size: 36px;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .game-info {
            font-size: 18px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        /* éŠæˆ²æ¡Œé¢ */
        .game-board {
            background: #1b5e20;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
            position: relative;
        }

        /* ç©å®¶å€åŸŸ */
        .player-area {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .player-name {
            color: #fff;
            font-size: 20px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .player-name.current {
            color: #ffeb3b;
            text-shadow: 0 0 10px rgba(255,235,59,0.5);
        }

        /* éº»å°‡ç‰Œæ¨£å¼ */
        .tile {
            display: inline-block;
            width: 55px;
            height: 75px;
            margin: 2px;
            padding: 5px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border: 2px solid #333;
            border-radius: 8px;
            text-align: center;
            line-height: 65px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            position: relative;
        }

        .tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tile.selected {
            background: linear-gradient(145deg, #ffeb3b, #ffc107);
            transform: translateY(-10px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        .tile.hidden {
            background: linear-gradient(145deg, #8b4513, #654321);
            color: transparent;
            cursor: default;
        }

        .tile.hidden:hover {
            transform: none;
        }

        /* èŠ±è‰²é¡è‰²èƒŒæ™¯ */
        .tile.wan { 
            background: linear-gradient(145deg, #ffebee, #ffcdd2);
            border-color: #d32f2f;
        }
        
        .tile.tiao { 
            background: linear-gradient(145deg, #e8f5e9, #c8e6c9);
            border-color: #388e3c;
        }
        
        .tile.tong { 
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-color: #1976d2;
        }

        /* å­—ç‰Œæ¨£å¼ */
        .tile.honor {
            font-size: 36px;
            line-height: 65px;
        }

        /* ç´…ä¸­ */
        .tile.hongzhong {
            background: linear-gradient(145deg, #ffebee, #ffcdd2);
            border-color: #d32f2f;
        }

        /* ç™½æ¿ */
        .tile.baiban {
            background: linear-gradient(145deg, #f5f5f5, #e0e0e0);
            border-color: #666;
        }

        /* ç™¼è²¡ */
        .tile.facai {
            background: linear-gradient(145deg, #e8f5e9, #c8e6c9);
            border-color: #2e7d32;
        }

        /* é¢¨ç‰Œæ¨£å¼ */
        .tile.feng {
            background: linear-gradient(145deg, #fff3e0, #ffe0b2);
            border-color: #e65100;
        }

        /* ç‰Œçµ„ */
        .meld {
            display: inline-flex;
            margin: 5px;
            padding: 5px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #666;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .meld-label {
            display: flex;
            align-items: center;
            margin-left: 5px;
            font-weight: bold;
            color: #333;
        }

        /* æ£„ç‰Œå€ */
        .discard-area {
            text-align: center;
            padding: 20px;
            background: #4caf50;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 100px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .discard-area h4 {
            color: #fff;
            margin-bottom: 10px;
        }

        .last-discarded {
            margin-top: 10px;
            padding: 10px;
            background: #ffeb3b;
            border-radius: 5px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ç©å®¶æ‰‹ç‰Œå€ */
        .player-hand {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn-start {
            background: linear-gradient(145deg, #4caf50, #45a049);
            color: #fff;
            font-size: 20px;
            padding: 15px 40px;
        }

        .btn-action {
            background: linear-gradient(145deg, #2196f3, #1976d2);
            color: #fff;
        }

        .btn-pass {
            background: linear-gradient(145deg, #9e9e9e, #757575);
            color: #fff;
        }

        .btn-restart {
            background: linear-gradient(145deg, #4caf50, #45a049);
            color: #fff;
            font-size: 20px;
            padding: 15px 40px;
        }

        /* å‹•ä½œå€ */
        .action-area {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .action-area h4 {
            color: #fff;
            margin-bottom: 10px;
        }

        /* éŠæˆ²çµæŸç•«é¢ */
        .game-over {
            text-align: center;
            padding: 40px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .game-over h2 {
            font-size: 32px;
            color: #4caf50;
            margin-bottom: 20px;
        }

        /* ç‰Œç‰†ä¿¡æ¯ */
        .wall-info {
            margin-top: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.9);
            border-radius: 5px;
            display: inline-block;
            font-weight: bold;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .tile {
                width: 45px;
                height: 60px;
                line-height: 50px;
                font-size: 24px;
            }
            
            .tile.honor {
                font-size: 28px;
            }
            
            .game-header h1 {
                font-size: 28px;
            }
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tile {
            animation: slideIn 0.3s ease;
        }

        /* ç‰¹æ®Šæ•ˆæœ */
        .highlight {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 235, 59, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 235, 59, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 235, 59, 0); }
        }

        /* åœ–ä¾‹èªªæ˜ */
        .legend {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 14px;
            max-width: 200px;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .legend-section {
            margin-bottom: 15px;
        }

        .legend-section h5 {
            color: #666;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }

        .legend-tile {
            width: 30px;
            height: 40px;
            margin-right: 8px;
            border: 1px solid #333;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 40px;
        }

        .legend-tile.wan {
            background: #ffebee;
            border-color: #d32f2f;
        }

        .legend-tile.tiao {
            background: #e8f5e9;
            border-color: #388e3c;
        }

        .legend-tile.tong {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        .legend-tile.hongzhong {
            background: #ffebee;
            border-color: #d32f2f;
        }

        .legend-tile.baiban {
            background: #f5f5f5;
            border-color: #666;
        }

        .legend-tile.facai {
            background: #e8f5e9;
            border-color: #2e7d32;
        }

        .legend-tile.feng {
            background: #fff3e0;
            border-color: #e65100;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- éŠæˆ²æ¨™é¡Œ -->
        <div class="game-header">
            <h1>ğŸ€„ éº»å°‡éŠæˆ² - Emojiç‰ˆ ğŸ€„</h1>
            <div class="game-info">
                <span id="windInfo">æ±é¢¨å ´ ç¬¬1å±€</span> | 
                <span id="gameMessage">æ­¡è¿ä¾†åˆ°éº»å°‡éŠæˆ²ï¼</span>
            </div>
        </div>

        <!-- åœ–ä¾‹èªªæ˜ -->
        <!-- div class="legend">
            <h4>Emojiéº»å°‡ç‰Œ</h4>
            
            <div class="legend-section">
                <h5>è¬å­—ç‰Œ</h5>
                <div class="legend-item">
                    <div class="legend-tile wan">1ï¸âƒ£</div>
                    <span>ä¸€è¬</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile wan">5ï¸âƒ£</div>
                    <span>äº”è¬</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile wan">9ï¸âƒ£</div>
                    <span>ä¹è¬</span>
                </div>
            </div>
            
            <div class="legend-section">
                <h5>æ¢å­—ç‰Œ</h5>
                <div class="legend-item">
                    <div class="legend-tile tiao">ğŸ‹</div>
                    <span>ä¸€æ¢</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile tiao">ğŸŒ¿</div>
                    <span>äº”æ¢</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile tiao">ğŸ‹</div>
                    <span>ä¹æ¢</span>
                </div>
            </div>
            
            <div class="legend-section">
                <h5>ç­’å­—ç‰Œ</h5>
                <div class="legend-item">
                    <div class="legend-tile tong">ğŸ”µ</div>
                    <span>ä¸€ç­’</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile tong">ğŸ”´</div>
                    <span>äº”ç­’</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile tong">ğŸ”µ</div>
                    <span>ä¹ç­’</span>
                </div>
            </div>
            
            <div class="legend-section">
                <h5>å­—ç‰Œ</h5>
                <div class="legend-item">
                    <div class="legend-tile hongzhong">ğŸ€„</div>
                    <span>ç´…ä¸­</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile baiban">âšª</div>
                    <span>ç™½æ¿</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile facai">ğŸ’°</div>
                    <span>ç™¼è²¡</span>
                </div>
                <div class="legend-item">
                    <div class="legend-tile feng">ğŸŒ…</div>
                    <span>é¢¨ç‰Œ</span>
                </div>
            </div>
        </div-->

        <!-- éŠæˆ²é–‹å§‹ç•«é¢ -->
        <div id="startScreen" style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-start" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
        </div>

        <!-- éŠæˆ²æ¡Œé¢ -->
        <div id="gameBoard" class="game-board" style="display: none;">
            <!-- å°å®¶ï¼ˆé›»è…¦2ï¼‰ -->
            <div class="player-area">
                <div class="player-name" id="player2Name">é›»è…¦2</div>
                <div id="player2Melds"></div>
                <div id="player2Tiles" style="min-height: 80px;"></div>
            </div>

            <!-- å·¦å³å…©å®¶ -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <!-- å·¦å®¶ï¼ˆé›»è…¦1ï¼‰ -->
                <div class="player-area" style="flex: 1; margin-right: 10px;">
                    <div class="player-name" id="player1Name">é›»è…¦1</div>
                    <div id="player1Melds"></div>
                    <div id="player1Tiles" style="min-height: 80px;"></div>
                </div>

                <!-- å³å®¶ï¼ˆé›»è…¦3ï¼‰ -->
                <div class="player-area" style="flex: 1; margin-left: 10px;">
                    <div class="player-name" id="player3Name">é›»è…¦3</div>
                    <div id="player3Melds"></div>
                    <div id="player3Tiles" style="min-height: 80px;"></div>
                </div>
            </div>

            <!-- ä¸­å¤®æ£„ç‰Œå€ -->
            <div class="discard-area">
                <h4>æ£„ç‰Œå€</h4>
                <div id="discardPile"></div>
                <div id="lastDiscarded" class="last-discarded" style="display: none;"></div>
            </div>

            <!-- ç©å®¶å€åŸŸ -->
            <div class="player-hand">
                <div class="player-name" id="player0Name">ç©å®¶</div>
                <div id="player0Melds"></div>
                <div id="player0Tiles"></div>
                
                <!-- å‹•ä½œå€ -->
                <div id="actionArea" class="action-area" style="display: none;">
                    <h4>å¯åŸ·è¡Œçš„å‹•ä½œï¼š</h4>
                    <div id="actionButtons"></div>
                </div>
                
                <!-- ç‰Œç‰†ä¿¡æ¯ -->
                <div class="wall-info">
                    ç‰Œç‰†å‰©é¤˜ï¼š<span id="wallCount">0</span> å¼µ
                </div>
            </div>
        </div>

        <!-- éŠæˆ²çµæŸç•«é¢ -->
        <div id="gameOverScreen" class="game-over" style="display: none;">
            <h2>éŠæˆ²çµæŸï¼</h2>
            <p id="finalMessage" style="font-size: 20px; margin-bottom: 30px;"></p>
            <button class="btn btn-restart" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
        </div>
    </div>

    <script>
        // éŠæˆ²ç‹€æ…‹
        let gameState = {
            status: 'waiting', // waiting, playing, ended
            players: [
                { id: 0, name: 'ç©å®¶', tiles: [], melds: [], discarded: [] },
                { id: 1, name: 'é›»è…¦1', tiles: [], melds: [], discarded: [] },
                { id: 2, name: 'é›»è…¦2', tiles: [], melds: [], discarded: [] },
                { id: 3, name: 'é›»è…¦3', tiles: [], melds: [], discarded: [] }
            ],
            wall: [],
            currentPlayer: 0,
            lastDiscarded: null,
            availableActions: [],
            selectedTile: null,
            wind: 'æ±',
            round: 1
        };

        // å‰µå»ºéº»å°‡ç‰Œ
        function createTiles() {
            const tiles = [];
            
            // è¬å­—ç‰Œ - ä½¿ç”¨æ•¸å­—emoji
            const wanEmojis = ['ğŸ€‡', 'ğŸ€ˆ', 'ğŸ€‰', 'ğŸ€‰', 'ğŸ€‹', 'ğŸ€Œ', 'ğŸ€', 'ğŸ€', 'ğŸ€'];
            const wanEmojis_1 = ['1ï¸', '2ï¸', '3ï¸', '4ï¸', '5ï¸', '6ï¸', '7ï¸', '8ï¸', '9'];
            const wanEmojis_2 = ['1ï¸âƒ£', '2ï¸âƒ£', '3ï¸âƒ£', '4ï¸âƒ£', '5ï¸âƒ£', '6ï¸âƒ£', '7ï¸âƒ£', '8ï¸âƒ£', '9ï¸âƒ£'];
            for (let i = 1; i <= 9; i++) {
                for (let j = 0; j < 4; j++) {
                    tiles.push({
                        id: `wan${i}-${j}`,
                        suit: 'è¬',
                        value: i,
                        display: wanEmojis[i-1],
                        type: 'suit',
                        class: 'wan'
                    });
                }
            }
            
            // æ¢å­—ç‰Œ - ä½¿ç”¨æ¤ç‰©emoji
            const tiaoEmojis = ['ğŸ€¡', 'ğŸ€‘', 'ğŸ€’', 'ğŸ€“', 'ğŸ€”', 'ğŸ€•', 'ğŸ€–', 'ğŸ€—', 'ğŸ€˜'];
            for (let i = 1; i <= 9; i++) {
                for (let j = 0; j < 4; j++) {
                    tiles.push({
                        id: `tiao${i}-${j}`,
                        suit: 'æ¢',
                        value: i,
                        display: tiaoEmojis[i-1],
                        type: 'suit',
                        class: 'tiao'
                    });
                }
            }
            
            // ç­’å­—ç‰Œ - ä½¿ç”¨åœ“åœˆemoji
            const tongEmojis = ['ğŸ€™', 'ğŸ€š', 'ğŸ€›', 'ğŸ€œ', 'ğŸ€', 'ğŸ€', 'ğŸ€Ÿ', 'ğŸ€ ', 'ğŸ€¡'];
            for (let i = 1; i <= 9; i++) {
                for (let j = 0; j < 4; j++) {
                    tiles.push({
                        id: `tong${i}-${j}`,
                        suit: 'ç­’',
                        value: i,
                        display: tongEmojis[i-1],
                        type: 'suit',
                        class: 'tong'
                    });
                }
            }
            // èŠ±ç‰Œ
            const flowers = [
                { name: 'æ˜¥', symbol: 'ğŸ€¦', class: 'spring' },
                { name: 'å¤', symbol: 'ğŸ€§', class: 'sunmmy' },
                { name: 'ç§‹', symbol: 'ğŸ€¨', class: 'winter' },
                { name: 'å†¬', symbol: 'ğŸ€©', class: 'dong' },
                { name: 'æ¢…', symbol: 'ğŸ€¢', class: 'mei' },
                { name: 'è—', symbol: 'ğŸ€£', class: 'lan' },
                { name: 'ç«¹', symbol: 'ğŸ€¤', class: 'zhu' },
                { name: 'èŠ', symbol: 'ğŸ€¥', class: 'chu' }
            ];
            
            // å­—ç‰Œ
            const honors = [
                { name: 'æ±', symbol: 'ğŸ€€', class: 'dong feng' },
                { name: 'å—', symbol: 'ğŸ€', class: 'nan feng' },
                { name: 'è¥¿', symbol: 'ğŸ€‚', class: 'xi feng' },
                { name: 'åŒ—', symbol: 'ğŸ€ƒ', class: 'bei feng' },
                { name: 'ä¸­', symbol: 'ğŸ€„', class: 'hongzhong honor' },
                { name: 'ç™¼', symbol: 'ğŸ€…', class: 'facai honor' },
                { name: 'ç™½', symbol: 'ğŸ€†', class: 'baiban honor' }
            ];
            
            honors.forEach(honor => {
                for (let j = 0; j < 4; j++) {
                    tiles.push({
                        id: `${honor.name}-${j}`,
                        suit: honor.name,
                        value: null,
                        display: honor.symbol,
                        type: 'honor',
                        class: honor.class
                    });
                }
            });
            
            return tiles;
        }

        // æ´—ç‰Œ
        function shuffleTiles(tiles) {
            const shuffled = [...tiles];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            const allTiles = shuffleTiles(createTiles());
            
            // æ¯äººç™¼13å¼µç‰Œ
            gameState.players.forEach((player, index) => {
                player.tiles = allTiles.slice(index * 13, (index + 1) * 13);
                player.tiles.sort((a, b) => {
                    if (a.type !== b.type) return a.type === 'honor' ? 1 : -1;
                    if (a.suit !== b.suit) return a.suit.localeCompare(b.suit);
                    return a.value - b.value;
                });
                player.melds = [];
                player.discarded = [];
            });
            
            // ç‰Œç‰†å‰©é¤˜çš„ç‰Œ
            gameState.wall = allTiles.slice(52);
            gameState.status = 'playing';
            gameState.currentPlayer = 0;
            gameState.lastDiscarded = null;
            gameState.availableActions = [];
            gameState.selectedTile = null;
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'block';
            document.getElementById('gameMessage').textContent = 'éŠæˆ²é–‹å§‹ï¼è¼ªåˆ°ç©å®¶æ‘¸ç‰Œ';
            
            updateDisplay();
            
            // ç©å®¶å…ˆæ‘¸ä¸€å¼µç‰Œ
            setTimeout(() => drawTile(0), 1000);
        }

        // æ‘¸ç‰Œ
        function drawTile(playerId) {
            if (gameState.wall.length === 0) {
                endGame('ç‰Œç‰†å·²ç©ºï¼æµå±€');
                return;
            }
            
            const drawnTile = gameState.wall.pop();
            gameState.players[playerId].tiles.push(drawnTile);
            
            // æ’åºæ‰‹ç‰Œ
            gameState.players[playerId].tiles.sort((a, b) => {
                if (a.type !== b.type) return a.type === 'honor' ? 1 : -1;
                if (a.suit !== b.suit) return a.suit.localeCompare(b.suit);
                return a.value - b.value;
            });
            
            updateDisplay();
            
            if (playerId === 0) {
                document.getElementById('gameMessage').textContent = 'è«‹é¸æ“‡è¦æ‰“å‡ºçš„ç‰Œ';
            } else {
                // AIè‡ªå‹•æ‰“ç‰Œ
                setTimeout(() => aiDiscard(playerId), 1500);
            }
        }

        // æ‰“ç‰Œ
        function discardTile(tile) {
            const player = gameState.players[gameState.currentPlayer];
            const tileIndex = player.tiles.findIndex(t => t.id === tile.id);
            
            if (tileIndex === -1) return;
            
            player.tiles.splice(tileIndex, 1);
            player.discarded.push(tile);
            gameState.lastDiscarded = { tile, player: gameState.currentPlayer };
            gameState.selectedTile = null;
            
            updateDisplay();
            
            // æª¢æŸ¥å…¶ä»–ç©å®¶æ˜¯å¦èƒ½åƒç¢°æ§“
            checkActions(tile, gameState.currentPlayer);
        }

        // æª¢æŸ¥å¯åŸ·è¡Œçš„å‹•ä½œ
        function checkActions(discardedTile, discarder) {
            const actions = [];
            
            gameState.players.forEach((player, index) => {
                if (index === discarder) return;
                
                // æª¢æŸ¥ç¢°
                const sameTiles = player.tiles.filter(t => 
                    t.suit === discardedTile.suit && t.value === discardedTile.value
                );
                if (sameTiles.length >= 2) {
                    actions.push({ type: 'pong', player: index, tile: discardedTile });
                }
                
                // æª¢æŸ¥æ§“
                if (sameTiles.length >= 3) {
                    actions.push({ type: 'kong', player: index, tile: discardedTile });
                }
                
                // æª¢æŸ¥åƒï¼ˆåªæœ‰ä¸‹å®¶å¯ä»¥ï¼‰
                if (index === (discarder + 1) % 4 && discardedTile.type === 'suit') {
                    const suitTiles = player.tiles.filter(t => 
                        t.suit === discardedTile.suit && t.type === 'suit'
                    );
                    
                    // æª¢æŸ¥èƒ½å¦çµ„æˆé †å­
                    for (let i = 0; i < suitTiles.length; i++) {
                        for (let j = i + 1; j < suitTiles.length; j++) {
                            const v1 = suitTiles[i].value;
                            const v2 = suitTiles[j].value;
                            const dv = discardedTile.value;
                            
                            if ((v1 + 1 === v2 && v1 - 1 === dv) ||
                                (v1 + 1 === dv && v1 + 2 === v2) ||
                                (dv + 1 === v1 && dv + 2 === v2)) {
                                actions.push({ 
                                    type: 'chow', 
                                    player: index, 
                                    tile: discardedTile,
                                    tiles: [suitTiles[i], suitTiles[j]]
                                });
                            }
                        }
                    }
                }
            });
            
            if (actions.length > 0) {
                gameState.availableActions = actions;
                
                // å¦‚æœç©å®¶æœ‰å¯åŸ·è¡Œçš„å‹•ä½œï¼Œç­‰å¾…é¸æ“‡
                const playerActions = actions.filter(a => a.player === 0);
                if (playerActions.length > 0) {
                    document.getElementById('gameMessage').textContent = 'è«‹é¸æ“‡è¦åŸ·è¡Œçš„å‹•ä½œ';
                    showActionButtons(playerActions);
                    return;
                }
                
                // AIè‡ªå‹•é¸æ“‡å„ªå…ˆç´šæœ€é«˜çš„å‹•ä½œ
                const aiAction = actions[0];
                setTimeout(() => executeAction(aiAction), 1000);
            } else {
                // æ²’æœ‰äººè¦ï¼Œä¸‹å®¶æ‘¸ç‰Œ
                nextTurn();
            }
        }

        // é¡¯ç¤ºå‹•ä½œæŒ‰éˆ•
        function showActionButtons(actions) {
            const actionArea = document.getElementById('actionArea');
            const actionButtons = document.getElementById('actionButtons');
            
            actionArea.style.display = 'block';
            actionButtons.innerHTML = '';
            
            actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-action';
                btn.textContent = action.type === 'pong' ? 'ç¢°' : 
                                 action.type === 'kong' ? 'æ§“' : 'åƒ';
                btn.onclick = () => executeAction(action);
                actionButtons.appendChild(btn);
            });
            
            // æ·»åŠ éæŒ‰éˆ•
            const passBtn = document.createElement('button');
            passBtn.className = 'btn btn-pass';
            passBtn.textContent = 'é';
            passBtn.onclick = () => {
                gameState.availableActions = [];
                actionArea.style.display = 'none';
                nextTurn();
            };
            actionButtons.appendChild(passBtn);
        }

        // åŸ·è¡Œå‹•ä½œ
        function executeAction(action) {
            const player = gameState.players[action.player];
            
            if (action.type === 'pong') {
                // ç¢°
                const sameTiles = player.tiles.filter(t => 
                    t.suit === action.tile.suit && t.value === action.tile.value
                ).slice(0, 2);
                
                sameTiles.forEach(tile => {
                    const index = player.tiles.findIndex(t => t.id === tile.id);
                    player.tiles.splice(index, 1);
                });
                
                player.melds.push({
                    type: 'pong',
                    tiles: [action.tile, ...sameTiles]
                });
                
                document.getElementById('gameMessage').textContent = `${player.name} ç¢°ï¼`;
            } else if (action.type === 'kong') {
                // æ§“
                const sameTiles = player.tiles.filter(t => 
                    t.suit === action.tile.suit && t.value === action.tile.value
                ).slice(0, 3);
                
                sameTiles.forEach(tile => {
                    const index = player.tiles.findIndex(t => t.id === tile.id);
                    player.tiles.splice(index, 1);
                });
                
                player.melds.push({
                    type: 'kong',
                    tiles: [action.tile, ...sameTiles]
                });
                
                document.getElementById('gameMessage').textContent = `${player.name} æ§“ï¼`;
            } else if (action.type === 'chow') {
                // åƒ
                action.tiles.forEach(tile => {
                    const index = player.tiles.findIndex(t => t.id === tile.id);
                    player.tiles.splice(index, 1);
                });
                
                player.melds.push({
                    type: 'chow',
                    tiles: [action.tile, ...action.tiles]
                });
                
                document.getElementById('gameMessage').textContent = `${player.name} åƒï¼`;
            }
            
            gameState.availableActions = [];
            gameState.currentPlayer = action.player;
            document.getElementById('actionArea').style.display = 'none';
            
            updateDisplay();
            
            // åŸ·è¡Œå‹•ä½œå¾Œéœ€è¦æ‰“ä¸€å¼µç‰Œ
            if (action.player === 0) {
                document.getElementById('gameMessage').textContent = 'è«‹é¸æ“‡è¦æ‰“å‡ºçš„ç‰Œ';
            } else {
                setTimeout(() => aiDiscard(action.player), 1500);
            }
        }

        // AIæ‰“ç‰Œ
        function aiDiscard(playerId) {
            const player = gameState.players[playerId];
            if (player.tiles.length === 0) return;
            
            // ç°¡å–®AIï¼šéš¨æ©Ÿæ‰“ä¸€å¼µç‰Œ
            const randomIndex = Math.floor(Math.random() * player.tiles.length);
            discardTile(player.tiles[randomIndex]);
        }

        // ä¸‹ä¸€å›åˆ
        function nextTurn() {
            const nextPlayer = (gameState.currentPlayer + 1) % 4;
            gameState.currentPlayer = nextPlayer;
            gameState.availableActions = [];
            
            updateDisplay();
            
            if (nextPlayer === 0) {
                document.getElementById('gameMessage').textContent = 'è¼ªåˆ°ç©å®¶æ‘¸ç‰Œ';
                setTimeout(() => drawTile(0), 500);
            } else {
                document.getElementById('gameMessage').textContent = `è¼ªåˆ°${gameState.players[nextPlayer].name}æ‘¸ç‰Œ`;
                setTimeout(() => drawTile(nextPlayer), 500);
            }
        }

        // çµæŸéŠæˆ²
        function endGame(message) {
            gameState.status = 'ended';
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'block';
            document.getElementById('finalMessage').textContent = message;
        }

        // é‡æ–°é–‹å§‹éŠæˆ²
        function restartGame() {
            gameState = {
                status: 'waiting',
                players: [
                    { id: 0, name: 'ç©å®¶', tiles: [], melds: [], discarded: [] },
                    { id: 1, name: 'é›»è…¦1', tiles: [], melds: [], discarded: [] },
                    { id: 2, name: 'é›»è…¦2', tiles: [], melds: [], discarded: [] },
                    { id: 3, name: 'é›»è…¦3', tiles: [], melds: [], discarded: [] }
                ],
                wall: [],
                currentPlayer: 0,
                lastDiscarded: null,
                availableActions: [],
                selectedTile: null,
                wind: 'æ±',
                round: 1
            };
            
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('gameMessage').textContent = 'æ­¡è¿ä¾†åˆ°éº»å°‡éŠæˆ²ï¼';
            document.getElementById('windInfo').textContent = 'æ±é¢¨å ´ ç¬¬1å±€';
        }

        // å‰µå»ºç‰Œé¢å…ƒç´ 
        function createTileElement(tile, isClickable = false, isSelected = false) {
            const div = document.createElement('div');
            div.className = `tile ${tile.class}`;
            div.textContent = tile.display;
            
            if (isClickable) {
                div.onclick = () => {
                    if (gameState.selectedTile === tile) {
                        discardTile(tile);
                    } else {
                        gameState.selectedTile = tile;
                        updateDisplay();
                    }
                };
            }
            
            if (isSelected) {
                div.classList.add('selected');
            }
            
            return div;
        }

        // å‰µå»ºéš±è—ç‰Œé¢
        function createHiddenTile() {
            const div = document.createElement('div');
            div.className = 'tile hidden';
            return div;
        }

        // å‰µå»ºç‰Œçµ„å…ƒç´ 
        function createMeldElement(meld) {
            const div = document.createElement('div');
            div.className = 'meld';
            
            meld.tiles.forEach(tile => {
                div.appendChild(createTileElement(tile));
            });
            
            const label = document.createElement('span');
            label.className = 'meld-label';
            label.textContent = meld.type === 'pong' ? 'ç¢°' : 
                               meld.type === 'kong' ? 'æ§“' : 'åƒ';
            div.appendChild(label);
            
            return div;
        }

        // æ›´æ–°é¡¯ç¤º
        function updateDisplay() {
            // æ›´æ–°ç•¶å‰ç©å®¶æŒ‡ç¤º
            for (let i = 0; i < 4; i++) {
                const nameElement = document.getElementById(`player${i}Name`);
                if (nameElement) {
                    if (i === gameState.currentPlayer) {
                        nameElement.classList.add('current');
                        nameElement.innerHTML = `${gameState.players[i].name} ğŸ‘†`;
                    } else {
                        nameElement.classList.remove('current');
                        nameElement.innerHTML = gameState.players[i].name;
                    }
                }
            }
            
            // æ›´æ–°æ¯å€‹ç©å®¶çš„ç‰Œ
            gameState.players.forEach((player, index) => {
                // æ›´æ–°æ‰‹ç‰Œ
                const tilesElement = document.getElementById(`player${index}Tiles`);
                if (tilesElement) {
                    tilesElement.innerHTML = '';
                    if (index === 0) {
                        // ç©å®¶çš„ç‰Œé¡¯ç¤º
                        player.tiles.forEach(tile => {
                            tilesElement.appendChild(createTileElement(
                                tile, 
                                gameState.currentPlayer === 0,
                                gameState.selectedTile === tile
                            ));
                        });
                    } else {
                        // AIçš„ç‰Œéš±è—
                        player.tiles.forEach(() => {
                            tilesElement.appendChild(createHiddenTile());
                        });
                    }
                }
                
                // æ›´æ–°ç‰Œçµ„
                const meldsElement = document.getElementById(`player${index}Melds`);
                if (meldsElement) {
                    meldsElement.innerHTML = '';
                    player.melds.forEach(meld => {
                        meldsElement.appendChild(createMeldElement(meld));
                    });
                }
            });
            
            // æ›´æ–°æ£„ç‰Œå€
            const discardPile = document.getElementById('discardPile');
            discardPile.innerHTML = '';
            gameState.players.forEach(player => {
                player.discarded.forEach(tile => {
                    discardPile.appendChild(createTileElement(tile));
                });
            });
            
            // æ›´æ–°æœ€å¾Œæ‰“å‡ºçš„ç‰Œ
            if (gameState.lastDiscarded) {
                const lastDiscardedElement = document.getElementById('lastDiscarded');
                lastDiscardedElement.style.display = 'inline-block';
                lastDiscardedElement.innerHTML = 'æœ€å¾Œæ‰“å‡ºçš„ç‰Œï¼š';
                lastDiscardedElement.appendChild(createTileElement(gameState.lastDiscarded.tile));
            }
            
            // æ›´æ–°ç‰Œç‰†æ•¸é‡
            document.getElementById('wallCount').textContent = gameState.wall.length;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDisplay();
        });
    </script>
</body>
</html>