
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>八卦方圓圖 — 真實六爻（單檔）</title>
<style>
  :root{
    --bg1:#fff8f0; --bg2:#efe6dd; --accent:#7b4b3a;
    font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
  .wrap{max-width:1100px;margin:18px auto;padding:12px;}
  h1{margin:6px 0;color:var(--accent);font-weight:700;}
  canvas{display:block;margin:12px auto;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.12);background:transparent;}
  .info{color:#5b4538;font-size:14px}
  .legend{margin-top:8px;color:#4b3a33;font-size:13px}
  a {color:#6b4f3f}
  button{padding:8px 12px;border-radius:8px;border:0;background:#7b4b3a;color:#fff;cursor:pointer}
</style>
</head>
<body>
  <div class="wrap">
    <h1>八卦方圓圖 — 六十四卦（真實六爻顯示）</h1>
    <div class="info">依你提供的 <code>gua64Names</code> 順序順時針排列；陽爻為實線，陰爻為中斷線。點任一卦可放大檢視。</div>
    <canvas id="c" width="1000" height="1000"></canvas>
    <div class="legend">
      資料來源（六十四卦二進位表示對照 King-Wen 順序）：Wikibooks 「I Ching — The 64 Hexagrams」。:contentReference[oaicite:1]{index=1}
    </div>
  </div>

<script>
/* 單檔：64卦方圓圖（真實六爻）說明：
   - 使用者提供的 gua64Names 陣列（含 64 個字串）作為順序
   - 我們以 King-Wen（文王）序的二進位表 (0 = 陰，1 = 陽) 作為每卦的真實六爻來源（已內嵌）
   - 每卦在圓周上畫出名稱與對應的六爻（從下到上）
   - 點擊某卦可在中間放大該卦（互動）
*/

// 使用者給定的順序（你原先提供）
const gua64Names1 = [ 
  "坤為地", "地雷復", "地水師", "地澤臨", "地山謙", "地火明夷", "地風升", "地天泰",
  "雷地豫", "震為雷", "雷水解", "雷澤歸妹", "雷山小過", "雷火豐", "雷風恆", "雷天大壯",
  "水地比", "水雷屯", "坎為水", "水澤節", "水山蹇", "水火既濟", "水風井", "水天需",
  "澤地萃", "澤雷隨", "澤水困", "兌為澤", "澤山咸", "澤火革", "澤風大過", "澤天夬",
  "山地剝", "山雷頤", "山水蒙", "山澤損", "艮為山", "山火賁", "山風蠱", "山天大畜",
  "火地晉", "火雷噬嗑", "火水未濟", "火澤睽", "火山旅", "離為火", "火風鼎", "火天大有",
  "風地觀", "風雷益", "風水渙", "風澤中孚", "風山漸", "風火家人", "巽為風", "風天小畜",
  "天地否", "天雷無妄", "天水訟", "天澤履", "天山遯", "天火同人", "天風姤", "乾為天"
];
const gua64Names = [ 
    "坤", "復", "師", "臨", "謙", "明夷", "升", "泰",
    "豫", "雷", "解", "歸妹", "小過", "豐", "恆", "大壯",
    "比", "屯", "水", "節", "蹇", "既濟", "井", "需",
    "萃", "隨", "困", "澤", "咸", "革", "大過", "夬",
    "剝", "頤", "蒙", "損", "山", "賁", "蠱", "大畜",
    "晉", "噬嗑", "未濟", "睽", "旅", "火", "鼎", "大有",
    "觀", "益", "渙", "中孚", "漸", "家人", "風", "小畜",
    "否", "無妄", "訟", "履", "遯", "同人", "姤", "天"
];
// 來源表：King-Wen（文王）序中每卦對應的中文（短名）與二進位 (從下爻到上爻的 6 位，0=陰、1=陽)
// 來源資料取自：Wikibooks "I Ching — The 64 Hexagrams"（King-Wen 序） -- 已人工整理成陣列
const kingWenTable21 = [
  /* index 1..64 in King-Wen order, but we store as 0..63 */
  {short:"乾",   bin:"111111"},
  {short:"坤",   bin:"000000"},
  {short:"屯",   bin:"010001"},
  {short:"蒙",   bin:"100010"},
  {short:"需",   bin:"010111"},
  {short:"訟",   bin:"111010"},
  {short:"師",   bin:"000010"},
  {short:"比",   bin:"010000"},
  {short:"小畜", bin:"110111"},
  {short:"履",   bin:"111011"},
  {short:"泰",   bin:"000111"},
  {short:"否",   bin:"111000"},
  {short:"同人", bin:"111101"},
  {short:"大有", bin:"101111"},
  {short:"謙",   bin:"000100"},
  {short:"豫",   bin:"001000"},
  {short:"隨",   bin:"011001"},
  {short:"蠱",   bin:"100110"},
  {short:"臨",   bin:"000011"},
  {short:"觀",   bin:"110000"},
  {short:"噬嗑", bin:"101001"},
  {short:"賁",   bin:"100101"},
  {short:"剝",   bin:"100000"},
  {short:"復",   bin:"000001"},
  {short:"無妄", bin:"111001"},
  {short:"大畜", bin:"100111"},
  {short:"頤",   bin:"100001"},
  {short:"大過", bin:"011110"},
  {short:"坎",   bin:"010010"},
  {short:"離",   bin:"101101"},
  {short:"咸",   bin:"011100"},
  {short:"恆",   bin:"001110"},
  {short:"遯",   bin:"111100"},
  {short:"大壯", bin:"001111"},
  {short:"晉",   bin:"101000"},
  {short:"明夷", bin:"000101"},
  {short:"家人", bin:"110101"},
  {short:"睽",   bin:"101011"},
  {short:"蹇",   bin:"010100"},
  {short:"解",   bin:"001010"},
  {short:"損",   bin:"100011"},
  {short:"益",   bin:"110001"},
  {short:"夬",   bin:"011111"},
  {short:"姤",   bin:"111110"},
  {short:"萃",   bin:"011000"},
  {short:"升",   bin:"000110"},
  {short:"困",   bin:"011010"},
  {short:"井",   bin:"010110"},
  {short:"革",   bin:"011101"},
  {short:"鼎",   bin:"101110"},
  {short:"震",   bin:"001001"},
  {short:"艮",   bin:"100100"},
  {short:"漸",   bin:"110100"},
  {short:"歸妹", bin:"001011"},
  {short:"豐",   bin:"001101"},
  {short:"旅",   bin:"101100"},
  {short:"巽",   bin:"110110"},
  {short:"兌",   bin:"011011"},
  {short:"渙",   bin:"110010"},
  {short:"節",   bin:"010011"},
  {short:"中孚", bin:"110011"},
  {short:"小過", bin:"001100"},
  {short:"既濟", bin:"010101"},
  {short:"未濟", bin:"101010"}
];
const kingWenTable = [
    {short:"坤為地", bin:"000000"},
    {short:"地雷復", bin:"000001"},
    {short:"地水師", bin:"000010"},
    {short:"地澤臨", bin:"000011"},
    {short:"地山謙", bin:"000100"},
    {short:"地火明夷", bin:"000101"},
    {short:"地風升", bin:"000110"},
    {short:"地天泰", bin:"000111"},

    {short:"雷地豫", bin:"001000"},
    {short:"震為雷", bin:"001001"},
    {short:"雷水解", bin:"001010"},
    {short:"雷澤歸妹", bin:"001011"},
    {short:"雷山小過", bin:"001100"},
    {short:"雷火豐", bin:"001101"},
    {short:"雷風恆", bin:"001110"},
    {short:"雷天大壯", bin: "001111"},

    {short:"水地比", bin:"010000"},
    {short:"水雷屯", bin:"010001"},
    {short:"坎為水", bin:"010010"},
    {short:"水澤節", bin:"010011"},
    {short:"水山蹇", bin:"010100"},
    {short:"水火既濟", bin:"010101"},
    {short:"水風井", bin:"010110"},
    {short:"水天需", bin:"010111"},

    {short:"澤地萃", bin:"011000"},
    {short:"澤雷隨", bin:"011001"},
    {short:"澤水困", bin:"011010"},
    {short:"兌為澤", bin:"011011"},
    {short:"澤山咸", bin:"011100"},
    {short:"澤火革", bin:"011101"},
    {short:"澤風大過", bin: "011110"},
    {short:"澤天夬", bin:"011111"},

    {short:"山地剝", bin:"100000"},
    {short:"山雷頤", bin:"100001"},
    {short:"山水蒙", bin:"100010"},
    {short:"山澤損", bin:"100011"},
    {short:"艮為山", bin:"100100"},
    {short:"山火賁", bin:"100101"},
    {short:"山風蠱", bin:"100110"},
    {short:"山天大畜", bin:"100111"},

    {short:"火地晉", bin:"101000"},
    {short:"火雷噬嗑", bin:"101001"},
    {short:"火水未濟", bin:"101010"},
    {short:"火澤睽", bin:"101011"},
    {short:"火山旅", bin:"101100"},
    {short:"離為火", bin:"101101"},
    {short:"火風鼎", bin:"101110"},
    {short:"火天大有", bin:"101111"},

    {short:"風地觀", bin:"110000"},
    {short:"風雷益", bin:"110001"},
    {short:"風水渙", bin:"110010"},
    {short:"風澤中孚", bin:"110011"},
    {short:"風山漸", bin:"110100"},
    {short:"風火家人", bin:"110101"},
    {short:"巽為風", bin:"110110"},
    {short:"風天小畜", bin:"110111"},

    {short:"天地否",   bin:"111000"},
    {short:"天雷無妄", bin:"111001"},
    {short:"天水訟",   bin:"111010"},
    {short:"天澤履",   bin:"111011"},
    {short:"天山遯",   bin:"111100"},
    {short:"天火同人", bin:"111101"},
    {short:"天風姤",   bin:"111110"},
    {short:"乾為天",   bin:"111111"}
];

// 小工具：給定一個 gua 名稱（你的 gua64Names 裡的字串），試著在 kingWenTable 中比對短名（短名通常是最後或包含於字串）
// 如果找不到就回 fallback（顯示為灰色問號）
function findBinaryForName(fullName){
  // 優先以「短名為子字串」來尋找
  for(const entry of kingWenTable){
    if(fullName.indexOf(entry.short) !== -1){
      return entry.bin;
    }
  }
  // 再嘗試比對「包含短名的其他變體」（比如「為」字順序反轉等）
  // 嘗試把 fullName 裡的常見詞去掉再找
  const cleaned = fullName.replace(/為|卦|之|﹝﹞/g, "");
  for(const entry of kingWenTable){
    if(cleaned.indexOf(entry.short) !== -1) return entry.bin;
  }
  return null;
}

// canvas 與繪製參數
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = canvas.width, H = canvas.height;
const cx = W/2, cy = H/2;
const outerR = 420;
const nameR = 470;
const guaR = 380;

// 互動 state
let scale = 1;
let offsetX = 0, offsetY = 0;
let dragging=false, lastMouse = null;

// 繪製主要畫面
function draw(){
  ctx.save();
  ctx.clearRect(0,0,W,H);

  // 背景（古風漸層）
  const g = ctx.createRadialGradient(cx,cy,60,cx,cy,outerR+60);
  g.addColorStop(0,'#fffaf0');
  g.addColorStop(1,'#e9e0d6');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,W,H);

  // 中心裝飾
  ctx.save();
  ctx.translate(cx + offsetX, cy + offsetY);
  ctx.scale(scale, scale);

  // 外圈圓
  ctx.beginPath();
  ctx.arc(0,0,outerR,0,Math.PI*2);
  ctx.lineWidth = 6/scale;
  ctx.strokeStyle = '#6b4b3a';
  ctx.stroke();

  // 畫 64 個卦
  const N = gua64Names.length;
  ctx.textAlign = 'center';
  for(let i=0;i<N;i++){
    const angle = (i / N) * Math.PI*2 - Math.PI/2; // 從上方開始順時針
    const gx = Math.cos(angle) * guaR;
    const gy = Math.sin(angle) * guaR;
    // 位子轉換至畫布中心
    const px = gx, py = gy;

    // 小圓點
    ctx.beginPath(); ctx.arc(px,py,6/scale,0,Math.PI*2); ctx.fillStyle = '#3e2723'; ctx.fill();

    // 畫卦圖（小尺寸）
    const bin = findBinaryForName(gua64Names[i]);
    drawMiniGua(ctx, px, py - 34/scale, 46/scale, 32/scale, bin); // 往上偏移寫名與卦圖分離

    // 寫卦名（放在圓外側）
    const tx = Math.cos(angle) * nameR;
    const ty = Math.sin(angle) * nameR;
    ctx.save();
    ctx.translate(tx, ty);
    // 旋轉文字，使文字朝外（便於閱讀）
    let rot = angle + Math.PI/2;
    // keep text upright by flipping if upside-down
    const deg = (rot * 180/Math.PI) % 360;
    if(deg > 90 && deg < 270) { rot += Math.PI; }
    ctx.rotate(rot);
    ctx.font = `${14/scale}px "Noto Sans TC",sans-serif`;
    ctx.fillStyle = '#2f1f16';
    ctx.fillText(gua64Names[i], 0, 0);
    ctx.restore();
  }

  // 中心：八卦方位（乾坤震巽離坎艮兌 或你喜歡的排列）
  const bagua = ["乾","坤","震","巽","坎","離","艮","兌"];
  ctx.font = `${22/scale}px "Noto Sans TC",sans-serif`;
  for(let j=0;j<8;j++){
    const a = (j/8)*Math.PI*2 - Math.PI/2;
    const rx = Math.cos(a) * 160;
    const ry = Math.sin(a) * 160;
    ctx.fillStyle = '#5b4032';
    ctx.fillText(bagua[j], rx, ry);
  }

  // 中央圓與標題
  ctx.beginPath(); ctx.arc(0,0,110/scale,0,Math.PI*2); ctx.fillStyle='#fff8e6'; ctx.fill();
  ctx.lineWidth = 3/scale; ctx.strokeStyle='#8b6b56'; ctx.stroke();
  ctx.font = `${20/scale}px "Noto Sans TC",sans-serif`; ctx.fillStyle='#5b4032'; ctx.fillText('八卦方圓圖', 0, -6/scale);
  ctx.font = `${12/scale}px "Noto Sans TC",sans-serif`; ctx.fillText('（點任一卦可放大檢視）', 0, 18/scale);

  ctx.restore();
  ctx.restore();
}

// 繪製一個小卦符，參數：ctx, center x/y, width, height, binString (6 位) 或 null
// 若 binString 為 null，畫灰色問號
function drawMiniGua(ctx, cx_, cy_, w, h, binString){
  ctx.save();
  ctx.translate(cx_, cy_);
  // six lines從下到上排列
  const lineH = h / 6;
  const halfW = w/2;
  ctx.lineWidth = Math.max(1, Math.min(3, lineH * 0.28));
  if(!binString){
    // 畫一個問號框
    ctx.fillStyle='rgba(120,120,120,0.12)';
    ctx.fillRect(-w/2, -h/2, w, h);
    ctx.fillStyle='#7b4b3a'; ctx.font = `${Math.max(10, lineH)}px sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('?',0,0);
    ctx.restore();
    return;
  }
  // binString 預期為 '010101'（下到上）
  // 繪製每一爻：陽=實線，陰=斷線（兩段）
  for(let i=0;i<6;i++){
  //for(let i=6;i>0;i--){
    const b = binString.charAt(i);
    const y = (h/2) - (i+0.5)*lineH; // 從上到下，調整：我們要從下到上 -> invert index
    const yi = -h/2 + (5 - i + 0.5) * lineH; // 使 index=0 對應最低線
    ctx.strokeStyle = '#111';
    if(b === '1'){ // 陽爻：實線
      ctx.beginPath(); ctx.moveTo(-halfW, yi); ctx.lineTo(halfW, yi); ctx.stroke();
    } else { // 陰爻：斷線 -> 左短 + 右短
      const gap = Math.max(8, w * 0.18);
      ctx.beginPath(); ctx.moveTo(-halfW, yi); ctx.lineTo(-gap/2, yi); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(gap/2, yi); ctx.lineTo(halfW, yi); ctx.stroke();
    }
  }
  ctx.restore();
}

// ---------- 互動：點擊放大檢視某卦 ----------
canvas.addEventListener('click', (ev) => {
  const rect = canvas.getBoundingClientRect();
  const mx = ev.clientX - rect.left;
  const my = ev.clientY - rect.top;
  // 轉回我們的視圖座標（考慮 scale 與 offset）
  const vx = (mx - W/2 - offsetX) / scale;
  const vy = (my - H/2 - offsetY) / scale;
  // 找最接近的卦（以 guaR 為半徑）
  const N = gua64Names.length;
  let best = -1, bestDist=1e9;
  for(let i=0;i<N;i++){
    const angle = (i / N) * Math.PI*2 - Math.PI/2;
    const gx = Math.cos(angle) * guaR;
    const gy = Math.sin(angle) * guaR;
    const d = Math.hypot(vx - gx, vy - gy);
    if(d < bestDist){ bestDist = d; best = i; }
  }
  if(bestDist < 48){ // 點在卦附近 => 顯示在中間（簡單的放大顯示）
    showDetail(best);
  }
});

// 顯示放大檢視（簡單做法：在 canvas 中央畫一個對話框）
function showDetail(idx){
  const name = gua64Names[idx];
  const bin = findBinaryForName(name);
  // 在畫面上用一個暫態 overlay 畫出放大圖
  // 這裡直接在 canvas 中間畫一個半透明面板
  ctx.save();
  // 暫停並畫半透明遮罩
  ctx.fillStyle = 'rgba(0,0,0,0.45)';
  ctx.fillRect(0,0,W,H);
  ctx.translate(cx, cy);
  // panel
  ctx.fillStyle = '#fffef7';
  roundRect(ctx, -260, -160, 520, 320, 12);
  ctx.fill();
  ctx.lineWidth = 2; ctx.strokeStyle='#8b6b56'; ctx.stroke();
  // 標題與卦名
  ctx.fillStyle = '#5b4032'; ctx.font = '22px "Noto Sans TC",sans-serif'; ctx.textAlign='center';
  ctx.fillText(name, 0, -100);
  // 放大卦圖（左右顯示六爻）
  const w = 260, h = 240;
  drawBigGua(ctx, -10, -10, 140, 180, bin);

  // 若有對應短名，顯示短名與 King-Wen index（若能找到）
  const short = kingWenTable.find(e => name.indexOf(e.short) !== -1);
  if(short){
    const idxKW = kingWenTable.indexOf(short) + 1;
    ctx.font = '14px "Noto Sans TC",sans-serif';
    ctx.fillText(`短名：${short.short}   King-Wen 編號：${idxKW}`, 0, 120);
  } else {
    ctx.font = '14px "Noto Sans TC",sans-serif';
    ctx.fillText(`（未能自動識別短名）`, 0, 120);
  }

  // 指示關閉（點擊任處）
  ctx.font = '12px "Noto Sans TC",sans-serif'; ctx.fillStyle='#6b4b3a'; ctx.fillText('點擊畫面任處關閉', 0, 145);

  // 監聽下一次點擊以清除 overlay（只一次）
  function onClose(){ window.removeEventListener('click', onClose); draw(); }
  setTimeout(()=>{ window.addEventListener('click', onClose); }, 50);
  ctx.restore();
}

function drawBigGua(ctx, cx_, cy_, w, h, binString){
  ctx.save(); ctx.translate(cx_, cy_);
  // draw frame
  ctx.strokeStyle = '#2d1f18'; ctx.lineWidth = 3; roundRect(ctx, -w/2-10, -h/2-10, w+20, h+20, 8); ctx.stroke();
  // draw six lines inside
  const lineH = h / 6;
  const halfW = w/2;
  ctx.lineWidth = Math.max(2, lineH * 0.22);
  for(let i=0;i<6;i++){
    const b = binString ? binString.charAt(i) : '0';
    const yi = -h/2 + (5 - i + 0.5) * lineH;
    if(b === '1'){ ctx.beginPath(); ctx.moveTo(-halfW, yi); ctx.lineTo(halfW, yi); ctx.stroke(); }
    else { const gap = Math.max(14, w*0.18); ctx.beginPath(); ctx.moveTo(-halfW, yi); ctx.lineTo(-gap/2, yi); ctx.stroke(); ctx.beginPath(); ctx.moveTo(gap/2, yi); ctx.lineTo(halfW, yi); ctx.stroke(); }
  }
  ctx.restore();
}

// helper: 圓角矩形
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

// ---------- 縮放與拖曳（基本） ----------
canvas.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const delta = -e.deltaY;
  const factor = delta > 0 ? 1.08 : 0.92;
  // 縮放在視窗中心
  const beforeScale = scale;
  scale *= factor;
  scale = Math.max(0.5, Math.min(2.6, scale));
  draw();
});

canvas.addEventListener('pointerdown', (e)=>{
  dragging = true; lastMouse = {x:e.clientX, y:e.clientY};
  canvas.setPointerCapture(e.pointerId);
});
canvas.addEventListener('pointermove', (e)=>{
  if(!dragging) return;
  const dx = e.clientX - lastMouse.x;
  const dy = e.clientY - lastMouse.y;
  lastMouse = {x:e.clientX, y:e.clientY};
  offsetX += dx; offsetY += dy;
  draw();
});
canvas.addEventListener('pointerup', (e)=>{ dragging=false; });

// 初始繪製
draw();

</script>
</body>
</html>
