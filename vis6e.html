<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å…­åå››å¦ Ã— èƒºåŸºé…¸å¯†ç¢¼å­ Ã— å¹²æ”¯äº”è¡Œ â€” å¢å¼·ç‰ˆäº’å‹•è¨ˆç®—å™¨</title>
  <style>
    body{font-family: system-ui, -apple-system, "å¾®è»Ÿæ­£é»‘é«”", "Noto Sans TC", Arial; margin:12px; background:#f7f7fb; color:#111}
    h1{font-size:18px;margin:6px 0;color:#1e40af}
    .layout{display:flex;gap:12px;flex-wrap:wrap}
    .panel{background:white;padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);flex:1;min-width:300px}
    .grid{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
    .node{background:linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);border-radius:8px;padding:6px;text-align:center;cursor:pointer;border:1px solid rgba(12,34,99,0.06);transition:all 0.2s ease}
    .node:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(12,34,99,0.12);background:linear-gradient(135deg, #dfe8ff 0%, #c7d2fe 100%)}
    .node.active{background:linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);border:2px solid #6366f1;transform:translateY(-2px)}
    .hexagram-name{font-size:10px;font-weight:600;color:#1e40af;margin-bottom:2px;line-height:1.2}
    .codon-info{font-size:11px;color:#374151;margin:1px 0}
    .binary{font-size:9px;color:#6b7280;font-family:monospace}
    label{display:block;margin-top:6px;font-size:13px;font-weight:500}
    input[type=range]{width:100%;accent-color:#6366f1}
    .kv{display:flex;justify-content:space-between;font-size:13px;margin:4px 0}
    .kv strong{color:#1e40af}
    pre{background:#0f172a;color:#e2e8f0;padding:12px;border-radius:8px;overflow:auto;font-size:12px;line-height:1.4}
    .small{font-size:12px;color:#6b7280;line-height:1.4}
    button{background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,0.3)}
    button:active{transform:translateY(0px)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{padding:6px 8px;border-radius:6px;border:1px solid #d1d5db;font-size:12px}
    .fortune{padding:8px 12px;border-radius:8px;font-weight:600;text-align:center;margin:8px 0}
    .fortune.å¤§å‰{background:#dcfce7;color:#166534;border:1px solid #86efac}
    .fortune.å°å‰{background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0}
    .fortune.å¹³{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
    .fortune.å°å‡¶{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
    .fortune.å¤§å‡¶{background:#fecaca;color:#7f1d1d;border:1px solid #f87171}
    .wuxing-chart{display:flex;gap:4px;margin:8px 0;height:24px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
    .wuxing-bar{display:flex;align-items:center;justify-content:center;color:white;font-size:10px;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,0.3);transition:all 0.3s ease}
    .wuxing-bar:hover{transform:scaleY(1.2);z-index:10}
    .wuxing-legend{display:flex;gap:8px;margin:4px 0;font-size:11px}
    .wuxing-item{display:flex;align-items:center;gap:3px}
    hr{border:none;height:1px;background:#e5e7eb;margin:10px 0}
  </style>
</head>
<body>
  <h1>å…­åå››å¦ Ã— èƒºåŸºé…¸å¯†ç¢¼å­ Ã— å¹²æ”¯äº”è¡Œ â€” å¢å¼·ç‰ˆäº’å‹•è¨ˆç®—å™¨</h1>
  <div class="layout">
    <div class="panel" style="flex:0 1 580px">
      <div class="small">èªªæ˜ï¼šé»é¸ä¸€å€‹å…­åå››å¦ç¯€é»ï¼Œæ¯å¦å°æ‡‰ä¸€å€‹RNAå¯†ç¢¼å­ã€‚ç³»çµ±æœƒçµåˆã€Œä»Šæ—¥å¹²æ”¯ â†’ äº”è¡Œå‘é‡ã€èˆ‡æ‰€é¸å¯†ç¢¼å­çš„æ•¸å€¼ï¼Œé€šééè¿´å…¬å¼è¨ˆç®—é‹å‹¢åˆ†æ•¸ã€‚å¦åºæ¡ç”¨æ–‡ç‹å…­åå››å¦åºã€‚</div>
      <hr />
      <div class="grid" id="grid"></div>
    </div>

    <div class="panel" style="flex:0 1 420px">
      <div id="info">
        <div class="kv"><strong>é¸ä¸­å¦è±¡ï¼š</strong><span id="selName">â€”</span></div>
        <div class="kv"><strong>äºŒé€²ä½ç¢¼ï¼š</strong><span id="selBinary">â€”</span></div>
        <div class="kv"><strong>å°æ‡‰å¯†ç¢¼å­ï¼š</strong><span id="selCodon">â€”</span></div>
        <div class="kv"><strong>èƒºåŸºé…¸ï¼š</strong><span id="selAA">â€”</span></div>
        <div class="kv"><strong>å¯†ç¢¼å­å€¼ï¼ˆæœªç¸®æ”¾ï¼‰ï¼š</strong><span id="selVal">â€”</span></div>
        <div class="kv"><strong>S_tï¼ˆåˆå§‹åˆ†æ•¸ 0â€“100ï¼‰ï¼š</strong><span id="stVal">â€”</span></div>
        <hr />
        <div class="kv"><strong>ä»Šæ—¥å…¬æ›†ï¼š</strong><span id="todayDate">â€”</span></div>
        <div class="kv"><strong>ä»Šæ—¥å¹²æ”¯ï¼š</strong><span id="ganzhi">â€”</span></div>
        <div class="kv"><strong>å¤©å¹²äº”è¡Œï¼š</strong><span id="stemWu">â€”</span></div>
        <div class="kv"><strong>åœ°æ”¯äº”è¡Œï¼š</strong><span id="branchWu">â€”</span></div>
        <div class="kv"><strong>ç¶œåˆäº”è¡Œå‘é‡ V_tï¼š</strong><span id="vwx">â€”</span></div>
        <div id="wuxingChart" style="margin: 8px 0;"></div>
      </div>

      <hr />
      <div>
        <label>Î±ï¼ˆç”Ÿæ‰¶æ”¾å¤§ä¿‚æ•¸ï¼‰ <span id="alphaVal">1.2</span></label>
        <input id="alpha" type="range" min="0" max="3" step="0.01" value="1.2" />
        <label>Î²ï¼ˆå‰‹åˆ¶æ”¾å¤§ä¿‚æ•¸ï¼‰ <span id="betaVal">0.8</span></label>
        <input id="beta" type="range" min="0" max="3" step="0.01" value="0.8" />
        <label>Î´ æ¬Šé‡æ¨¡å¼</label>
        <div class="row"><select id="deltaMode"><option value="exp">2^{i-1}ï¼ˆæŒ‡æ•¸éå¢ï¼‰</option><option value="equal">ç­‰æ¬Šé‡</option><option value="fib">è²»æ°æ•¸åˆ—</option></select><button id="normBtn">æ­£è¦åŒ– Î´</button></div>
        <label>æŠ•å½±å‡½æ•¸ P</label>
        <div class="row"><select id="pMode"><option value="clamp">é™åˆ¶ç¯„åœ [0,100]</option><option value="sigmoid">Sigmoid æ˜ å°„</option><option value="tanh">Tanh æ˜ å°„</option><option value="identity">ç„¡è®Šæ›</option></select></div>
      </div>

      <hr />
      <div>
        <button id="calcBtn">ğŸ”® è¨ˆç®—é‹å‹¢ S_{t+1}</button>
        <div style="height:8px"></div>
        <div class="kv"><strong>é‹å‹¢åˆ†æ•¸ï¼š</strong><span id="st1">â€”</span></div>
        <div class="fortune" id="luckDisplay" style="display:none">â€”</div>
      </div>

      <hr />
      <div>
        <label>åƒæ•¸æ§åˆ¶</label>
        <div class="row">
          <button id="resetBtn">ğŸ”„ æ¢å¾©é è¨­</button>
          <button id="randomBtn">ğŸ² éš¨æ©Ÿåƒæ•¸</button>
          <button id="exportBtn">ğŸ“¤ åŒ¯å‡ºè¨­å®š</button>
        </div>
      </div>
    </div>
  </div>

  <hr />
  <div class="panel">
    <strong>ğŸ” è¨ˆç®—éç¨‹è©³è§£</strong>
    <pre id="trace">è«‹é¸æ“‡ä¸€å€‹å¦è±¡ä¸¦é»æ“Šã€Œè¨ˆç®—é‹å‹¢ã€é–‹å§‹åˆ†æã€‚</pre>
  </div>

<script>
// 64å¦åï¼ˆæ–‡ç‹å¦åºï¼‰
const guaNames = [
  "ä¹¾ç‚ºå¤©", "æ¾¤å¤©å¤¬", "ç«å¤©å¤§æœ‰", "é›·å¤©å¤§å£¯", "é¢¨å¤©å°ç•œ", "æ°´å¤©éœ€", "å±±å¤©å¤§ç•œ", "åœ°å¤©æ³°",
  "å¤©æ¾¤å±¥", "å…Œç‚ºæ¾¤", "ç«æ¾¤ç½", "é›·æ¾¤æ­¸å¦¹", "é¢¨æ¾¤ä¸­å­š", "æ°´æ¾¤ç¯€", "å±±æ¾¤æ", "åœ°æ¾¤è‡¨",
  "å¤©ç«åŒäºº", "æ¾¤ç«é©", "é›¢ç‚ºç«", "é›·ç«è±", "é¢¨ç«å®¶äºº", "æ°´ç«æ—¢æ¿Ÿ", "å±±ç«è³", "åœ°ç«æ˜å¤·",
  "å¤©é›·ç„¡å¦„", "æ¾¤é›·éš¨", "ç«é›·å™¬å—‘", "éœ‡ç‚ºé›·", "é¢¨é›·ç›Š", "æ°´é›·å±¯", "å±±é›·é ¤", "åœ°é›·å¾©",
  "å¤©é¢¨å§¤", "æ¾¤é¢¨å¤§é", "ç«é¢¨é¼", "é›·é¢¨æ†", "å·½ç‚ºé¢¨", "æ°´é¢¨äº•", "å±±é¢¨è ±", "åœ°é¢¨å‡",
  "å¤©æ°´è¨Ÿ", "æ¾¤æ°´å›°", "ç«æ°´æœªæ¿Ÿ", "é›·æ°´è§£", "é¢¨æ°´æ¸™", "åç‚ºæ°´", "å±±æ°´è’™", "åœ°æ°´å¸«",
  "å¤©å±±é¯", "æ¾¤å±±å’¸", "ç«å±±æ—…", "é›·å±±å°é", "é¢¨å±±æ¼¸", "æ°´å±±è¹‡", "è‰®ç‚ºå±±", "åœ°å±±è¬™",
  "å¤©åœ°å¦", "æ¾¤åœ°èƒ", "ç«åœ°æ™‰", "é›·åœ°è±«", "é¢¨åœ°è§€", "æ°´åœ°æ¯”", "å±±åœ°å‰", "å¤ç‚ºåœ°"
];

// äºŒé€²ä½ä»£ç¢¼ï¼ˆæ–‡ç‹å¦åºï¼‰
const kingwenBits = [
  "111111","111110","111101","111100","111011","111010","111001","111000",
  "110111","110110","110101","110100","110011","110010","110001","110000",
  "101111","101110","101101","101100","101011","101010","101001","101000",
  "100111","100110","100101","100100","100011","100010","100001","100000",
  "011111","011110","011101","011100","011011","011010","011001","011000",
  "010111","010110","010101","010100","010011","010010","010001","010000",
  "001111","001110","001101","001100","001011","001010","001001","001000",
  "000111","000110","000101","000100","000011","000010","000001","000000"
];

// 64 å€‹ RNA å¯†ç¢¼å­
const codonList = [
  'TTT','TTC','TTA','TTG','TCT','TCC','TCA','TCG',
  'TAT','TAC','TAA','TAG','TGT','TGC','TGA','TGG',
  'CTT','CTC','CTA','CTG','CCT','CCC','CCA','CCG',
  'CAT','CAC','CAA','CAG','CGT','CGC','CGA','CGG',
  'ATT','ATC','ATA','ATG','ACT','ACC','ACA','ACG',
  'AAT','AAC','AAA','AAG','AGT','AGC','AGA','AGG',
  'GTT','GTC','GTA','GTG','GCT','GCC','GCA','GCG',
  'GAT','GAC','GAA','GAG','GGT','GGC','GGA','GGG'
];

// èƒºåŸºé…¸å°æ‡‰è¡¨
const codonToAA = {
  TTT:'Phe',TTC:'Phe',TTA:'LeT',TTG:'LeT',TCT:'Ser',TCC:'Ser',TCA:'Ser',TCG:'Ser',
  TAT:'Tyr',TAC:'Tyr',TAA:'Stop',TAG:'Stop',TGT:'Cys',TGC:'Cys',TGA:'Stop',TGG:'Trp',
  CTT:'LeT',CTC:'LeT',CTA:'LeT',CTG:'LeT',CCT:'Pro',CCC:'Pro',CCA:'Pro',CCG:'Pro',
  CAT:'His',CAC:'His',CAA:'Gln',CAG:'Gln',CGT:'Arg',CGC:'Arg',CGA:'Arg',CGG:'Arg',
  ATT:'Ile',ATC:'Ile',ATA:'Ile',ATG:'Met',ACT:'Thr',ACC:'Thr',ACA:'Thr',ACG:'Thr',
  AAT:'Asn',AAC:'Asn',AAA:'Lys',AAG:'Lys',AGT:'Ser',AGC:'Ser',AGA:'Arg',AGG:'Arg',
  GTT:'Val',GTC:'Val',GTA:'Val',GTG:'Val',GCT:'Ala',GCC:'Ala',GCA:'Ala',GCG:'Ala',
  GAT:'Asp',GAC:'Asp',GAA:'GlT',GAG:'GlT',GGT:'Gly',GGC:'Gly',GGA:'Gly',GGG:'Gly'
};

// å¯†ç¢¼å­æ•¸å€¼è¨ˆç®—
const baseVal = {T:1,C:2,A:3,G:4};
function codonValue(codon){
  return codon.split('').reduce((s,ch)=>s + (baseVal[ch]||0),0);
}
function scaleTo100(v){ return v * (100/12); }

// å¹²æ”¯èˆ‡äº”è¡Œç³»çµ±
const stems = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
const branches = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
const stemToWu = { 'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´' };
const branchToWu = { 
  'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«',
  'åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´' 
};
const wuIndex = { 'æœ¨':0,'ç«':1,'åœŸ':2,'é‡‘':3,'æ°´':4 };
const wuNames = ['æœ¨','ç«','åœŸ','é‡‘','æ°´'];
const wuColors = ['#22c55e','#ef4444','#64748b','#f59e0b','#3b82f6'];
const wuxingColors = wuColors; // åˆ¥åï¼Œä¿æŒå…¼å®¹æ€§

function stemToVector(stem){ 
  const v = [0,0,0,0,0]; 
  v[wuIndex[stemToWu[stem]]] = 1; 
  return v; 
}

function branchToVector(branch){ 
  const v = [0,0,0,0,0]; 
  v[wuIndex[branchToWu[branch]]] = 1; 
  return v; 
}

function combineVectors(stemVec, branchVec, stemWeight = 0.6, branchWeight = 0.4) {
  return stemVec.map((s, i) => s * stemWeight + branchVec[i] * branchWeight);
}

// è¨ˆç®—å¹²æ”¯æ—¥æœŸ
function daysBetween(a,b){
  const _MS = 24*3600*1000;
  return Math.floor((Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()) - Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()))/_MS);
}
const refDate = new Date(Date.UTC(1984,1,2)); // 1984-02-02 ç”²å­æ—¥

function getGanZhiForDate(d){
  const days = daysBetween(refDate, d);
  const idx = ((days % 60) + 60) % 60;
  const stem = stems[idx % 10];
  const branch = branches[idx % 12];
  return {stem, branch, idx};
}

// åˆå§‹åŒ– M çŸ©é™£ï¼ˆç”Ÿæ‰¶èˆ‡å‰‹åˆ¶ï¼‰
let Msheng = [];
let Mke = [];
for(let i=0;i<6;i++){
  // æ›´ç²¾ç·»çš„æ¬Šé‡åˆ†é…
  const baseSheng = Array(5).fill(0).map((_,j)=>{
    const phase = (i*0.7 + j*1.3) % (2*Math.PI);
    return (Math.sin(phase) + 1.2) / 2.2 * 0.15 + 0.05;
  });
  Msheng.push(baseSheng);
  
  const baseKe = Array(5).fill(0).map((_,j)=>{
    const phase = (i*1.1 + j*0.9 + Math.PI/3) % (2*Math.PI);
    return (Math.cos(phase) + 1.1) / 2.1 * 0.12 + 0.03;
  });
  Mke.push(baseKe);
}

// Î´ æ¬Šé‡ç³»çµ±
let delta = [1,2,4,8,16,32]; // é è¨­æŒ‡æ•¸æ¬Šé‡
function updateDelta(){
  const mode = document.getElementById('deltaMode').value;
  if(mode === 'equal'){
    delta = Array(6).fill(1);
  } else if(mode === 'fib'){
    delta = [1,1,2,3,5,8];
  } else {
    delta = [1,2,4,8,16,32];
  }
  normalizeDelta();
}

function normalizeDelta(){ 
  const s = delta.reduce((a,b)=>a+b,0); 
  delta = delta.map(x=>x/s); 
}

// å»ºç«‹ç¶²æ ¼ä»‹é¢
const grid = document.getElementById('grid');
codonList.forEach((c, idx)=>{
  const el = document.createElement('div');
  el.className = 'node';
  el.dataset.codon = c;
  el.dataset.idx = idx;
  el.innerHTML = `
    <div class="hexagram-name">${guaNames[idx]}</div>
    <div class="codon-info">${c} â†’ ${codonToAA[c]||''}</div>
    <div class="binary">${kingwenBits[idx]}</div>
  `;
  el.addEventListener('click', ()=>selectNode(el));
  grid.appendChild(el);
});

let currentEl = null;
function selectNode(el){ 
  if(currentEl) currentEl.classList.remove('active'); 
  currentEl = el; 
  el.classList.add('active');
  
  const idx = parseInt(el.dataset.idx);
  const c = el.dataset.codon; 
  const aa = codonToAA[c]||''; 
  const val = codonValue(c); 
  const scaled = Math.round(scaleTo100(val)*100)/100;
  
  document.getElementById('selName').innerText = guaNames[idx];
  document.getElementById('selBinary').innerText = kingwenBits[idx];
  document.getElementById('selCodon').innerText = c; 
  document.getElementById('selAA').innerText = aa; 
  document.getElementById('selVal').innerText = val;
  document.getElementById('stVal').innerText = scaled;
}

// é¡¯ç¤ºä»Šæ—¥ä¿¡æ¯
function showToday(){ 
  const d = new Date(); 
  document.getElementById('todayDate').innerText = d.toLocaleDateString('zh-TW'); 
  const gz = getGanZhiForDate(d); 
  document.getElementById('ganzhi').innerText = gz.stem + gz.branch + ` (ç¬¬${gz.idx+1}æ—¥)`; 
  
  // é¡¯ç¤ºå¤©å¹²åœ°æ”¯äº”è¡Œ
  const stemWu = stemToWu[gz.stem];
  const branchWu = branchToWu[gz.branch];
  document.getElementById('stemWu').innerText = `${gz.stem} â†’ ${stemWu}`;
  document.getElementById('branchWu').innerText = `${gz.branch} â†’ ${branchWu}`;
  
  // è¨ˆç®—ç¶œåˆäº”è¡Œå‘é‡
  const stemVec = stemToVector(gz.stem);
  const branchVec = branchToVector(gz.branch);
  const combinedVec = combineVectors(stemVec, branchVec);
  
  document.getElementById('vwx').innerText = `[${combinedVec.map(x=>x.toFixed(2)).join(', ')}]`;
  
  // ç¹ªè£½äº”è¡Œåˆ†ä½ˆåœ–è¡¨
  drawWuxingChart(combinedVec);
}

function drawWuxingChart(wuxingVec) {
  const chartEl = document.getElementById('wuxingChart');
  const maxVal = Math.max(...wuxingVec);
  const minWidth = 20; // æœ€å°å¯¬åº¦
  
  let chartHTML = '<div class="wuxing-chart">';
  wuxingVec.forEach((val, i) => {
    const percentage = maxVal > 0 ? Math.max((val / maxVal * 80), minWidth) : minWidth;
    chartHTML += `<div class="wuxing-bar" style="flex:${percentage}; background:${wuxingColors[i]}" title="${wuNames[i]}: ${val.toFixed(3)}">${wuNames[i]}</div>`;
  });
  chartHTML += '</div>';
  
  // æ·»åŠ åœ–ä¾‹
  chartHTML += '<div class="wuxing-legend">';
  wuNames.forEach((name, i) => {
    chartHTML += `<div class="wuxing-item"><div class="wuxing-color" style="background:${wuxingColors[i]}"></div></div>`;
  });
  chartHTML += '</div>';
  
  chartEl.innerHTML = chartHTML;
}
showToday();

// æ§åˆ¶é …äº‹ä»¶
const alphaEl = document.getElementById('alpha'); 
const betaEl = document.getElementById('beta');
alphaEl.addEventListener('input', ()=>document.getElementById('alphaVal').innerText = alphaEl.value);
betaEl.addEventListener('input', ()=>document.getElementById('betaVal').innerText = betaEl.value);
document.getElementById('deltaMode').addEventListener('change', updateDelta);

// è¨ˆç®—å‡½æ•¸
function dotVec(a,b){ return a.reduce((s,x,i)=>s + x*(b[i]||0),0); }

function applyP(x, mode){ 
  if(mode==='clamp') return Math.max(0,Math.min(100,x)); 
  if(mode==='sigmoid'){ 
    const y = 1/(1+Math.exp(-(x-50)/15)); 
    return y*100; 
  }
  if(mode==='tanh'){
    const y = Math.tanh((x-50)/20);
    return (y+1)*50;
  }
  return x; 
}

function compute(){ 
  if(!currentEl){ 
    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å¦è±¡ï¼'); 
    return; 
  }
  
  const idx = parseInt(currentEl.dataset.idx);
  const codon = currentEl.dataset.codon; 
  const val = codonValue(codon); 
  const St = scaleTo100(val);
  
  // ç²å–ä»Šæ—¥å¹²æ”¯äº”è¡Œ
  const d = new Date(); 
  const gz = getGanZhiForDate(d); 
  const stemVec = stemToVector(gz.stem);
  const branchVec = branchToVector(gz.branch);
  const V5 = combineVectors(stemVec, branchVec); // ä½¿ç”¨ç¶œåˆäº”è¡Œå‘é‡
  
  // åƒæ•¸
  const alpha = parseFloat(alphaEl.value); 
  const beta = parseFloat(betaEl.value);
  
  let sumSheng = 0; 
  let sumKe = 0; 
  let trace = [];
  trace.push(`=== ${guaNames[idx]} (${kingwenBits[idx]}) é‹å‹¢åˆ†æ ===`);
  trace.push(`å¯†ç¢¼å­: ${codon} â†’ ${codonToAA[codon]} (æ•¸å€¼=${val}, ç¸®æ”¾=${St.toFixed(3)})`);
  trace.push(`ä»Šæ—¥å¹²æ”¯: ${gz.stem}${gz.branch}ï¼ˆå¤©å¹²${gz.stem} â†’ ${stemToWu[gz.stem]} | åœ°æ”¯${gz.branch} â†’ ${branchToWu[gz.branch]})`);
  trace.push(`ç¶œåˆäº”è¡Œå‘é‡ V_t: [${V5.map(x=>x.toFixed(3)).join(', ')}]`);
  trace.push(`åƒæ•¸: Î±=${alpha}, Î²=${beta}`);
  trace.push('');
  trace.push('å„ç¶­åº¦è¨ˆç®—:');
  
  for(let i=0;i<6;i++){
    const mS = dotVec(Msheng[i], V5); 
    const mK = dotVec(Mke[i], V5);
    const termS = mS * delta[i]; 
    const termK = mK * delta[i];
    sumSheng += termS; 
    sumKe += termK;
    trace.push(`ç¶­åº¦${i+1}: ç”Ÿæ‰¶=${mS.toFixed(4)}Ã—${delta[i].toFixed(4)}=${termS.toFixed(6)}, å‰‹åˆ¶=${mK.toFixed(4)}Ã—${delta[i].toFixed(4)}=${termK.toFixed(6)}`);
  }
  
  trace.push('');
  trace.push(`ç¸½ç”Ÿæ‰¶åŠ› = ${sumSheng.toFixed(6)}`);
  trace.push(`ç¸½å‰‹åˆ¶åŠ› = ${sumKe.toFixed(6)}`);
  
  const raw = St + alpha*sumSheng - beta*sumKe;
  const pmode = document.getElementById('pMode').value; 
  const sNext = applyP(raw, pmode);
  
  let luck = '';
  let luckClass = '';
  if(sNext>=85) { luck='å¤§å‰'; luckClass='å¤§å‰'; }
  else if(sNext>=65) { luck='å°å‰'; luckClass='å°å‰'; }
  else if(sNext>=35) { luck='å¹³'; luckClass='å¹³'; }
  else if(sNext>=15) { luck='å°å‡¶'; luckClass='å°å‡¶'; }
  else { luck='å¤§å‡¶'; luckClass='å¤§å‡¶'; }

  trace.push('');
  trace.push(`åŸå§‹åˆ†æ•¸ = ${St.toFixed(3)} + ${alpha}Ã—${sumSheng.toFixed(6)} - ${beta}Ã—${sumKe.toFixed(6)} = ${raw.toFixed(6)}`);
  trace.push(`ç¶“${pmode}å‡½æ•¸è™•ç† â†’ ${sNext.toFixed(3)}`);
  trace.push(`é‹å‹¢åˆ¤å®š: ${luck} âœ¨`);

  document.getElementById('st1').innerText = sNext.toFixed(2);
  const luckEl = document.getElementById('luckDisplay');
  luckEl.innerText = luck;
  luckEl.className = `fortune ${luckClass}`;
  luckEl.style.display = 'block';
  
  document.getElementById('trace').innerText = trace.join('\n');
}

// æŒ‰éˆ•äº‹ä»¶
document.getElementById('calcBtn').addEventListener('click', compute);

document.getElementById('normBtn').addEventListener('click', ()=>{
  normalizeDelta(); 
  alert(`Î´æ¬Šé‡å·²æ­£è¦åŒ–ï¼\næ–°æ¬Šé‡: [${delta.map(x=>x.toFixed(4)).join(', ')}]`); 
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  alphaEl.value = 1.2;
  betaEl.value = 0.8;
  document.getElementById('alphaVal').innerText = '1.2';
  document.getElementById('betaVal').innerText = '0.8';
  document.getElementById('deltaMode').value = 'exp';
  document.getElementById('pMode').value = 'clamp';
  updateDelta();
  alert('åƒæ•¸å·²é‡ç½®ç‚ºé è¨­å€¼ï¼'); 
});

document.getElementById('randomBtn').addEventListener('click', ()=>{
  const newAlpha = (Math.random() * 2 + 0.5).toFixed(2);
  const newBeta = (Math.random() * 2 + 0.5).toFixed(2);
  alphaEl.value = newAlpha;
  betaEl.value = newBeta;
  document.getElementById('alphaVal').innerText = newAlpha;
  document.getElementById('betaVal').innerText = newBeta;
  
  const modes = ['exp', 'equal', 'fib'];
  const randomMode = modes[Math.floor(Math.random() * modes.length)];
  document.getElementById('deltaMode').value = randomMode;
  updateDelta();
  
  alert('åƒæ•¸å·²éš¨æ©ŸåŒ–ï¼è©¦è©¦æ–°çš„çµ„åˆå§ ğŸ²'); 
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = {
    alpha: parseFloat(alphaEl.value),
    beta: parseFloat(betaEl.value),
    deltaMode: document.getElementById('deltaMode').value,
    pMode: document.getElementById('pMode').value,
    delta,
    Msheng,
    Mke,
    timestamp: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = `iching-params-${Date.now()}.json`; 
  a.click(); 
  URL.revokeObjectURL(url);
});

// åˆå§‹åŒ–
updateDelta();
selectNode(document.querySelector('.node'));
</script>
</body>
</html>