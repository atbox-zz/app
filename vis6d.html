<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>äº¬æˆ¿å…«å®®å¦ Ã— DNAå¯†ç¢¼å­ Ã— å¹²æ”¯äº”è¡Œ â€” äº’å‹•è¨ˆç®—å™¨</title>
  <style>
    body{font-family: system-ui, -apple-system, "å¾®è»Ÿæ­£é»‘é«”", "Noto Sans TC", Arial; margin:12px; background:#f7f7fb; color:#111}
    h1{font-size:18px;margin:6px 0;color:#1e40af}
    .layout{display:flex;gap:12px;flex-wrap:wrap}
    .panel{background:white;padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);flex:1;min-width:300px}
    .palace-section{margin-bottom:16px}
    .palace-title{font-weight:700;font-size:14px;color:#dc2626;margin-bottom:6px;padding:6px;background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);border-radius:6px;text-align:center}
    .palace-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:8px}
    .node{background:linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);border-radius:8px;padding:6px;text-align:center;cursor:pointer;border:1px solid rgba(12,34,99,0.06);transition:all 0.2s ease}
    .node:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(12,34,99,0.12);background:linear-gradient(135deg, #dfe8ff 0%, #c7d2fe 100%)}
    .node.active{background:linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);border:2px solid #6366f1;transform:translateY(-2px)}
    .node.bengua{border:2px solid #dc2626;background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)}
    .node.bengua:hover{background:linear-gradient(135deg, #fde68a 0%, #fcd34d 100%)}
    .hexagram-name{font-size:10px;font-weight:600;color:#1e40af;margin-bottom:2px;line-height:1.2}
    .codon-info{font-size:11px;color:#374151;margin:1px 0}
    .binary{font-size:9px;color:#6b7280;font-family:monospace}
    .gua-type{font-size:9px;color:#dc2626;font-weight:600}
    label{display:block;margin-top:6px;font-size:13px;font-weight:500}
    input[type=range]{width:100%;accent-color:#6366f1}
    .kv{display:flex;justify-content:space-between;font-size:13px;margin:4px 0}
    .kv strong{color:#1e40af}
    pre{background:#0f172a;color:#e2e8f0;padding:12px;border-radius:8px;overflow:auto;font-size:12px;line-height:1.4}
    .small{font-size:12px;color:#6b7280;line-height:1.4}
    button{background:linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.2s ease}
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,0.3)}
    button:active{transform:translateY(0px)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select{padding:6px 8px;border-radius:6px;border:1px solid #d1d5db;font-size:12px}
    .fortune{padding:8px 12px;border-radius:8px;font-weight:600;text-align:center;margin:8px 0}
    .fortune.å¤§å‰{background:#dcfce7;color:#166534;border:1px solid #86efac}
    .fortune.å°å‰{background:#f0fdf4;color:#15803d;border:1px solid #bbf7d0}
    .fortune.å¹³{background:#fef3c7;color:#92400e;border:1px solid #fde68a}
    .fortune.å°å‡¶{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}
    .fortune.å¤§å‡¶{background:#fecaca;color:#7f1d1d;border:1px solid #f87171}
    .wuxing-chart{display:flex;gap:4px;margin:8px 0;height:24px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb}
    .wuxing-bar{display:flex;align-items:center;justify-content:center;color:white;font-size:10px;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,0.3);transition:all 0.3s ease}
    .wuxing-bar:hover{transform:scaleY(1.2);z-index:10}
    .wuxing-legend{display:flex;gap:8px;margin:4px 0;font-size:11px;flex-wrap:wrap}
    .wuxing-item{display:flex;align-items:center;gap:3px}
    .wuxing-color{width:12px;height:12px;border-radius:2px;border:1px solid rgba(0,0,0,0.1)}
    hr{border:none;height:1px;background:#e5e7eb;margin:10px 0}
    .scroll-container{max-height:70vh;overflow-y:auto;padding-right:6px}
    .scroll-container::-webkit-scrollbar{width:8px}
    .scroll-container::-webkit-scrollbar-track{background:#f1f5f9;border-radius:4px}
    .scroll-container::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}
    .scroll-container::-webkit-scrollbar-thumb:hover{background:#94a3b8}
  </style>
</head>
<body>
  <h1>äº¬æˆ¿å…«å®®å¦åº Ã— DNAå¯†ç¢¼å­ Ã— å¹²æ”¯äº”è¡Œ â€” äº’å‹•è¨ˆç®—å™¨</h1>
  <div class="layout">
    <div class="panel" style="flex:0 1 600px">
      <div class="small">èªªæ˜ï¼šæ¡ç”¨äº¬æˆ¿å…«å®®å¦åºæ’åˆ—ï¼ˆä¹¾ã€éœ‡ã€åã€è‰®ã€å¤ã€å·½ã€é›¢ã€å…Œï¼‰ï¼Œæ¯å®®8å¦ã€‚ç´…æ¡†ç‚ºæœ¬å®®å¦ï¼Œå…¶é¤˜ä¾åºç‚ºä¸€ä¸–â†’äº”ä¸–â†’éŠé­‚â†’æ­¸é­‚ã€‚é»é¸ä»»ä¸€å¦è±¡æŸ¥çœ‹å…¶å°æ‡‰DNAå¯†ç¢¼å­èˆ‡é‹å‹¢åˆ†æã€‚</div>
      <hr />
      <div class="scroll-container" id="palaceContainer"></div>
    </div>

    <div class="panel" style="flex:0 1 420px">
      <div id="info">
        <div class="kv"><strong>é¸ä¸­å¦è±¡ï¼š</strong><span id="selName">â€”</span></div>
        <div class="kv"><strong>æ‰€å±¬å®®ä½ï¼š</strong><span id="selPalace">â€”</span></div>
        <div class="kv"><strong>å¦åºé¡å‹ï¼š</strong><span id="selType">â€”</span></div>
        <div class="kv"><strong>äºŒé€²ä½ç¢¼ï¼š</strong><span id="selBinary">â€”</span></div>
        <div class="kv"><strong>å°æ‡‰å¯†ç¢¼å­ï¼š</strong><span id="selCodon">â€”</span></div>
        <div class="kv"><strong>èƒºåŸºé…¸ï¼š</strong><span id="selAA">â€”</span></div>
        <div class="kv"><strong>å¯†ç¢¼å­å€¼ï¼ˆæœªç¸®æ”¾ï¼‰ï¼š</strong><span id="selVal">â€”</span></div>
        <div class="kv"><strong>S_tï¼ˆåˆå§‹åˆ†æ•¸ 0â€“100ï¼‰ï¼š</strong><span id="stVal">â€”</span></div>
        <hr />
        <div class="kv"><strong>ä»Šæ—¥å…¬æ›†ï¼š</strong><span id="todayDate">â€”</span></div>
        <div class="kv"><strong>ä»Šæ—¥å¹²æ”¯ï¼š</strong><span id="ganzhi">â€”</span></div>
        <div class="kv"><strong>å¤©å¹²äº”è¡Œï¼š</strong><span id="stemWu">â€”</span></div>
        <div class="kv"><strong>åœ°æ”¯äº”è¡Œï¼š</strong><span id="branchWu">â€”</span></div>
        <div class="kv"><strong>ç¶œåˆäº”è¡Œå‘é‡ V_tï¼š</strong><span id="vwx">â€”</span></div>
        <div id="wuxingChart" style="margin: 8px 0;"></div>
      </div>

      <hr />
      <div>
        <label>Î±ï¼ˆç”Ÿæ‰¶æ”¾å¤§ä¿‚æ•¸ï¼‰ <span id="alphaVal">1.2</span></label>
        <input id="alpha" type="range" min="0" max="3" step="0.01" value="1.2" />
        <label>Î²ï¼ˆå‰‹åˆ¶æ”¾å¤§ä¿‚æ•¸ï¼‰ <span id="betaVal">0.8</span></label>
        <input id="beta" type="range" min="0" max="3" step="0.01" value="0.8" />
        <label>Î´ æ¬Šé‡æ¨¡å¼</label>
        <div class="row"><select id="deltaMode"><option value="exp">2^{i-1}ï¼ˆæŒ‡æ•¸éå¢ï¼‰</option><option value="equal">ç­‰æ¬Šé‡</option><option value="fib">è²»æ°æ•¸åˆ—</option></select><button id="normBtn">æ­£è¦åŒ– Î´</button></div>
        <label>æŠ•å½±å‡½æ•¸ P</label>
        <div class="row"><select id="pMode"><option value="clamp">é™åˆ¶ç¯„åœ [0,100]</option><option value="sigmoid">Sigmoid æ˜ å°„</option><option value="tanh">Tanh æ˜ å°„</option><option value="identity">ç„¡è®Šæ›</option></select></div>
      </div>

      <hr />
      <div>
        <button id="calcBtn">ğŸ”® è¨ˆç®—é‹å‹¢ S_{t+1}</button>
        <div style="height:8px"></div>
        <div class="kv"><strong>é‹å‹¢åˆ†æ•¸ï¼š</strong><span id="st1">â€”</span></div>
        <div class="fortune" id="luckDisplay" style="display:none">â€”</div>
      </div>

      <hr />
      <div>
        <label>åƒæ•¸æ§åˆ¶</label>
        <div class="row">
          <button id="resetBtn">ğŸ”„ æ¢å¾©é è¨­</button>
          <button id="randomBtn">ğŸ² éš¨æ©Ÿåƒæ•¸</button>
          <button id="exportBtn">ğŸ“¤ åŒ¯å‡ºè¨­å®š</button>
        </div>
      </div>
    </div>
  </div>

  <hr />
  <div class="panel">
    <strong>ğŸ” è¨ˆç®—éç¨‹è©³è§£</strong>
    <pre id="trace">è«‹é¸æ“‡ä¸€å€‹å¦è±¡ä¸¦é»æ“Šã€Œè¨ˆç®—é‹å‹¢ã€é–‹å§‹åˆ†æã€‚</pre>
  </div>

<script>
// äº¬æˆ¿å…«å®®å¦åºï¼ˆæ¯å®®8å¦ï¼‰
const jingfangPalaces = {
  'ä¹¾å®®': [
    {name:'ä¹¾ç‚ºå¤©', bits:'111111', type:'æœ¬å®®å¦'},
    {name:'å¤©é¢¨å§¤', bits:'111110', type:'ä¸€ä¸–'},
    {name:'å¤©å±±é¯', bits:'111100', type:'äºŒä¸–'},
    {name:'å¤©åœ°å¦', bits:'111000', type:'ä¸‰ä¸–'},
    {name:'é¢¨åœ°è§€', bits:'110000', type:'å››ä¸–'},
    {name:'å±±åœ°å‰', bits:'100000', type:'äº”ä¸–'},
    {name:'ç«åœ°æ™‰', bits:'101000', type:'éŠé­‚'},
    {name:'ç«å¤©å¤§æœ‰', bits:'101111', type:'æ­¸é­‚'}
  ],
  'éœ‡å®®': [
    {name:'éœ‡ç‚ºé›·', bits:'001001', type:'æœ¬å®®å¦'},
    {name:'é›·åœ°è±«', bits:'001000', type:'ä¸€ä¸–'},
    {name:'é›·æ°´è§£', bits:'001010', type:'äºŒä¸–'},
    {name:'é›·é¢¨æ†', bits:'001110', type:'ä¸‰ä¸–'},
    {name:'åœ°é¢¨å‡', bits:'000110', type:'å››ä¸–'},
    {name:'æ°´é¢¨äº•', bits:'010110', type:'äº”ä¸–'},
    {name:'æ¾¤é¢¨å¤§é', bits:'011110', type:'éŠé­‚'},
    {name:'æ¾¤é›·éš¨', bits:'011001', type:'æ­¸é­‚'}
  ],
  'åå®®': [
    {name:'åç‚ºæ°´', bits:'010010', type:'æœ¬å®®å¦'},
    {name:'æ°´æ¾¤ç¯€', bits:'010011', type:'ä¸€ä¸–'},
    {name:'æ°´é›·å±¯', bits:'010001', type:'äºŒä¸–'},
    {name:'æ°´ç«æ—¢æ¿Ÿ', bits:'010101', type:'ä¸‰ä¸–'},
    {name:'æ¾¤ç«é©', bits:'011101', type:'å››ä¸–'},
    {name:'é›·ç«è±', bits:'001101', type:'äº”ä¸–'},
    {name:'åœ°ç«æ˜å¤·', bits:'000101', type:'éŠé­‚'},
    {name:'åœ°æ°´å¸«', bits:'000010', type:'æ­¸é­‚'}
  ],
  'è‰®å®®': [
    {name:'è‰®ç‚ºå±±', bits:'100100', type:'æœ¬å®®å¦'},
    {name:'å±±ç«è³', bits:'100101', type:'ä¸€ä¸–'},
    {name:'å±±å¤©å¤§ç•œ', bits:'100111', type:'äºŒä¸–'},
    {name:'å±±æ¾¤æ', bits:'100011', type:'ä¸‰ä¸–'},
    {name:'ç«æ¾¤ç½', bits:'101011', type:'å››ä¸–'},
    {name:'å¤©æ¾¤å¤¬', bits:'111011', type:'äº”ä¸–'},
    {name:'é¢¨æ¾¤ä¸­å­š', bits:'110011', type:'éŠé­‚'},
    {name:'é¢¨å±±æ¼¸', bits:'110100', type:'æ­¸é­‚'}
  ],
  'å¤å®®': [
    {name:'å¤ç‚ºåœ°', bits:'000000', type:'æœ¬å®®å¦'},
    {name:'åœ°é›·å¾©', bits:'000001', type:'ä¸€ä¸–'},
    {name:'åœ°æ¾¤è‡¨', bits:'000011', type:'äºŒä¸–'},
    {name:'åœ°å¤©æ³°', bits:'000111', type:'ä¸‰ä¸–'},
    {name:'é›·å¤©å¤§å£¯', bits:'001111', type:'å››ä¸–'},
    {name:'æ¾¤å¤©å¤¬', bits:'011111', type:'äº”ä¸–'},
    {name:'æ°´å¤©éœ€', bits:'010111', type:'éŠé­‚'},
    {name:'æ°´åœ°æ¯”', bits:'010000', type:'æ­¸é­‚'}
  ],
  'å·½å®®': [
    {name:'å·½ç‚ºé¢¨', bits:'011011', type:'æœ¬å®®å¦'},
    {name:'é¢¨å¤©å°ç•œ', bits:'011111', type:'ä¸€ä¸–'},
    {name:'é¢¨ç«å®¶äºº', bits:'011101', type:'äºŒä¸–'},
    {name:'é¢¨é›·ç›Š', bits:'011001', type:'ä¸‰ä¸–'},
    {name:'å¤©é›·ç„¡å¦„', bits:'111001', type:'å››ä¸–'},
    {name:'ç«é›·å™¬å—‘', bits:'101001', type:'äº”ä¸–'},
    {name:'å±±é›·é ¤', bits:'100001', type:'éŠé­‚'},
    {name:'å±±é¢¨è ±', bits:'100110', type:'æ­¸é­‚'}
  ],
  'é›¢å®®': [
    {name:'é›¢ç‚ºç«', bits:'101101', type:'æœ¬å®®å¦'},
    {name:'ç«å±±æ—…', bits:'101100', type:'ä¸€ä¸–'},
    {name:'ç«é¢¨é¼', bits:'101110', type:'äºŒä¸–'},
    {name:'ç«æ°´æœªæ¿Ÿ', bits:'101010', type:'ä¸‰ä¸–'},
    {name:'å±±æ°´è’™', bits:'100010', type:'å››ä¸–'},
    {name:'é¢¨æ°´æ¸™', bits:'110010', type:'äº”ä¸–'},
    {name:'å¤©æ°´è¨Ÿ', bits:'111010', type:'éŠé­‚'},
    {name:'å¤©ç«åŒäºº', bits:'111101', type:'æ­¸é­‚'}
  ],
  'å…Œå®®': [
    {name:'å…Œç‚ºæ¾¤', bits:'011011', type:'æœ¬å®®å¦'},
    {name:'æ¾¤æ°´å›°', bits:'011010', type:'ä¸€ä¸–'},
    {name:'æ¾¤åœ°èƒ', bits:'011000', type:'äºŒä¸–'},
    {name:'æ¾¤å±±å’¸', bits:'011100', type:'ä¸‰ä¸–'},
    {name:'æ°´å±±è¹‡', bits:'010100', type:'å››ä¸–'},
    {name:'åœ°å±±è¬™', bits:'000100', type:'äº”ä¸–'},
    {name:'é›·å±±å°é', bits:'001100', type:'éŠé­‚'},
    {name:'é›·æ¾¤æ­¸å¦¹', bits:'001011', type:'æ­¸é­‚'}
  ]
};

// 64 å€‹ DNA å¯†ç¢¼å­ï¼ˆæŒ‰äº¬æˆ¿å…«å®®é †åºå°æ‡‰ï¼‰
const codonList = [
  // ä¹¾å®® 8 å¦
  'TTT','TTC','TTA','TTG','TCT','TCC','TCA','TCG',
  // éœ‡å®® 8 å¦
  'TAT','TAC','TAA','TAG','TGT','TGC','TGA','TGG',
  // åå®® 8 å¦
  'CTT','CTC','CTA','CTG','CCT','CCC','CCA','CCG',
  // è‰®å®® 8 å¦
  'CAT','CAC','CAA','CAG','CGT','CGC','CGA','CGG',
  // å¤å®® 8 å¦
  'ATT','ATC','ATA','ATG','ACT','ACC','ACA','ACG',
  // å·½å®® 8 å¦
  'AAT','AAC','AAA','AAG','AGT','AGC','AGA','AGG',
  // é›¢å®® 8 å¦
  'GTT','GTC','GTA','GTG','GCT','GCC','GCA','GCG',
  // å…Œå®® 8 å¦
  'GAT','GAC','GAA','GAG','GGT','GGC','GGA','GGG'
];

// èƒºåŸºé…¸å°æ‡‰è¡¨ï¼ˆDNAç‰ˆæœ¬ï¼šT,C,A,Gï¼‰
const codonToAA = {
  TTT:'Phe',TTC:'Phe',TTA:'Leu',TTG:'Leu',TCT:'Ser',TCC:'Ser',TCA:'Ser',TCG:'Ser',
  TAT:'Tyr',TAC:'Tyr',TAA:'Stop',TAG:'Stop',TGT:'Cys',TGC:'Cys',TGA:'Stop',TGG:'Trp',
  CTT:'Leu',CTC:'Leu',CTA:'Leu',CTG:'Leu',CCT:'Pro',CCC:'Pro',CCA:'Pro',CCG:'Pro',
  CAT:'His',CAC:'His',CAA:'Gln',CAG:'Gln',CGT:'Arg',CGC:'Arg',CGA:'Arg',CGG:'Arg',
  ATT:'Ile',ATC:'Ile',ATA:'Ile',ATG:'Met',ACT:'Thr',ACC:'Thr',ACA:'Thr',ACG:'Thr',
  AAT:'Asn',AAC:'Asn',AAA:'Lys',AAG:'Lys',AGT:'Ser',AGC:'Ser',AGA:'Arg',AGG:'Arg',
  GTT:'Val',GTC:'Val',GTA:'Val',GTG:'Val',GCT:'Ala',GCC:'Ala',GCA:'Ala',GCG:'Ala',
  GAT:'Asp',GAC:'Asp',GAA:'Glu',GAG:'Glu',GGT:'Gly',GGC:'Gly',GGA:'Gly',GGG:'Gly'
};

// å¯†ç¢¼å­æ•¸å€¼è¨ˆç®—ï¼ˆDNAï¼šT=1, C=2, A=3, G=4ï¼‰
const baseVal = {T:1,C:2,A:3,G:4};
function codonValue(codon){
  return codon.split('').reduce((s,ch)=>s + (baseVal[ch]||0),0);
}
function scaleTo100(v){ return v * (100/12); }

// å¹²æ”¯èˆ‡äº”è¡Œç³»çµ±
const stems = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
const branches = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];
const stemToWu = { 'ç”²':'æœ¨','ä¹™':'æœ¨','ä¸™':'ç«','ä¸':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´' };
const branchToWu = { 
  'å­':'æ°´','ä¸‘':'åœŸ','å¯…':'æœ¨','å¯':'æœ¨','è¾°':'åœŸ','å·³':'ç«',
  'åˆ':'ç«','æœª':'åœŸ','ç”³':'é‡‘','é…‰':'é‡‘','æˆŒ':'åœŸ','äº¥':'æ°´' 
};
const wuIndex = { 'æœ¨':0,'ç«':1,'åœŸ':2,'é‡‘':3,'æ°´':4 };
const wuNames = ['æœ¨','ç«','åœŸ','é‡‘','æ°´'];
const wuColors = ['#22c55e','#ef4444','#f59e0b','#64748b','#3b82f6'];
const wuxingColors = wuColors;

function stemToVector(stem){ 
  const v = [0,0,0,0,0]; 
  v[wuIndex[stemToWu[stem]]] = 1; 
  return v; 
}

function branchToVector(branch){ 
  const v = [0,0,0,0,0]; 
  v[wuIndex[branchToWu[branch]]] = 1; 
  return v; 
}

function combineVectors(stemVec, branchVec, stemWeight = 0.6, branchWeight = 0.4) {
  return stemVec.map((s, i) => s * stemWeight + branchVec[i] * branchWeight);
}

// è¨ˆç®—å¹²æ”¯æ—¥æœŸ
function daysBetween(a,b){
  const _MS = 24*3600*1000;
  return Math.floor((Date.UTC(b.getFullYear(),b.getMonth(),b.getDate()) - Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()))/_MS);
}
const refDate = new Date(Date.UTC(1984,1,2));

function getGanZhiForDate(d){
  const days = daysBetween(refDate, d);
  const idx = ((days % 60) + 60) % 60;
  const stem = stems[idx % 10];
  const branch = branches[idx % 12];
  return {stem, branch, idx};
}

// åˆå§‹åŒ– M çŸ©é™£
let Msheng = [];
let Mke = [];
for(let i=0;i<6;i++){
  const baseSheng = Array(5).fill(0).map((_,j)=>{
    const phase = (i*0.7 + j*1.3) % (2*Math.PI);
    return (Math.sin(phase) + 1.2) / 2.2 * 0.15 + 0.05;
  });
  Msheng.push(baseSheng);
  
  const baseKe = Array(5).fill(0).map((_,j)=>{
    const phase = (i*1.1 + j*0.9 + Math.PI/3) % (2*Math.PI);
    return (Math.cos(phase) + 1.1) / 2.1 * 0.12 + 0.03;
  });
  Mke.push(baseKe);
}

// Î´ æ¬Šé‡ç³»çµ±
let delta = [1,2,4,8,16,32];
function updateDelta(){
  const mode = document.getElementById('deltaMode').value;
  if(mode === 'equal'){
    delta = Array(6).fill(1);
  } else if(mode === 'fib'){
    delta = [1,1,2,3,5,8];
  } else {
    delta = [1,2,4,8,16,32];
  }
  normalizeDelta();
}

function normalizeDelta(){ 
  const s = delta.reduce((a,b)=>a+b,0); 
  delta = delta.map(x=>x/s); 
}

// å»ºç«‹å…«å®®ç¶²æ ¼ä»‹é¢
const container = document.getElementById('palaceContainer');
const palaceNames = Object.keys(jingfangPalaces);
let globalIndex = 0;

palaceNames.forEach(palaceName => {
  const section = document.createElement('div');
  section.className = 'palace-section';
  
  const title = document.createElement('div');
  title.className = 'palace-title';
  title.textContent = palaceName;
  section.appendChild(title);
  
  const grid = document.createElement('div');
  grid.className = 'palace-grid';
  
  jingfangPalaces[palaceName].forEach((gua, localIdx) => {
    const codon = codonList[globalIndex];
    const el = document.createElement('div');
    el.className = 'node';
    if(gua.type === 'æœ¬å®®å¦') el.classList.add('bengua');
    
    el.dataset.codon = codon;
    el.dataset.idx = globalIndex;
    el.dataset.palace = palaceName;
    el.dataset.type = gua.type;
    el.dataset.name = gua.name;
    el.dataset.bits = gua.bits;
    
    el.innerHTML = `
      <div class="hexagram-name">${gua.name}</div>
      <div class="gua-type">${gua.type}</div>
      <div class="codon-info">${codon} â†’ ${codonToAA[codon]||''}</div>
      <div class="binary">${gua.bits}</div>
    `;
    el.addEventListener('click', ()=>selectNode(el));
    grid.appendChild(el);
    globalIndex++;
  });
  
  section.appendChild(grid);
  container.appendChild(section);
});

let currentEl = null;
function selectNode(el){ 
  if(currentEl) currentEl.classList.remove('active'); 
  currentEl = el; 
  el.classList.add('active');
  
  const c = el.dataset.codon; 
  const aa = codonToAA[c]||''; 
  const val = codonValue(c); 
  const scaled = Math.round(scaleTo100(val)*100)/100;
  
  document.getElementById('selName').innerText = el.dataset.name;
  document.getElementById('selPalace').innerText = el.dataset.palace;
  document.getElementById('selType').innerText = el.dataset.type;
  document.getElementById('selBinary').innerText = el.dataset.bits;
  document.getElementById('selCodon').innerText = c; 
  document.getElementById('selAA').innerText = aa; 
  document.getElementById('selVal').innerText = val;
  document.getElementById('stVal').innerText = scaled;
}

// é¡¯ç¤ºä»Šæ—¥ä¿¡æ¯èˆ‡äº”è¡Œåœ–è¡¨
function showToday(){ 
  const d = new Date(); 
  document.getElementById('todayDate').innerText = d.toLocaleDateString('zh-TW'); 
  const gz = getGanZhiForDate(d); 
  document.getElementById('ganzhi').innerText = gz.stem + gz.branch + ` (ç¬¬${gz.idx+1}æ—¥)`; 
  
  const stemWu = stemToWu[gz.stem];
  const branchWu = branchToWu[gz.branch];
  document.getElementById('stemWu').innerText = `${gz.stem} â†’ ${stemWu}`;
  document.getElementById('branchWu').innerText = `${gz.branch} â†’ ${branchWu}`;
  
  const stemVec = stemToVector(gz.stem);
  const branchVec = branchToVector(gz.branch);
  const combinedVec = combineVectors(stemVec, branchVec);
  
  document.getElementById('vwx').innerText = `[${combinedVec.map(x=>x.toFixed(2)).join(', ')}]`;
  
  drawWuxingChart(combinedVec);
}

function drawWuxingChart(wuxingVec) {
  const chartEl = document.getElementById('wuxingChart');
  const maxVal = Math.max(...wuxingVec);
  const minWidth = 20;
  
  let chartHTML = '<div class="wuxing-chart">';
  wuxingVec.forEach((val, i) => {
    const percentage = maxVal > 0 ? Math.max((val / maxVal * 80), minWidth) : minWidth;
    chartHTML += `<div class="wuxing-bar" style="flex:${percentage}; background:${wuxingColors[i]}" title="${wuNames[i]}: ${val.toFixed(3)}">${wuNames[i]}</div>`;
  });
  chartHTML += '</div>';
  
  chartHTML += '<div class="wuxing-legend">';
  wuNames.forEach((name, i) => {
    chartHTML += `<div class="wuxing-item"><div class="wuxing-color" style="background:${wuxingColors[i]}"></div><span>${name}</span></div>`;
  });
  chartHTML += '</div>';
  
  chartEl.innerHTML = chartHTML;
}
showToday();

// æ§åˆ¶é …äº‹ä»¶
const alphaEl = document.getElementById('alpha'); 
const betaEl = document.getElementById('beta');
alphaEl.addEventListener('input', ()=>document.getElementById('alphaVal').innerText = alphaEl.value);
betaEl.addEventListener('input', ()=>document.getElementById('betaVal').innerText = betaEl.value);
document.getElementById('deltaMode').addEventListener('change', updateDelta);

// è¨ˆç®—å‡½æ•¸
function dotVec(a,b){ return a.reduce((s,x,i)=>s + x*(b[i]||0),0); }

function applyP(x, mode){ 
  if(mode==='clamp') return Math.max(0,Math.min(100,x)); 
  if(mode==='sigmoid'){ 
    const y = 1/(1+Math.exp(-(x-50)/15)); 
    return y*100; 
  }
  if(mode==='tanh'){
    const y = Math.tanh((x-50)/20);
    return (y+1)*50;
  }
  return x; 
}

function compute(){ 
  if(!currentEl){ 
    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹å¦è±¡ï¼'); 
    return; 
  }
  
  const codon = currentEl.dataset.codon; 
  const val = codonValue(codon); 
  const St = scaleTo100(val);
  
  // ç²å–ä»Šæ—¥å¹²æ”¯äº”è¡Œ
  const d = new Date(); 
  const gz = getGanZhiForDate(d); 
  const stemVec = stemToVector(gz.stem);
  const branchVec = branchToVector(gz.branch);
  const V5 = combineVectors(stemVec, branchVec);
  
  // åƒæ•¸
  const alpha = parseFloat(alphaEl.value); 
  const beta = parseFloat(betaEl.value);
  
  let sumSheng = 0; 
  let sumKe = 0; 
  let trace = [];
  trace.push(`=== ${currentEl.dataset.name} (${currentEl.dataset.bits}) é‹å‹¢åˆ†æ ===`);
  trace.push(`æ‰€å±¬å®®ä½: ${currentEl.dataset.palace} | é¡å‹: ${currentEl.dataset.type}`);
  trace.push(`å¯†ç¢¼å­: ${codon} â†’ ${codonToAA[codon]} (æ•¸å€¼=${val}, ç¸®æ”¾=${St.toFixed(3)})`);
  trace.push(`ä»Šæ—¥å¹²æ”¯: ${gz.stem}${gz.branch}`);
  trace.push(`å¤©å¹²${gz.stem} â†’ ${stemToWu[gz.stem]} | åœ°æ”¯${gz.branch} â†’ ${branchToWu[gz.branch]}`);
  trace.push(`ç¶œåˆäº”è¡Œå‘é‡ V_t: [${V5.map(x=>x.toFixed(3)).join(', ')}]`);
  trace.push(`åƒæ•¸: Î±=${alpha}, Î²=${beta}`);
  trace.push('');
  trace.push('å„ç¶­åº¦è¨ˆç®—:');
  
  for(let i=0;i<6;i++){
    const mS = dotVec(Msheng[i], V5); 
    const mK = dotVec(Mke[i], V5);
    const termS = mS * delta[i]; 
    const termK = mK * delta[i];
    sumSheng += termS; 
    sumKe += termK;
    trace.push(`ç¶­åº¦${i+1}: ç”Ÿæ‰¶=${mS.toFixed(4)}Ã—${delta[i].toFixed(4)}=${termS.toFixed(6)}, å‰‹åˆ¶=${mK.toFixed(4)}Ã—${delta[i].toFixed(4)}=${termK.toFixed(6)}`);
  }
  
  trace.push('');
  trace.push(`ç¸½ç”Ÿæ‰¶åŠ› = ${sumSheng.toFixed(6)}`);
  trace.push(`ç¸½å‰‹åˆ¶åŠ› = ${sumKe.toFixed(6)}`);
  
  const raw = St + alpha*sumSheng - beta*sumKe;
  const pmode = document.getElementById('pMode').value; 
  const sNext = applyP(raw, pmode);
  
  let luck = '';
  let luckClass = '';
  if(sNext>=85) { luck='å¤§å‰'; luckClass='å¤§å‰'; }
  else if(sNext>=65) { luck='å°å‰'; luckClass='å°å‰'; }
  else if(sNext>=35) { luck='å¹³'; luckClass='å¹³'; }
  else if(sNext>=15) { luck='å°å‡¶'; luckClass='å°å‡¶'; }
  else { luck='å¤§å‡¶'; luckClass='å¤§å‡¶'; }

  trace.push('');
  trace.push(`åŸå§‹åˆ†æ•¸ = ${St.toFixed(3)} + ${alpha}Ã—${sumSheng.toFixed(6)} - ${beta}Ã—${sumKe.toFixed(6)} = ${raw.toFixed(6)}`);
  trace.push(`ç¶“${pmode}å‡½æ•¸è™•ç† â†’ ${sNext.toFixed(3)}`);
  trace.push(`é‹å‹¢åˆ¤å®š: ${luck} âœ¨`);

  document.getElementById('st1').innerText = sNext.toFixed(2);
  const luckEl = document.getElementById('luckDisplay');
  luckEl.innerText = luck;
  luckEl.className = `fortune ${luckClass}`;
  luckEl.style.display = 'block';
  
  document.getElementById('trace').innerText = trace.join('\n');
}

// æŒ‰éˆ•äº‹ä»¶
document.getElementById('calcBtn').addEventListener('click', compute);

document.getElementById('normBtn').addEventListener('click', ()=>{
  normalizeDelta(); 
  alert(`Î´æ¬Šé‡å·²æ­£è¦åŒ–ï¼\næ–°æ¬Šé‡: [${delta.map(x=>x.toFixed(4)).join(', ')}]`); 
});

document.getElementById('resetBtn').addEventListener('click', ()=>{
  alphaEl.value = 1.2;
  betaEl.value = 0.8;
  document.getElementById('alphaVal').innerText = '1.2';
  document.getElementById('betaVal').innerText = '0.8';
  document.getElementById('deltaMode').value = 'exp';
  document.getElementById('pMode').value = 'clamp';
  updateDelta();
  alert('åƒæ•¸å·²é‡ç½®ç‚ºé è¨­å€¼ï¼'); 
});

document.getElementById('randomBtn').addEventListener('click', ()=>{
  const newAlpha = (Math.random() * 2 + 0.5).toFixed(2);
  const newBeta = (Math.random() * 2 + 0.5).toFixed(2);
  alphaEl.value = newAlpha;
  betaEl.value = newBeta;
  document.getElementById('alphaVal').innerText = newAlpha;
  document.getElementById('betaVal').innerText = newBeta;
  
  const modes = ['exp', 'equal', 'fib'];
  const randomMode = modes[Math.floor(Math.random() * modes.length)];
  document.getElementById('deltaMode').value = randomMode;
  updateDelta();
  
  alert('åƒæ•¸å·²éš¨æ©ŸåŒ–ï¼è©¦è©¦æ–°çš„çµ„åˆå§ ğŸ²'); 
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = {
    alpha: parseFloat(alphaEl.value),
    beta: parseFloat(betaEl.value),
    deltaMode: document.getElementById('deltaMode').value,
    pMode: document.getElementById('pMode').value,
    delta,
    Msheng,
    Mke,
    timestamp: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = `jingfang-params-${Date.now()}.json`; 
  a.click(); 
  URL.revokeObjectURL(url);
});

// åˆå§‹åŒ–
updateDelta();
selectNode(document.querySelector('.node'));
</script>
</body>
</html>