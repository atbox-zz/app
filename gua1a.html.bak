<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>野鶴增刪卜易金錢卦</title>
    <script src="lunar.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #d4af37, #ffd700);
            color: #333;
            text-align: center;
            padding: 1px;
            position: relative;
        }

        .header::before {
            content: '☯';
            position: absolute;
            top: 20px;
            left: 30px;
            font-size: 1em;
            opacity: 0.3;
        }

        .header::after {
            content: '☯';
            position: absolute;
            top: 2px;
            right: 3px;
            font-size: 1em;
            opacity: 0.3;
        }

        .header h1 {
            margin: 0;
            font-size: 1.1em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .date-info {
            background: #f8f9fa;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            font-size: 1.1em;
            color: #495057;
        }

        .roll-button {
            display: block;
            width: 200px;
            margin: 30px auto;
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 16px rgba(255, 107, 107, 0.3);
        }

        .roll-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(255, 107, 107, 0.4);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
        }

        .result-area {
            background: #fff;
            min-height: 500px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 14px;
            border-radius: 10px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .interpretation-area {
            background: #fff;
            min-height: 500px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 600px;
        }

        .coin-animation {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            grid-column: span 2;
        }

        .coin {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #8b4513;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: flip 0.6s ease-in-out;
        }

        @keyframes flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(0deg); }
        }

        .gua-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #d4af37;
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border: 2px solid #d4af37;
        }

        .gua-main {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid #4ecdc4;
            line-height: 1.8;
        }

        .yao-section {
            margin: 20px 0;
        }

        .yao-item {
            background: #fff;
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff6b6b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .yao-text {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .yao-interpretation {
            color: #666;
            line-height: 1.6;
        }

        .section-title {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            padding: 10px 20px;
            margin: 20px 0 10px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .coin-animation {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
        <button class="roll-button" onclick="rollGua()">野鶴增刪卜易</button>
        </div>
        
        <div class="date-info" id="dateInfo">
            載入中...
        </div>

        
        <div class="coin-animation" id="coinAnimation" style="display: none;">
            <div class="coin" id="coin1">㊣</div>
            <div class="coin" id="coin2">㊣</div>
            <div class="coin" id="coin3">㊣</div>
        </div>
        
        <div class="main-content">
            <div class="result-area" id="resultArea">
                點擊「擲筊博杯」開始占卜...
            </div>
            
            <div class="interpretation-area" id="interpretationArea">
                <div class="gua-title">卦象解釋將在此顯示</div>
                <p style="text-align: center; color: #666; margin-top: 50px;">
                    🔮 請先進行占卜，系統將自動顯示詳細的卦象解釋
                </p>
            </div>
        </div>
    </div>

    <script>
        // 64卦解釋資料庫（示例資料）
        const gua64Interpretations = {
            "坤為地": {
                "main": "坤卦象徵大地，柔順包容，宜順勢而為，謙卑待人。占卜建議：以靜制動，謹慎行事，勿急進。",
                "yao": [
                    {
                        "text": "初六：履霜，堅冰至。",
                        "interpretation": "占卜建議：初現寒霜，預示堅冰將至，宜謹慎行事，防患於未然。\n五行分析：初爻屬土（坤卦本質），日干庚金生土，利於穩固基礎，但需警惕潛在風險。動爻影響：若動，變為陽爻，轉為震卦（地雷復），預示新生，宜積極準備。"
                    },
                    {
                        "text": "六二：直方大，不習無不利。",
                        "interpretation": "占卜建議：保持正直，遵循正道，無往不利。\n五行分析：二爻屬土，與日干庚金相生，利於穩定發展。動爻影響：若動，變為兌卦（地澤臨），有利結交貴人。"
                    },
                    {
                        "text": "六三：含章可貞，或從王事，無成有終。",
                        "interpretation": "占卜建議：低調行事，默默耕耘，終有成果。\n五行分析：三爻屬土，與日支辰土比和，穩固但需謙虛。動爻影響：若動，變為艮卦（地山謙），更強調謙遜。"
                    },
                    {
                        "text": "六四：括囊，無咎無譽。",
                        "interpretation": "占卜建議：謹言慎行，保持低調，可避禍福。\n五行分析：四爻屬土，與日干庚金相生，宜守成。動爻影響：若動，變為離卦（地火明夷），需韜光養晦。"
                    },
                    {
                        "text": "六五：黃裳元吉。",
                        "interpretation": "占卜建議：謙虛中正，行事得宜，可獲吉利。\n五行分析：五爻屬土，與日支辰土比和，利於中正之道。動爻影響：若動，變為巽卦（地風升），宜穩步上升。"
                    },
                    {
                        "text": "上六：龍戰於野，其血玄黃。",
                        "interpretation": "占卜建議：過於爭鬥恐兩敗俱傷，宜退守和解。\n五行分析：上爻屬土，與日干庚金相生，但過盛易爭，需謹慎。動爻影響：若動，變為乾卦（地天泰），陰陽交泰，宜把握和諧。"
                    }
                ]
            },
            "乾為天": {
                "main": "乾卦象徵天，剛健進取，宜主動出擊，自強不息。占卜建議：時機成熟，可大膽行動，但需謹防過剛。",
                "yao": [
                    {
                        "text": "初九：潛龍勿用。",
                        "interpretation": "占卜建議：時機未至，宜潛伏待時，勿急於表現。\n五行分析：初爻屬金（乾卦本質），宜養精蓄銳。動爻影響：若動，變為巽卦（天風姤），需謹防小人。"
                    },
                    {
                        "text": "九二：見龍在田，利見大人。",
                        "interpretation": "占卜建議：開始嶄露頭角，宜結交貴人，互相提攜。\n五行分析：二爻屬金，宜積極進取。動爻影響：若動，變為離卦（天火同人），利於團結合作。"
                    },
                    {
                        "text": "九三：君子終日乾乾，夕惕若厲，無咎。",
                        "interpretation": "占卜建議：需勤勉不懈，保持警覺，方能無咎。\n五行分析：三爻屬金，需持續努力。動爻影響：若動，變為艮卦（天山遁），宜適時退避。"
                    },
                    {
                        "text": "九四：或躍在淵，無咎。",
                        "interpretation": "占卜建議：機會來臨，可嘗試躍進，但需謹慎評估。\n五行分析：四爻屬金，宜把握時機。動爻影響：若動，變為兌卦（天澤履），宜謹慎前行。"
                    },
                    {
                        "text": "九五：飛龍在天，利見大人。",
                        "interpretation": "占卜建議：正處高峰，宜善用影響力，利益眾人。\n五行分析：五爻屬金，正是得勢之時。動爻影響：若動，變為坎卦（天水訟），需防爭端。"
                    },
                    {
                        "text": "上九：亢龍有悔。",
                        "interpretation": "占卜建議：盛極必衰，宜適可而止，謙虛退讓。\n五行分析：上爻屬金，過剛易折。動爻影響：若動，變為震卦（天雷無妄），需順應自然。"
                    }
                ]
            }
            // 可以繼續添加其他62卦的解釋...

        }
        // 天干地支數據
        const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
        const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        
        // 64卦名
        const gua64Names = [
            "坤為地", "地雷復", "地水師", "地澤臨", "地山謙", "地火明夷", "地風升", "地天泰",
            "雷地豫", "震為雷", "雷水解", "雷澤歸妹", "雷山小過", "雷火豐", "雷風恆", "雷天大壯",
            "水地比", "水雷屯", "坎為水", "水澤節", "水山蹇", "水火既濟", "水風井", "水天需",
            "澤地萃", "澤雷隨", "澤水困", "兌為澤", "澤山咸", "澤火革", "澤風大過", "澤天夬",
            "山地剝", "山雷頤", "山水蒙", "山澤損", "艮為山", "山火賁", "山風蠱", "山天大畜",
            "火地晉", "火雷噬嗑", "火水未濟", "火澤睽", "火山旅", "離為火", "火風鼎", "火天大有",
            "風地觀", "風雷益", "風水渙", "風澤中孚", "風山漸", "風火家人", "巽為風", "風天小畜",
            "天地否", "天雷無妄", "天水訟", "天澤履", "天山遁", "天火同人", "天風姤", "乾為天"
        ];

        // 六神配置
        const liuShen = {
            '甲': ['青龍', '朱雀', '勾陳', '螣蛇', '白虎', '玄武'],
            '乙': ['青龍', '朱雀', '勾陳', '螣蛇', '白虎', '玄武'],
            '丙': ['朱雀', '勾陳', '螣蛇', '白虎', '玄武', '青龍'],
            '丁': ['朱雀', '勾陳', '螣蛇', '白虎', '玄武', '青龍'],
            '戊': ['勾陳', '螣蛇', '白虎', '玄武', '青龍', '朱雀'],
            '己': ['螣蛇', '白虎', '玄武', '青龍', '朱雀', '勾陳'],
            '庚': ['白虎', '玄武', '青龍', '朱雀', '勾陳', '螣蛇'],
            '辛': ['白虎', '玄武', '青龍', '朱雀', '勾陳', '螣蛇'],
            '壬': ['玄武', '青龍', '朱雀', '勾陳', '螣蛇', '白虎'],
            '癸': ['玄武', '青龍', '朱雀', '勾陳', '螣蛇', '白虎']
        };

        // 初始化日期信息
        function initDateInfo() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const hour = now.getHours();
            
            try {
                // 使用 lunar-javascript 庫計算準確的農曆日期
                const solar = Lunar.fromYmdHms(year, month, date, hour, 0, 0).getSolar();
                const lunar = Lunar.fromSolar(solar);
                
                const yearGanZhi = lunar.getYearInGanZhi();
                const monthGanZhi = lunar.getMonthInGanZhi();
                const dateGanZhi = lunar.getDayInGanZhi();
                const hourGanZhi = lunar.getTimeInGanZhi();
                
                document.getElementById('dateInfo').innerHTML = 
                    `國曆【${year}年${month}月${date}日】 農曆【${yearGanZhi}年 ${monthGanZhi}月 ${dateGanZhi}日 ${hourGanZhi}時】`;
                
                // 將干支資料存儲為全局變量，供其他函數使用
                window.currentGanZhi = {
                    year: yearGanZhi,
                    month: monthGanZhi,
                    date: dateGanZhi,
                    hour: hourGanZhi
                };
            } catch (error) {
                console.error('農曆計算錯誤:', error);
                // 如果農曆庫載入失敗，使用備用的固定值
                const yearGanZhi = '乙巳';
                const monthGanZhi = '甲申';
                const dateGanZhi = '己酉';
                const hourGanZhi = getGanZhi(Math.floor(hour / 2));
                
                document.getElementById('dateInfo').innerHTML = 
                    `國曆【${year}年${month}月${date}日】 農曆【${yearGanZhi}年 ${monthGanZhi}月 ${dateGanZhi}日 ${hourGanZhi}時】`;
                
                window.currentGanZhi = {
                    year: yearGanZhi,
                    month: monthGanZhi,
                    date: dateGanZhi,
                    hour: hourGanZhi
                };
            }
        }

        function getGanZhi(index) {
            const ganIndex = index % 10;
            const zhiIndex = index % 12;
            return tianGan[ganIndex] + diZhi[zhiIndex];
        }

        function getElementFromGan(gan) {
            const elementMap = {
                '甲': '木', '乙': '木',
                '丙': '火', '丁': '火',
                '戊': '土', '己': '土',
                '庚': '金', '辛': '金',
                '壬': '水', '癸': '水'
            };
            return elementMap[gan] || '';
        }

        function getElementFromZhi(zhi) {
            const elementMap = {
                '寅': '木', '卯': '木',
                '巳': '火', '午': '火',
                '辰': '土', '戌': '土', '丑': '土', '未': '土',
                '申': '金', '酉': '金',
                '亥': '水', '子': '水'
            };
            return elementMap[zhi] || '';
        }

        function calculateFiveElements(ganZhiArray) {
            const elements = { '木': 0, '火': 0, '土': 0, '金': 0, '水': 0 };
            
            ganZhiArray.forEach(gz => {
                const gan = gz.charAt(0);
                const zhi = gz.charAt(1);
                elements[getElementFromGan(gan)]++;
                elements[getElementFromZhi(zhi)]++;
            });
            
            return elements;
        }

        function determineYongShen(elements) {
            let minElement = '';
            let minValue = Infinity;
            
            for (let [element, value] of Object.entries(elements)) {
                if (value < minValue) {
                    minValue = value;
                    minElement = element;
                }
            }
            
            return `${minElement} (補強${minElement})`;
        }

        function displayInterpretation(guaName, changeYao) {
            const interpretationArea = document.getElementById('interpretationArea');
            const interpretation = gua64Interpretations[guaName];
            
            if (!interpretation) {
                interpretationArea.innerHTML = `
                    <div class="gua-title">${guaName}</div>
                    <div class="gua-main">
                        此卦解釋資料庫中暫無詳細資料，您可以根據傳統易學理論進行解讀。
                    </div>
                `;
                return;
            }
            
            let html = `<div class="gua-title">${guaName}</div>`;
            
            html += `<div class="gua-main">${interpretation.main}</div>`;
            
            html += `<div class="section-title">六爻詳解</div>`;
            html += `<div class="yao-section">`;
            
            interpretation.yao.forEach((yao, index) => {
                const yaoNames = ["初爻", "二爻", "三爻", "四爻", "五爻", "上爻"];
                const isChanging = changeYao.includes(index);
                
                html += `
                    <div class="yao-item ${isChanging ? 'highlight' : ''}">
                        <div class="yao-text">
                            ${yaoNames[index]}：${yao.text}
                            ${isChanging ? ' <span style="color: #ff6b6b;">[動爻]</span>' : ''}
                        </div>
                        <div class="yao-interpretation">${yao.interpretation.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            });
            
            html += `</div>`;
            
            if (changeYao.length > 0) {
                html += `
                    <div style="background: #fff3cd; padding: 15px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <strong>動爻提示：</strong>本次占卜有 ${changeYao.length} 個動爻，請特別留意這些爻位的變化和提示。
                    </div>
                `;
            }
            
            interpretationArea.innerHTML = html;
        }

        async function rollGua() {
            const resultArea = document.getElementById('resultArea');
            const coinAnimation = document.getElementById('coinAnimation');
            
            resultArea.innerHTML = '';
            
            let result = "□■□■□■□■□■□■□■□■□\n";
            result += "㊣㊣㊣野鶴金錢卦〇〇〇\n";
            result += "■□■□■□■□■□■□■□■□■\n\n";
            
            const answer = [];
            const coin = [];
            const doin = [];
            const changeYao = []; // 記錄動爻位置
            
            // 投擲六次硬幣
            for (let i = 0; i < 6; i++) {
                // 顯示投幣動畫
                coinAnimation.style.display = 'flex';
                
                const coin1 = Math.floor(Math.random() * 2);
                const coin2 = Math.floor(Math.random() * 2);
                const coin3 = Math.floor(Math.random() * 2);
                
                // 更新硬幣顯示
                document.getElementById('coin1').textContent = coin1 ? '㊣' : '〇';
                document.getElementById('coin2').textContent = coin2 ? '㊣' : '〇';
                document.getElementById('coin3').textContent = coin3 ? '㊣' : '〇';
                
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const sum = coin1 + coin2 + coin3;
                answer[i] = sum;
                
                let coinResult = "";
                coinResult += coin1 ? "㊣" : "〇";
                coinResult += coin2 ? "㊣" : "〇";
                coinResult += coin3 ? "㊣" : "〇";
                
                result += `第${i + 1}次${coinResult} ${sum} `;
                
                if (sum === 3) {
                    result += "交 X老陰變\n";
                    coin[i] = 0;
                    doin[i] = 1;
                    changeYao.push(i); // 記錄動爻
                } else if (sum === 1) {
                    result += "拆   少陰\n";
                    coin[i] = 0;
                    doin[i] = 0;
                } else if (sum === 2) {
                    result += "單   少陽\n";
                    coin[i] = 1;
                    doin[i] = 1;
                } else {
                    result += "重 O老陽變\n";
                    coin[i] = 1;
                    doin[i] = 0;
                    changeYao.push(i); // 記錄動爻
                }
                
                resultArea.innerHTML = result;
            }
            
            coinAnimation.style.display = 'none';
            
            // 顯示卦象
            result += "\n==========================\n";
            const yaoOrder = ["初爻", "二爻", "三爻", "四爻", "五爻", "上爻"];
            
            for (let i = 5; i >= 0; i--) {
                result += yaoOrder[i] + " ";
                
                if (answer[i] === 3) {
                    result += "〇　〇 X老陰 變 〇〇〇\n";
                } else if (answer[i] === 1) {
                    result += "〇　〇   少陰   〇　〇\n";
                } else if (answer[i] === 2) {
                    result += "〇〇〇   少陽   〇〇〇\n";
                } else {
                    result += "〇〇〇 O老陽 變 〇　〇\n";
                }
            }
            
            // 計算卦名
            const guaIndex = coin[5] * 32 + coin[4] * 16 + coin[3] * 8 + coin[2] * 4 + coin[1] * 2 + coin[0];
            const bianguaIndex = doin[5] * 32 + doin[4] * 16 + doin[3] * 8 + doin[2] * 4 + doin[1] * 2 + doin[0];
            
            const benguaName = gua64Names[guaIndex];
            const bianguaName = gua64Names[bianguaIndex];
            
            result += `\n本卦: ${benguaName}　　變卦: ${bianguaName}\n`;
            result += "==========================================\n";
            
            // 五行分析
            const now = new Date();
            
            // 使用農曆庫計算的干支資料
            const yearGanZhi = window.currentGanZhi?.year || '乙巳';
            const monthGanZhi = window.currentGanZhi?.month || '甲申';
            const dateGanZhi = window.currentGanZhi?.date || '己酉';
            const hourGanZhi = window.currentGanZhi?.hour || getGanZhi(Math.floor(now.getHours() / 2));
            
            result += `干支【${yearGanZhi}年 ${monthGanZhi}月 ${dateGanZhi}日 ${hourGanZhi}時】\n`;
            
            const fiveElements = calculateFiveElements([yearGanZhi, monthGanZhi, dateGanZhi, hourGanZhi]);
            const yongShen = determineYongShen(fiveElements);
            
            result += `五行強弱: ${JSON.stringify(fiveElements)}\n`;
            result += `用神: ${yongShen}\n`;
            
            // 星煞信息
            const dayZhi = dateGanZhi.charAt(1);
            const dayGan = dateGanZhi.charAt(0);
            
            result += "\n星煞【";
            
            // 驛馬、桃花、劫煞
            const xinsha = getXinSha(dayZhi);
            result += xinsha;
            
            // 貴人、祿神、羊刃
            const guiren = getGuiRen(dayGan);
            result += guiren;
            
            result += "】";
            
            resultArea.innerHTML = result;
            
            // 顯示卦象解釋
            displayInterpretation(benguaName, changeYao);
        }

        function getXinSha(dayZhi) {
            const yima = {
                '申': '驛馬：寅　桃花：酉　劫煞：巳 ',
                '子': '驛馬：寅　桃花：酉　劫煞：巳 ',
                '辰': '驛馬：寅　桃花：酉　劫煞：巳 ',
                '寅': '驛馬：申　桃花：卯　劫煞：亥 ',
                '午': '驛馬：申　桃花：卯　劫煞：亥 ',
                '戌': '驛馬：申　桃花：卯　劫煞：亥 ',
                '巳': '驛馬：亥　桃花：午　劫煞：寅 ',
                '酉': '驛馬：亥　桃花：午　劫煞：寅 ',
                '丑': '驛馬：亥　桃花：午　劫煞：寅 ',
                '亥': '驛馬：巳　桃花：子　劫煞：申 ',
                '卯': '驛馬：巳　桃花：子　劫煞：申 ',
                '未': '驛馬：巳　桃花：子　劫煞：申 '
            };
            return yima[dayZhi] || '';
        }

        function getGuiRen(dayGan) {
            const guiren = {
                '甲': '貴人：丑未　祿神：寅　羊刃：卯',
                '乙': '貴人：申子　祿神：卯　羊刃：辰',
                '丙': '貴人：酉亥　祿神：午　羊刃：午',
                '丁': '貴人：酉亥　祿神：巳　羊刃：未',
                '戊': '貴人：丑未　祿神：午　羊刃：午',
                '己': '貴人：申子　祿神：巳　羊刃：未',
                '庚': '貴人：寅午　祿神：申　羊刃：酉',
                '辛': '貴人：寅午　祿神：酉　羊刃：戌',
                '壬': '貴人：卯巳　祿神：子　羊刃：子',
                '癸': '貴人：卯巳　祿神：亥　羊刃：丑'
            };
            return guiren[dayGan] || '';
        }

        // 頁面載入時初始化
        window.onload = function() {
            initDateInfo();
            // 自動執行一次占卜
            setTimeout(() => {
                rollGua();
            }, 1500);
        }
    </script>
</body>
</html>