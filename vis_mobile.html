<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>六十四卦在六維超立方體中的結構</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef, #dee2e6);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            color: #333;
            touch-action: none;
        }
        
        .container {
            display: block;
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        .main-view {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: grab;
        }
        
        .main-view:active {
            cursor: grabbing;
        }
        
        .info-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .info-panel.show {
            transform: translateY(0);
        }
        
        .title {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            z-index: 100;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            pointer-events: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            min-width: 250px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group:last-child {
            margin-bottom: 0;
        }
        
        .control-group label {
            color: #fff;
            font-size: 14px;
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            background: #333;
            border: none;
            border-radius: 5px;
            height: 8px;
        }
        
        .control-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        .control-group select {
            width: 100%;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 8px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .hexagram-info {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .hexagram-name {
            font-size: 22px;
            font-weight: bold;
            color: #d4851c;
            margin-bottom: 10px;
        }
        
        .hexagram-symbol {
            font-size: 32px;
            font-family: monospace;
            margin-bottom: 15px;
            line-height: 1.3;
            color: #333;
        }
        
        .coordinate {
            font-family: monospace;
            color: #198754;
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .description {
            font-size: 16px;
            line-height: 1.5;
            color: #333;
        }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
            border: 1px solid #666;
        }
        
        .legend h3 {
            margin-top: 0;
            color: #ffdd44;
            font-size: 18px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .legend-item span {
            color: #ffffff;
            font-size: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .instructions {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #666;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #ffdd44;
            font-size: 18px;
        }
        
        .instructions p {
            color: #ffffff;
            font-size: 15px;
            line-height: 1.5;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .toggle-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .toggle-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .toggle-button:active {
            transform: translateY(0px);
        }
        
        .legend.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-view" id="mainView"></div>
        
        <div class="floating-controls" id="floatingControls">
            <div class="control-slider">
                <label>大小</label>
                <input type="range" id="hexagramSize" min="0.5" max="3" step="0.1" value="1.5">
            </div>
            <div class="control-slider">
                <label>投影</label>
                <input type="range" id="projectionDimension" min="0" max="5" step="1" value="3">
            </div>
        </div>
        
        <div class="info-panel" id="infoPanel">
            <button class="close-btn" id="closeInfo">×</button>
            
            <div id="selectedHexagram" class="hexagram-info">
                <div class="hexagram-name">點擊卦象查看詳情</div>
                <div class="description">在六維超立方體中，每個卦象對應一個頂點。陰爻(⚋)對應0，陽爻(⚊)對應1。用手指拖動畫面可以旋轉視角觀察不同角度的結構。</div>
            </div>
            
            <div class="instructions">
                <h3>操作說明</h3>
                <p>• 用手指拖動畫面來旋轉視角</p>
                <p>• 點擊卦象查看詳細資訊</p>
                <p>• 調整投影維度來改變投影方式</p>
            </div>
            
            <div class="legend" id="legend">
                <h3>顏色說明</h3>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>乾卦系統 (多陽爻)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4ecdc4;"></div>
                    <span>坤卦系統 (多陰爻)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #45b7d1;"></div>
                    <span>震卦系統</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f7dc6f;"></div>
                    <span>艮卦系統</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #bb8fce;"></div>
                    <span>坎卦系統</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #82e0aa;"></div>
                    <span>離卦系統</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8c471;"></div>
                    <span>巽卦系統</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #85c1e9;"></div>
                    <span>兌卦系統</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 移動控制按鈕到最後 -->
    <div class="mobile-controls">
        <button class="control-btn" id="infoBtn">ℹ️</button>
        <button class="control-btn" id="settingsBtn">⚙️</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 六十四卦數據
        const hexagrams = [
            {name: "乾", symbol: "☰", lines: [1,1,1,1,1,1], desc: "天，創造力，陽剛"},
            {name: "坤", symbol: "☷", lines: [0,0,0,0,0,0], desc: "地，接受力，陰柔"},
            {name: "屯", symbol: "☳☵", lines: [1,0,0,0,1,0], desc: "雷水屯，艱難之始"},
            {name: "蒙", symbol: "☵☶", lines: [0,1,0,0,0,1], desc: "山水蒙，蒙昧無知"},
            {name: "需", symbol: "☵☰", lines: [1,1,1,0,1,0], desc: "水天需，等待時機"},
            {name: "訟", symbol: "☰☵", lines: [0,1,0,1,1,1], desc: "天水訟，爭訟不和"},
            {name: "師", symbol: "☷☵", lines: [0,1,0,0,0,0], desc: "地水師，軍隊領導"},
            {name: "比", symbol: "☵☷", lines: [0,0,0,0,1,0], desc: "水地比，親密比附"},
            {name: "小畜", symbol: "☴☰", lines: [1,1,1,0,1,1], desc: "風天小畜，小有積蓄"},
            {name: "履", symbol: "☰☱", lines: [1,1,0,1,1,1], desc: "天澤履，踐履前行"},
            {name: "泰", symbol: "☷☰", lines: [1,1,1,0,0,0], desc: "地天泰，通泰順暢"},
            {name: "否", symbol: "☰☷", lines: [0,0,0,1,1,1], desc: "天地否，閉塞不通"},
            {name: "同人", symbol: "☰☲", lines: [1,0,1,1,1,1], desc: "天火同人，團結同心"},
            {name: "大有", symbol: "☲☰", lines: [1,1,1,1,0,1], desc: "火天大有，大有收穫"},
            {name: "謙", symbol: "☷☶", lines: [0,0,1,0,0,0], desc: "地山謙，謙遜美德"},
            {name: "豫", symbol: "☳☷", lines: [0,0,0,1,0,0], desc: "雷地豫，安樂豫悅"},
            {name: "隨", symbol: "☱☳", lines: [1,0,0,1,1,0], desc: "澤雷隨，隨順而行"},
            {name: "蠱", symbol: "☶☴", lines: [0,1,1,0,0,1], desc: "山風蠱，撥亂反正"},
            {name: "臨", symbol: "☷☱", lines: [1,1,0,0,0,0], desc: "地澤臨，君臨天下"},
            {name: "觀", symbol: "☴☷", lines: [0,0,0,0,1,1], desc: "風地觀，觀察瞻仰"},
            {name: "噬嗑", symbol: "☲☳", lines: [1,0,0,1,0,1], desc: "火雷噬嗑，咬合除障"},
            {name: "賁", symbol: "☶☲", lines: [1,0,1,0,0,1], desc: "山火賁，文飾之美"},
            {name: "剝", symbol: "☶☷", lines: [0,0,0,0,0,1], desc: "山地剝，剝落衰敗"},
            {name: "復", symbol: "☷☳", lines: [1,0,0,0,0,0], desc: "地雷復，恢復返歸"},
            {name: "无妄", symbol: "☰☳", lines: [1,0,0,1,1,1], desc: "天雷无妄，無虛妄"},
            {name: "大畜", symbol: "☶☰", lines: [1,1,1,0,0,1], desc: "山天大畜，大有蓄積"},
            {name: "頤", symbol: "☶☳", lines: [1,0,0,0,0,1], desc: "山雷頤，頤養之道"},
            {name: "大過", symbol: "☱☴", lines: [0,1,1,1,1,0], desc: "澤風大過，大有過度"},
            {name: "坎", symbol: "☵", lines: [0,1,0,0,1,0], desc: "水，險難陷阱"},
            {name: "離", symbol: "☲", lines: [1,0,1,1,0,1], desc: "火，光明附麗"},
            {name: "咸", symbol: "☶☱", lines: [1,1,0,0,0,1], desc: "山澤咸，感應交流"},
            {name: "恆", symbol: "☳☴", lines: [0,1,1,1,0,0], desc: "雷風恆，恆久持續"},
            {name: "遯", symbol: "☰☶", lines: [0,0,1,1,1,1], desc: "天山遯，遁退避世"},
            {name: "大壯", symbol: "☳☰", lines: [1,1,1,1,0,0], desc: "雷天大壯，大力強壯"},
            {name: "晉", symbol: "☲☷", lines: [0,0,0,1,0,1], desc: "火地晉，前進晉升"},
            {name: "明夷", symbol: "☷☲", lines: [1,0,1,0,0,0], desc: "地火明夷，光明隱晦"},
            {name: "家人", symbol: "☴☲", lines: [1,0,1,0,1,1], desc: "風火家人，家庭和睦"},
            {name: "睽", symbol: "☲☱", lines: [1,1,0,1,0,1], desc: "火澤睽，背離分歧"},
            {name: "蹇", symbol: "☵☶", lines: [0,0,1,0,1,0], desc: "水山蹇，艱難險阻"},
            {name: "解", symbol: "☳☵", lines: [0,1,0,1,0,0], desc: "雷水解，解除困難"},
            {name: "損", symbol: "☶☱", lines: [1,1,0,0,0,1], desc: "山澤損，減損節制"},
            {name: "益", symbol: "☴☳", lines: [1,0,0,0,1,1], desc: "風雷益，增益助長"},
            {name: "夬", symbol: "☱☰", lines: [1,1,1,1,1,0], desc: "澤天夬，決斷果決"},
            {name: "姤", symbol: "☰☴", lines: [0,1,1,1,1,1], desc: "天風姤，陰陽相遇"},
            {name: "萃", symbol: "☱☷", lines: [0,0,0,1,1,0], desc: "澤地萃，聚集匯萃"},
            {name: "升", symbol: "☷☴", lines: [0,1,1,0,0,0], desc: "地風升，上升發展"},
            {name: "困", symbol: "☱☵", lines: [0,1,0,1,1,0], desc: "澤水困，困頓窘迫"},
            {name: "井", symbol: "☵☴", lines: [0,1,1,0,1,0], desc: "水風井，水井之象"},
            {name: "革", symbol: "☱☲", lines: [1,0,1,1,1,0], desc: "澤火革，變革改革"},
            {name: "鼎", symbol: "☲☴", lines: [0,1,1,1,0,1], desc: "火風鼎，鼎器承載"},
            {name: "震", symbol: "☳", lines: [1,0,0,1,0,0], desc: "雷，震動覺醒"},
            {name: "艮", symbol: "☶", lines: [0,0,1,0,0,1], desc: "山，靜止止息"},
            {name: "漸", symbol: "☴☶", lines: [0,0,1,0,1,1], desc: "風山漸，漸進發展"},
            {name: "歸妹", symbol: "☳☱", lines: [1,1,0,1,0,0], desc: "雷澤歸妹，少女出嫁"},
            {name: "豐", symbol: "☳☲", lines: [1,0,1,1,0,0], desc: "雷火豐，豐盛富足"},
            {name: "旅", symbol: "☲☶", lines: [0,0,1,1,0,1], desc: "火山旅，旅行客居"},
            {name: "巽", symbol: "☴", lines: [0,1,1,0,1,1], desc: "風，謙遜順從"},
            {name: "兌", symbol: "☱", lines: [1,1,0,1,1,0], desc: "澤，喜悅交流"},
            {name: "渙", symbol: "☴☵", lines: [0,1,0,0,1,1], desc: "風水渙，渙散離析"},
            {name: "節", symbol: "☵☱", lines: [1,1,0,0,1,0], desc: "水澤節，節制約束"},
            {name: "中孚", symbol: "☴☱", lines: [1,1,0,0,1,1], desc: "風澤中孚，誠信忠實"},
            {name: "小過", symbol: "☳☶", lines: [0,0,1,1,0,0], desc: "雷山小過，小有過度"},
            {name: "既濟", symbol: "☵☲", lines: [1,0,1,0,1,0], desc: "水火既濟，事已完成"},
            {name: "未濟", symbol: "☲☵", lines: [0,1,0,1,0,1], desc: "火水未濟，事未完成"}
        ];

        // 創建場景
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        
        const container = document.querySelector('.main-view');
        renderer.setSize(container.offsetWidth, container.offsetHeight);
        renderer.setClearColor(0xffffff, 1);
        container.appendChild(renderer.domElement);

        // 確保按鈕顯示在最上層
        const mobileControls = document.querySelector('.mobile-controls');
        document.body.appendChild(mobileControls);

        // 觸控和鼠標控制變數
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let rotationX = 0.3;
        let rotationY = 0.3;
        let targetRotationX = 0.3;
        let targetRotationY = 0.3;

        // 生成64個6維頂點
        const vertices6D = [];
        for (let i = 0; i < 64; i++) {
            const binary = i.toString(2).padStart(6, '0');
            const vertex = binary.split('').map(b => parseInt(b));
            vertices6D.push(vertex);
        }

        // 將6維坐標投影到3D空間
        function project6Dto3D(vertex6D, projectionDim = 3) {
            let x = vertex6D[0] - 0.5;
            let y = vertex6D[1] - 0.5;
            let z = vertex6D[2] - 0.5;
            
            // 根據投影維度動態調整高維度的投影
            for (let i = 3; i < 6; i++) {
                const weight = i === projectionDim ? 0.6 : 0.3;
                const angle = (i - 2) * Math.PI / 3;
                x += weight * Math.cos(angle) * (vertex6D[i] - 0.5);
                y += weight * Math.sin(angle) * (vertex6D[i] - 0.5);
                z += weight * Math.cos(angle * 0.7) * (vertex6D[i] - 0.5);
            }
            
            return [x * 3, y * 3, z * 3];
        }

        // 根據卦象生成顏色
        function getHexagramColor(lines) {
            const yangCount = lines.reduce((sum, line) => sum + line, 0);
            
            // 根據陰陽比例和卦象特性生成顏色
            if (yangCount === 6) return new THREE.Color(0xff6b6b); // 純陽 - 紅色
            if (yangCount === 0) return new THREE.Color(0x4ecdc4); // 純陰 - 青色
            if (yangCount === 5) return new THREE.Color(0xff8e53); // 一陰五陽
            if (yangCount === 1) return new THREE.Color(0x45b7d1); // 一陽五陰
            if (yangCount === 4) return new THREE.Color(0xf7dc6f); // 二陰四陽
            if (yangCount === 2) return new THREE.Color(0xbb8fce); // 二陽四陰
            return new THREE.Color(0x82e0aa); // 三陰三陽 - 平衡
        }

        // 創建卦象mesh
        const hexagramMeshes = [];
        const hexagramLabels = [];
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const sceneGroup = new THREE.Group(); // 創建一個群組來控制整體旋轉
        scene.add(sceneGroup);

        hexagrams.forEach((hexagram, index) => {
            const vertex6D = hexagram.lines;
            
            // 創建卦象球體
            const geometry = new THREE.SphereGeometry(0.08, 16, 16);
            const color = getHexagramColor(vertex6D);
            const material = new THREE.MeshBasicMaterial({ 
                color: color,
                transparent: true,
                opacity: 0.9
            });
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.userData = { hexagram: hexagram, index: index };
            sceneGroup.add(mesh);
            hexagramMeshes.push({ mesh, vertex6D, hexagram });

            // 創建標籤
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 128;
            canvas.height = 64;
            
            context.fillStyle = 'rgba(255, 255, 255, 0.9)';
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            context.fillStyle = '#333333';
            context.font = 'bold 16px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(hexagram.name, canvas.width / 2, canvas.height / 2);
            
            const texture = new THREE.CanvasTexture(canvas);
            const labelMaterial = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true,
                opacity: 0.8
            });
            const label = new THREE.Sprite(labelMaterial);
            label.scale.set(0.5, 0.25, 1);
            sceneGroup.add(label);
            hexagramLabels.push({ label, vertex6D, hexagram });
        });

        // 創建連接線（相鄰卦象）
        const lines = [];
        function createLines() {
            // 清除現有線條
            lines.forEach(lineData => sceneGroup.remove(lineData.line));
            lines.length = 0;

            for (let i = 0; i < hexagrams.length; i++) {
                for (let j = i + 1; j < hexagrams.length; j++) {
                    const hex1 = hexagrams[i].lines;
                    const hex2 = hexagrams[j].lines;
                    
                    // 檢查是否只有一爻不同（相鄰卦象）
                    let diff = 0;
                    for (let k = 0; k < 6; k++) {
                        if (hex1[k] !== hex2[k]) diff++;
                    }
                    
                    if (diff === 1) {
                        const geometry = new THREE.BufferGeometry();
                        const material = new THREE.LineBasicMaterial({ 
                            color: 0x444444,
                            transparent: true,
                            opacity: 0.2
                        });
                        const line = new THREE.Line(geometry, material);
                        sceneGroup.add(line);
                        lines.push({ line, i, j });
                    }
                }
            }
        }

        createLines();

        // 設置相機位置
        camera.position.set(8, 8, 8);
        camera.lookAt(0, 0, 0);

        // 觸控和鼠標事件處理
        function getEventPos(event) {
            if (event.touches && event.touches.length > 0) {
                return { x: event.touches[0].clientX, y: event.touches[0].clientY };
            }
            return { x: event.clientX, y: event.clientY };
        }

        function onPointerDown(event) {
            event.preventDefault();
            isDragging = true;
            const pos = getEventPos(event);
            previousMousePosition = { x: pos.x, y: pos.y };
        }

        function onPointerMove(event) {
            if (!isDragging) return;
            
            event.preventDefault();
            const pos = getEventPos(event);
            
            const deltaX = pos.x - previousMousePosition.x;
            const deltaY = pos.y - previousMousePosition.y;
            
            targetRotationY += deltaX * 0.01;
            targetRotationX += deltaY * 0.01;
            
            // 限制X軸旋轉範圍
            targetRotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, targetRotationX));
            
            previousMousePosition = { x: pos.x, y: pos.y };
        }

        function onPointerUp(event) {
            isDragging = false;
        }

        // 點擊事件處理
        function onPointerClick(event) {
            if (isDragging) return; // 如果正在拖動，不處理點擊
            
            const pos = getEventPos(event);
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((pos.x - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((pos.y - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(hexagramMeshes.map(h => h.mesh));

            if (intersects.length > 0) {
                const selectedHexagram = intersects[0].object.userData.hexagram;
                displayHexagramInfo(selectedHexagram);
            }
        }

        // 註冊事件監聽器
        const canvas = renderer.domElement;
        
        // 鼠標事件
        canvas.addEventListener('mousedown', onPointerDown);
        canvas.addEventListener('mousemove', onPointerMove);
        canvas.addEventListener('mouseup', onPointerUp);
        canvas.addEventListener('click', onPointerClick);
        
        // 觸控事件
        canvas.addEventListener('touchstart', onPointerDown, { passive: false });
        canvas.addEventListener('touchmove', onPointerMove, { passive: false });
        canvas.addEventListener('touchend', onPointerUp, { passive: false });
        canvas.addEventListener('touchstart', onPointerClick, { passive: false });

        function displayHexagramInfo(hexagram) {
            const infoDiv = document.getElementById('selectedHexagram');
            const linesSymbol = hexagram.lines.map(line => line ? '⚊' : '⚋').reverse().join('<br>');
            const coordinate = `(${hexagram.lines.join(',')})`;
            
            infoDiv.innerHTML = `
                <div class="hexagram-name">${hexagram.name}卦</div>
                <div class="hexagram-symbol">${linesSymbol}</div>
                <div class="coordinate">6D坐標: ${coordinate}</div>
                <div class="description">${hexagram.desc}</div>
            `;
        }

        // 動畫循環
        function animate() {
            requestAnimationFrame(animate);
            
            const size = parseFloat(document.getElementById('hexagramSize').value);
            const showLines = true; // 預設顯示連線
            const showNames = true; // 預設顯示名稱
            const projectionDim = parseInt(document.getElementById('projectionDimension').value);
            
            // 平滑旋轉插值
            rotationX += (targetRotationX - rotationX) * 0.1;
            rotationY += (targetRotationY - rotationY) * 0.1;
            
            // 應用旋轉到場景群組
            sceneGroup.rotation.x = rotationX;
            sceneGroup.rotation.y = rotationY;
            
            // 更新卦象位置
            hexagramMeshes.forEach(({ mesh, vertex6D }) => {
                const pos3D = project6Dto3D(vertex6D, projectionDim);
                mesh.position.set(pos3D[0], pos3D[1], pos3D[2]);
                mesh.scale.setScalar(size);
            });
            
            // 更新標籤位置和顯示
            hexagramLabels.forEach(({ label, vertex6D }) => {
                const pos3D = project6Dto3D(vertex6D, projectionDim);
                label.position.set(pos3D[0], pos3D[1] + 0.3, pos3D[2]);
                label.visible = showNames;
            });
            
            // 更新連接線
            lines.forEach(({ line, i, j }) => {
                const pos1 = project6Dto3D(hexagrams[i].lines, projectionDim);
                const pos2 = project6Dto3D(hexagrams[j].lines, projectionDim);
                const points = [
                    new THREE.Vector3(pos1[0], pos1[1], pos1[2]),
                    new THREE.Vector3(pos2[0], pos2[1], pos2[2])
                ];
                line.geometry.setFromPoints(points);
                line.visible = showLines;
            });
            
            renderer.render(scene, camera);
        }

        animate();

        // 響應式調整
        window.addEventListener('resize', () => {
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });

        // 防止右鍵選單
        canvas.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        // 手機介面控制
        const infoBtn = document.getElementById('infoBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const infoPanel = document.getElementById('infoPanel');
        const floatingControls = document.getElementById('floatingControls');
        const closeInfo = document.getElementById('closeInfo');
        
        // 顯示資訊面板
        infoBtn.addEventListener('click', function() {
            infoPanel.classList.add('show');
        });
        
        // 顯示設定控制
        settingsBtn.addEventListener('click', function() {
            floatingControls.classList.toggle('show');
        });
        
        // 關閉資訊面板
        closeInfo.addEventListener('click', function() {
            infoPanel.classList.remove('show');
        });
        
        // 點擊面板外部關閉
        infoPanel.addEventListener('click', function(e) {
            if (e.target === infoPanel) {
                infoPanel.classList.remove('show');
            }
        });
    </script>
</body>
</html>