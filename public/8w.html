<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>八字大運與流年 - 精確節氣計算</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#fbf7ec;--panel:#fffaf0;--card:#fffdf6;--accent:#cfa85a;--muted:#8a6b2f;--line:#e6d6a9;--ok:#d7f7d7;--bad:#f7d7d7;--mid:#efefef;--text:#222;--shadow:0 12px 30px rgba(0,0,0,0.06)}
html,body{height:100%;margin:0;background:var(--bg);font-family:'Noto Sans TC',system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:var(--text)}
.wrap{max-width:1180px;margin:18px auto;padding:18px;background:linear-gradient(180deg,var(--card),#ffffff);border-radius:12px;box-shadow:var(--shadow)}
h1{margin:0 0 12px;font-size:20px;text-align:center}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:end;margin-bottom:12px}
.col{flex:1;min-width:160px}
label{display:block;font-size:13px;color:#444;margin-bottom:6px}
input[type="text"], input[type="datetime-local"], select {width:80%;padding:10px;border:1px solid var(--line);border-radius:8px;background:white;font-size:14px;box-sizing:border-box}
button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
button.secondary{background:#8a6b2f}
.board{display:none;margin-top:12px;background:var(--panel);padding:14px;border-radius:12px;border:1px solid var(--line)}
/* 四柱視覺 */
.toprow{display:flex;gap:12px;align-items:stretch}
.pillars{flex:1;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.pillar{background:linear-gradient(180deg,#fff,#fff8e6);border:2px solid rgba(210,170,90,0.18);border-radius:10px;padding:18px;text-align:center;display:flex;flex-direction:column;justify-content:center;min-height:160px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
.pillar .label{font-size:13px;color:#6b4f2a}
.pillar .ten{font-size:13px;color:var(--muted);margin-top:6px}
.pillar .gz{font-size:46px;font-weight:900;letter-spacing:8px;margin-top:6px;color:#2b2b2b}
.pillar .hidden{font-size:13px;color:#4b3a1a;margin-top:8px}
/* info column */
.info{width:320px;background:white;border:1px solid var(--line);border-radius:10px;padding:14px}
.info h3{margin:0 0 8px;font-size:15px}
.info pre{margin:0;font-size:13px;white-space:pre-wrap}
.meta{display:flex;gap:12px;margin-top:12px}
.card{flex:1;background:white;padding:12px;border-radius:10px;border:1px solid var(--line)}
.card strong{display:block;margin-bottom:8px}
/* 大運 / 流年 */
.area{display:flex;gap:12px;margin-top:12px;align-items:flex-start}
.panel{flex:1;background:white;padding:12px;border-radius:10px;border:1px solid var(--line)}
.panel h4{margin:0 0 8px;font-size:15px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:8px;font-size:13px;text-align:center}
th{background:#fff6e6}
.biggz{font-weight:900;font-size:16px;color:#3b2b1a}
.ok{background:var(--ok)}
.bad{background:var(--bad)}
.mid{background:var(--mid)}
.small{font-size:12px}
.debug{margin-top:12px;background:#fafafa;border:1px dashed var(--line);padding:10px;border-radius:8px;font-size:12px}
.footer{font-size:12px;color:#666;text-align:right;margin-top:12px}
.switches{display:flex;gap:8px;align-items:center;margin-top:8px}
.highlight{background-color:#fff3cd;font-weight:bold}
@media (max-width:980px){.pillars{grid-template-columns:repeat(2,1fr)}.info{width:100%}.toprow{flex-direction:column}.area{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">
  <h1>八字命盤 — 節氣起運計算</h1>

  <div class="controls">
    <div class="col" style="flex:0 0 160px"><label>姓名</label><input id="name" type="text" value="測試人" maxlength="8" placeholder="最多8個字"></div>
    <div class="col" style="flex:0 0 80px"><label>性別</label><select id="gender"><option value="未定">未定</option><option value="男">男</option><option value="女">女</option></select></div>
    <div class="col" style="flex:1"><label>出生（公曆）</label><input id="birth" type="datetime-local" value="2015-08-25T09:00"></div>
    <button id="genBtn">生成命盤</button>
      <button id="downloadBtn" class="secondary">下載 PNG</button>
      <button id="showFullBtn">顯示完整人生（到100歲）</button>
  </div>

  <div style="margin-bottom:12px">
    <div class="switches">
    </div>
  </div>

  <div class="board" id="board">
    <div class="toprow">
      <div class="pillars" id="pillars">
        <div class="pillar"><div class="label">年柱</div><div class="ten" id="ten_year">—</div><div class="gz" id="gz_year">—</div><div class="hidden" id="hid_year">藏干：—</div></div>
        <div class="pillar"><div class="label">月柱</div><div class="ten" id="ten_month">—</div><div class="gz" id="gz_month">—</div><div class="hidden" id="hid_month">藏干：—</div></div>
        <div class="pillar"><div class="label">日柱</div><div class="ten" id="ten_day">日主</div><div class="gz" id="gz_day">—</div><div class="hidden" id="hid_day">藏干：—</div></div>
        <div class="pillar"><div class="label">時柱</div><div class="ten" id="ten_time">—</div><div class="gz" id="gz_time">—</div><div class="hidden" id="hid_time">藏干：—</div></div>
      </div>

      <div class="info">
        <h3>基本資訊</h3>
        <pre id="basic">—</pre>
        <div style="height:8px"></div>
        <h3>補充資訊</h3>
        <pre id="extras">—</pre>
      </div>
    </div>

    <div class="meta">
      <div class="card"><strong>五行統計 & 日主</strong><pre id="wx">—</pre></div>
      <div class="card"><strong>起運計算說明</strong><pre id="tenLegend">起運計算方法：
1. 年干陰陽配性別定順逆
2. 陽男陰女順行，陰男陽女逆行  
3. 順行：生日到下個節氣
4. 逆行：生日到上個節氣
5. 距離天數 ÷ 3 = 起運歲數
6. 不足3天按1歲計算</pre></div>
    </div>

    <div class="area">
      <div class="panel"><h4>大運（節氣計算）</h4>
        <table id="dayunTable"><thead><tr><th>序</th><th>起運年齡</th><th>干支</th><th>十神</th><th>起運年</th><th>止運年</th><th>順逆</th></tr></thead><tbody></tbody></table></div>

      <div class="panel"><h4>流年（僅顯示「當前大運」的 10 年）</h4>
        <table id="liunianTable"><thead><tr><th>西元</th><th>干支</th><th>年齡</th><th>十神</th><th>吉凶</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="debug"><strong>起運計算過程</strong><pre id="debug">—</pre></div>
    <div class="footer">資料來源：lunar-javascript（CDN）· 節氣起運算法</div>
  </div>
</div>

<!-- lunar-javascript + html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.7.3/lunar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const stems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
const branches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];

// 24節氣對照表（農曆月份對應）
const jieQiNames = [
  '立春', '雨水', '驚蟄', '春分', '清明', '穀雨',
  '立夏', '小滿', '芒種', '夏至', '小暑', '大暑', 
  '立秋', '處暑', '白露', '秋分', '寒露', '霜降',
  '立冬', '小雪', '大雪', '冬至', '小寒', '大寒'
];

// 月令節氣（每個月的主要節氣，用於確定月柱）
const monthJieQi = [
  '立春', '驚蟄', '清明', '立夏', '芒種', '小暑',
  '立秋', '白露', '寒露', '立冬', '大雪', '小寒'
];

const hiddenMap = {
  '子': '癸', '丑': '己辛癸', '寅': '甲丙戊', '卯': '乙', '辰': '戊乙癸', '巳': '丙戊庚',
  '午': '丁己', '未': '己丁乙', '申': '庚壬戊', '酉': '辛', '戌': '戊辛丁', '亥': '壬甲'
};
const xunkongByDayStem = {
  '甲': ['戌', '亥'], '乙': ['戌', '亥'], '丙': ['午', '未'], '丁': ['午', '未'], '戊': ['寅', '卯'],
  '己': ['寅', '卯'], '庚': ['子', '丑'], '辛': ['子', '丑'], '壬': ['辰', '巳'], '癸': ['辰', '巳']
};

// 十神對應表
const tenGodMap = (function() {
  const m = {
    '甲': ['比肩', '劫財', '食神', '傷官', '偏財', '正財', '七殺', '正官', '偏印', '正印'],
    '乙': ['劫財', '比肩', '傷官', '食神', '正財', '偏財', '正官', '七殺', '正印', '偏印'],
    '丙': ['偏印', '正印', '比肩', '劫財', '食神', '傷官', '偏財', '正財', '七殺', '正官'],
    '丁': ['正印', '偏印', '劫財', '比肩', '傷官', '食神', '正財', '偏財', '正官', '七殺'],
    '戊': ['七殺', '正官', '偏印', '正印', '比肩', '劫財', '食神', '傷官', '偏財', '正財'],
    '己': ['正官', '七殺', '正印', '偏印', '劫財', '比肩', '傷官', '食神', '正財', '偏財'],
    '庚': ['偏財', '正財', '七殺', '正官', '偏印', '正印', '比肩', '劫財', '食神', '傷官'],
    '辛': ['正財', '偏財', '正官', '七殺', '正印', '偏印', '劫財', '比肩', '傷官', '食神'],
    '壬': ['傷官', '食神', '偏財', '正財', '七殺', '正官', '偏印', '正印', '比肩', '劫財'],
    '癸': ['食神', '傷官', '正財', '偏財', '正官', '七殺', '正印', '偏印', '劫財', '比肩']
  };
  const o = {};
  Object.keys(m).forEach(k => {
    o[k] = {};
    for (let i = 0; i < 10; i++) o[k][stems[i]] = m[k][i];
  });
  return o;
})();

const tenLuck = {
  '正印': '吉', '偏印': '中', '比肩': '中', '劫財': '中', '食神': '吉', '傷官': '凶',
  '正財': '吉', '偏財': '吉', '正官': '吉', '七殺': '凶'
};

function westernZodiac(m, d) {
  const table = [
    { name: '摩羯', start: [12, 22] }, { name: '水瓶', start: [1, 20] }, { name: '雙魚', start: [2, 19] },
    { name: '牡羊', start: [3, 21] }, { name: '金牛', start: [4, 21] }, { name: '雙子', start: [5, 21] },
    { name: '巨蟹', start: [6, 22] }, { name: '獅子', start: [7, 23] }, { name: '處女', start: [8, 23] },
    { name: '天秤', start: [9, 23] }, { name: '天蠍', start: [10, 24] }, { name: '射手', start: [11, 23] }
  ];
  for (let i = 0; i < table.length; i++) {
    const [mm, dd] = table[i].start;
    if ((m === mm && d >= dd) || (m === ((mm % 12) + 1) && d < table[(i + 1) % 12].start[1])) return table[i].name;
  }
  return '';
}

function shiftArr(arr, item, step) {
  const idx = arr.indexOf(item);
  if (idx === -1) return '';
  return arr[(idx + step + arr.length) % arr.length];
}

function getTenGod(dayStem, otherStem) {
  if (!dayStem || !otherStem) return '';
  return (tenGodMap[dayStem] && tenGodMap[dayStem][otherStem]) || '';
}

function s(x) { return x == null ? '' : String(x); }

// 獲取指定年份的所有節氣時間
function getJieQiForYear(year) {
  let jieQiList = [];
  
  try {
    // 使用 lunar-javascript 的正確方法獲取節氣
    // 遍歷整年的每一天，獲取節氣信息
    for (let month = 1; month <= 12; month++) {
      for (let day = 1; day <= 31; day++) {
        try {
          const solar = Solar.fromYmd(year, month, day);
          if (!solar) continue;
          
          const lunar = solar.getLunar();
          if (!lunar) continue;
          
          // 檢查這一天是否為節氣
          const jieQi = lunar.getJieQi();
          if (jieQi) {
            // 找到節氣日
            jieQiList.push({
              name: jieQi,
              date: new Date(year, month - 1, day),
              solar: solar
            });
          }
        } catch (e) {
          // 忽略無效日期（如2月30日）
          continue;
        }
      }
    }
    
    // 如果還是沒有找到足夠的節氣，嘗試另一種方法
    if (jieQiList.length < 20) {
      console.log('第一種方法獲取的節氣數量不足，嘗試第二種方法');
      jieQiList = [];
      
      // 方法2：使用更直接的方式
      for (let month = 1; month <= 12; month++) {
        try {
          const solar = Solar.fromYmd(year, month, 15);
          const lunar = solar.getLunar();
          
          // 嘗試獲取該月的節氣表
          if (lunar.getJieQiTable) {
            const jieQiTable = lunar.getJieQiTable();
            Object.keys(jieQiTable).forEach(jqName => {
              const jqSolar = jieQiTable[jqName];
              if (jqSolar && jqSolar.getYear() === year) {
                jieQiList.push({
                  name: jqName,
                  date: new Date(jqSolar.getYear(), jqSolar.getMonth() - 1, jqSolar.getDay()),
                  solar: jqSolar
                });
              }
            });
          }
        } catch (e) {
          continue;
        }
      }
    }
    
    // 方法3：如果以上方法都不行，嘗試從年度對象直接獲取
    if (jieQiList.length < 20) {
      console.log('第二種方法也不夠，嘗試第三種方法');
      try {
        const solar = Solar.fromYmd(year, 1, 1);
        const lunarYear = solar.getLunar().getYear();
        
        if (lunarYear && lunarYear.getJieQi) {
          const yearJieQi = lunarYear.getJieQi();
          yearJieQi.forEach(jq => {
            if (jq && jq.getName && jq.getSolar) {
              const jqSolar = jq.getSolar();
              jieQiList.push({
                name: jq.getName(),
                date: new Date(jqSolar.getYear(), jqSolar.getMonth() - 1, jqSolar.getDay()),
                solar: jqSolar
              });
            }
          });
        }
      } catch (e) {
        console.warn('第三種方法也失敗:', e);
      }
    }
    
  } catch (e) {
    console.error('獲取節氣時發生錯誤:', e);
  }
  
  // 如果所有方法都失敗，拋出錯誤而不是使用近似值
  if (jieQiList.length === 0) {
    throw new Error(`無法獲取 ${year} 年的節氣數據，請檢查 lunar-javascript 庫版本`);
  }
  
  console.log(`成功獲取 ${year} 年的 ${jieQiList.length} 個節氣`);
  
  // 去除重複並按日期排序
  const uniqueJieQi = [];
  const seen = new Set();
  jieQiList.forEach(jq => {
    const key = `${jq.name}_${jq.date.getTime()}`;
    if (!seen.has(key)) {
      seen.add(key);
      uniqueJieQi.push(jq);
    }
  });
  
  uniqueJieQi.sort((a, b) => a.date - b.date);
  return uniqueJieQi;
}

// 計算大運起運歲數
function calculatePreciseStartAge(birthDate, yearStem, gender) {
  const birthYear = birthDate.getFullYear();
  const isMale = (gender === '男');
  const yangStems = ['甲', '丙', '戊', '庚', '壬'];
  const isYearStemYang = yangStems.includes(yearStem);
  
  // 判斷順逆行
  const isForward = (isMale && isYearStemYang) || (!isMale && !isYearStemYang);
  
  try {
    // 獲取出生年份和前後年份的節氣
    const jieQiThisYear = getJieQiForYear(birthYear);
    const jieQiNextYear = getJieQiForYear(birthYear + 1);
    const jieQiPrevYear = getJieQiForYear(birthYear - 1);
    
    // 合併所有節氣並排序
    const allJieQi = [...jieQiPrevYear, ...jieQiThisYear, ...jieQiNextYear]
      .filter(jq => jq && jq.date && jq.name) // 確保數據完整
      .sort((a, b) => a.date - b.date);
    
    let targetJieQi = null;
    let distanceDays = 0;
    let calculationDetail = '';
    
    console.log('所有節氣:', allJieQi.map(jq => `${jq.name}:${jq.date.toLocaleDateString()}`));
    console.log('生日:', birthDate.toLocaleDateString());
    console.log('順逆行:', isForward ? '順行' : '逆行');
    
    if (isForward) {
      // 順行：找下一個節氣
      targetJieQi = allJieQi.find(jq => jq.date > birthDate);
      if (targetJieQi) {
        distanceDays = Math.ceil((targetJieQi.date - birthDate) / (1000 * 60 * 60 * 24));
        calculationDetail = `順行：從生日 ${birthDate.toLocaleDateString()} 到下個節氣 ${targetJieQi.name} ${targetJieQi.date.toLocaleDateString()}`;
      } else {
        // 如果找不到，可能是年底，找下一年的第一個節氣
        const nextYearJieQi = getJieQiForYear(birthYear + 2);
        targetJieQi = nextYearJieQi[0];
        if (targetJieQi) {
          distanceDays = Math.ceil((targetJieQi.date - birthDate) / (1000 * 60 * 60 * 24));
          calculationDetail = `順行：從生日 ${birthDate.toLocaleDateString()} 到下年節氣 ${targetJieQi.name} ${targetJieQi.date.toLocaleDateString()}`;
        }
      }
    } else {
      // 逆行：找上一個節氣
      const reversedJieQi = [...allJieQi].reverse();
      targetJieQi = reversedJieQi.find(jq => jq.date < birthDate);
      if (targetJieQi) {
        distanceDays = Math.ceil((birthDate - targetJieQi.date) / (1000 * 60 * 60 * 24));
        calculationDetail = `逆行：從上個節氣 ${targetJieQi.name} ${targetJieQi.date.toLocaleDateString()} 到生日 ${birthDate.toLocaleDateString()}`;
      } else {
        // 如果找不到，可能是年初，找上一年的最後一個節氣
        const prevYearJieQi = getJieQiForYear(birthYear - 2);
        targetJieQi = prevYearJieQi[prevYearJieQi.length - 1];
        if (targetJieQi) {
          distanceDays = Math.ceil((birthDate - targetJieQi.date) / (1000 * 60 * 60 * 24));
          calculationDetail = `逆行：從上年節氣 ${targetJieQi.name} ${targetJieQi.date.toLocaleDateString()} 到生日 ${birthDate.toLocaleDateString()}`;
        }
      }
    }
    
    // 計算起運歲數：3天為1歲，不足3天按1歲計算
    let startAge = 0;
    if (distanceDays > 0) {
      startAge = Math.max(1, Math.ceil(distanceDays / 3));
    } else {
      throw new Error('無法計算節氣距離');
    }
    
    const ageCalculation = `距離 ${distanceDays} 天，${distanceDays} ÷ 3 = ${(distanceDays / 3).toFixed(2)} → 起運 ${startAge} 歲`;
    
    console.log('計算結果:', { targetJieQi: targetJieQi?.name, distanceDays, startAge });
    
    return {
      startAge,
      isForward,
      targetJieQi: targetJieQi ? targetJieQi.name : '未找到',
      targetDate: targetJieQi ? targetJieQi.date : null,
      distanceDays,
      calculationDetail: calculationDetail + '\n' + ageCalculation
    };
    
  } catch (error) {
    console.error('節氣計算失敗:', error);
    
    // 如果節氣計算完全失敗，給出明確的錯誤信息
    return {
      startAge: 0,
      isForward,
      targetJieQi: '計算失敗',
      targetDate: null,
      distanceDays: 0,
      calculationDetail: `節氣計算失敗：${error.message}\n請檢查 lunar-javascript 庫版本或網絡連接`
    };
  }
}

// 精確大運計算函數
function calculateDayunPrecise(lunar, gender, birthYear, birthDate, yearGz, monthGz) {
  const yearStem = s(yearGz)[0] || '';
  const monthStem = s(monthGz)[0] || '';
  const monthBranch = s(monthGz)[1] || '';
  
  // 使用精確計算獲取起運資訊
  const startInfo = calculatePreciseStartAge(birthDate, yearStem, gender);
  const { startAge, isForward } = startInfo;
  
  // 從月柱開始排大運
  const dayunList = [];
  let currentStemIndex = stems.indexOf(monthStem);
  let currentBranchIndex = branches.indexOf(monthBranch);
  
  // 第一步大運應該是月柱的下一柱（順行）或上一柱（逆行）
  if (isForward) {
    currentStemIndex = (currentStemIndex + 1) % 10;
    currentBranchIndex = (currentBranchIndex + 1) % 12;
  } else {
    currentStemIndex = (currentStemIndex - 1 + 10) % 10;
    currentBranchIndex = (currentBranchIndex - 1 + 12) % 12;
  }
  
  for (let i = 0; i < 10; i++) {
    const age = startAge + i * 10;
    const startYear = birthYear + age;
    const gz = (currentStemIndex >= 0 && currentBranchIndex >= 0) ? 
               (stems[currentStemIndex] + branches[currentBranchIndex]) : '—';
    
    dayunList.push({
      index: i + 1,
      startAge: age,
      startYear: startYear,
      endYear: startYear + 9,
      gz: gz,
      startDate: new Date(startYear, 0, 1),
      direction: isForward ? '順行' : '逆行'
    });
    
    // 繼續排下一個大運
    if (isForward) {
      currentStemIndex = (currentStemIndex + 1) % 10;
      currentBranchIndex = (currentBranchIndex + 1) % 12;
    } else {
      currentStemIndex = (currentStemIndex - 1 + 10) % 10;
      currentBranchIndex = (currentBranchIndex - 1 + 12) % 12;
    }
  }
  
  return { dayunList, isForward, startInfo };
}

/* main */
document.getElementById('genBtn').addEventListener('click', () => {
  const name = document.getElementById('name').value.trim() || '無名氏';
  const gender = document.getElementById('gender').value || '未指定';
  const b = document.getElementById('birth').value;
  if (!b) { alert('請輸入出生日期時間'); return; }
  const dt = new Date(b);
  if (dt > new Date()) { alert('出生日期不能晚於當前時間'); return; }
  if (dt.getFullYear() < 1900) { alert('出生年份過早，請確認'); return; }
  
  const solar = Solar.fromDate(dt);
  const lunar = solar.getLunar();
  const birthYear = solar.getYear();

  const yearGz = lunar.getYearInGanZhi ? lunar.getYearInGanZhi() : (lunar.getYear && lunar.getYear() ? lunar.getYear().getGanZhi() : '');
  const monthGz = lunar.getMonthInGanZhi ? lunar.getMonthInGanZhi() : (lunar.getMonth && lunar.getMonth() ? lunar.getMonth().getGanZhi() : '');
  const dayGz = lunar.getDayInGanZhi ? lunar.getDayInGanZhi() : (lunar.getDay && lunar.getDay() ? lunar.getDay().getGanZhi() : '');
  const timeGz = lunar.getTimeInGanZhi ? lunar.getTimeInGanZhi() : (lunar.getTime && lunar.getTime() ? lunar.getTime().getGanZhi() : '');

  document.getElementById('board').style.display = 'block';
  document.getElementById('gz_year').textContent = yearGz || '—';
  document.getElementById('gz_month').textContent = monthGz || '—';
  document.getElementById('gz_day').textContent = dayGz || '—';
  document.getElementById('gz_time').textContent = timeGz || '—';

  const dayStem = s(dayGz)[0] || '';
  const dayBranch = s(dayGz)[1] || '';

  function showHidden(gz) {
    if (!gz) return '—';
    const z = gz[1];
    const p = hiddenMap[z] || '';
    return p ? ('藏干：' + p.split('').join(' ')) : '藏干：—';
  }
  document.getElementById('hid_year').textContent = showHidden(yearGz);
  document.getElementById('hid_month').textContent = showHidden(monthGz);
  document.getElementById('hid_day').textContent = showHidden(dayGz);
  document.getElementById('hid_time').textContent = showHidden(timeGz);

  document.getElementById('ten_year').textContent = getTenGod(dayStem, s(yearGz)[0]) || '—';
  document.getElementById('ten_month').textContent = getTenGod(dayStem, s(monthGz)[0]) || '—';
  document.getElementById('ten_day').textContent = '日主';
  document.getElementById('ten_time').textContent = getTenGod(dayStem, s(timeGz)[0]) || '—';

  const basic = `姓名：${name}
性別：${gender}
公曆：${solar.toFullString()}
農曆：${lunar.toFullString().split(' ').slice(0, 2).join(' ')}`;
  document.getElementById('basic').textContent = basic;

  const mStem = s(monthGz)[0] || '';
  const mBranch = s(monthGz)[1] || '';
  const zodiac = westernZodiac(dt.getMonth() + 1, dt.getDate());
  const xunkong = xunkongByDayStem[dayStem] ? xunkongByDayStem[dayStem].join('、') : '—';
  const taiStem = shiftArr(stems, mStem, 1);
  const taiBranch = shiftArr(branches, mBranch, 3);
  const taiYuan = taiStem && taiBranch ? (taiStem + taiBranch) : '—';
  const taiXiBranch = taiBranch ? shiftArr(branches, taiBranch, 1) : '';
  const taiXi = taiStem && taiXiBranch ? (taiStem + taiXiBranch) : '—';
  const monthIdx = branches.indexOf(mBranch);
  const timeBranch = s(timeGz)[1] || '';
  const timeIdx = branches.indexOf(timeBranch);
  const mingIdx = ((monthIdx >= 0 ? monthIdx : 0) + (timeIdx >= 0 ? timeIdx : 0)) % 12;
  const mingBranch = branches[mingIdx];
  const branch2stem = {
    '子': '癸', '丑': '己', '寅': '甲', '卯': '乙', '辰': '戊', '巳': '丙',
    '午': '丁', '未': '己', '申': '庚', '酉': '辛', '戌': '戊', '亥': '壬'
  };
  const mingStem = branch2stem[mingBranch] || '';
  const mingGz = mingStem ? (mingStem + mingBranch) : '—';
  const shenIdx = (mingIdx + 3) % 12;
  const shenBranch = branches[shenIdx];
  const shenStem = branch2stem[shenBranch] || '';
  const shenGz = shenStem ? (shenStem + shenBranch) : '—';
  
  const extrasText = `西洋星座：${zodiac}
空亡（旬空）：${xunkong}
胎元：${taiYuan}
胎息：${taiXi}
命宮：${mingGz}（地支:${mingBranch}）
身宮：${shenGz}（地支:${shenBranch}）

`;
  document.getElementById('extras').textContent = extrasText;

  const five = { 金: 0, 木: 0, 水: 0, 火: 0, 土: 0 };
  const map = {
    '甲': '木', '乙': '木', '丙': '火', '丁': '火', '戊': '土', '己': '土',
    '庚': '金', '辛': '金', '壬': '水', '癸': '水', '子': '水', '丑': '土',
    '寅': '木', '卯': '木', '辰': '土', '巳': '火', '午': '火', '未': '土',
    '申': '金', '酉': '金', '戌': '土', '亥': '水'
  };
  [yearGz, monthGz, dayGz, timeGz].forEach(gz => {
    if (!gz) return;
    const s0 = gz[0], b0 = gz[1];
    if (map[s0]) five[map[s0]]++;
    if (map[b0]) five[map[b0]]++;
  });
  document.getElementById('wx').textContent = `五行：金 ${five['金']}  木 ${five['木']}  水 ${five['水']}  火 ${five['火']}  土 ${five['土']}
日主：${dayStem || '—'}`;

  const debug = [];
  debug.push(`日干（日主）：${dayStem || '—'}  日支：${dayBranch || '—'}`);
  debug.push(`年干：${s(yearGz)[0] || '—'}  月干：${s(monthGz)[0] || '—'}`);

  // ---------- 使用精確大運計算 ----------
  const { dayunList, isForward, startInfo } = calculateDayunPrecise(lunar, gender, birthYear, dt, yearGz, monthGz);
  
  debug.push(`\n=== 精確起運計算 ===`);
  debug.push(`年干：${s(yearGz)[0]} ${(['甲', '丙', '戊', '庚', '壬'].includes(s(yearGz)[0])) ? '(陽)' : '(陰)'}，${gender}命`);
  debug.push(`大運方向：${isForward ? '順行' : '逆行'} (${isForward ? '陽男陰女順行' : '陰男陽女逆行'})`);
  debug.push(`月柱：${monthGz} → 大運從${isForward ? '下一柱' : '上一柱'}開始排列`);
  debug.push(`\n節氣計算詳情：`);
  debug.push(startInfo.calculationDetail);
  debug.push(`目標節氣：${startInfo.targetJieQi}`);
  if (startInfo.targetDate) {
    debug.push(`節氣日期：${startInfo.targetDate.toLocaleDateString()}`);
  }
  debug.push(`起運年齡：${startInfo.startAge} 歲`);

  // 渲染大運表格
  const dayunTbody = document.querySelector('#dayunTable tbody');
  dayunTbody.innerHTML = '';
  
  // 確定當前大運（用於高亮顯示）
  const currentYear = new Date().getFullYear();
  let currentDayunIndex = 0;
  for (let i = 0; i < dayunList.length; i++) {
    const d = dayunList[i];
    const sy = Number(d.startYear);
    const ey = Number(d.endYear);
    if (currentYear >= sy && currentYear <= ey) {
      currentDayunIndex = i;
      break;
    }
  }
  
  dayunList.forEach((d, index) => {
    const ten = getTenGod(dayStem, s(d.gz)[0]) || '—';
    const tr = document.createElement('tr');
    if (index === currentDayunIndex) {
      tr.className = 'highlight';
    }
    tr.innerHTML = `<td>${d.index}</td><td>${d.startAge}</td><td class="biggz">${d.gz}</td><td>${ten}</td><td>${d.startYear || '—'}</td><td>${d.endYear || '—'}</td><td class="small">${d.direction}</td>`;
    dayunTbody.appendChild(tr);
  });

  // 渲染流年
  function renderLiuNianForDayun(d) {
    const liuTbody = document.querySelector('#liunianTable tbody');
    liuTbody.innerHTML = '';
    const startYear = Number(d.startYear);
    for (let i = 0; i < 10; i++) {
      const y = startYear + i;
      let yGz = '—';
      try {
        const s = Solar.fromYmd(y, 1, 1);
        yGz = s.getLunar().getYearInGanZhi ? s.getLunar().getYearInGanZhi() : s.getLunar().getYear().getGanZhi();
      } catch (e) {
        yGz = '—';
      }
      const stem = s(yGz)[0] || '';
      const ten = dayStem ? getTenGod(dayStem, stem) || '—' : '—';
      const luck = tenLuck[ten] || '中';
      const tr = document.createElement('tr');
      
      // 高亮當前年份
      if (y === currentYear) {
        tr.className = (luck === '吉') ? 'ok highlight' : (luck === '凶') ? 'bad highlight' : 'mid highlight';
      } else {
        tr.className = (luck === '吉') ? 'ok' : (luck === '凶') ? 'bad' : 'mid';
      }
      
      tr.innerHTML = `<td>${y}</td><td>${yGz}</td><td>${(y - birthYear)}</td><td>${ten}</td><td>${luck}</td>`;
      liuTbody.appendChild(tr);
    }
  }

  // 渲染當前大運的流年
  renderLiuNianForDayun(dayunList[currentDayunIndex]);

  // 儲存狀態
  window._bazi_state = { dayunList, solar, lunar, dayStem, birthYear, currentDayunIndex, startInfo };

  document.getElementById('debug').textContent = debug.join('\n');
});

// show full life until 100
document.getElementById('showFullBtn').addEventListener('click', () => {
  const state = window._bazi_state;
  if (!state) { alert('請先生成命盤'); return; }
  const { dayunList, solar, dayStem } = state;
  const startYear = dayunList[0].startYear;
  const endYear = solar.getYear() + 100;
  const currentYear = new Date().getFullYear();
  
  const liuTbody = document.querySelector('#liunianTable tbody');
  liuTbody.innerHTML = '';
  
  for (let y = startYear; y <= endYear; y++) {
    let yGz = '—';
    try {
      const s = Solar.fromYmd(y, 1, 1);
      yGz = s.getLunar().getYearInGanZhi ? s.getLunar().getYearInGanZhi() : s.getLunar().getYear().getGanZhi();
    } catch (e) {
      yGz = '—';
    }
    const stem = s(yGz)[0] || '';
    const ten = dayStem ? getTenGod(dayStem, stem) || '—' : '—';
    const luck = tenLuck[ten] || '中';
    const tr = document.createElement('tr');
    
    // 高亮當前年份
    if (y === currentYear) {
      tr.className = (luck === '吉') ? 'ok highlight' : (luck === '凶') ? 'bad highlight' : 'mid highlight';
    } else {
      tr.className = (luck === '吉') ? 'ok' : (luck === '凶') ? 'bad' : 'mid';
    }
    
    tr.innerHTML = `<td>${y}</td><td>${yGz}</td><td>${(y - solar.getYear())}</td><td>${ten}</td><td>${luck}</td>`;
    liuTbody.appendChild(tr);
  }
  document.querySelector('#board .panel h4').textContent = '流年（完整人生直到 +100 歲）';
});

// download PNG
document.getElementById('downloadBtn').addEventListener('click', () => {
  const board = document.querySelector('.board');
  if (board.style.display === 'none') { alert('請先生成命盤'); return; }
  
  const state = window._bazi_state;
  if (!state) { alert('請先生成命盤'); return; }
  
  // 獲取生日資訊作為檔名
  const birthInput = document.getElementById('birth').value;
  let filename = 'bazi.png';
  if (birthInput) {
    const dt = new Date(birthInput);
    const year = dt.getFullYear();
    const month = String(dt.getMonth() + 1).padStart(2, '0');
    const day = String(dt.getDate()).padStart(2, '0');
    filename = `bazi_${year}${month}${day}.png`;
  }
  
  const dbg = document.querySelector('.debug');
  const dbgDisplay = dbg.style.display;
  dbg.style.display = 'none';
  html2canvas(board, { scale: 2, useCORS: true }).then(canvas => {
    dbg.style.display = dbgDisplay;
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = filename;
    link.click();
  }).catch(err => {
    dbg.style.display = dbgDisplay;
    alert('匯出失敗：' + err);
  });
});
</script>
</body>
</html>