<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bazi With Dayun — 精細化版</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#fbf7ec;--panel:#fffaf0;--card:#fffdf6;--accent:#cfa85a;--muted:#8a6b2f;--line:#e6d6a9;--ok:#d7f7d7;--bad:#f7d7d7;--mid:#efefef;--text:#222;--shadow:0 12px 30px rgba(0,0,0,0.06)}
html,body{height:100%;margin:0;background:var(--bg);font-family:'Noto Sans TC',system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:var(--text)}
.wrap{max-width:1180px;margin:18px auto;padding:18px;background:linear-gradient(180deg,var(--card),#ffffff);border-radius:12px;box-shadow:var(--shadow)}
h1{margin:0 0 12px;font-size:20px;text-align:center}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:end;margin-bottom:12px}
.col{flex:1;min-width:160px}
label{display:block;font-size:13px;color:#444;margin-bottom:6px}
input[type="text"], input[type="datetime-local"], select {width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:white;font-size:14px;box-sizing:border-box}
button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
button.secondary{background:#8a6b2f}
.board{display:none;margin-top:12px;background:var(--panel);padding:14px;border-radius:12px;border:1px solid var(--line)}
/* 四柱視覺 */
.toprow{display:flex;gap:12px;align-items:stretch}
.pillars{flex:1;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.pillar{background:linear-gradient(180deg,#fff,#fff8e6);border:2px solid rgba(210,170,90,0.18);border-radius:10px;padding:18px;text-align:center;display:flex;flex-direction:column;justify-content:center;min-height:160px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
.pillar .label{font-size:13px;color:#6b4f2a}
.pillar .ten{font-size:13px;color:var(--muted);margin-top:6px}
.pillar .gz{font-size:46px;font-weight:900;letter-spacing:8px;margin-top:6px;color:#2b2b2b}
.pillar .hidden{font-size:13px;color:#4b3a1a;margin-top:8px}
/* info column */
.info{width:320px;background:white;border:1px solid var(--line);border-radius:10px;padding:14px}
.info h3{margin:0 0 8px;font-size:15px}
.info pre{margin:0;font-size:13px;white-space:pre-wrap}
.meta{display:flex;gap:12px;margin-top:12px}
.card{flex:1;background:white;padding:12px;border-radius:10px;border:1px solid var(--line)}
.card strong{display:block;margin-bottom:8px}
/* 大運 / 流年 */
.area{display:flex;gap:12px;margin-top:12px;align-items:flex-start}
.panel{flex:1;background:white;padding:12px;border-radius:10px;border:1px solid var(--line)}
.panel h4{margin:0 0 8px;font-size:15px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:8px;font-size:13px;text-align:center}
th{background:#fff6e6}
.biggz{font-weight:900;font-size:16px;color:#3b2b1a}
.ok{background:var(--ok)}
.bad{background:var(--bad)}
.mid{background:var(--mid)}
.small{font-size:12px}
.debug{margin-top:12px;background:#fafafa;border:1px dashed var(--line);padding:10px;border-radius:8px;font-size:12px}
.footer{font-size:12px;color:#666;text-align:right;margin-top:12px}
@media (max-width:980px){.pillars{grid-template-columns:repeat(2,1fr)}.info{width:100%}.toprow{flex-direction:column}.area{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap">
  <h1>八字命盤 — 精細化版</h1>

  <div class="controls">
    <div class="col"><label>姓名</label><input id="name" type="text" placeholder="王小明"></div>
    <div class="col"><label>性別</label><select id="gender"><option value="">未指定</option><option value="男">男</option><option value="女">女</option></select></div>
    <div class="col"><label>出生（公曆）</label><input id="birth" type="datetime-local" value="1968-10-30T18:30"></div>
    <div class="col" style="min-width:140px"><button id="genBtn">生成命盤</button>
        <button id="downloadBtn" class="secondary">下載 PNG</button></div>
  </div>

  <div class="board" id="board">
    <div class="toprow">
      <div class="pillars" id="pillars">
        <div class="pillar"><div class="label">年柱</div><div class="ten" id="ten_year">—</div><div class="gz" id="gz_year">—</div><div class="hidden" id="hid_year">藏干：—</div></div>
        <div class="pillar"><div class="label">月柱</div><div class="ten" id="ten_month">—</div><div class="gz" id="gz_month">—</div><div class="hidden" id="hid_month">藏干：—</div></div>
        <div class="pillar"><div class="label">日柱</div><div class="ten" id="ten_day">日主</div><div class="gz" id="gz_day">—</div><div class="hidden" id="hid_day">藏干：—</div></div>
        <div class="pillar"><div class="label">時柱</div><div class="ten" id="ten_time">—</div><div class="gz" id="gz_time">—</div><div class="hidden" id="hid_time">藏干：—</div></div>
      </div>

      <div class="info">
        <h3>基本資訊</h3>
        <pre id="basic">—</pre>
        <div style="height:8px"></div>
        <h3>補充資訊</h3>
        <pre id="extras">—</pre>
      </div>
    </div>

    <div class="meta">
      <div class="card"><strong>五行統計 & 日主</strong><pre id="wx">—</pre></div>
      <div class="card"><strong>其他（十神表說明）</strong><pre id="tenLegend">日主對應十神顯示於表格中；綠=吉、紅=凶、灰=中性。</pre></div>
    </div>

    <div class="area">
      <div class="panel"><h4>大運（起運年齡 / 十神 / 起訖年）</h4>
        <table id="dayunTable"><thead><tr><th>序</th><th>起運年齡</th><th>干支</th><th>十神</th><th>起運年</th><th>止運年</th></tr></thead><tbody></tbody></table></div>

      <div class="panel"><h4>流年（前 40 年示例）</h4>
        <table id="liunianTable"><thead><tr><th>西元</th><th>干支</th><th>年齡</th><th>十神</th><th>吉凶</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div class="debug"><strong>計算過程（便於核對）</strong><pre id="debug">—</pre></div>
    <div class="footer">資料來源：lunar-javascript（CDN） · 預設時區：本機時區（若需指定時區請使用 ISO 格式輸入）</div>
  </div>
</div>

<!-- lunar-javascript + html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.7.3/lunar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const stems = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
const branches = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
const hiddenMap = {'子':'癸','丑':'己辛癸','寅':'甲丙戊','卯':'乙','辰':'戊乙癸','巳':'丙戊庚','午':'丁己','未':'己丁乙','申':'庚壬戊','酉':'辛','戌':'戊辛丁','亥':'壬甲'};
const xunkongByDayStem = {'甲':['戌','亥'],'乙':['戌','亥'],'丙':['午','未'],'丁':['午','未'],'戊':['寅','卯'],'己':['寅','卯'],'庚':['子','丑'],'辛':['子','丑'],'壬':['辰','巳'],'癸':['辰','巳']};
const tenGodMap = {/* full map omitted here for brevity - will be reconstructed in runtime */};
// Rebuild tenGodMap at runtime to avoid huge literal here
(function(){
  const map = {
    '甲':['比肩','劫財','食神','傷官','偏財','正財','七殺','正官','偏印','正印'],
    '乙':['劫財','比肩','傷官','食神','正財','偏財','正官','七殺','正印','偏印'],
    '丙':['偏印','正印','比肩','劫財','食神','傷官','偏財','正財','七殺','正官'],
    '丁':['正印','偏印','劫財','比肩','傷官','食神','正財','偏財','正官','七殺'],
    '戊':['七殺','正官','偏印','正印','比肩','劫財','食神','傷官','偏財','正財'],
    '己':['正官','七殺','正印','偏印','劫財','比肩','傷官','食神','正財','偏財'],
    '庚':['偏財','正財','七殺','正官','偏印','正印','比肩','劫財','食神','傷官'],
    '辛':['正財','偏財','正官','七殺','正印','偏印','劫財','比肩','傷官','食神'],
    '壬':['傷官','食神','偏財','正財','七殺','正官','偏印','正印','比肩','劫財'],
    '癸':['食神','傷官','正財','偏財','正官','七殺','正印','偏印','劫財','比肩']
  };
  Object.keys(map).forEach(k=>{
    const arr = map[k];
    tenGodMap[k] = {};
    for(let i=0;i<10;i++) tenGodMap[k][stems[i]] = arr[i];
  });
})();
const tenLuck = {'正印':'吉','偏印':'中','比肩':'中','劫財':'中','食神':'吉','傷官':'凶','正財':'吉','偏財':'吉','正官':'吉','七殺':'凶'};
function westernZodiac(m,d){const table=[{name:'摩羯',start:[12,22]},{name:'水瓶',start:[1,20]},{name:'雙魚',start:[2,19]},{name:'牡羊',start:[3,21]},{name:'金牛',start:[4,21]},{name:'雙子',start:[5,21]},{name:'巨蟹',start:[6,22]},{name:'獅子',start:[7,23]},{name:'處女',start:[8,23]},{name:'天秤',start:[9,23]},{name:'天蠍',start:[10,24]},{name:'射手',start:[11,23]}];for(let i=0;i<table.length;i++){const [mm,dd]=table[i].start; if((m===mm && d>=dd) || (m===((mm)%12)+1 && d < table[(i+1)%12].start[1])) return table[i].name;}return '';}
function shiftArr(arr,item,step){const idx=arr.indexOf(item); if(idx===-1) return ''; return arr[(idx+step+arr.length)%arr.length];}
function getTenGod(dayStem, otherStem){ if(!dayStem||!otherStem) return ''; return (tenGodMap[dayStem] && tenGodMap[dayStem][otherStem]) || ''; }
function s(x){ return x==null ? '' : String(x); }

/* ---------- 主程式 ---------- */
document.getElementById('genBtn').addEventListener('click', ()=>{
  const name = document.getElementById('name').value.trim() || '無名氏';
  const gender = document.getElementById('gender').value || '未指定';
  const b = document.getElementById('birth').value; if(!b){alert('請輸入出生日期時間'); return;} 
  const dt = new Date(b);
  const solar = Solar.fromDate(dt); const lunar = solar.getLunar();

  const yearGz = lunar.getYearInGanZhi ? lunar.getYearInGanZhi() : (lunar.getYear && lunar.getYear() ? lunar.getYear().getGanZhi() : '');
  const monthGz = lunar.getMonthInGanZhi ? lunar.getMonthInGanZhi() : (lunar.getMonth && lunar.getMonth() ? lunar.getMonth().getGanZhi() : '');
  const dayGz = lunar.getDayInGanZhi ? lunar.getDayInGanZhi() : (lunar.getDay && lunar.getDay() ? lunar.getDay().getGanZhi() : '');
  const timeGz = lunar.getTimeInGanZhi ? lunar.getTimeInGanZhi() : (lunar.getTime && lunar.getTime() ? lunar.getTime().getGanZhi() : '');

  document.getElementById('board').style.display='block';
  document.getElementById('gz_year').textContent = yearGz || '—';
  document.getElementById('gz_month').textContent = monthGz || '—';
  document.getElementById('gz_day').textContent = dayGz || '—';
  document.getElementById('gz_time').textContent = timeGz || '—';

  const dayStem = s(dayGz)[0]||''; const dayBranch = s(dayGz)[1]||'';

  function showHidden(gz){ if(!gz) return '—'; const z=gz[1]; const p=hiddenMap[z]||''; return p?('藏干：'+p.split('').join(' ')):'藏干：—'; }
  document.getElementById('hid_year').textContent = showHidden(yearGz);
  document.getElementById('hid_month').textContent = showHidden(monthGz);
  document.getElementById('hid_day').textContent = showHidden(dayGz);
  document.getElementById('hid_time').textContent = showHidden(timeGz);

  document.getElementById('ten_year').textContent = getTenGod(dayStem, s(yearGz)[0]) || '—';
  document.getElementById('ten_month').textContent = getTenGod(dayStem, s(monthGz)[0]) || '—';
  document.getElementById('ten_day').textContent = '日主';
  document.getElementById('ten_time').textContent = getTenGod(dayStem, s(timeGz)[0]) || '—';

  const basic = `姓名：${name}
性別：${gender}
公曆：${solar.toFullString()}
農曆：${lunar.toFullString().split().slice(0,2).join(' / ')}
生肖：${lunar.getYearShengxiao ? lunar.getYearShengxiao() : ''}`;
  document.getElementById('basic').textContent = basic;

  const mStem = s(monthGz)[0]||''; const mBranch = s(monthGz)[1]||''; const zodiac = westernZodiac(dt.getMonth()+1, dt.getDate());
  const xunkong = xunkongByDayStem[dayStem] ? xunkongByDayStem[dayStem].join('、') : '—';
  const taiStem = shiftArr(stems, mStem, 1); const taiBranch = shiftArr(branches, mBranch, 3); const taiYuan = taiStem && taiBranch ? (taiStem + taiBranch) : '—';
  const taiXiBranch = taiBranch ? shiftArr(branches, taiBranch, 1) : ''; const taiXi = taiStem && taiXiBranch ? (taiStem + taiXiBranch) : '—';
  const monthIdx = branches.indexOf(mBranch); const timeBranch = s(timeGz)[1] || ''; const timeIdx = branches.indexOf(timeBranch);
  const mingIdx = ((monthIdx>=0?monthIdx:0) + (timeIdx>=0?timeIdx:0)) % 12; const mingBranch = branches[mingIdx];
  const branch2stem = {'子':'癸','丑':'己','寅':'甲','卯':'乙','辰':'戊','巳':'丙','午':'丁','未':'己','申':'庚','酉':'辛','戌':'戊','亥':'壬'};
  const mingStem = branch2stem[mingBranch] || ''; const mingGz = mingStem ? (mingStem + mingBranch) : '—'; const shenIdx = (mingIdx + 3) % 12; const shenBranch = branches[shenIdx]; const shenStem = branch2stem[shenBranch] || ''; const shenGz = shenStem ? (shenStem + shenBranch) : '—';
  const extrasText = `西洋星座：${zodiac}
空亡（旬空）：${xunkong}
胎元：${taiYuan}
胎息：${taiXi}
命宮：${mingGz}（地支:${mingBranch}）
身宮：${shenGz}（地支:${shenBranch}）

（註）命宮/身宮為常見變體算法；如需指定流派請提供範例以利校正。`;
  document.getElementById('extras').textContent = extrasText;

  const five = {金:0,木:0,水:0,火:0,土:0}; const map = {'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水','子':'水','丑':'土','寅':'木','卯':'木','辰':'土','巳':'火','午':'火','未':'土','申':'金','酉':'金','戌':'土','亥':'水'};
  [yearGz,monthGz,dayGz,timeGz].forEach(gz=>{ if(!gz) return; const s0=gz[0], b0=gz[1]; if(map[s0]) five[map[s0]]++; if(map[b0]) five[map[b0]]++; });
  document.getElementById('wx').textContent = `五行：金 ${five['金']}  木 ${five['木']}  水 ${five['水']}  火 ${five['火']}  土 ${five['土']}
日主：${dayStem||'—'}`;

  const debug = [];
  debug.push(`日干（日主）：${dayStem||'—'}  日支：${dayBranch||'—'}`);
  debug.push(`旬空（空亡）：${xunkong || '—'}`);
  debug.push(`胎元：月干(${mStem||'—'})→${taiStem||'—'}，月支(${mBranch||'—'})→${taiBranch||'—'} => ${taiYuan}`);
  debug.push(`胎息：${taiXi}`);
  debug.push(`命宮 idx 計算：monthIdx=${monthIdx}, timeIdx=${timeIdx} => mingIdx=${mingIdx} (${mingGz})  身宮=${shenGz}`);

  // 大運（嘗試多種屬性取法，並在 debug 中記錄 dayunArr 以便排查）
  const dayunTbody = document.querySelector('#dayunTable tbody'); dayunTbody.innerHTML = '';
  let dayunArr = null;
  try{
    if(typeof lunar.getDaYun === 'function') dayunArr = lunar.getDaYun();
    else if(typeof lunar.getDayun === 'function') dayunArr = lunar.getDayun();
    else if(lunar.getEightChar && typeof lunar.getEightChar === 'function'){
      const ec = lunar.getEightChar(); if(ec.getDaYun) dayunArr = ec.getDaYun(); else if(ec.getDaYunList) dayunArr = ec.getDaYunList();
    }
  }catch(e){ console.warn('dayun api error', e); }

  debug.push('dayunArr (raw): ' + (Array.isArray(dayunArr)? JSON.stringify(dayunArr.map(d=>{ try{ if(typeof d==='string') return d; if(d.getGanZhi) return d.getGanZhi(); if(d.ganZhi) return d.ganZhi; if(d.getGan && d.getZhi) return d.getGan()+d.getZhi(); if(d.gan && d.zhi) return d.gan+d.zhi; return JSON.stringify(d); }catch(err){return String(d);} })) : String(dayunArr)));

  if(dayunArr && dayunArr.length){
    dayunArr.forEach((d, idx)=>{
      let startAge = '';
      try{ startAge = (d.getStartAge && d.getStartAge()) || d.startAge || (d.start && d.start.age) || ''; }catch(e){}
      let gz = '';
      try{
        if(typeof d === 'string') gz = d;
        else if(d.getGanZhi) gz = d.getGanZhi();
        else if(d.ganZhi) gz = d.ganZhi;
        else if(d.getGan && d.getZhi) gz = d.getGan()+d.getZhi();
        else if(d.gan && d.zhi) gz = d.gan+d.zhi;
        else if(d.getStart && typeof d.getStart === 'function'){
          const st = d.getStart();
          if(st && st.getLunar && typeof st.getLunar === 'function'){
            const stL = st.getLunar(); if(stL.getYearInGanZhi) gz = stL.getYearInGanZhi();
            else if(stL.getYear && stL.getYear().getGanZhi) gz = stL.getYear().getGanZhi();
          } else if(st && st.getGanZhi) gz = st.getGanZhi();
        }
      }catch(e){ gz = '' }

      // startYear
      let startYear = '';
      try{ startYear = (d.getStartYear && d.getStartYear()) || d.startYear || (d.getStart && d.getStart && d.getStart().getYear && d.getStart().getYear()) || ''; }catch(e){}
      let endYear = '';
      try{ endYear = (d.getEndYear && d.getEndYear()) || d.endYear || (startYear?Number(startYear)+9:''); }catch(e){ endYear = ''; }

      if(!gz || gz==='') gz = '—';
      const ten = dayStem ? getTenGod(dayStem, s(gz)[0]) || '—' : '—';
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${idx+1}</td><td>${startAge}</td><td class="biggz">${gz}</td><td>${ten}</td><td>${startYear}</td><td>${endYear}</td>`;
      dayunTbody.appendChild(tr);
    });
  } else {
    const by = solar.getYear();
    for(let i=0;i<10;i++){ const startAge = 4 + i*10; const sY = by + startAge; const eY = sY + 9; const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${startAge}</td><td class="biggz">—</td><td>—</td><td>${sY}</td><td>${eY}</td>`; dayunTbody.appendChild(tr); }
    debug.push('（警示）大運 API 未取得，已用簡易 fallback（每 10 年一柱，示意 4 歲起運）');
  }

  // 流年
  const liuTbody = document.querySelector('#liunianTable tbody'); liuTbody.innerHTML = '';
  const birthYear = solar.getYear(); const showYears = 40;
  for(let i=0;i<=showYears;i++){
    const y = birthYear + i; let yGz = '—'; try{ const s = Solar.fromYmd(y,1,1); yGz = s.getLunar().getYearInGanZhi ? s.getLunar().getYearInGanZhi() : s.getLunar().getYear().getGanZhi(); }catch(e){ yGz='—'; }
    const stem = s(yGz)[0] || '';
    const ten = dayStem ? getTenGod(dayStem, stem) || '—' : '—';
    const luck = tenLuck[ten] || '中';
    const tr = document.createElement('tr'); tr.className = (luck==='吉')? 'ok' : (luck==='凶')? 'bad' : 'mid'; tr.innerHTML = `<td>${y}</td><td>${yGz}</td><td>${i}</td><td>${ten}</td><td>${luck}</td>`; liuTbody.appendChild(tr);
  }

  document.getElementById('debug').textContent = debug.join();
});

// 匯出 PNG
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const board = document.querySelector('.board'); if(board.style.display === 'none'){ alert('請先生成命盤'); return; }
  const dbg = document.querySelector('.debug'); const dbgDisplay = dbg.style.display; dbg.style.display = 'none';
  html2canvas(board, {scale:2, useCORS:true}).then(canvas=>{ dbg.style.display = dbgDisplay; const link = document.createElement('a'); link.href = canvas.toDataURL('image/png'); link.download = 'bazi.png'; link.click(); }).catch(err=>{ dbg.style.display = dbgDisplay; alert('匯出失敗：' + err); });
});
</script>
</body>
</html>
