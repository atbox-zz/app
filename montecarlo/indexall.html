<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 å°ç£å…¨ç¸£å¸‚é¸æƒ…æ¨¡æ“¬çµ‚æ¥µç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1a2a3a; --accent: #f39c12; --bg: #f0f2f5; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* é ‚éƒ¨å°è¦½ */
        header { background: var(--primary); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .status-bar { font-size: 0.9rem; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; }

        /* ä¸»ä½ˆå±€ */
        .wrapper { display: grid; grid-template-columns: 320px 1fr; flex: 1; overflow: hidden; }
        
        /* å·¦å´æ§åˆ¶é¢æ¿ */
        .sidebar { background: white; padding: 20px; border-right: 1px solid #ddd; overflow-y: auto; }
        .control-section { margin-bottom: 25px; }
        h3 { font-size: 1rem; border-left: 4px solid var(--accent); padding-left: 10px; margin-bottom: 15px; }
        select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 10px; }
        
        /* äº‹ä»¶é¡¯ç¤º */
        .event-card { background: #fff8e1; border: 1px solid #ffe082; padding: 12px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 15px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; transition: 0.2s; }
        .btn-run { background: var(--accent); color: white; }
        .btn-event { background: #34495e; color: white; }

        /* å³å´å ±è¡¨ */
        .main-view { padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .full-width { grid-column: span 2; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .win-tag { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div><strong>2026 Election AI Command</strong> | å…¨å°ç¸£å¸‚é•·æ¨¡æ“¬</div>
    <div class="status-bar">ğŸ“… ç•¶å‰æ¨¡æ“¬æ—¥æœŸï¼š2026å¹´1æœˆ13æ—¥ (é¸å‰ 320 å¤©)</div>
</header>

<div class="wrapper">
    <div class="sidebar">
        <div class="control-section">
            <h3>ğŸ“ é¸æ“‡å€åŸŸèˆ‡ç¸£å¸‚</h3>
            <select id="regionSelect" onchange="updateCityList()">
                <option value="north">åŒ—éƒ¨åœ°å€ (åŒ—åŒ—åŸºæ¡ƒç«¹è‹—)</option>
                <option value="central">ä¸­éƒ¨åœ°å€ (ä¸­å½°æŠ•é›²)</option>
                <option value="south">å—éƒ¨åœ°å€ (å˜‰å—é«˜å±)</option>
                <option value="east">æ±éƒ¨åŠé›¢å³¶ (å®œèŠ±æ±æ¾é‡‘é¦¬)</option>
            </select>
            <select id="citySelect" onchange="loadCityData()"></select>
        </div>

        <div class="control-section">
            <h3>ğŸ­ é¸æˆ°äº‹ä»¶æ¨¡æ“¬</h3>
            <div class="event-card" id="eventBox">ç„¡é è­¦äº‹ä»¶ã€‚ç›®å‰çš„é¸æƒ…å—å¤§ç’°å¢ƒé€šè†¨èˆ‡åœ°æ–¹æ”¿ç¸¾å½±éŸ¿ã€‚</div>
            <button class="btn btn-event" onclick="triggerEvent()">ğŸ² éš¨æ©Ÿè§¸ç™¼çªç™¼äº‹ä»¶</button>
            <button class="btn btn-run" onclick="startFullSimulation()">ğŸš€ åŸ·è¡Œä¸€è¬æ¬¡è’™ç‰¹å¡æ´›æ¨¡æ“¬</button>
        </div>

        <div id="candidateStats"></div>
    </div>

    <div class="main-view">
        <div class="chart-card full-width">
            <h3>ğŸ“ˆ æ”¯æŒåº¦æ¼”åŒ–è¶¨å‹¢ç·š (é¸å‰ 320 å¤©é æ¸¬)</h3>
            <canvas id="timeLineChart" height="80"></canvas>
        </div>

        <div class="chart-card">
            <h3>ğŸ¯ æ¨¡æ“¬å‹é¸ç‡åˆ†ä½ˆ</h3>
            <canvas id="winChart"></canvas>
        </div>

        <div class="chart-card">
            <h3>ğŸ“Š å€™é¸äººç‰¹è³ªå°æ¯” (Radar)</h3>
            <canvas id="radarChart"></canvas>
        </div>

        <div class="chart-card full-width">
            <h3>ğŸ æ¨¡æ“¬æ•¸æ“šè©³æƒ…</h3>
            <table id="resultTable">
                <thead>
                    <tr><th>å€™é¸äºº</th><th>é™£ç‡Ÿ</th><th>å¹³å‡æ”¯æŒåº¦</th><th>æœ€é«˜å¾—ç¥¨ç‡</th><th>å‹é¸æ©Ÿç‡</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- 1. å…¨å° 22 ç¸£å¸‚é è¨­æ•¸æ“šåº« ---
const allCityData = {
    north: {
        "Taipei": [{name:"è”£è¬å®‰", party:"è—", mean:48, sd:3, air:85, org:85, img:90, color:"#000095"}, {name:"ç¶ ç‡ŸæŒ‘æˆ°è€…", party:"ç¶ ", mean:35, sd:4, air:80, org:80, img:75, color:"#1b9431"}, {name:"é»ƒçŠçŠ/ç™½ç‡Ÿ", party:"ç™½", mean:12, sd:5, air:90, org:40, img:80, color:"#28c8c8"}],
        "NewTaipei": [{name:"æå››å·", party:"è—", mean:42, sd:3, air:75, org:92, img:85, color:"#000095"}, {name:"è˜‡å·§æ…§", party:"ç¶ ", mean:38, sd:3, air:88, org:85, img:82, color:"#1b9431"}, {name:"é»ƒåœ‹æ˜Œ", party:"ç™½", mean:15, sd:6, air:95, org:35, img:70, color:"#28c8c8"}],
        "Taoyuan": [{name:"å¼µå–„æ”¿", party:"è—", mean:45, sd:3, air:70, org:85, img:80, color:"#000095"}, {name:"ç¶ ç‡Ÿå€™é¸äºº", party:"ç¶ ", mean:40, sd:4, air:85, org:80, img:75, color:"#1b9431"}],
        "HsinchuCity": [{name:"ä»£ç†å¸‚é•·/è—ç™½", party:"è—/ç™½", mean:40, sd:6, air:80, org:60, img:70, color:"#28c8c8"}, {name:"ç¶ ç‡ŸæŒ‘æˆ°è€…", party:"ç¶ ", mean:35, sd:4, air:85, org:75, img:80, color:"#1b9431"}]
        // ... (çœç•¥éƒ¨åˆ†ä»¥ä¿æŒç°¡æ½”ï¼Œé‚è¼¯ç›¸åŒ)
    },
    central: {
        "Taichung": [{name:"æ±Ÿå•Ÿè‡£/è—ç‡Ÿ", party:"è—", mean:46, sd:3, air:80, org:90, img:88, color:"#000095"}, {name:"ä½•æ¬£ç´”/ç¶ ç‡Ÿ", party:"ç¶ ", mean:40, sd:4, air:82, org:85, img:80, color:"#1b9431"}],
        "Changhua": [{name:"è—ç‡Ÿæ¥ç­äºº", party:"è—", mean:44, sd:3, air:65, org:90, img:75, color:"#000095"}, {name:"ç¶ ç‡ŸæŒ‘æˆ°è€…", party:"ç¶ ", mean:42, sd:4, air:75, org:85, img:78, color:"#1b9431"}]
    },
    south: {
        "Tainan": [{name:"ç¶ ç‡Ÿåˆé¸å‹è€…", party:"ç¶ ", mean:55, sd:4, air:80, org:92, img:85, color:"#1b9431"}, {name:"è¬é¾ä»‹", party:"è—", mean:35, sd:3, air:92, org:70, img:85, color:"#000095"}],
        "Kaohsiung": [{name:"ç¶ ç‡Ÿäº”è™å°‡", party:"ç¶ ", mean:43, sd:3, air:85, org:90, img:85, color:"#1b9431"}, {name:"æŸ¯å¿—æ©", party:"è—", mean:41, sd:3, air:85, org:85, img:90, color:"#000095"}]
    },
    east: {
        "Hualien": [{name:"è—ç‡Ÿå€™é¸äºº", party:"è—", mean:60, sd:5, air:60, org:95, img:80, color:"#000095"}, {name:"ç¶ ç‡ŸæŒ‘æˆ°è€…", party:"ç¶ ", mean:25, sd:4, air:70, org:60, img:70, color:"#1b9431"}]
    }
};

let currentCityCands = [];
let charts = {};
let eventBonus = [];

// --- 2. æ ¸å¿ƒæ§åˆ¶å‡½æ•¸ ---
function updateCityList() {
    const region = document.getElementById('regionSelect').value;
    const citySelect = document.getElementById('citySelect');
    citySelect.innerHTML = Object.keys(allCityData[region]).map(c => `<option value="${c}">${c}</option>`).join('');
    loadCityData();
}

function loadCityData() {
    const region = document.getElementById('regionSelect').value;
    const cityName = document.getElementById('citySelect').value;
    currentCityCands = JSON.parse(JSON.stringify(allCityData[region][cityName]));
    eventBonus = new Array(currentCityCands.length).fill(0);
    startFullSimulation();
}

// Box-Muller æ­£æ…‹åˆ†ä½ˆéš¨æ©Ÿæ•¸
function randn() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function startFullSimulation() {
    // 1. è’™ç‰¹å¡æ´›æ¨¡æ“¬ (10,000æ¬¡)
    const stats = runMonteCarlo();
    // 2. æ™‚é–“è»¸é æ¸¬ (320å¤©)
    runTimeSeries();
    // 3. æ›´æ–°æ‰€æœ‰åœ–è¡¨èˆ‡è¡¨æ ¼
    updateUI(stats);
}

function runMonteCarlo() {
    const iterations = 10000;
    let results = currentCityCands.map(c => ({...c, wins:0, totalScore:0, maxScore:0}));
    
    for(let i=0; i<iterations; i++) {
        let scores = results.map((c, idx) => {
            let score = (c.mean + eventBonus[idx]) + (randn() * c.sd);
            return { idx, score };
        });
        
        // æ¨¡æ“¬æ£„ä¿æ•ˆæ‡‰ï¼šè‹¥ç¬¬ä¸‰åä½æ–¼é–€æª»ä¸”ç‚ºä¸‰è…³ç£
        if(scores.length === 3) {
            scores.sort((a,b) => b.score - a.score);
            if(scores[2].score < 12) {
                let leakage = scores[2].score * 0.3; // 30%é¸ç¥¨ä½ç§»
                scores[2].score -= leakage;
                scores[0].score += leakage; // å‡è¨­æµå‘ç¬¬ä¸€å
            }
        }

        let winner = scores.reduce((prev, curr) => (curr.score > prev.score) ? curr : prev);
        results[winner.idx].wins++;
        results.forEach((r, idx) => {
            let s = scores.find(x => x.idx === idx).score;
            r.totalScore += s;
            if(s > r.maxScore) r.maxScore = s;
        });
    }
    return results;
}

function runTimeSeries() {
    const days = 320;
    const datasets = currentCityCands.map((c, idx) => {
        let data = [];
        let cur = c.mean + eventBonus[idx];
        for(let d=0; d<days; d++) {
            cur += (randn() * (c.sd/10)) + (d > 280 ? (c.org/1000) : 0);
            data.push(cur.toFixed(2));
        }
        return { label: c.name, data: data, borderColor: c.color, pointRadius:0, fill:false };
    });

    if(charts.time) charts.time.destroy();
    charts.time = new Chart(document.getElementById('timeLineChart'), {
        type: 'line',
        data: { labels: new Array(days).fill(''), datasets: datasets },
        options: { responsive: true, scales: { y: { beginAtZero: false } } }
    });
}

function triggerEvent() {
    const evs = [
        {txt: "ğŸš¨ çˆ†ç™¼é‡å¤§çˆ­è­°äº‹ä»¶ï¼é ˜å…ˆè€…å—å‚·ã€‚", val: -5, target: "leader"},
        {txt: "ğŸŠ æˆåŠŸå¤§é€ å‹¢ï¼Œçµ„ç¹”ç¥¨å…¨é¢å‹•å“¡ï¼", val: 4, target: "random"},
        {txt: "ğŸŒ¦ï¸ æŠ•ç¥¨æ—¥æ°£å€™é æ¸¬ä¸ä½³ï¼Œå½±éŸ¿æŠ•ç¥¨ç‡ã€‚", val: -2, target: "all"}
    ];
    const e = evs[Math.floor(Math.random() * evs.length)];
    document.getElementById('eventBox').innerText = e.txt;
    
    if(e.target === "leader") eventBonus[0] += e.val;
    else if(e.target === "all") eventBonus = eventBonus.map(v => v + e.val);
    else eventBonus[Math.floor(Math.random()*eventBonus.length)] += e.val;

    startFullSimulation();
}

function updateUI(stats) {
    // åœ“é¤…åœ–
    if(charts.win) charts.win.destroy();
    charts.win = new Chart(document.getElementById('winChart'), {
        type: 'doughnut',
        data: { labels: stats.map(s => s.name), datasets: [{ data: stats.map(s => s.wins), backgroundColor: stats.map(s => s.color) }] }
    });

    // é›·é”åœ–
    if(charts.radar) charts.radar.destroy();
    charts.radar = new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: ['ç©ºæˆ°','çµ„ç¹”','å½¢è±¡'],
            datasets: stats.map(s => ({ label: s.name, data:[s.air, s.org, s.img], borderColor: s.color, backgroundColor: s.color+'33' }))
        }
    });

    // è¡¨æ ¼
    const tbody = document.querySelector('#resultTable tbody');
    tbody.innerHTML = stats.sort((a,b) => b.wins - a.wins).map(s => `
        <tr>
            <td><strong>${s.name}</strong></td>
            <td>${s.party}</td>
            <td>${(s.totalScore/10000).toFixed(2)}%</td>
            <td>${s.maxScore.toFixed(2)}%</td>
            <td><span class="win-tag">${(s.wins/100).toFixed(1)}%</span></td>
        </tr>
    `).join('');
}

// åˆå§‹åŒ–
window.onload = updateCityList;
</script>
</body>
</html>