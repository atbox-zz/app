<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="免費八字命盤生成工具，提供精確節氣計算與五行精紀分析，生成個人化四柱、大運與流年報告。">
  <meta name="keywords" content="八字, 命盤, 大運, 流年, 十神, 節氣計算, 五行精紀">
  <meta property="og:title" content="八字命盤生成器">
  <meta property="og:description" content="生成個人化八字命盤，包含四柱、大運、流年和五行精紀分析。">
  <meta property="og:type" content="website">
  <title>八字大運與流年 - 精確節氣計算 + 五行精紀分析</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#fbf7ec;--panel:#fffaf0;--card:#fffdf6;--accent:#cfa85a;--muted:#8a6b2f;--line:#e6d6a9;--ok:#d7f7d7;--bad:#f7d7d7;--mid:#efefef;--text:#222;--shadow:0 12px 30px rgba(0,0,0,0.06)}
    html,body{height:100%;margin:0;background:var(--bg);font-family:'Noto Sans TC',system-ui,-apple-system,'Segoe UI',Roboto,Arial;color:var(--text)}
    .wrap{max-width:1200px;margin:18px auto;padding:18px;background:linear-gradient(180deg,var(--card),#ffffff);border-radius:12px;box-shadow:var(--shadow)}
    h1{margin:0 0 12px;font-size:20px;text-align:center}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:end;margin-bottom:12px}
    .col{flex:1;min-width:160px}
    label{display:block;font-size:13px;color:#444;margin-bottom:6px}
    input[type="text"], input[type="datetime-local"], select {width:80%;padding:10px;border:1px solid var(--line);border-radius:8px;background:white;font-size:14px;box-sizing:border-box}
    button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:white;font-weight:700;cursor:pointer}
    button.secondary{background:#8a6b2f}
    .board{display:none;margin-top:12px;background:var(--panel);padding:14px;border-radius:12px;border:1px solid var(--line)}
    .toprow{display:flex;gap:12px;align-items:stretch}
    .pillars{flex:1;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .pillar{background:linear-gradient(180deg,#fff,#fff8e6);border:2px solid rgba(210,170,90,0.18);border-radius:10px;padding:18px;text-align:center;display:flex;flex-direction:column;justify-content:center;min-height:160px;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .pillar .label{font-size:13px;color:#6b4f2a}
    .pillar .ten{font-size:13px;color:var(--muted);margin-top:6px}
    .pillar .gz{font-size:46px;font-weight:900;letter-spacing:8px;margin-top:6px;color:#2b2b1b}
    .pillar .hidden{font-size:13px;color:#4b3a1a;margin-top:8px}
    .info{width:320px;background:white;border:1px solid var(--line);border-radius:10px;padding:14px}
    .info h3{margin:0 0 8px;font-size:15px}
    .info pre{margin:0;font-size:13px;white-space:pre-wrap}
    .meta{display:flex;gap:12px;margin-top:12px}
    .card{flex:1;background:white;padding:12px;border-radius:10px;border:1px solid var(--line)}
    .card strong{display:block;margin-bottom:8px}
    .area{display:flex;gap:12px;margin-top:12px;align-items:flex-start}
    .panel{flex:1;background:white;padding:12px;border-radius:10px;border:1px solid var(--line)}
    .panel h4{margin:0 0 8px;font-size:15px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px;font-size:13px;text-align:center}
    th{background:#fff6e6}
    #dayunTable tbody tr{cursor:pointer;transition:background-color 0.2s ease}
    #dayunTable tbody tr:hover{background-color:#fff8e6}
    .biggz{font-weight:900;font-size:16px;color:#3b2b1a}
    .ok{background:var(--ok)}
    .bad{background:var(--bad)}
    .mid{background:var(--mid)}
    .small{font-size:12px}
    .footer{font-size:12px;color:#666;text-align:right;margin-top:12px}
    .switches{display:flex;gap:8px;align-items:center;margin-top:8px}
    .highlight{background-color:#fff3cd;font-weight:bold}
    .stats-area{display:flex;gap:12px;margin-top:12px;align-items:flex-start}
    .stats-panel{flex:1;background:white;padding:12px;border-radius:10px;border:1px solid var(--line)}
    .stats-panel h4{margin:0 0 12px;font-size:15px;color:#2b2b1a}
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .stat-category{background:#fafafa;padding:10px;border-radius:8px;border:1px solid #e6d6a9}
    .stat-category h5{margin:0 0 8px;font-size:14px;color:#6b4f2a}
    .stat-item{display:flex;justify-content:space-between;align-items:center;margin:4px 0;font-size:13px}
    .stat-value{font-weight:bold;color:#2b2b1a}
    .strength-meter{width:60px;height:8px;background:#e6d6a9;border-radius:4px;overflow:hidden;margin-left:8px}
    .strength-fill{height:100%;transition:width 0.3s ease;border-radius:4px}
    .strength-weak{background:#f7d7d7}
    .strength-mid{background:#efefef}
    .strength-strong{background:#d7f7d7}
    .strength-very-strong{background:#b8e6b8}
    .overall-strength{margin-top:12px;padding:12px;background:linear-gradient(135deg,#fff6e6,#fff);border:2px solid rgba(207,168,90,0.3);border-radius:10px;text-align:center}
    .overall-strength h5{margin:0 0 8px;font-size:16px;color:#6b4f2a}
    .strength-score{font-size:24px;font-weight:900;margin:8px 0}
    .strength-description{font-size:13px;color:#666;line-height:1.4}
    @media (max-width:980px){.pillars{grid-template-columns:repeat(2,1fr)}.info{width:100%}.toprow{flex-direction:column}.area{flex-direction:column}.stats-area{flex-direction:column}.stats-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>八字命盤 — 節氣起運計算 + 五行精紀分析</h1>
    <div class="controls">
      <div class="col" style="flex:0 0 160px"><label for="name">姓名</label><input id="name" type="text" aria-required="false" value="寒露" maxlength="8" placeholder="最多8個字"></div>
      <div class="col" style="flex:0 0 80px"><label for="gender">性別</label><select id="gender"><option value="男">男</option><option value="女">女</option></select></div>
      <div class="col" style="flex:1"><label for="birth">出生（公曆）</label><input id="birth" type="datetime-local" value="1968-10-30T18:30"></div>
      <div class="col" style="flex:0 0 120px"><label for="lang">語言</label><select id="lang" aria-label="選擇語言"><option value="zh-TW">正體中文</option><option value="zh-CN">簡體中文</option><option value="en">English</option></select></div>
      <button id="genBtn" aria-label="生成八字命盤">生成命盤</button>
      <button id="downloadBtn" class="secondary">下載 PNG</button>
      <button id="showFullBtn">顯示完整人生（到100歲）</button>
    </div>
    <div class="board" id="board">
      <div class="toprow">
        <div class="pillars" id="pillars">
          <div class="pillar"><div class="label">年柱</div><div class="ten" id="ten_year">—</div><div class="gz" id="gz_year">—</div><div class="hidden" id="hid_year">藏干：—</div></div>
          <div class="pillar"><div class="label">月柱</div><div class="ten" id="ten_month">—</div><div class="gz" id="gz_month">—</div><div class="hidden" id="hid_month">藏干：—</div></div>
          <div class="pillar"><div class="label">日柱</div><div class="ten" id="ten_day">日主</div><div class="gz" id="gz_day">—</div><div class="hidden" id="hid_day">藏干：—</div></div>
          <div class="pillar"><div class="label">時柱</div><div class="ten" id="ten_time">—</div><div class="gz" id="gz_time">—</div><div class="hidden" id="hid_time">藏干：—</div></div>
        </div>
        <div class="info">
          <h3>基本資訊</h3>
          <pre id="basic">—</pre>
          <div style="height:8px"></div>
          <h3>補充資訊</h3>
          <pre id="extras">—</pre>
        </div>
      </div>
      <div class="meta">
        <div class="card"><strong>五行統計 & 日主</strong><pre id="wx">—</pre><canvas id="fiveChart" height="150"></canvas></div>
        <div class="card"><strong>五行精紀分析</strong><pre id="tenLegend">—</pre></div>
      </div>
      <div class="area">
        <div class="panel"><h4>大運（節氣計算）</h4>
          <table id="dayunTable" role="grid" aria-label="大運表格">
            <thead><tr><th>序</th><th>起運年齡</th><th>干支</th><th>天干十神</th><th>地支十神</th><th>起運年</th><th>止運年</th><th>順逆</th></tr></thead>
            <tbody></tbody>
          </table>
          <canvas id="dayunChart" height="200"></canvas>
        </div>
        <div class="panel"><h4>流年（僅顯示「當前大運」的 10 年）</h4>
          <table id="liunianTable">
            <thead><tr><th>西元</th><th>干支</th><th>年齡</th><th>十神</th><th>吉凶</th></tr></thead>
            <tbody></tbody>
          </table>
          <canvas id="liunianChart" height="200"></canvas>
        </div>
      </div>
      <div class="stats-area">
        <div class="stats-panel">
          <h4>大運十神強弱統計（當前人生階段）</h4>
          <div class="stats-grid">
            <div class="stat-category"><h5>天干十神統計</h5><div id="tianganStats"></div></div>
            <div class="stat-category"><h5>地支十神統計</h5><div id="dizhiStats"></div></div>
          </div>
          <div class="overall-strength">
            <h5>整體十神強弱等級評估</h5>
            <div class="strength-score" id="overallScore">—</div>
            <div class="strength-description" id="strengthDesc">請先生成命盤以查看詳細分析</div>
          </div>
        </div>
      </div>
      <div class="footer">資料來源：lunar-javascript（CDN）· 節氣起運算法 + 五行精紀分析</div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.7.3/lunar.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/i18next@23.11.5/dist/umd/i18next.min.js"></script>
  <script>
    // 輔助函數：安全設置 textContent
    function setTextContent(id, content) {
      const element = document.getElementById(id);
      if (element) {
        element.textContent = content || '—';
      } else {
        console.warn(`Element with ID "${id}" not found.`);
      }
    }

    // 輔助函數：安全設置 innerHTML
    function setInnerHTML(id, html) {
      const element = document.getElementById(id);
      if (element) {
        element.innerHTML = html;
      } else {
        console.warn(`Element with ID "${id}" not found.`);
      }
    }

    // 多語言初始化
    document.addEventListener('DOMContentLoaded', () => {
      i18next.init({
        lng: 'zh-TW',
        resources: {
          'zh-TW': {
            translation: {
              title: '八字命盤 — 節氣起運計算 + 五行精紀分析',
              basic: '基本資訊',
              extras: '補充資訊',
              wx: '五行統計 & 日主',
              dayun: '大運（節氣計算）',
              liunian: '流年（僅顯示「當前大運」的 10 年）',
              stats: '大運十神強弱統計（當前人生階段）',
              generate: '生成命盤',
              download: '下載 PNG',
              fullLife: '顯示完整人生（到100歲）',
              tenLegend: '五行精紀分析'
            }
          },
          'zh-CN': {
            translation: {
              title: '八字命盘 — 节气起运计算 + 五行精纪分析',
              basic: '基本信息',
              extras: '补充信息',
              wx: '五行统计 & 日主',
              dayun: '大运（节气计算）',
              liunian: '流年（仅显示“当前大运”的 10 年）',
              stats: '大运十神强弱统计（当前人生阶段）',
              generate: '生成命盘',
              download: '下载 PNG',
              fullLife: '显示完整人生（到100岁）',
              tenLegend: '五行精纪分析'
            }
          },
          'en': {
            translation: {
              title: 'BaZi Chart — Solar Term Calculation + Five Elements Analysis',
              basic: 'Basic Info',
              extras: 'Additional Info',
              wx: 'Five Elements & Day Master',
              dayun: 'Luck Cycles (Solar Term Calculation)',
              liunian: 'Annual Influences (Current Luck Cycle 10 Years)',
              stats: 'Luck Cycle Ten Gods Strength Analysis (Current Life Stage)',
              generate: 'Generate Chart',
              download: 'Download PNG',
              fullLife: 'Show Full Life (to 100 Years)',
              tenLegend: 'Five Elements Analysis'
            }
          }
        }
      }).then(() => updateLanguage());
    });

    function updateLanguage() {
      const h1 = document.querySelector('h1');
      if (h1) h1.textContent = i18next.t('title');
      const basicH3 = document.querySelector('.info h3:first-child');
      if (basicH3) basicH3.textContent = i18next.t('basic');
      const extrasH3 = document.querySelector('.info h3:nth-child(3)');
      if (extrasH3) extrasH3.textContent = i18next.t('extras');
      const wxStrong = document.querySelector('.meta .card strong:first-child');
      if (wxStrong) wxStrong.textContent = i18next.t('wx');
      const tenLegendStrong = document.querySelector('.meta .card:nth-child(2) strong');
      if (tenLegendStrong) tenLegendStrong.textContent = i18next.t('tenLegend');
      const dayunH4 = document.querySelector('.area .panel h4:first-child');
      if (dayunH4) dayunH4.textContent = i18next.t('dayun');
      const liunianH4 = document.querySelector('.area .panel:nth-child(2) h4');
      if (liunianH4) liunianH4.textContent = i18next.t('liunian');
      const statsH4 = document.querySelector('.stats-panel h4');
      if (statsH4) statsH4.textContent = i18next.t('stats');
      setTextContent('genBtn', i18next.t('generate'));
      setTextContent('downloadBtn', i18next.t('download'));
      setTextContent('showFullBtn', i18next.t('fullLife'));
    }

    // 常數定義
    const stems = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
    const branches = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
    const hiddenMap = {
      '子': '癸', '丑': '己辛癸', '寅': '甲丙戊', '卯': '乙', '辰': '戊乙癸', '巳': '丙戊庚',
      '午': '丁己', '未': '己丁乙', '申': '庚壬戊', '酉': '辛', '戌': '戊辛丁', '亥': '壬甲'
    };
    const xunkongByDayStem = {
      '甲': ['戌', '亥'], '乙': ['戌', '亥'], '丙': ['午', '未'], '丁': ['午', '未'], '戊': ['寅', '卯'],
      '己': ['寅', '卯'], '庚': ['子', '丑'], '辛': ['子', '丑'], '壬': ['辰', '巳'], '癸': ['辰', '巳']
    };
    const tenGodMap = (function() {
      const m = {
        '甲': ['比肩', '劫財', '食神', '傷官', '偏財', '正財', '七殺', '正官', '偏印', '正印'],
        '乙': ['劫財', '比肩', '傷官', '食神', '正財', '偏財', '正官', '七殺', '正印', '偏印'],
        '丙': ['偏印', '正印', '比肩', '劫財', '食神', '傷官', '偏財', '正財', '七殺', '正官'],
        '丁': ['正印', '偏印', '劫財', '比肩', '傷官', '食神', '正財', '偏財', '正官', '七殺'],
        '戊': ['七殺', '正官', '偏印', '正印', '比肩', '劫財', '食神', '傷官', '偏財', '正財'],
        '己': ['正官', '七殺', '正印', '偏印', '劫財', '比肩', '傷官', '食神', '正財', '偏財'],
        '庚': ['偏財', '正財', '七殺', '正官', '偏印', '正印', '比肩', '劫財', '食神', '傷官'],
        '辛': ['正財', '偏財', '正官', '七殺', '正印', '偏印', '劫財', '比肩', '傷官', '食神'],
        '壬': ['傷官', '食神', '偏財', '正財', '七殺', '正官', '偏印', '正印', '比肩', '劫財'],
        '癸': ['食神', '傷官', '正財', '偏財', '正官', '七殺', '正印', '偏印', '劫財', '比肩']
      };
      const o = {};
      Object.keys(m).forEach(k => {
        o[k] = {};
        for (let i = 0; i < 10; i++) o[k][stems[i]] = m[k][i];
      });
      return o;
    })();
    const branchToStemMap = {
      '子': '癸', '丑': '己', '寅': '甲', '卯': '乙', '辰': '戊', '巳': '丙',
      '午': '丁', '未': '己', '申': '庚', '酉': '辛', '戌': '戊', '亥': '壬'
    };
    const tenLuck = {
      '正印': '吉', '偏印': '中', '比肩': '中', '劫財': '中', '食神': '吉', '傷官': '凶',
      '正財': '吉', '偏財': '吉', '正官': '吉', '七殺': '凶'
    };
    const tenGodStrength = {
      '正印': 85, '偏印': 65, '比肩': 70, '劫財': 60, '食神': 80, 
      '傷官': 45, '正財': 88, '偏財': 75, '正官': 90, '七殺': 35
    };
    const fiveElementMap = {
      '甲': '木', '乙': '木', '丙': '火', '丁': '火', '戊': '土', '己': '土',
      '庚': '金', '辛': '金', '壬': '水', '癸': '水', '子': '水', '丑': '土',
      '寅': '木', '卯': '木', '辰': '土', '巳': '火', '午': '火', '未': '土',
      '申': '金', '酉': '金', '戌': '土', '亥': '水'
    };
    const tianyiMap = {
      '甲': ['丑', '未'], '乙': ['子', '申'], '丙': ['亥', '酉'], '丁': ['亥', '酉'],
      '戊': ['丑', '未'], '己': ['子', '申'], '庚': ['巳', '卯'], '辛': ['巳', '卯'],
      '壬': ['辰', '寅'], '癸': ['辰', '寅']
    };
    const luMap = {
      '甲': '寅', '乙': '卯', '丙': '巳', '丁': '午', '戊': '巳', '己': '午',
      '庚': '申', '辛': '酉', '壬': '亥', '癸': '子'
    };
    const horseMap = {
      '寅': '申', '卯': '酉', '辰': '戌', '巳': '亥', '午': '子', '未': '丑',
      '申': '寅', '酉': '卯', '戌': '辰', '亥': '巳', '子': '午', '丑': '未'
    };
    const wenChangMap = {
      '甲': '巳', '乙': '午', '丙': '申', '丁': '酉', '戊': '申', '己': '酉',
      '庚': '亥', '辛': '子', '壬': '寅', '癸': '卯'
    };
    const sheepBladeMap = {
      '甲': '卯', '乙': '寅', '丙': '午', '丁': '巳', '戊': '午', '己': '巳',
      '庚': '酉', '辛': '申', '壬': '子', '癸': '亥'
    };

    // 計算函數
    function westernZodiac(m, d) {
      const table = [
        { name: '摩羯', start: [12, 22] }, { name: '水瓶', start: [1, 20] }, { name: '雙魚', start: [2, 19] },
        { name: '牡羊', start: [3, 21] }, { name: '金牛', start: [4, 21] }, { name: '雙子', start: [5, 21] },
        { name: '巨蟹', start: [6, 22] }, { name: '獅子', start: [7, 23] }, { name: '處女', start: [8, 23] },
        { name: '天秤', start: [9, 23] }, { name: '天蠍', start: [10, 24] }, { name: '射手', start: [11, 23] }
      ];
      for (let i = 0; i < table.length; i++) {
        const [mm, dd] = table[i].start;
        if ((m === mm && d >= dd) || (m === ((mm % 12) + 1) && d < table[(i + 1) % 12].start[1])) return table[i].name;
      }
      return '';
    }

    function shiftArr(arr, item, step) {
      const idx = arr.indexOf(item);
      if (idx === -1) return '';
      return arr[(idx + step + arr.length) % arr.length];
    }

    function getTenGod(dayStem, otherStem) {
      if (!dayStem || !otherStem) return '';
      return (tenGodMap[dayStem] && tenGodMap[dayStem][otherStem]) || '';
    }

    function s(x) { return x == null ? '' : String(x); }

    // 節氣快取
    const jieQiCache = {};
    function getJieQiForYear(year) {
      if (jieQiCache[year]) return jieQiCache[year];
      try {
        const solar = Solar.fromYmd(year, 6, 15);
        const lunar = solar.getLunar();
        const jieQiTable = lunar.getJieQiTable();
        const jieQiList = Object.entries(jieQiTable)
          .filter(([_, jq]) => jq.getYear() === year)
          .map(([name, jq]) => ({
            name,
            date: new Date(jq.getYear(), jq.getMonth() - 1, jq.getDay(), jq.getHour(), jq.getMinute()),
            solar: jq
          }))
          .sort((a, b) => a.date - b.date);
        jieQiCache[year] = jieQiList;
        return jieQiList;
      } catch (e) {
        console.error(`獲取 ${year} 年節氣失敗:`, e);
        return [];
      }
    }

    function calculatePreciseStartAge(birthDate, yearStem, gender) {
      const birthYear = birthDate.getFullYear();
      const isMale = (gender === '男');
      const yangStems = ['甲', '丙', '戊', '庚', '壬'];
      const isYearStemYang = yangStems.includes(yearStem);
      const isForward = (isMale && isYearStemYang) || (!isMale && !isYearStemYang);
      const jieQiThisYear = getJieQiForYear(birthYear);
      const jieQiNextYear = getJieQiForYear(birthYear + 1);
      const jieQiPrevYear = getJieQiForYear(birthYear - 1);
      const allJieQi = [...jieQiPrevYear, ...jieQiThisYear, ...jieQiNextYear].sort((a, b) => a.date - b.date);
      let targetJieQi = null;
      let distanceDays = 0;
      let calculationDetail = '';
      if (isForward) {
        targetJieQi = allJieQi.find(jq => jq.date > birthDate);
        if (targetJieQi) {
          distanceDays = Math.ceil((targetJieQi.date - birthDate) / (1000 * 60 * 60 * 24));
          calculationDetail = `順行：從生日 ${birthDate.toLocaleDateString()} ${birthDate.toLocaleTimeString()} 到下個節氣 ${targetJieQi.name} ${targetJieQi.date.toLocaleDateString()} ${targetJieQi.date.toLocaleTimeString()}`;
        }
      } else {
        const reversedJieQi = [...allJieQi].reverse();
        targetJieQi = reversedJieQi.find(jq => jq.date < birthDate);
        if (targetJieQi) {
          distanceDays = Math.ceil((birthDate - targetJieQi.date) / (1000 * 60 * 60 * 24));
          calculationDetail = `逆行：從上個節氣 ${targetJieQi.name} ${targetJieQi.date.toLocaleDateString()} ${targetJieQi.date.toLocaleTimeString()} 到生日 ${birthDate.toLocaleDateString()} ${birthDate.toLocaleTimeString()}`;
        }
      }
      let startAge = 0;
      if (distanceDays > 0) {
        startAge = Math.max(1, Math.ceil(distanceDays / 3));
      }
      const ageCalculation = `距離 ${distanceDays} 天，${distanceDays} ÷ 3 = ${(distanceDays / 3).toFixed(2)} → 起運 ${startAge} 歲`;
      console.log('=== 精確起運計算 ===');
      console.log(`年干：${yearStem} ${yangStems.includes(yearStem) ? '(陽)' : '(陰)'}，${gender}命`);
      console.log(`大運方向：${isForward ? '順行' : '逆行'} (${isForward ? '陽男陰女順行' : '陰男陽女逆行'})`);
      console.log(`節氣計算詳情：`);
      console.log(calculationDetail);
      console.log(`目標節氣：${targetJieQi ? targetJieQi.name : '未找到'}`);
      if (targetJieQi && targetJieQi.date) {
        console.log(`節氣日期：${targetJieQi.date.toLocaleDateString()}`);
      }
      console.log(`起運年齡：${startAge} 歲`);
      return {
        startAge,
        isForward,
        targetJieQi: targetJieQi ? targetJieQi.name : '未找到',
        targetDate: targetJieQi ? targetJieQi.date : null,
        distanceDays,
        calculationDetail: calculationDetail + '\n' + ageCalculation
      };
    }

    function calculateDayunPrecise(lunar, gender, birthYear, birthDate, yearGz, monthGz) {
      const yearStem = s(yearGz)[0] || '';
      const monthStem = s(monthGz)[0] || '';
      const monthBranch = s(monthGz)[1] || '';
      const startInfo = calculatePreciseStartAge(birthDate, yearStem, gender);
      const { startAge, isForward } = startInfo;
      const dayunList = [];
      let currentStemIndex = stems.indexOf(monthStem);
      let currentBranchIndex = branches.indexOf(monthBranch);
      if (isForward) {
        currentStemIndex = (currentStemIndex + 1) % 10;
        currentBranchIndex = (currentBranchIndex + 1) % 12;
      } else {
        currentStemIndex = (currentStemIndex - 1 + 10) % 10;
        currentBranchIndex = (currentBranchIndex - 1 + 12) % 12;
      }
      for (let i = 0; i < 10; i++) {
        const age = startAge + i * 10;
        const startYear = birthYear + age;
        const gz = stems[currentStemIndex] + branches[currentBranchIndex];
        dayunList.push({
          index: i + 1,
          startAge: age,
          startYear: startYear,
          endYear: startYear + 9,
          gz: gz,
          tianganStem: stems[currentStemIndex],
          dizhiBranch: branches[currentBranchIndex],
          startDate: new Date(startYear, 0, 1),
          direction: isForward ? '順行' : '逆行'
        });
        if (isForward) {
          currentStemIndex = (currentStemIndex + 1) % 10;
          currentBranchIndex = (currentBranchIndex + 1) % 12;
        } else {
          currentStemIndex = (currentStemIndex - 1 + 10) % 10;
          currentBranchIndex = (currentBranchIndex - 1 + 12) % 12;
        }
      }
      return { dayunList, isForward, startInfo };
    }

    function calculateTenGodStats(dayunList, dayStem, currentAge, specificDayunIndex = null) {
      const tianganStats = {};
      const dizhiStats = {};
      let totalStrength = 0;
      let validCount = 0;
      let relevantDayun = specificDayunIndex !== null ? [dayunList[specificDayunIndex]] : dayunList.filter(d => d.startAge <= currentAge + 40 && d.startAge + 9 >= currentAge);
      relevantDayun.forEach(dayun => {
        if (dayun.tianganStem && dayun.dizhiBranch) {
          const tianganTenGod = getTenGod(dayStem, dayun.tianganStem);
          if (tianganTenGod) {
            tianganStats[tianganTenGod] = (tianganStats[tianganTenGod] || 0) + 1;
            totalStrength += tenGodStrength[tianganTenGod] || 50;
            validCount++;
          }
          const dizhiStem = branchToStemMap[dayun.dizhiBranch];
          if (dizhiStem) {
            const dizhiTenGod = getTenGod(dayStem, dizhiStem);
            if (dizhiTenGod) {
              dizhiStats[dizhiTenGod] = (dizhiStats[dizhiTenGod] || 0) + 1;
              totalStrength += (tenGodStrength[dizhiTenGod] || 50) * 0.7;
              validCount++;
            }
          }
        }
      });
      const avgStrength = validCount > 0 ? totalStrength / validCount : 50;
      return {
        tianganStats,
        dizhiStats,
        avgStrength,
        relevantCount: relevantDayun.length,
        isSpecificDayun: specificDayunIndex !== null,
        dayunInfo: specificDayunIndex !== null ? dayunList[specificDayunIndex] : null
      };
    }

    function calculateFiveElements(yearGz, monthGz, dayGz, timeGz) {
      const five = { 金: 0, 木: 0, 水: 0, 火: 0, 土: 0 };
      [yearGz, monthGz, dayGz, timeGz].forEach(gz => {
        if (gz) {
          five[fiveElementMap[gz[0]]] = (five[fiveElementMap[gz[0]]] || 0) + 1;
          five[fiveElementMap[gz[1]]] = (five[fiveElementMap[gz[1]]] || 0) + 1;
          const hidden = hiddenMap[gz[1]] || '';
          hidden.split('').forEach(h => {
            five[fiveElementMap[h]] = (five[fiveElementMap[h]] || 0) + 0.5;
          });
        }
      });
      return `金 ${five['金'].toFixed(1)}  木 ${five['木'].toFixed(1)}  水 ${five['水'].toFixed(1)}  火 ${five['火'].toFixed(1)}  土 ${five['土'].toFixed(1)}`;
    }

    function calculateShenSha(dayStem, yearBranch, monthBranch, dayBranch, timeBranch) {
      const shenSha = [];
      if (tianyiMap[dayStem].includes(yearBranch) || tianyiMap[dayStem].includes(monthBranch) ||
          tianyiMap[dayStem].includes(dayBranch) || tianyiMap[dayStem].includes(timeBranch)) {
        shenSha.push(`天乙貴人（${tianyiMap[dayStem].join('、')}）`);
      }
      if (luMap[dayStem] === yearBranch || luMap[dayStem] === monthBranch ||
          luMap[dayStem] === dayBranch || luMap[dayStem] === timeBranch) {
        shenSha.push(`祿（${luMap[dayStem]}）`);
      }
      if (horseMap[dayBranch] === yearBranch || horseMap[dayBranch] === monthBranch ||
          horseMap[dayBranch] === timeBranch) {
        shenSha.push(`驛馬（${horseMap[dayBranch]}）`);
      }
      if (wenChangMap[dayStem] === yearBranch || wenChangMap[dayStem] === monthBranch ||
          wenChangMap[dayStem] === dayBranch || wenChangMap[dayStem] === timeBranch) {
        shenSha.push(`文昌貴人（${wenChangMap[dayStem]}）`);
      }
      const yinShou = getTenGod(dayStem, yearGz[0]) === '正印' || getTenGod(dayStem, monthGz[0]) === '正印' ||
                      getTenGod(dayStem, timeGz[0]) === '正印';
      if (yinShou) shenSha.push('印绶');
      const shiShen = getTenGod(dayStem, yearGz[0]) === '食神' || getTenGod(dayStem, monthGz[0]) === '食神' ||
                      getTenGod(dayStem, timeGz[0]) === '食神';
      if (shiShen) shenSha.push('食神');
      const caiShen = getTenGod(dayStem, yearGz[0]) === '正財' || getTenGod(dayStem, monthGz[0]) === '正財' ||
                      getTenGod(dayStem, timeGz[0]) === '正財' ||
                      getTenGod(dayStem, yearGz[0]) === '偏財' || getTenGod(dayStem, monthGz[0]) === '偏財' ||
                      getTenGod(dayStem, timeGz[0]) === '偏財';
      if (caiShen) shenSha.push('財神');
      return shenSha.length > 0 ? shenSha.join('、') : '無';
    }

    function calculateDayGe(dayStem, monthBranch, fiveElements) {
      const monthToGe = {
        '寅': { '甲': '正格', '丙': '正官', '戊': '正財', '庚': '食神', '壬': '傷官' },
        '卯': { '乙': '正格', '丁': '正官', '己': '正財', '辛': '食神', '癸': '傷官' },
        '辰': { '戊': '正格', '庚': '正官', '壬': '正財', '甲': '食神', '丙': '傷官' },
        '巳': { '丙': '正格', '戊': '正官', '庚': '正財', '壬': '食神', '甲': '傷官' },
        '午': { '丁': '正格', '己': '正官', '辛': '正財', '癸': '食神', '乙': '傷官' },
        '未': { '己': '正格', '辛': '正官', '癸': '正財', '乙': '食神', '丁': '傷官' },
        '申': { '庚': '正格', '壬': '正官', '甲': '正財', '丙': '食神', '戊': '傷官' },
        '酉': { '辛': '正格', '癸': '正官', '乙': '正財', '丁': '食神', '己': '傷官' },
        '戌': { '戊': '正格', '庚': '正官', '壬': '正財', '甲': '食神', '丙': '傷官' },
        '亥': { '壬': '正格', '甲': '正官', '丙': '正財', '戊': '食神', '庚': '傷官' },
        '子': { '癸': '正格', '乙': '正官', '丁': '正財', '己': '食神', '辛': '傷官' },
        '丑': { '己': '正格', '辛': '正官', '癸': '正財', '乙': '食神', '丁': '傷官' }
      };
      const five = fiveElements.split(' ').reduce((acc, curr) => {
        const [element, value] = curr.split(' ');
        acc[element] = parseFloat(value);
        return acc;
      }, {});
      if (five[dayStem === '甲' || dayStem === '乙' ? '木' : dayStem === '丙' || dayStem === '丁' ? '火' :
               dayStem === '戊' || dayStem === '己' ? '土' : dayStem === '庚' || dayStem === '辛' ? '金' : '水'] >= 4) {
        return '專旺格';
      }
      return monthToGe[monthBranch]?.[dayStem] || '正格';
    }

    function calculateGuiXiongGe(dayStem, dayBranch, timeBranch) {
      const guiGe = [];
      const xiongGe = [];
      if (wenChangMap[dayStem] === dayBranch || wenChangMap[dayStem] === timeBranch) {
        guiGe.push('文昌貴人');
      }
      if (sheepBladeMap[dayStem] === dayBranch) {
        xiongGe.push('羊刃');
      }
      return {
        gui: guiGe.length > 0 ? guiGe.join('、') : '無',
        xiong: xiongGe.length > 0 ? xiongGe.join('、') : '無'
      };
    }

    function renderDayunKChart(dayunList, dayStem) {
      const labels = dayunList.map(d => `${d.startAge}-${d.startAge + 9}`);
      const data = dayunList.map(d => {
        const tianganTenGod = getTenGod(dayStem, d.tianganStem);
        const dizhiStem = branchToStemMap[d.dizhiBranch];
        const dizhiTenGod = dizhiStem ? getTenGod(dayStem, dizhiStem) : '';
        const open = tianganTenGod ? tenGodStrength[tianganTenGod] || 50 : 50;
        const close = dizhiTenGod ? (tenGodStrength[dizhiTenGod] || 50) * 0.7 : 50;
        const high = Math.max(open, close);
        const low = Math.min(open, close);
        return { x: `${d.startAge}-${d.startAge + 9}`, y: [open, high, low, close] };
      });
      const ctx = document.getElementById('dayunChart');
      if (!ctx) {
        console.warn('Canvas element "dayunChart" not found.');
        return;
      }
      new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '天干十神強度',
            data: data.map(d => d.y[0]),
            borderColor: '#4CAF50',
            fill: false
          }, {
            label: '地支十神強度',
            data: data.map(d => d.y[2]),
            borderColor: '#FF5722',
            fill: false
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: '強度分數' } },
            x: { title: { display: true, text: '年齡區間' } }
          },
          plugins: { title: { display: true, text: '大運十神強度走勢' } }
        }
      });
    }

    function renderLiuNianKChart(startYear, endYear, dayStem, birthYear) {
      const data = [];
      for (let y = startYear; y <= endYear; y++) {
        let yGz = '—';
        try {
          const s = Solar.fromYmd(y, 1, 1);
          yGz = s.getLunar().getYearInGanZhi();
        } catch (e) {}
        const stem = s(yGz)[0] || '';
        const tenGod = getTenGod(dayStem, stem) || '';
        const strength = tenGod ? tenGodStrength[tenGod] || 50 : 50;
        data.push({ x: `${y}`, y: [strength, strength, strength, strength] });
      }
      const ctx = document.getElementById('liunianChart');
      if (!ctx) {
        console.warn('Canvas element "liunianChart" not found.');
        return;
      }
      new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: data.map(d => d.x),
          datasets: [{
            label: '流年十神強度',
            data: data.map(d => d.y[0]),
            borderColor: '#2196F3',
            fill: false
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: '強度分數' } },
            x: { title: { display: true, text: '年份' } }
          },
          plugins: { title: { display: true, text: '流年十神強度走勢' } }
        }
      });
    }

    function renderTenGodStats(tianganStats, dizhiStats, avgStrength, statsResult = null) {
      const statsTitle = document.querySelector('.stats-panel h4');
      if (statsTitle && statsResult && statsResult.isSpecificDayun && statsResult.dayunInfo) {
        const dayun = statsResult.dayunInfo;
        statsTitle.textContent = `大運十神強弱統計（第${dayun.index}步：${dayun.gz} ${dayun.startAge}-${dayun.startAge + 9}歲）`;
      } else if (statsTitle) {
        statsTitle.textContent = i18next.t('stats');
      }
      const allTenGods = ['正印', '偏印', '比肩', '劫財', '食神', '傷官', '正財', '偏財', '正官', '七殺'];
      const fragmentT = document.createDocumentFragment();
      allTenGods.forEach(tenGod => {
        const count = tianganStats[tenGod] || 0;
        const strength = tenGodStrength[tenGod] || 50;
        const item = document.createElement('div');
        item.className = 'stat-item';
        item.innerHTML = `
          <span>${tenGod}</span>
          <div style="display: flex; align-items: center;">
            <span class="stat-value">${count}</span>
            <div class="strength-meter">
              <div class="strength-fill ${getStrengthClass(strength)}" style="width: ${strength}%"></div>
            </div>
          </div>
        `;
        fragmentT.appendChild(item);
      });
      setInnerHTML('tianganStats', '');
      const tianganStatsEl = document.getElementById('tianganStats');
      if (tianganStatsEl) tianganStatsEl.appendChild(fragmentT);
      const fragmentD = document.createDocumentFragment();
      allTenGods.forEach(tenGod => {
        const count = dizhiStats[tenGod] || 0;
        const strength = (tenGodStrength[tenGod] || 50) * 0.7;
        const item = document.createElement('div');
        item.className = 'stat-item';
        item.innerHTML = `
          <span>${tenGod}</span>
          <div style="display: flex; align-items: center;">
            <span class="stat-value">${count}</span>
            <div class="strength-meter">
              <div class="strength-fill ${getStrengthClass(strength)}" style="width: ${strength}%"></div>
            </div>
          </div>
        `;
        fragmentD.appendChild(item);
      });
      setInnerHTML('dizhiStats', '');
      const dizhiStatsEl = document.getElementById('dizhiStats');
      if (dizhiStatsEl) dizhiStatsEl.appendChild(fragmentD);
      updateOverallStrength(avgStrength);
    }

    function getStrengthClass(strength) {
      if (strength >= 85) return 'strength-very-strong';
      if (strength >= 70) return 'strength-strong';
      if (strength >= 50) return 'strength-mid';
      return 'strength-weak';
    }

    function updateOverallStrength(avgStrength) {
      let level, description, color;
      if (avgStrength >= 85) {
        level = '極佳';
        color = '#2d5a2d';
        description = '十神配置極為有利，大運走勢非常理想。事業財運皆有良好發展，人生運勢呈上升趨勢，把握機會可獲得重大成就。';
      } else if (avgStrength >= 70) {
        level = '良好';
        color = '#4a6741';
        description = '十神配置整體良好，大運走勢穩定向上。多數時期運勢平順，有望在事業或財運方面取得不錯的進展。';
      } else if (avgStrength >= 50) {
        level = '平穩';
        color = '#8a6b2f';
        description = '十神配置趨於平衡，大運走勢中等。運勢起伏不大，需要通過努力和智慧來創造機會，穩步前進。';
      } else if (avgStrength >= 35) {
        level = '需謹慎';
        color = '#a0522d';
        description = '十神配置偏弱，大運中有挑戰性階段。需要更加謹慎處事，避免冒險投資，通過踏實努力來度過困難期。';
      } else {
        level = '挑戰較大';
        color = '#8b4513';
        description = '十神配置存在較大挑戰，大運走勢需特別注意。建議保守穩健，避免重大決策，通過學習提升來改善運勢。';
      }
      setTextContent('overallScore', `${level} (${avgStrength.toFixed(0)}分)`);
      const scoreEl = document.getElementById('overallScore');
      if (scoreEl) scoreEl.style.color = color;
      setTextContent('strengthDesc', description);
    }

    function renderLiuNianForDayun(d, dayunIndex, dayStem, birthYear) {
      const liuTbody = document.querySelector('#liunianTable tbody');
      if (!liuTbody) {
        console.warn('Element "#liunianTable tbody" not found.');
        return;
      }
      liuTbody.innerHTML = '';
      const startYear = Number(d.startYear);
      const currentYear = new Date().getFullYear();
      for (let i = 0; i < 10; i++) {
        const y = startYear + i;
        let yGz = '—';
        try {
          const s = Solar.fromYmd(y, 1, 1);
          yGz = s.getLunar().getYearInGanZhi();
        } catch (e) {}
        const stem = s(yGz)[0] || '';
        const ten = dayStem ? getTenGod(dayStem, stem) || '—' : '—';
        const luck = tenLuck[ten] || '中';
        const tr = document.createElement('tr');
        if (y === currentYear) {
          tr.className = (luck === '吉') ? 'ok highlight' : (luck === '凶') ? 'bad highlight' : 'mid highlight';
        } else {
          tr.className = (luck === '吉') ? 'ok' : (luck === '凶') ? 'bad' : 'mid';
        }
        tr.innerHTML = `<td>${y}</td><td>${yGz}</td><td>${(y - birthYear)}</td><td>${ten}</td><td>${luck}</td>`;
        liuTbody.appendChild(tr);
      }
      renderLiuNianKChart(startYear, startYear + 9, dayStem, birthYear);
    }

    // 主邏輯
    document.getElementById('genBtn').addEventListener('click', () => {
      const name = document.getElementById('name').value.trim() || '無名氏';
      const gender = document.getElementById('gender').value;
      const b = document.getElementById('birth').value;
      if (!b) { alert('請輸入出生日期時間（格式：YYYY-MM-DDTHH:MM）'); return; }
      if (!gender) { alert('請選擇性別'); return; }
      const dt = new Date(b);
      if (isNaN(dt.getTime())) { alert('無效的日期格式，請檢查'); return; }
      if (dt > new Date()) { alert('出生日期不能晚於當前時間'); return; }
      if (dt.getFullYear() < 1900) { alert('出生年份過早，僅支援1900年後'); return; }
      
      const board = document.getElementById('board');
      if (board) board.style.display = 'block';
      const solar = Solar.fromDate(dt);
      const lunar = solar.getLunar();
      const birthYear = solar.getYear();
      const yearGz = lunar.getYearInGanZhi();
      const monthGz = lunar.getMonthInGanZhi();
      const dayGz = lunar.getDayInGanZhi();
      const timeGz = lunar.getTimeInGanZhi();
      setTextContent('gz_year', yearGz);
      setTextContent('gz_month', monthGz);
      setTextContent('gz_day', dayGz);
      setTextContent('gz_time', timeGz);
      const dayStem = s(dayGz)[0] || '';
      const dayBranch = s(dayGz)[1] || '';
      const yearBranch = s(yearGz)[1] || '';
      const monthBranch = s(monthGz)[1] || '';
      const timeBranch = s(timeGz)[1] || '';
      function showHidden(gz) {
        if (!gz) return '—';
        const z = gz[1];
        const p = hiddenMap[z] || '';
        return p ? ('藏干：' + p.split('').join(' ')) : '藏干：—';
      }
      setTextContent('hid_year', showHidden(yearGz));
      setTextContent('hid_month', showHidden(monthGz));
      setTextContent('hid_day', showHidden(dayGz));
      setTextContent('hid_time', showHidden(timeGz));
      setTextContent('ten_year', getTenGod(dayStem, s(yearGz)[0]));
      setTextContent('ten_month', getTenGod(dayStem, s(monthGz)[0]));
      setTextContent('ten_day', '日主');
      setTextContent('ten_time', getTenGod(dayStem, s(timeGz)[0]));
      const basic = `姓名：${name}\n性別：${gender}\n公曆：${solar.toFullString()}\n農曆：${lunar.toFullString().split(' ').slice(0, 2).join(' ')}`;
      setTextContent('basic', basic);
      const mStem = s(monthGz)[0] || '';
      const mBranch = s(monthGz)[1] || '';
      const zodiac = westernZodiac(dt.getMonth() + 1, dt.getDate());
      const xunkong = xunkongByDayStem[dayStem] ? xunkongByDayStem[dayStem].join('、') : '—';
      const taiStem = shiftArr(stems, mStem, 1);
      const taiBranch = shiftArr(branches, mBranch, 3);
      const taiYuan = taiStem + taiBranch;
      const taiXiBranch = shiftArr(branches, taiBranch, 1);
      const taiXi = taiStem + taiXiBranch;
      const monthIdx = branches.indexOf(mBranch);
      const timeIdx = branches.indexOf(timeBranch);
      const mingIdx = ((monthIdx >= 0 ? monthIdx : 0) + (timeIdx >= 0 ? timeIdx : 0)) % 12;
      const mingBranch = branches[mingIdx];
      const branch2stem = {
        '子': '癸', '丑': '己', '寅': '甲', '卯': '乙', '辰': '戊', '巳': '丙',
        '午': '丁', '未': '己', '申': '庚', '酉': '辛', '戌': '戊', '亥': '壬'
      };
      const mingStem = branch2stem[mingBranch] || '';
      const mingGz = mingStem + mingBranch;
      const shenIdx = (mingIdx + 3) % 12;
      const shenBranch = branches[shenIdx];
      const shenStem = branch2stem[shenBranch] || '';
      const shenGz = shenStem + shenBranch;
      const extrasText = `西洋星座：${zodiac}\n空亡（旬空）：${xunkong}\n胎元：${taiYuan}\n胎息：${taiXi}\n命宮：${mingGz}（地支:${mingBranch}）\n身宮：${shenGz}（地支:${shenBranch}）`;
      setTextContent('extras', extrasText);
      const fiveElements = calculateFiveElements(yearGz, monthGz, dayGz, timeGz);
      setTextContent('wx', `五行：${fiveElements}\n日主：${dayStem || '—'}`);
      const fiveChart = document.getElementById('fiveChart');
      if (fiveChart) {
        const five = fiveElements.split(' ').reduce((acc, curr) => {
          const [element, value] = curr.split(' ');
          acc[element] = parseFloat(value);
          return acc;
        }, {});
        new Chart(fiveChart.getContext('2d'), {
          type: 'bar',
          data: {
            labels: ['金', '木', '水', '火', '土'],
            datasets: [{
              label: '五行分佈',
              data: [five['金'], five['木'], five['水'], five['火'], five['土']],
              backgroundColor: ['#607D8B', '#4CAF50', '#2196F3', '#FF5722', '#FFC107']
            }]
          },
          options: {
            scales: { y: { beginAtZero: true } },
            plugins: { title: { display: true, text: i18next.t('wx') } }
          }
        });
      }
      const { startAge, targetJieQi, distanceDays } = calculatePreciseStartAge(dt, s(yearGz)[0], gender);
      const ganShen = [
        `年干：${s(yearGz)[0]}（${getTenGod(dayStem, s(yearGz)[0]) || '—'}）`,
        `月干：${s(monthGz)[0]}（${getTenGod(dayStem, s(monthGz)[0]) || '—'}）`,
        `日干：${dayStem}（日主）`,
        `時干：${s(timeGz)[0]}（${getTenGod(dayStem, s(timeGz)[0]) || '—'}）`
      ].join('\n');
      const zhiShen = [
        `年支：${yearBranch}（${getTenGod(dayStem, branchToStemMap[yearBranch]) || '—'}）`,
        `月支：${monthBranch}（${getTenGod(dayStem, branchToStemMap[monthBranch]) || '—'}）`,
        `日支：${dayBranch}（${getTenGod(dayStem, branchToStemMap[dayBranch]) || '—'}）`,
        `時支：${timeBranch}（${getTenGod(dayStem, branchToStemMap[timeBranch]) || '—'}）`
      ].join('\n');
      const jieQiText = `節氣：${targetJieQi}（距離 ${distanceDays} 天，起運 ${startAge} 歲）`;
      const dayGe = calculateDayGe(dayStem, monthBranch, fiveElements);
      const { gui, xiong } = calculateGuiXiongGe(dayStem, dayBranch, timeBranch);
      const shenSha = calculateShenSha(dayStem, yearBranch, monthBranch, dayBranch, timeBranch);
      const tenLegendText = `干神：
${ganShen}
支神：
${zhiShen}
五行：${fiveElements}
${jieQiText}
胎元：${taiYuan}
日格：${dayGe}
日時貴格：${gui}
日時凶格：${xiong}
神煞：${shenSha}`;
      setTextContent('tenLegend', tenLegendText);
      const { dayunList, isForward, startInfo } = calculateDayunPrecise(lunar, gender, birthYear, dt, yearGz, monthGz);
      console.log('=== 十神強弱分析 ===');
      console.log(`日干（日主）：${dayStem || '—'}  日支：${dayBranch || '—'}`);
      console.log(`年干：${s(yearGz)[0] || '—'}  月干：${s(monthGz)[0] || '—'}`);
      const currentYear = new Date().getFullYear();
      const currentAge = currentYear - birthYear;
      let currentDayunIndex = 0;
      for (let i = 0; i < dayunList.length; i++) {
        const d = dayunList[i];
        if (currentYear >= d.startYear && currentYear <= d.endYear) {
          currentDayunIndex = i;
          break;
        }
      }
      const dayunTbody = document.querySelector('#dayunTable tbody');
      if (dayunTbody) {
        dayunTbody.innerHTML = '';
        dayunList.forEach((d, index) => {
          const tianganTen = getTenGod(dayStem, d.tianganStem) || '—';
          const dizhiStem = branchToStemMap[d.dizhiBranch];
          const dizhiTen = dizhiStem ? getTenGod(dayStem, dizhiStem) || '—' : '—';
          const tr = document.createElement('tr');
          tr.setAttribute('tabindex', '0');
          tr.setAttribute('aria-selected', index === currentDayunIndex ? 'true' : 'false');
          if (index === currentDayunIndex) {
            tr.className = 'highlight';
          }
          tr.addEventListener('click', () => {
            document.querySelectorAll('#dayunTable tbody tr').forEach(row => {
              row.classList.remove('highlight');
              row.setAttribute('aria-selected', 'false');
            });
            tr.classList.add('highlight');
            tr.setAttribute('aria-selected', 'true');
            renderLiuNianForDayun(d, index, dayStem, birthYear);
            const specificStats = calculateTenGodStats(dayunList, dayStem, currentAge, index);
            renderTenGodStats(specificStats.tianganStats, specificStats.dizhiStats, specificStats.avgStrength, specificStats);
            let titleSuffix;
            if (currentYear >= d.startYear && currentYear <= d.endYear) {
              titleSuffix = `（當前大運 第${d.index}步）`;
            } else if (currentYear < d.startYear) {
              titleSuffix = `（未來大運 第${d.index}步）`;
            } else {
              titleSuffix = `（過去大運 第${d.index}步）`;
            }
            const liunianH4 = document.querySelector('#liunianTable').parentElement.querySelector('h4');
            if (liunianH4) liunianH4.textContent = `流年（${d.startAge}-${d.startAge + 9}歲）${titleSuffix}`;
          });
          tr.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              tr.click();
            }
          });
          tr.innerHTML = `<td>${d.index}</td><td>${d.startAge}</td><td class="biggz">${d.gz}</td><td>${tianganTen}</td><td>${dizhiTen}</td><td>${d.startYear || '—'}</td><td>${d.endYear || '—'}</td><td class="small">${d.direction}</td>`;
          dayunTbody.appendChild(tr);
        });
      }
      renderLiuNianForDayun(dayunList[currentDayunIndex], currentDayunIndex, dayStem, birthYear);
      const tenGodStatsResult = calculateTenGodStats(dayunList, dayStem, currentAge);
      renderTenGodStats(tenGodStatsResult.tianganStats, tenGodStatsResult.dizhiStats, tenGodStatsResult.avgStrength, tenGodStatsResult);
      console.log(`分析範圍：當前年齡 ${currentAge} 歲，未來40年大運`);
      console.log(`相關大運數量：${tenGodStatsResult.relevantCount} 步`);
      console.log(`整體強弱評分：${tenGodStatsResult.avgStrength.toFixed(1)} 分`);
      window._bazi_state = { dayunList, solar, lunar, dayStem, birthYear, currentDayunIndex, startInfo, currentAge };
      renderDayunKChart(dayunList, dayStem);
    });

    document.getElementById('showFullBtn').addEventListener('click', () => {
      const state = window._bazi_state;
      if (!state) { alert('請先生成命盤'); return; }
      const { dayunList, solar, dayStem, birthYear } = state;
      const startYear = dayunList[0].startYear;
      const endYear = solar.getYear() + 100;
      const currentYear = new Date().getFullYear();
      const liuTbody = document.querySelector('#liunianTable tbody');
      if (!liuTbody) {
        console.warn('Element "#liunianTable tbody" not found.');
        return;
      }
      liuTbody.innerHTML = '';
      for (let y = startYear; y <= endYear; y++) {
        let yGz = '—';
        try {
          const s = Solar.fromYmd(y, 1, 1);
          yGz = s.getLunar().getYearInGanZhi();
        } catch (e) {}
        const stem = s(yGz)[0] || '';
        const ten = dayStem ? getTenGod(dayStem, stem) || '—' : '—';
        const luck = tenLuck[ten] || '中';
        const tr = document.createElement('tr');
        if (y === currentYear) {
          tr.className = (luck === '吉') ? 'ok highlight' : (luck === '凶') ? 'bad highlight' : 'mid highlight';
        } else {
          tr.className = (luck === '吉') ? 'ok' : (luck === '凶') ? 'bad' : 'mid';
        }
        tr.innerHTML = `<td>${y}</td><td>${yGz}</td><td>${(y - birthYear)}</td><td>${ten}</td><td>${luck}</td>`;
        liuTbody.appendChild(tr);
      }
      document.querySelectorAll('#dayunTable tbody tr').forEach(row => {
        row.classList.remove('highlight');
        row.setAttribute('aria-selected', 'false');
      });
      const overallStats = calculateTenGodStats(dayunList, dayStem, birthYear + 100 - birthYear);
      renderTenGodStats(overallStats.tianganStats, overallStats.dizhiStats, overallStats.avgStrength, overallStats);
      const liunianH4 = document.querySelector('#liunianTable').parentElement.querySelector('h4');
      if (liunianH4) liunianH4.textContent = '流年（完整人生直到 +100 歲）';
      renderLiuNianKChart(startYear, endYear, dayStem, birthYear);
    });
    // download PNG
    document.getElementById('downloadBtn').addEventListener('click', () => {
        const board = document.querySelector('.board');
        if (board.style.display === 'none') { alert('請先生成命盤'); return; }
        
        const state = window._bazi_state;
        if (!state) { alert('請先生成命盤'); return; }
        
        // 獲取生日資訊作為檔名
        const birthInput = document.getElementById('birth').value;
        let filename = 'bazi.png';
        if (birthInput) {
            const dt = new Date(birthInput);
            const year = dt.getFullYear();
            const month = String(dt.getMonth() + 1).padStart(2, '0');
            const day = String(dt.getDate()).padStart(2, '0');
            filename = `${year}${month}${day}.png`;
        }
        
        const dbg = document.querySelector('.debug');
        const dbgDisplay = dbg.style.display;
        dbg.style.display = 'none';
        html2canvas(board, { scale: 2, useCORS: true }).then(canvas => {
            dbg.style.display = dbgDisplay;
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = filename;
            link.click();
        }).catch(err => {
            dbg.style.display = dbgDisplay;
            alert('匯出失敗：' + err);
        });
    });
    document.getElementById('lang').addEventListener('change', (e) => {
    i18next.changeLanguage(e.target.value).then(() => updateLanguage());
    });
    // 初始化語言
    document.getElementById('lang').value = 'zh-TW';
    i18next.changeLanguage('zh-TW').then(() => updateLanguage());
</script>
</body>
</html>